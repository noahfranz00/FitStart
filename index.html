<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>FitStart — AI Fitness Plans</title>
<meta name="application-name" content="FitStart">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="FitStart">
<meta name="theme-color" content="#0a0a0a">
<meta name="mobile-web-app-capable" content="yes">
<meta name="description" content="AI-powered fitness plans, workout tracking, and nutrition logging.">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Syne:wght@400;500;700;800&family=DM+Mono:wght@300;400;500&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
/* ═══════════════════════════════════════════ */
/* STYLES.CSS — All CSS                        */
/* ═══════════════════════════════════════════ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; min-width:0; }
:root {
  --black: #0A0A0A; --dark: #111; --card: #161616; --border: rgba(255,255,255,0.07);
  --border2: rgba(255,255,255,0.13); --white: #F2F0EB; --off: #E2DFD8; --dim: #B8B4AE;
  --green: #4ADE80; --green-dim: rgba(74,222,128,0.12);
  --orange: #FB923C; --orange-dim: rgba(251,146,60,0.12);
  --red: #F43F5E; --red-dim: rgba(244,63,94,0.12);
  --blue: #60A5FA; --tier-color: var(--green); --tier-dim: var(--green-dim);
}
body.intermediate { --tier-color: var(--orange); --tier-dim: var(--orange-dim); }
body.advanced { --tier-color: var(--red); --tier-dim: var(--red-dim); }
html { overflow-x:hidden; max-width:100vw; padding-top: env(safe-area-inset-top); }
body { font-family: 'Inter', 'Syne', sans-serif; background: var(--black); color: var(--white); min-height: 100vh; overflow-x: hidden; max-width:100vw; }
body::before {
  content: ''; position: fixed; inset: 0; pointer-events: none; z-index: 0;
  background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none'%3E%3Cg fill='%23ffffff' fill-opacity='0.015'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
}
* { position: relative; z-index: 1; }
@keyframes fadeUp { from { opacity:0; transform:translateY(14px); } to { opacity:1; transform:none; } }
@keyframes barPulse { 0%,100% { transform:scaleY(0.5); opacity:0.4; } 50% { transform:scaleY(1); opacity:1; } }
@keyframes spin { to { transform:rotate(360deg); } }
@keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.5; } }

/* ── NAV ── */
nav { display:flex; justify-content:space-between; align-items:center; padding:20px 48px; border-bottom:1px solid var(--border); background:rgba(10,10,10,0.92); backdrop-filter:blur(10px); position:sticky; top:0; z-index:200; width:100%; box-sizing:border-box; }
.logo { font-family:'Bebas Neue',sans-serif; font-size:1.9rem; letter-spacing:2px; }
.logo-dot { color:var(--green); transition:color 0.4s; }
.nav-right { display:flex; align-items:center; gap:14px; }
.nav-pill { font-size:0.68rem; font-weight:700; letter-spacing:1.5px; text-transform:uppercase; color:var(--dim); border:1px solid var(--border); border-radius:100px; padding:6px 14px; }
.nav-cta { padding:9px 22px; border-radius:10px; border:none; background:var(--green); color:var(--black); font-family:'Bebas Neue',sans-serif; font-size:0.95rem; letter-spacing:1.5px; cursor:pointer; transition:all 0.2s; }
.nav-cta:hover { opacity:0.9; }
.streak-pill { display:flex; align-items:center; gap:6px; background:var(--orange-dim); border:1px solid rgba(251,146,60,0.25); border-radius:100px; padding:7px 16px; font-size:0.75rem; font-weight:700; color:var(--orange); }
.user-pill { display:flex; align-items:center; gap:8px; background:var(--card); border:1px solid var(--border); border-radius:100px; padding:6px 14px 6px 6px; font-size:0.78rem; color:var(--off); cursor:pointer; }
.avatar { width:26px; height:26px; border-radius:50%; background:linear-gradient(135deg,var(--green),var(--blue)); display:flex; align-items:center; justify-content:center; font-size:0.65rem; font-weight:700; color:var(--black); flex-shrink:0; }

/* ── SCREENS ── */
.screen { display:none; }
.screen.active { display:block; }

/* ── ONBOARDING ── */
#screen-onboard .hero { padding:60px 48px 40px; max-width:1100px; margin:0 auto; box-sizing:border-box; }
.hero-eyebrow { display:flex; align-items:center; gap:12px; font-size:0.72rem; font-weight:700; letter-spacing:2px; text-transform:uppercase; color:var(--dim); margin-bottom:20px; }
.eyebrow-line { width:32px; height:1px; background:var(--dim); }
#ob-headline { font-family:'Bebas Neue',sans-serif; font-size:clamp(3.5rem,8vw,6rem); line-height:0.92; letter-spacing:1px; margin-bottom:20px; }
.line-accent { color:var(--tier-color); transition:color 0.4s; display:block; }
.hero-sub { font-size:1rem; color:var(--off); max-width:540px; line-height:1.7; font-weight:400; margin-bottom:32px; }
.tier-selector { display:flex; gap:10px; flex-wrap:wrap; }
.tier-btn { flex:1; min-width:160px; padding:16px 20px; background:var(--card); border:1px solid var(--border); border-radius:14px; cursor:pointer; text-align:left; transition:all 0.25s; color:var(--white); }
.tier-btn:hover { border-color:var(--border2); }
.tier-btn.active { border-color:var(--tier-color); background:var(--tier-dim); }
.tier-label { font-family:'Bebas Neue',sans-serif; font-size:1.15rem; letter-spacing:1px; }
.tier-btn.active .tier-label { color:var(--tier-color); }
.tier-desc { font-size:0.72rem; color:var(--dim); margin-top:4px; }
.tier-dots { display:flex; gap:4px; margin-top:10px; }
.tier-dot { width:6px; height:6px; border-radius:50%; background:var(--border2); }
.tier-btn.active .tier-dot { background:var(--tier-color); }

.main-layout { display:grid; grid-template-columns:1fr 300px; gap:24px; max-width:1100px; margin:0 auto; padding:0 48px 60px; }
.form-card { background:var(--card); border:1px solid var(--border); border-radius:20px; padding:32px; }
.form-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; }
.form-title { font-family:'Bebas Neue',sans-serif; font-size:1.4rem; letter-spacing:1px; }
.tier-badge { font-size:0.65rem; font-weight:700; letter-spacing:1.5px; text-transform:uppercase; color:var(--green); background:var(--green-dim); border:1px solid rgba(74,222,128,0.2); padding:5px 12px; border-radius:6px; }
.tier-badge.intermediate { color:var(--orange); background:var(--orange-dim); border-color:rgba(251,146,60,0.2); }
.tier-badge.advanced { color:var(--red); background:var(--red-dim); border-color:rgba(244,63,94,0.2); }
.form-section-label { font-size:0.6rem; font-weight:700; letter-spacing:2px; text-transform:uppercase; color:var(--dim); margin-bottom:12px; margin-top:20px; }
.form-row { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
.form-group { display:flex; flex-direction:column; gap:6px; }
.form-group label { font-size:0.65rem; font-weight:700; letter-spacing:1.5px; text-transform:uppercase; color:var(--dim); }
.form-group input, .form-group select { padding:10px 13px; background:var(--dark); border:1px solid var(--border); border-radius:10px; font-family:'Syne',sans-serif; font-size:0.88rem; color:var(--white); outline:none; transition:border-color 0.2s; }
.form-group input:focus, .form-group select:focus { border-color:var(--tier-color); }
.form-group input::placeholder { color:var(--dim); }
.form-group select option { background:var(--dark); }

/* Split selector */
.split-selector { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:6px; }
.split-btn { padding:12px 14px; background:var(--dark); border:1px solid var(--border); border-radius:10px; cursor:pointer; text-align:left; transition:all 0.2s; }
.split-btn:hover { border-color:var(--border2); }
.split-btn.active { border-color:var(--tier-color); background:var(--tier-dim); }
.split-btn-title { font-size:0.82rem; font-weight:700; color:var(--off); }
.split-btn.active .split-btn-title { color:var(--tier-color); }
.split-btn-desc { font-size:0.68rem; color:var(--dim); margin-top:3px; }

/* Day picker */
.day-picker { display:flex; gap:6px; flex-wrap:wrap; margin-top:6px; }
.day-pill { padding:8px 14px; border-radius:8px; border:1px solid var(--border); background:var(--dark); font-family:'DM Mono',monospace; font-size:0.78rem; color:var(--dim); cursor:pointer; transition:all 0.18s; user-select:none; }
.day-pill.active { border-color:var(--tier-color); background:var(--tier-dim); color:var(--tier-color); font-weight:500; }

/* Timeline selector */
.timeline-selector { display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; }
.tl-btn { padding:10px 18px; border-radius:9px; border:1px solid var(--border); background:var(--dark); font-family:'DM Mono',monospace; font-size:0.8rem; color:var(--dim); cursor:pointer; transition:all 0.2s; }
.tl-btn:hover { border-color:var(--border2); color:var(--off); }
.tl-btn.active { border-color:var(--tier-color); background:var(--tier-dim); color:var(--tier-color); font-weight:500; }

.btn-generate { width:100%; margin-top:24px; padding:16px; background:var(--tier-color); color:var(--black); border:none; border-radius:12px; font-family:'Bebas Neue',sans-serif; font-size:1.1rem; letter-spacing:2px; cursor:pointer; transition:all 0.2s; }
.btn-generate:hover { opacity:0.9; transform:translateY(-1px); }
.btn-generate:disabled { opacity:0.5; cursor:not-allowed; transform:none; }
.price-note { text-align:center; font-size:0.72rem; color:var(--dim); margin-top:10px; font-family:'DM Mono',monospace; }

/* Sidebar */
.sidebar-info { display:flex; flex-direction:column; gap:14px; }
.info-card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:22px; }
.info-card-label { font-size:0.62rem; font-weight:700; letter-spacing:2px; text-transform:uppercase; color:var(--dim); margin-bottom:14px; }
.feature-item { display:flex; gap:10px; align-items:flex-start; margin-bottom:10px; }
.feature-dot { width:6px; height:6px; border-radius:50%; background:var(--tier-color); flex-shrink:0; margin-top:6px; }
.feature-text { font-size:0.82rem; color:var(--off); line-height:1.5; }

/* Loading */
.loading-wrap { display:none; text-align:center; padding:80px 48px; }
.loader { display:flex; align-items:center; justify-content:center; gap:6px; margin-bottom:20px; }
.loader-bar { width:4px; height:32px; border-radius:2px; background:var(--tier-color); animation:barPulse 0.8s ease-in-out infinite; }
.loader-bar:nth-child(2) { animation-delay:0.1s; height:48px; }
.loader-bar:nth-child(3) { animation-delay:0.2s; height:24px; }
.loader-bar:nth-child(4) { animation-delay:0.3s; height:40px; }
.loader-bar:nth-child(5) { animation-delay:0.4s; height:20px; }
.loading-wrap p { color:var(--off); font-size:0.95rem; }
.loading-wrap small { color:var(--dim); font-size:0.75rem; font-family:'DM Mono',monospace; margin-top:8px; display:block; }

/* Results */
#results-section { display:none; max-width:1100px; margin:0 auto; padding:0 48px 60px; overflow-x:hidden; }
.results-banner { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:24px; padding-bottom:20px; border-bottom:1px solid var(--border); animation:fadeUp 0.3s ease forwards; flex-wrap:wrap; gap:12px; }
.results-banner h2 { font-family:'Bebas Neue',sans-serif; font-size:2.2rem; letter-spacing:1px; margin-bottom:4px; }
.results-banner p { font-size:0.88rem; color:var(--off); }
.results-tier-badge { font-family:'Bebas Neue',sans-serif; font-size:0.95rem; letter-spacing:2px; padding:8px 16px; border-radius:8px; background:var(--green-dim); color:var(--green); border:1px solid rgba(74,222,128,0.2); }
.results-tier-badge.intermediate { background:var(--orange-dim); color:var(--orange); border-color:rgba(251,146,60,0.2); }
.results-tier-badge.advanced { background:var(--red-dim); color:var(--red); border-color:rgba(244,63,94,0.2); }
.results-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:14px; margin-bottom:16px; }
.r-card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:26px; animation:fadeUp 0.35s ease forwards; opacity:0; overflow:hidden; word-break:break-word; }
.r-card:nth-child(2) { animation-delay:0.08s; }
.r-card:nth-child(3) { animation-delay:0.16s; }
.r-card-icon { font-size:1.6rem; margin-bottom:12px; }
.r-card h3 { font-family:'Bebas Neue',sans-serif; font-size:1.4rem; letter-spacing:1.5px; color:var(--white); margin-bottom:12px; }
.r-card p { font-size:0.88rem; color:var(--off); line-height:1.6; margin-bottom:5px; }
.r-card strong { color:var(--white); font-weight:700; }
.r-card ul { margin-left:14px; margin-top:8px; }
.r-card li { font-size:0.86rem; color:var(--off); line-height:1.7; }
.week-card { background:var(--card); border:1px solid var(--border); border-radius:18px; padding:28px; margin-bottom:16px; animation:fadeUp 0.4s 0.2s ease forwards; opacity:0; }
.week-card h3 { font-family:'Bebas Neue',sans-serif; font-size:1.1rem; letter-spacing:1.5px; margin-bottom:18px; }
.day-row { display:grid; grid-template-columns:100px 1fr auto; gap:16px; align-items:center; padding:13px 0; border-bottom:1px solid var(--border); }
.day-row:last-child { border-bottom:none; }
.day-name { font-family:'DM Mono',monospace; font-size:0.72rem; color:var(--dim); text-transform:uppercase; letter-spacing:1px; }
.day-workout { font-size:0.83rem; color:var(--off); line-height:1.5; }
.day-tag { font-size:0.62rem; font-weight:700; letter-spacing:1px; text-transform:uppercase; padding:4px 10px; border-radius:6px; white-space:nowrap; }
.day-tag.workout { background:var(--green-dim); color:var(--green); }
.day-tag.workout.intermediate { background:var(--orange-dim); color:var(--orange); }
.day-tag.workout.advanced { background:var(--red-dim); color:var(--red); }
.day-tag.rest { background:rgba(255,255,255,0.04); color:var(--dim); }
.cta-into-app { background:linear-gradient(135deg,#111,#1a1a1a); border:1px solid var(--border); border-radius:20px; padding:48px; text-align:center; animation:fadeUp 0.4s 0.35s ease forwards; opacity:0; position:relative; overflow:hidden; }
.cta-into-app::before { content:''; position:absolute; top:-60px; left:50%; transform:translateX(-50%); width:300px; height:300px; background:radial-gradient(circle,rgba(74,222,128,0.08),transparent 70%); pointer-events:none; }
body.intermediate .cta-into-app::before { background:radial-gradient(circle,rgba(251,146,60,0.08),transparent 70%); }
body.advanced .cta-into-app::before { background:radial-gradient(circle,rgba(244,63,94,0.08),transparent 70%); }
.cta-into-app h3 { font-family:'Bebas Neue',sans-serif; font-size:2.5rem; letter-spacing:1px; margin-bottom:8px; }
.cta-into-app p { font-size:0.9rem; color:var(--off); margin-bottom:28px; }
.btn-enter-app { display:inline-flex; align-items:center; gap:10px; padding:18px 44px; border-radius:12px; border:none; background:var(--tier-color); color:var(--black); font-family:'Bebas Neue',sans-serif; font-size:1.2rem; letter-spacing:2px; cursor:pointer; transition:all 0.2s; }
.btn-enter-app:hover { opacity:0.9; transform:translateY(-2px); }
.cta-fine { margin-top:14px; font-size:0.72rem; color:var(--dim); font-family:'DM Mono',monospace; }

/* ── SIGNUP SCREEN ── */
#screen-signup { display:none; }
#screen-signup.active { display:block; }
.signup-wrap { max-width:980px; margin:0 auto; padding:48px 48px 80px; display:grid; grid-template-columns:1fr 420px; gap:40px; align-items:start; }
.signup-left { padding-top:8px; }
.signup-eyebrow { font-size:0.65rem; font-weight:700; letter-spacing:2px; text-transform:uppercase; color:var(--tier-color); display:flex; align-items:center; gap:10px; margin-bottom:18px; }
.signup-eyebrow-line { width:24px; height:1px; background:var(--tier-color); }
.signup-left h2 { font-family:'Bebas Neue',sans-serif; font-size:clamp(2.8rem,5vw,4.2rem); letter-spacing:1px; line-height:0.95; margin-bottom:16px; }
.signup-left h2 span { color:var(--tier-color); }
.signup-tagline { font-size:0.9rem; color:var(--off); line-height:1.7; margin-bottom:28px; max-width:420px; }
.plan-summary { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:22px; margin-bottom:24px; }
.ps-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:14px; }
.ps-label { font-size:0.6rem; font-weight:700; letter-spacing:2px; text-transform:uppercase; color:var(--dim); }
.ps-tier-badge { font-size:0.62rem; font-weight:700; letter-spacing:1px; text-transform:uppercase; color:var(--tier-color); background:var(--tier-dim); padding:3px 10px; border-radius:5px; }
.ps-plan-name { font-family:'Bebas Neue',sans-serif; font-size:1.5rem; letter-spacing:1px; margin-bottom:4px; }
.ps-tagline { font-size:0.78rem; color:var(--dim); margin-bottom:14px; font-style:italic; }
.ps-stats { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
.ps-stat { background:var(--dark); border:1px solid var(--border); border-radius:9px; padding:10px 13px; }
.ps-stat-val { font-family:'DM Mono',monospace; font-size:0.85rem; font-weight:500; }
.ps-stat-label { font-size:0.6rem; font-weight:700; letter-spacing:1px; text-transform:uppercase; color:var(--dim); margin-top:2px; }
.included-list { display:flex; flex-direction:column; gap:8px; }
.included-item { display:flex; align-items:center; gap:10px; font-size:0.82rem; color:var(--off); }
.included-check { width:18px; height:18px; border-radius:5px; background:var(--green-dim); border:1px solid rgba(74,222,128,0.25); display:flex; align-items:center; justify-content:center; font-size:0.6rem; color:var(--green); flex-shrink:0; }
.signup-card { background:var(--card); border:1px solid var(--border2); border-radius:22px; padding:32px; position:sticky; top:90px; }
.trial-badge { display:flex; align-items:center; justify-content:center; gap:8px; background:var(--green-dim); border:1px solid rgba(74,222,128,0.2); border-radius:10px; padding:12px; margin-bottom:24px; font-size:0.8rem; font-weight:700; color:var(--green); }
.signup-form-title { font-family:'Bebas Neue',sans-serif; font-size:1.6rem; letter-spacing:1px; margin-bottom:4px; }
.signup-form-sub { font-size:0.75rem; color:var(--dim); font-family:'DM Mono',monospace; margin-bottom:22px; }
.sf-group { display:flex; flex-direction:column; gap:6px; margin-bottom:13px; }
.sf-label { font-size:0.6rem; font-weight:700; letter-spacing:1.5px; text-transform:uppercase; color:var(--dim); }
.sf-input { padding:12px 14px; background:var(--dark); border:1px solid var(--border); border-radius:11px; font-family:'Syne',sans-serif; font-size:0.88rem; color:var(--white); outline:none; transition:border-color 0.2s; width:100%; }
.sf-input:focus { border-color:var(--green); }
.sf-input::placeholder { color:var(--dim); }
.sf-row { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:13px; }
.pw-strength { display:flex; gap:4px; margin-top:6px; }
.pw-bar { flex:1; height:3px; border-radius:2px; background:var(--border); transition:background 0.2s; }
.pw-bar.weak { background:var(--red); } .pw-bar.ok { background:var(--orange); } .pw-bar.strong { background:var(--green); }
.trial-breakdown { background:var(--dark); border:1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:20px; }
.tb-row { display:flex; justify-content:space-between; align-items:center; padding:7px 0; border-bottom:1px solid var(--border); font-size:0.8rem; }
.tb-row:last-child { border-bottom:none; }
.tb-label { color:var(--dim); }
.tb-val { color:var(--white); font-weight:600; font-family:'DM Mono',monospace; }
.tb-val.free { color:var(--green); font-family:'Bebas Neue',sans-serif; font-size:1rem; letter-spacing:1px; }
.tb-val.after { color:var(--off); font-size:0.75rem; }
.btn-start-trial { width:100%; padding:17px; background:var(--green); color:var(--black); border:none; border-radius:13px; font-family:'Bebas Neue',sans-serif; font-size:1.2rem; letter-spacing:2px; cursor:pointer; transition:all 0.2s; display:flex; align-items:center; justify-content:center; gap:8px; }
.btn-start-trial:hover { opacity:0.9; transform:translateY(-2px); }
.btn-start-trial:disabled { opacity:0.5; cursor:not-allowed; transform:none; }
body.intermediate .btn-start-trial { background:var(--orange); }
body.advanced .btn-start-trial { background:var(--red); }
.signup-fine { text-align:center; font-size:0.67rem; color:var(--dim); font-family:'DM Mono',monospace; margin-top:12px; line-height:1.6; }
.signup-login { text-align:center; margin-top:14px; font-size:0.78rem; color:var(--dim); }
.signup-login a { color:var(--off); text-decoration:underline; cursor:pointer; }
.spinner { width:16px; height:16px; border-radius:50%; border:2px solid rgba(0,0,0,0.25); border-top-color:rgba(0,0,0,0.8); animation:spin 0.6s linear infinite; }

/* ── DASHBOARD ── */
#screen-dash { display:none; }
#screen-dash.active { display:flex !important; flex-direction:column; min-height:100vh; }
.shell { display:flex; height:calc(100vh - 69px); }
.sidebar-nav { width:220px; flex-shrink:0; background:var(--dark); border-right:1px solid var(--border); padding:28px 12px; display:flex; flex-direction:column; gap:2px; overflow-y:auto; }
.sb-label { font-size:0.62rem; font-weight:700; letter-spacing:2px; text-transform:uppercase; color:var(--dim); padding:10px 12px 6px; }
.sb-btn { display:flex; align-items:center; gap:10px; padding:11px 14px; border-radius:10px; font-size:0.83rem; font-weight:500; color:var(--off); cursor:pointer; transition:all 0.18s; background:none; border:none; width:100%; text-align:left; font-family:'Syne',sans-serif; }
.sb-btn:hover { background:rgba(255,255,255,0.04); color:var(--white); }
.sb-btn.active { background:var(--green-dim); color:var(--green); border:1px solid rgba(74,222,128,0.15); }
.sb-icon { font-size:1rem; width:20px; text-align:center; flex-shrink:0; }
.sb-badge { margin-left:auto; font-family:'DM Mono',monospace; font-size:0.62rem; background:rgba(255,255,255,0.05); color:var(--dim); padding:2px 7px; border-radius:100px; }
.sb-btn.active .sb-badge { background:rgba(74,222,128,0.15); color:var(--green); }
.main-content { flex:1; overflow-y:auto; padding:36px 40px; display:flex; flex-direction:column; min-height:0; }
.view { display:none; animation:fadeUp 0.3s ease; }
.view.active { display:block; }
#view-coach.active { display:flex !important; flex-direction:column; height:100%; min-height:0; }
/* 
  Mobile coach layout: position:fixed overlay that fills the exact space between 
  the app's nav bar and the tab bar. Uses dvh to handle Safari's dynamic viewport.
*/
@media(max-width:768px) {
  .main-content.coach-active {
    /* When coach is active, make main-content invisible — the coach overlay takes over */
    padding: 0 !important;
    overflow: hidden !important;
  }
  .main-content.coach-active #view-coach.active {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    z-index: 100 !important; /* below nav(200) and tab bar(9999) */
    background: var(--black) !important;
    display: flex !important;
    flex-direction: column !important;
    /* Padding accounts for nav top and tab bar bottom */
    padding-top: 48px !important;
    padding-bottom: calc(60px + env(safe-area-inset-bottom, 6px)) !important;
  }
  .main-content.coach-active .coach-chat-container {
    flex: 1 !important;
    min-height: 0 !important;
    border: none !important;
    border-radius: 0 !important;
    display: flex !important;
    flex-direction: column !important;
    background: var(--black) !important;
  }
  .main-content.coach-active .coach-messages {
    flex: 1 !important;
    min-height: 0 !important;
    overflow-y: auto !important;
    -webkit-overflow-scrolling: touch !important;
  }
  .main-content.coach-active .coach-input-bar {
    flex-shrink: 0 !important;
    background: var(--black) !important;
  }
  /* Hide the AI COACH header row on mobile to save space */
  .main-content.coach-active #view-coach > div:first-child {
    padding: 8px 14px 6px !important;
  }
}
.page-header { margin-bottom:28px; }
.page-title { font-family:'Bebas Neue',sans-serif; font-size:2rem; letter-spacing:1px; line-height:1; }
.page-sub { font-family:'Inter',sans-serif; font-size:0.82rem; color:var(--off); margin-top:5px; }
.card { background:var(--card); border:1px solid var(--border); border-radius:18px; padding:24px; }
.card-label { font-size:0.62rem; font-weight:700; letter-spacing:2px; text-transform:uppercase; color:var(--dim); margin-bottom:10px; }
.today-grid { display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-bottom:16px; }
.stat-card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:20px; }
.sc-val { font-family:'Bebas Neue',sans-serif; font-size:2.2rem; letter-spacing:1px; color:var(--green); line-height:1; margin-bottom:3px; transition:color 0.3s; }
.sc-val.over { color:var(--red); }
.sc-sub { font-family:'DM Mono',monospace; font-size:0.75rem; color:var(--off); }
.prog-bar { height:3px; background:rgba(255,255,255,0.06); border-radius:2px; margin-top:10px; overflow:hidden; }
.prog-fill { height:100%; border-radius:2px; background:var(--green); transition:width 0.4s ease, background 0.3s; }
.prog-fill.over { background:var(--red); }
.workout-card { background:var(--card); border:1px solid var(--border); border-radius:18px; padding:24px; margin-bottom:16px; overflow:visible; }
.wc-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:20px; }
.wc-badge { display:inline-flex; align-items:center; gap:6px; font-size:0.65rem; font-weight:700; letter-spacing:1.5px; text-transform:uppercase; color:var(--green); background:var(--green-dim); border:1px solid rgba(74,222,128,0.2); padding:4px 10px; border-radius:6px; margin-bottom:6px; width:fit-content; }
.wc-name { font-family:'Bebas Neue',sans-serif; font-size:1.4rem; letter-spacing:1px; }
.btn-primary { padding:11px 24px; background:var(--green); color:var(--black); border:none; border-radius:10px; font-family:'Bebas Neue',sans-serif; font-size:0.95rem; letter-spacing:2px; cursor:pointer; transition:all 0.2s; flex-shrink:0; }
.btn-primary:hover { opacity:0.9; transform:translateY(-1px); }
.btn-primary.done { background:var(--green-dim); color:var(--green); border:1px solid rgba(74,222,128,0.3); }
.ex-list { display:flex; flex-direction:column; gap:8px; overflow:visible; }
.ex-row { display:grid; grid-template-columns:30px 1fr auto; align-items:center; gap:12px; padding:11px 14px; background:var(--dark); border-radius:10px; border:1px solid var(--border); cursor:pointer; transition:all 0.18s; position:relative; overflow:visible !important; }
.ex-row:hover { border-color:var(--border2); }
.ex-row.done { border-color:rgba(74,222,128,0.2); background:rgba(74,222,128,0.04); }
.ex-row-dots { width:28px; height:28px; border-radius:6px; border:none; background:transparent; color:var(--dim); cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:1.2rem; padding:0; flex-shrink:0; line-height:1; }
.ex-row-dots:hover { color:var(--white); background:rgba(255,255,255,0.08); }
.ex-row-dots:active { background:rgba(255,255,255,0.12); }
.ex-row-dots-wrap { display:contents; }
.ex-row-dropdown { display:none; } /* not used — portal renders on body */
.ex-row-dropdown span { display:block; padding:10px 14px; font-size:0.82rem; color:var(--off); cursor:pointer; }
.ex-row-dropdown span:hover { background:rgba(255,255,255,0.06); color:var(--white); }
.ex-row-dropdown span.delete:hover { color:var(--red); }
.ex-name { font-size:0.87rem; font-weight:500; color:var(--off); }
.ex-row.done .ex-name { color:var(--green); }
.ex-detail { font-family:'DM Mono',monospace; font-size:0.72rem; color:var(--dim); }
.ex-check { width:22px; height:22px; border-radius:6px; border:1.5px solid var(--border2); display:flex; align-items:center; justify-content:center; font-size:0.7rem; transition:all 0.2s; }
.ex-row.done .ex-check { background:var(--green); border-color:var(--green); color:var(--black); }
.log-toggle-card { background:var(--card); border:1px solid var(--border); border-radius:18px; overflow:hidden; }
.log-toggle-header { display:flex; align-items:center; justify-content:space-between; padding:18px 24px; cursor:pointer; transition:background 0.2s; }
.log-toggle-header:hover { background:rgba(255,255,255,0.02); }
.log-toggle-title { display:flex; align-items:center; gap:10px; font-size:0.85rem; font-weight:700; color:var(--green); }
.plus-icon { width:26px; height:26px; border-radius:7px; background:var(--green-dim); border:1px solid rgba(74,222,128,0.25); display:flex; align-items:center; justify-content:center; font-size:1rem; color:var(--green); }
.log-form { padding:0 24px 20px; display:none; flex-direction:column; gap:12px; }
.log-form.open { display:flex; }
.lf-name input { width:100%; padding:11px 14px; background:var(--dark); border:1px solid var(--border); border-radius:10px; font-family:'Syne',sans-serif; font-size:0.88rem; color:var(--white); outline:none; }
.lf-name input::placeholder { color:var(--dim); }
.lf-macros { display:grid; grid-template-columns:repeat(4,1fr); gap:10px; }
.lf-field { display:flex; flex-direction:column; gap:5px; }
.lf-label { font-size:0.6rem; font-weight:700; letter-spacing:2px; text-transform:uppercase; text-align:center; color:var(--dim); }
.lf-label.cal { color:var(--off); } .lf-label.p { color:var(--green); } .lf-label.c { color:var(--blue); } .lf-label.f { color:var(--orange); }
.lf-field input { padding:10px 6px; background:var(--dark); border:1px solid var(--border); border-radius:10px; font-family:'DM Mono',monospace; font-size:0.95rem; color:var(--white); text-align:center; outline:none; width:100%; }
.lf-field input::placeholder { color:var(--dim); }
.lf-actions { display:flex; gap:8px; justify-content:flex-end; }
.btn-log { padding:10px 22px; background:var(--green); color:var(--black); border:none; border-radius:9px; font-family:'Bebas Neue',sans-serif; font-size:0.95rem; letter-spacing:1.5px; cursor:pointer; }
.btn-cancel-form { padding:10px 18px; background:none; color:var(--dim); border:1px solid var(--border); border-radius:9px; font-family:'Syne',sans-serif; font-size:0.82rem; cursor:pointer; }

/* Week view */
.week-day-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:10px; margin-bottom:24px; }
.wday { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px 10px; text-align:center; cursor:pointer; transition:all 0.2s; }
.wday:hover { border-color:var(--green); transform:translateY(-2px); }
.wday.is-today { border-color:var(--green); background:var(--green-dim); }
.wday.is-done { border-color:rgba(74,222,128,0.25); }
.wday-name { font-size:0.7rem; font-weight:700; letter-spacing:1.5px; text-transform:uppercase; color:var(--off); margin-bottom:10px; }
.wday.is-today .wday-name { color:var(--green); }
.wday-icon { font-size:1.4rem; margin-bottom:8px; display:flex; align-items:center; justify-content:center; min-height:28px; }
.wday-label { font-size:0.8rem; color:var(--off); line-height:1.3; font-weight:500; }
.wday.is-today .wday-label { color:var(--off); }
.week-stat-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:14px; }

/* Nutrition */
.day-picker-nav { display:flex; gap:6px; margin-bottom:20px; flex-wrap:wrap; }
.dp-btn { padding:8px 16px; border-radius:8px; border:1px solid var(--border); background:var(--card); font-family:'DM Mono',monospace; font-size:0.77rem; color:var(--dim); cursor:pointer; transition:all 0.2s; }
.dp-btn:hover { border-color:var(--border2); color:var(--off); }
.dp-btn.active { border-color:var(--green); background:var(--green-dim); color:var(--green); }
.macro-bar { background:var(--card); border:1px solid var(--border); border-radius:18px; padding:24px; display:grid; grid-template-columns:repeat(4,1fr); gap:20px; margin-bottom:16px; }
.mb-item { display:flex; flex-direction:column; gap:4px; }
.mb-label { font-size:0.6rem; font-weight:700; letter-spacing:2px; text-transform:uppercase; color:var(--dim); }
.mb-val { font-family:'Bebas Neue',sans-serif; font-size:2rem; letter-spacing:1px; color:var(--green); line-height:1; transition:color 0.3s; }
.mb-val.over { color:var(--red); }
.mb-target { font-family:'DM Mono',monospace; font-size:0.68rem; color:var(--dim); }
.mb-bar { height:3px; background:rgba(255,255,255,0.06); border-radius:2px; margin-top:6px; overflow:hidden; }
.mb-fill { height:100%; border-radius:2px; background:var(--green); transition:width 0.4s ease, background 0.3s; }
.mb-fill.over { background:var(--red); }
.meal-list { display:flex; flex-direction:column; gap:8px; margin-bottom:16px; }
.meal-row { display:grid; grid-template-columns:1fr auto auto; align-items:center; gap:16px; padding:14px 18px; background:var(--card); border:1px solid var(--border); border-radius:12px; animation:fadeUp 0.25s ease forwards; }
.mr-name { font-size:0.87rem; font-weight:600; margin-bottom:3px; }
.mr-macros { font-family:'DM Mono',monospace; font-size:0.7rem; color:var(--dim); display:flex; gap:10px; }
.mr-macros .mp { color:var(--green); } .mr-macros .mc { color:var(--blue); } .mr-macros .mf { color:var(--orange); }
.mr-cal { font-family:'Bebas Neue',sans-serif; font-size:1.25rem; color:var(--off); letter-spacing:1px; white-space:nowrap; }
.mr-del { width:28px; height:28px; border-radius:7px; border:1px solid var(--border); background:none; color:var(--dim); font-size:0.82rem; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all 0.2s; }
.mr-del:hover { background:var(--red-dim); border-color:var(--red); color:var(--red); }
.empty { text-align:center; padding:36px; color:var(--dim); font-size:0.83rem; border:1px dashed rgba(255,255,255,0.07); border-radius:14px; }
.empty-icon { font-size:1.8rem; margin-bottom:8px; opacity:0.35; }

/* Progress */
.progress-grid { display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px; }
.prog-card { background:var(--card); border:1px solid var(--border); border-radius:18px; padding:24px; }
.prog-card.wide { grid-column:1/-1; }
.pc-title { font-family:'Bebas Neue',sans-serif; font-size:1.1rem; letter-spacing:1.5px; margin-bottom:16px; }
.weight-big { font-family:'Bebas Neue',sans-serif; font-size:3.8rem; letter-spacing:1px; line-height:1; }
.weight-change { font-size:0.85rem; color:var(--green); font-weight:600; margin-top:4px; margin-bottom:16px; }
.mini-bars { display:flex; align-items:flex-end; gap:5px; height:56px; margin-top:16px; }
.mini-bar { flex:1; border-radius:3px 3px 0 0; background:rgba(74,222,128,0.18); }
.mini-bar.now { background:var(--green); }
.stat-boxes { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.sbox { background:var(--dark); border:1px solid var(--border); border-radius:10px; padding:14px; }
.sbox-val { font-family:'Bebas Neue',sans-serif; font-size:1.7rem; letter-spacing:1px; color:var(--green); line-height:1; }
.sbox-label { font-size:0.62rem; font-weight:700; letter-spacing:1px; text-transform:uppercase; color:var(--dim); margin-top:4px; }
.streak-cal { display:grid; grid-template-columns:repeat(7,1fr); gap:5px; }
.sc-day { aspect-ratio:1; border-radius:5px; background:rgba(255,255,255,0.04); border:1px solid var(--border); display:flex; align-items:center; justify-content:center; font-family:'DM Mono',monospace; font-size:0.58rem; color:var(--dim); }
.sc-day.done { background:var(--green-dim); border-color:rgba(74,222,128,0.3); }
.sc-day.today { background:var(--green); color:var(--black); font-weight:700; border-color:var(--green); }

/* ── WORKOUT ENVIRONMENT ── */
#screen-workout { display:none; }
#screen-workout.active { display:flex !important; flex-direction:column; position:fixed !important; top:0; left:0; right:0; bottom:0; height:100vh; height:100dvh; width:100vw; overflow:hidden; background:var(--black); z-index:5000; }
.wo-header { display:flex; align-items:center; gap:16px; padding:max(16px,env(safe-area-inset-top)) 24px 16px; border-bottom:1px solid var(--border); background:rgba(10,10,10,0.95); flex-shrink:0; }
.wo-back { padding:10px 18px; border:1px solid var(--border2); border-radius:9px; background:var(--card); color:var(--white); font-family:'Syne',sans-serif; font-size:0.88rem; font-weight:600; cursor:pointer; transition:all 0.2s; }
.wo-back:hover { color:var(--green); border-color:var(--green); }
.wo-title { font-family:'Bebas Neue',sans-serif; font-size:1.4rem; letter-spacing:1.5px; flex:1; }
.wo-progress-wrap { flex:1; display:flex; align-items:center; gap:10px; max-width:300px; }
.wo-progress-bar { flex:1; height:4px; background:rgba(255,255,255,0.06); border-radius:2px; overflow:hidden; }
.wo-progress-fill { height:100%; background:var(--green); border-radius:2px; transition:width 0.4s ease; }
.wo-progress-label { font-family:'DM Mono',monospace; font-size:0.72rem; color:var(--dim); white-space:nowrap; }
.wo-body { display:flex; flex:1; overflow:hidden; }
.wo-exercise-list { width:280px; flex-shrink:0; overflow-y:auto; border-right:1px solid var(--border); padding:16px 12px; display:flex; flex-direction:column; gap:6px; }
.wo-ex-item { padding:12px 14px; border-radius:10px; border:1px solid var(--border); cursor:pointer; transition:all 0.18s; }
.wo-ex-item:hover { border-color:var(--border2); }
.wo-ex-item.active { border-color:var(--green); background:var(--green-dim); }
.wo-ex-item.completed { border-color:rgba(74,222,128,0.2); background:rgba(74,222,128,0.04); }
.wo-ex-num { font-family:'DM Mono',monospace; font-size:0.65rem; color:var(--dim); margin-bottom:4px; }
.wo-ex-item.active .wo-ex-num { color:var(--green); }
.wo-ex-name { font-size:0.85rem; font-weight:600; color:var(--off); }
.wo-ex-item.active .wo-ex-name { color:var(--green); }
.wo-ex-item.completed .wo-ex-name { color:var(--green); }
.wo-ex-sets { font-family:'DM Mono',monospace; font-size:0.68rem; color:var(--dim); margin-top:3px; }
.wo-ex-done-check { display:inline-block; width:14px; height:14px; border-radius:3px; background:var(--green); color:var(--black); font-size:0.55rem; text-align:center; line-height:14px; margin-left:6px; }
.wo-main { flex:1; overflow-y:auto; padding:20px 24px; display:flex; flex-direction:column; gap:16px; }
.wo-main.elite { padding:16px 20px; gap:12px; }
.wo-main.elite .ex-demo-wrap { display:none; }
.wo-main.elite .wo-ex-header { padding:12px 0; border-bottom:none; }
.wo-main.elite .sets-panel { background:var(--dark); border-color:var(--border2); padding:18px; }
.strength-score { display:flex; align-items:center; gap:12px; padding:10px 14px; background:linear-gradient(135deg,rgba(74,222,128,0.08),rgba(74,222,128,0.04)); border:1px solid rgba(74,222,128,0.2); border-radius:10px; margin-bottom:12px; font-family:'DM Mono',monospace; }
.strength-score-val { font-size:1.4rem; font-weight:600; color:var(--green); letter-spacing:1px; }
.strength-score-label { font-size:0.65rem; font-weight:700; letter-spacing:2px; text-transform:uppercase; color:var(--dim); margin-top:2px; }
.strength-score-delta { font-size:0.8rem; color:var(--green); margin-left:auto; }
.strength-score-delta.down { color:var(--dim); }

/* Exercise demo panel */
.ex-video-panel { background:var(--card); border:1px solid var(--border); border-radius:18px; overflow:hidden; }
.ex-video-header { display:flex; align-items:center; justify-content:space-between; padding:18px 22px 14px; flex-wrap:wrap; gap:10px; }
.ex-video-title { font-family:'Bebas Neue',sans-serif; font-size:1.8rem; letter-spacing:1.5px; }
.ex-video-badge { font-size:0.7rem; font-weight:700; letter-spacing:1px; text-transform:uppercase; color:var(--green); background:var(--green-dim); border:1px solid rgba(74,222,128,0.3); padding:8px 14px; border-radius:10px; cursor:pointer; transition:all 0.15s; user-select:none; display:flex; flex-direction:column; gap:2px; min-width:110px; position:relative; }
.ex-video-badge:hover { background:rgba(74,222,128,0.15); border-color:rgba(74,222,128,0.5); transform:scale(1.02); }
.ex-video-badge:active { transform:scale(0.98); }
.ex-demo-wrap { padding:16px 18px; border-top:1px solid var(--border); }
.ex-muscles-tag { font-family:'DM Mono',monospace; font-size:0.72rem; color:var(--dim); margin-bottom:14px; }
.ex-demo-frames { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; }
.demo-frame { background:var(--dark); border:1px solid var(--border); border-radius:12px; overflow:hidden; display:flex; flex-direction:column; }
.demo-frame-img { width:100%; aspect-ratio:4/3; object-fit:cover; display:block; background:var(--dark); }
.demo-frame-img-placeholder { width:100%; aspect-ratio:4/3; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:6px; background:linear-gradient(135deg,#1a1a1a,#111); }
.demo-frame-label { font-size:0.62rem; font-weight:700; letter-spacing:2px; text-transform:uppercase; padding:8px 10px; text-align:center; }
.demo-frame:nth-child(1) .demo-frame-label { color:var(--blue); }
.demo-frame:nth-child(2) .demo-frame-label { color:var(--green); }
.demo-frame:nth-child(3) .demo-frame-label { color:var(--orange); }
.demo-frame-icon { font-size:2rem; opacity:0.4; }
.demo-frame-name { font-size:0.65rem; color:var(--dim); text-align:center; padding:0 8px; }

/* Exercise customizer */
.ex-customizer { background:var(--card); border:1px solid var(--border); border-radius:18px; padding:20px; }
.ec-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
.ec-title { font-family:'Bebas Neue',sans-serif; font-size:1.1rem; letter-spacing:1px; }
.btn-add-ex { display:flex; align-items:center; gap:6px; padding:9px 16px; background:var(--green-dim); border:1px solid rgba(74,222,128,0.25); border-radius:9px; color:var(--green); font-family:'Bebas Neue',sans-serif; font-size:0.9rem; letter-spacing:1.5px; cursor:pointer; transition:all 0.2s; }
.btn-add-ex:hover { background:rgba(74,222,128,0.2); }
.ec-list { display:flex; flex-direction:column; gap:6px; }
.ec-row { display:grid; grid-template-columns:24px 1fr auto auto; align-items:center; gap:10px; padding:10px 12px; background:var(--dark); border:1px solid var(--border); border-radius:10px; cursor:pointer; transition:all 0.18s; }
.ec-row:hover { border-color:var(--border2); }
.ec-row.active { border-color:var(--green); background:var(--green-dim); }
.ec-num { font-family:'DM Mono',monospace; font-size:0.72rem; color:var(--dim); text-align:center; }
.ec-row.active .ec-num { color:var(--green); }
.ec-name { font-size:0.85rem; font-weight:600; color:var(--off); }
.ec-row.active .ec-name { color:var(--green); }
.ec-sets { font-family:'DM Mono',monospace; font-size:0.7rem; color:var(--dim); white-space:nowrap; }
.ec-del { width:26px; height:26px; border-radius:6px; border:1px solid var(--border); background:none; color:var(--dim); cursor:pointer; font-size:0.75rem; display:flex; align-items:center; justify-content:center; transition:all 0.2s; flex-shrink:0; }
.ec-del:hover { background:var(--red-dim); border-color:var(--red); color:var(--red); }

/* Add exercise modal */
.add-ex-modal { position:fixed; inset:0; background:rgba(0,0,0,0.85); backdrop-filter:blur(8px); z-index:900; display:none; align-items:flex-end; justify-content:center; }
.add-ex-modal.open { display:flex; }
.add-ex-sheet { background:var(--dark); border:1px solid var(--border2); border-radius:24px 24px 0 0; width:100%; max-width:680px; max-height:85vh; display:flex; flex-direction:column; }
.aes-header { display:flex; align-items:center; justify-content:space-between; padding:20px 24px 14px; border-bottom:1px solid var(--border); flex-shrink:0; }
.aes-title { font-family:'Bebas Neue',sans-serif; font-size:1.3rem; letter-spacing:1px; }
.aes-close { width:32px; height:32px; border-radius:8px; border:1px solid var(--border); background:none; color:var(--dim); cursor:pointer; font-size:1rem; display:flex; align-items:center; justify-content:center; }
.aes-close:hover { border-color:var(--border2); color:var(--white); }
.aes-search { padding:14px 24px; border-bottom:1px solid var(--border); flex-shrink:0; }
.aes-search input { width:100%; padding:10px 14px; background:var(--card); border:1px solid var(--border); border-radius:10px; font-family:'Syne',sans-serif; font-size:0.88rem; color:var(--white); outline:none; }
.aes-search input:focus { border-color:var(--green); }
.aes-search input::placeholder { color:var(--dim); }
.aes-filters { display:flex; gap:8px; padding:12px 24px; border-bottom:1px solid var(--border); flex-shrink:0; flex-wrap:wrap; }
.aes-filter-btn { display:flex; align-items:center; gap:5px; padding:7px 12px; border-radius:8px; border:1px solid var(--border); background:var(--card); font-family:'DM Mono',monospace; font-size:0.72rem; color:var(--dim); cursor:pointer; white-space:nowrap; transition:all 0.15s; position:relative; }
.aes-filter-btn:hover { border-color:var(--border2); color:var(--off); }
.aes-filter-btn.active { border-color:var(--green); background:var(--green-dim); color:var(--green); }
.aes-filter-btn svg { flex-shrink:0; }
.aes-dropdown { position:fixed; background:#1a1a1a; border:1px solid rgba(255,255,255,0.15); border-radius:12px; padding:6px 0; min-width:180px; z-index:9999; box-shadow:0 12px 40px rgba(0,0,0,0.7); max-height:280px; overflow-y:auto; }
.aes-dropdown-item { display:flex; align-items:center; justify-content:space-between; padding:10px 16px; font-size:0.82rem; color:#E2DFD8; cursor:pointer; transition:background 0.12s; }
.aes-dropdown-item:hover { background:rgba(255,255,255,0.06); }
.aes-dropdown-item.selected { color:var(--green); }
.aes-dropdown-item.selected::after { content:'✓'; font-size:0.75rem; }
.aes-muscle-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }
.aes-list { overflow-y:auto; padding:12px 24px 24px; flex:1; display:flex; flex-direction:column; gap:6px; }
.aes-item { display:grid; grid-template-columns:10px 1fr auto; align-items:center; gap:10px; padding:12px 14px; background:var(--card); border:1px solid var(--border); border-radius:10px; cursor:pointer; transition:all 0.18s; }
.aes-item:hover { border-color:var(--green); }
.aes-item.added { border-color:rgba(74,222,128,0.3); background:rgba(74,222,128,0.05); }
.aes-item-name { font-size:0.85rem; font-weight:600; color:var(--off); }
.aes-item.added .aes-item-name { color:var(--green); }
.aes-item-cat { font-size:0.62rem; font-weight:700; letter-spacing:1px; text-transform:uppercase; color:var(--dim); }
.aes-item-add { width:28px; height:28px; border-radius:7px; border:1px solid var(--green); background:var(--green-dim); color:var(--green); font-size:1rem; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all 0.2s; flex-shrink:0; }
.aes-item-add:hover { background:var(--green); color:var(--black); }
.aes-item-add.done { background:var(--green); color:var(--black); border-color:var(--green); }
.ex-video-placeholder { position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:12px; background:#0d0d0d; }
.ex-video-placeholder-icon { font-size:2.5rem; opacity:0.3; }
.ex-video-placeholder p { font-size:0.82rem; color:var(--dim); }

/* Sets tracker */
.sets-panel { background:var(--card); border:1px solid var(--border); border-radius:18px; padding:22px; overflow:visible; }
.sets-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
.sets-title { font-family:'Bebas Neue',sans-serif; font-size:1.1rem; letter-spacing:1px; }
.rest-timer { display:flex; align-items:center; gap:8px; font-family:'DM Mono',monospace; font-size:0.82rem; color:var(--dim); }
.rest-timer-btn { padding:6px 14px; border:1px solid var(--border); border-radius:7px; background:none; color:var(--dim); font-family:'DM Mono',monospace; font-size:0.78rem; cursor:pointer; transition:all 0.2s; }
.rest-timer-btn:hover { border-color:var(--orange); color:var(--orange); }
.rest-timer-btn.running { border-color:var(--orange); color:var(--orange); animation:pulse 1s infinite; }
.sets-table { width:100%; border-collapse:collapse; }
.sets-table col:nth-child(1) { width:55px; }
.sets-table col:nth-child(2) { width:auto; }
.sets-table col:nth-child(3) { width:auto; }
.sets-table col:nth-child(4) { width:44px; }
.sets-table col:nth-child(5) { width:36px; }
.sets-table th { font-size:0.6rem; font-weight:700; letter-spacing:2px; text-transform:uppercase; color:var(--dim); padding:0 8px 10px; text-align:center; white-space:nowrap; }
.sets-table th:first-child { text-align:left; }
.sets-table td { padding:6px 8px; text-align:center; border-top:1px solid var(--border); vertical-align:middle; }
.sets-table tr:first-child td { border-top:none; }
.set-input { width:64px; padding:8px 6px; background:var(--dark); border:1px solid var(--border); border-radius:8px; font-family:'DM Mono',monospace; font-size:0.9rem; color:var(--white); text-align:center; outline:none; transition:border-color 0.2s; }
.set-input:focus { border-color:var(--green); }
.set-num { font-family:'DM Mono',monospace; font-size:0.82rem; color:var(--dim); }
.set-done-btn { width:32px; height:32px; border-radius:8px; border:1.5px solid var(--border2); background:none; color:var(--dim); cursor:pointer; font-size:0.8rem; transition:all 0.2s; }
.set-done-btn:hover { border-color:var(--green); color:var(--green); }
.set-done-btn.done { background:var(--green); border-color:var(--green); color:var(--black); }
.set-del-btn { width:28px; height:28px; border-radius:6px; border:1px solid transparent; background:none; color:var(--dim); cursor:pointer; font-size:0.7rem; transition:all 0.2s; opacity:0.5; }
.set-del-btn:hover { opacity:1; border-color:var(--red); color:var(--red); background:rgba(244,63,94,0.1); }
/* Hide the prev-data row under inputs for horizontal simplicity */
.set-cell-weight, .set-cell-reps { text-align:center; }
.set-cell-weight .set-prev, .set-cell-reps .set-prev { font-family:'DM Mono',monospace; font-size:0.62rem; color:var(--dim); margin-top:2px; display:block; }
.set-cell-weight .set-prev.has-data, .set-cell-reps .set-prev.has-data { color:var(--blue); }

/* Rest timer overlay */
.rest-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.85); backdrop-filter:blur(8px); z-index:800; display:none; align-items:center; justify-content:center; }
.rest-overlay.open { display:flex; }
.rest-card { background:var(--card); border:1px solid var(--border2); border-radius:24px; padding:48px 60px; text-align:center; }
.rest-label { font-size:0.72rem; font-weight:700; letter-spacing:3px; text-transform:uppercase; color:var(--dim); margin-bottom:12px; }
.rest-countdown { font-family:'Bebas Neue',sans-serif; font-size:6rem; letter-spacing:2px; color:var(--green); line-height:1; margin-bottom:8px; }
.rest-sub { font-size:0.82rem; color:var(--dim); margin-bottom:28px; }
.btn-skip-rest { padding:12px 32px; border:1px solid var(--border); border-radius:10px; background:none; color:var(--off); font-family:'Syne',sans-serif; font-size:0.88rem; cursor:pointer; transition:all 0.2s; }
.btn-skip-rest:hover { border-color:var(--green); color:var(--green); }

/* Nav buttons in workout */
.wo-nav-btns { display:flex; gap:10px; margin-top:4px; padding-bottom: env(safe-area-inset-bottom, 0px); }
.btn-prev-ex, .btn-next-ex { flex:1; padding:13px; border:1px solid var(--border2); border-radius:11px; background:var(--card); color:var(--white); font-family:'Bebas Neue',sans-serif; font-size:1rem; letter-spacing:1.5px; cursor:pointer; transition:all 0.2s; }
.btn-prev-ex.hidden { display:none !important; flex:0 !important; width:0 !important; min-width:0 !important; padding:0 !important; border:none !important; overflow:hidden !important; }
.btn-prev-ex:hover { border-color:var(--border2); }
.btn-next-ex { background:var(--green); color:var(--black); border-color:var(--green); }
.btn-next-ex:hover { opacity:0.9; }
.btn-finish-workout { width:100%; padding:16px; padding-bottom: max(16px, env(safe-area-inset-bottom)); background:var(--green); color:var(--black); border:none; border-radius:0; font-family:'Bebas Neue',sans-serif; font-size:1.2rem; letter-spacing:2px; cursor:pointer; transition:all 0.2s; display:none; flex-shrink:0; }
.btn-finish-workout:hover { opacity:0.9; transform:translateY(-1px); }

/* Workout Left Panel */
.wo-left-panel { width:220px; flex-shrink:0; background:var(--dark); border-right:1px solid var(--border); display:flex; flex-direction:column; overflow:hidden; }
.wo-left-header { padding:14px 16px; border-bottom:1px solid var(--border); flex-shrink:0; }
.wo-left-title { font-family:'Bebas Neue',sans-serif; font-size:1.05rem; letter-spacing:1px; color:var(--white); }
.wo-left-sub { font-size:0.72rem; color:var(--dim); margin-top:2px; font-family:'Inter',sans-serif; }
.wo-ex-sidebar { flex:1; overflow-y:auto; padding:8px; }
.wo-ex-sidebar-item { display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:10px; cursor:pointer; transition:all 0.15s; border:1px solid transparent; margin-bottom:4px; }
.wo-ex-sidebar-item:hover { background:rgba(255,255,255,0.04); }
.wo-ex-sidebar-item.active { background:var(--green-dim); border-color:rgba(74,222,128,0.2); }
.wo-ex-sidebar-num { font-family:'DM Mono',monospace; font-size:0.68rem; color:var(--dim); width:18px; flex-shrink:0; }
.wo-ex-sidebar-item.active .wo-ex-sidebar-num { color:var(--green); }
.wo-ex-sidebar-info { flex:1; min-width:0; }
.wo-ex-sidebar-name { font-size:0.82rem; font-weight:600; color:var(--off); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.wo-ex-sidebar-item.active .wo-ex-sidebar-name { color:var(--white); }
.wo-ex-sidebar-sets { font-family:'DM Mono',monospace; font-size:0.65rem; color:var(--dim); margin-top:2px; }
.wo-ex-sidebar-done { width:16px; height:16px; border-radius:50%; background:var(--green); display:flex; align-items:center; justify-content:center; font-size:0.55rem; color:var(--black); flex-shrink:0; }
.wo-ex-del { width:22px; height:22px; border-radius:5px; border:1px solid transparent; background:none; color:var(--dim); cursor:pointer; font-size:0.65rem; opacity:0; transition:all 0.15s; flex-shrink:0; }
.wo-ex-sidebar-item:hover .wo-ex-del { opacity:1; border-color:var(--border); }
.wo-ex-del:hover { background:rgba(239,68,68,0.1); border-color:rgba(239,68,68,0.3); color:#ef4444; }
.wo-ex-header { padding:16px 20px 12px; border-bottom:1px solid var(--border); }
.ex-video-title { font-family:'Bebas Neue',sans-serif; font-size:1.6rem; letter-spacing:1px; color:var(--white); line-height:1; }

/* Sets table with add/delete */
.sets-table th { font-family:'DM Mono',monospace; font-size:0.68rem; color:var(--dim); text-transform:uppercase; letter-spacing:1px; padding:8px 10px; text-align:left; }
.sets-table td { padding:8px 10px; }
.set-prev { font-family:'DM Mono',monospace; font-size:0.72rem; color:var(--dim); }
.set-weight-input { width:75px; padding:7px 10px; background:var(--dark); border:1px solid var(--border); border-radius:7px; font-family:'DM Mono',monospace; font-size:0.9rem; color:var(--white); outline:none; text-align:center; transition:border-color 0.2s; }
.set-weight-input:focus { border-color:var(--green); }
.set-reps-input { width:55px; padding:7px 10px; background:var(--dark); border:1px solid var(--border); border-radius:7px; font-family:'DM Mono',monospace; font-size:0.9rem; color:var(--white); outline:none; text-align:center; transition:border-color 0.2s; }
.set-reps-input:focus { border-color:var(--green); }
.set-check { width:28px; height:28px; border-radius:7px; border:1px solid var(--border); background:none; color:var(--dim); cursor:pointer; font-size:0.9rem; transition:all 0.2s; }
.set-check.done { background:var(--green); border-color:var(--green); color:var(--black); }
.set-weight-input.done, .set-reps-input.done { background:rgba(74,222,128,0.08) !important; border-color:rgba(74,222,128,0.25) !important; color:var(--green) !important; opacity:1 !important; }
.set-del { width:24px; height:24px; border-radius:5px; border:1px solid transparent; background:none; color:var(--dim); cursor:pointer; font-size:0.65rem; transition:all 0.15s; }
.set-del:hover { background:rgba(239,68,68,0.1); border-color:rgba(239,68,68,0.3); color:#ef4444; }

/* Weight log history */
.weight-log-card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:20px; margin-bottom:14px; }

/* Meal cat no-emoji fix */
.meal-cat-name { font-family:'Bebas Neue',sans-serif; font-size:1rem; letter-spacing:1px; color:var(--white); }
.meal-cat-cals { font-size:0.78rem; color:var(--dim); margin-top:2px; font-family:'Inter',sans-serif; }

/* Meal Categories (MFP-style) */
.meal-cat-card { background:var(--card); border:1px solid var(--border); border-radius:16px; overflow:hidden; margin-bottom:12px; }
.meal-cat-header { display:flex; align-items:center; justify-content:space-between; padding:14px 18px; cursor:pointer; }
.meal-cat-header:hover { background:rgba(255,255,255,0.02); }
.meal-cat-left { display:flex; align-items:center; gap:10px; }
.meal-cat-icon { font-size:1.1rem; }
.meal-cat-name { font-family:'Bebas Neue',sans-serif; font-size:1rem; letter-spacing:1px; }
.meal-cat-cals { font-family:'DM Mono',monospace; font-size:0.72rem; color:var(--dim); }
.meal-cat-add { display:flex; align-items:center; gap:8px; }
.btn-cat-add { display:flex; align-items:center; gap:5px; padding:7px 13px; background:var(--green-dim); border:1px solid rgba(74,222,128,0.2); border-radius:8px; color:var(--green); font-family:'Bebas Neue',sans-serif; font-size:0.78rem; letter-spacing:1px; cursor:pointer; white-space:nowrap; transition:all 0.2s; }
.btn-cat-add:hover { background:rgba(74,222,128,0.2); }
.btn-cat-scan { display:flex; align-items:center; gap:5px; padding:7px 13px; background:rgba(99,102,241,0.1); border:1px solid rgba(99,102,241,0.2); border-radius:8px; color:#818cf8; font-family:'Bebas Neue',sans-serif; font-size:0.78rem; letter-spacing:1px; cursor:pointer; white-space:nowrap; transition:all 0.2s; }
.btn-cat-scan:hover { background:rgba(99,102,241,0.2); }
.meal-cat-entries { border-top:1px solid var(--border); }
.meal-entry-row { display:grid; grid-template-columns:1fr auto auto; align-items:center; gap:10px; padding:10px 18px; border-bottom:1px solid rgba(255,255,255,0.04); }
.meal-entry-row:last-child { border-bottom:none; }
.mer-name { font-size:0.83rem; font-weight:600; color:var(--off); }
.mer-macros { font-size:0.7rem; color:var(--dim); margin-top:2px; }
.mer-cal { font-family:'Bebas Neue',sans-serif; font-size:0.95rem; color:var(--green); }
.mer-del { width:24px; height:24px; border-radius:6px; border:1px solid var(--border); background:none; color:var(--dim); cursor:pointer; font-size:0.7rem; display:flex; align-items:center; justify-content:center; transition:all 0.2s; }
.mer-del:hover { background:rgba(239,68,68,0.1); border-color:rgba(239,68,68,0.3); color:#ef4444; }
.meal-cat-total { display:flex; justify-content:flex-end; gap:16px; padding:8px 18px; background:rgba(255,255,255,0.02); border-top:1px solid var(--border); font-family:'DM Mono',monospace; font-size:0.7rem; color:var(--dim); }

/* Food Search Modal */
.food-modal { position:fixed; inset:0; background:rgba(0,0,0,0.9); backdrop-filter:blur(8px); z-index:900; display:none; flex-direction:column; }
.food-modal.open { display:flex; }
.food-modal-header { display:flex; align-items:center; gap:12px; padding:16px 20px; border-bottom:1px solid var(--border); background:var(--dark); flex-shrink:0; }
.food-modal-title { font-family:'Bebas Neue',sans-serif; font-size:1.1rem; letter-spacing:1px; flex:1; }
.food-modal-close { width:32px; height:32px; border-radius:8px; border:1px solid var(--border); background:none; color:var(--dim); cursor:pointer; font-size:1rem; display:flex; align-items:center; justify-content:center; }
.food-modal-search-row { display:flex; gap:8px; padding:14px 20px; border-bottom:1px solid var(--border); background:var(--dark); flex-shrink:0; }
.food-modal-input { flex:1; padding:10px 14px; background:var(--card); border:1px solid var(--border); border-radius:10px; font-family:'Syne',sans-serif; font-size:0.88rem; color:var(--white); outline:none; }
.food-modal-input:focus { border-color:var(--green); }
.food-modal-input::placeholder { color:var(--dim); }
.btn-food-modal-search { padding:10px 16px; background:var(--green-dim); border:1px solid rgba(74,222,128,0.25); border-radius:10px; color:var(--green); font-family:'Bebas Neue',sans-serif; font-size:0.88rem; letter-spacing:1.5px; cursor:pointer; white-space:nowrap; }
.btn-food-modal-scan { padding:10px 14px; background:rgba(99,102,241,0.1); border:1px solid rgba(99,102,241,0.2); border-radius:10px; color:#818cf8; font-size:1rem; cursor:pointer; }
.food-modal-tabs { display:flex; border-bottom:1px solid var(--border); background:var(--dark); flex-shrink:0; }
.fmt-tab { flex:1; padding:10px; text-align:center; font-family:'DM Mono',monospace; font-size:0.72rem; color:var(--dim); cursor:pointer; border-bottom:2px solid transparent; transition:all 0.2s; }
.fmt-tab.active { color:var(--green); border-bottom-color:var(--green); }
.food-modal-results { flex:1; overflow-y:auto; background:var(--black); }
.food-modal-empty { padding:40px 20px; text-align:center; color:var(--dim); font-size:0.83rem; }
.food-modal-loading { padding:40px 20px; text-align:center; color:var(--dim); }
.food-modal-item { display:grid; grid-template-columns:1fr auto; align-items:center; gap:12px; padding:13px 20px; border-bottom:1px solid rgba(255,255,255,0.04); cursor:pointer; transition:background 0.15s; }
.food-modal-item:hover { background:rgba(255,255,255,0.03); }
.fmi-name { font-size:0.85rem; font-weight:600; color:var(--off); }
.fmi-brand { font-size:0.7rem; color:var(--dim); margin-top:1px; }
.fmi-macros { font-size:0.7rem; color:var(--dim); margin-top:2px; }
.fmi-cal { font-family:'Bebas Neue',sans-serif; font-size:1rem; color:var(--green); }
.fmi-add { width:30px; height:30px; border-radius:8px; background:var(--green-dim); border:1px solid rgba(74,222,128,0.2); color:var(--green); font-size:1.1rem; cursor:pointer; display:flex; align-items:center; justify-content:center; }
.fmi-add:hover { background:var(--green); color:var(--black); }
.recent-foods-section { padding:14px 20px 8px; }
.rfs-label { font-family:'DM Mono',monospace; font-size:0.68rem; color:var(--dim); letter-spacing:1px; text-transform:uppercase; margin-bottom:10px; }

/* Water Tracking */
.water-section { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:20px 22px; margin-bottom:14px; }
.water-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
.water-title { font-family:'Bebas Neue',sans-serif; font-size:1.1rem; letter-spacing:1px; }
.water-goal-label { font-family:'DM Mono',monospace; font-size:0.72rem; color:var(--dim); }
.water-ring-wrap { display:flex; align-items:center; gap:24px; margin-bottom:16px; }
.water-ring { position:relative; width:100px; height:100px; flex-shrink:0; }
.water-ring svg { transform:rotate(-90deg); }
.water-ring-track { fill:none; stroke:var(--border2); stroke-width:8; }
.water-ring-fill { fill:none; stroke:#38bdf8; stroke-width:8; stroke-linecap:round; transition:stroke-dashoffset 0.4s ease; }
.water-ring-text { position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; }
.water-oz { font-family:'Bebas Neue',sans-serif; font-size:1.6rem; color:#38bdf8; line-height:1; }
.water-oz-label { font-family:'DM Mono',monospace; font-size:0.62rem; color:var(--dim); }
.water-btns { display:flex; gap:8px; flex-wrap:wrap; }
.water-add-btn { padding:9px 16px; border-radius:9px; border:1px solid rgba(56,189,248,0.25); background:rgba(56,189,248,0.08); color:#38bdf8; font-family:'Bebas Neue',sans-serif; font-size:0.9rem; letter-spacing:1.5px; cursor:pointer; transition:all 0.2s; }
.water-add-btn:hover { background:rgba(56,189,248,0.18); }
.water-add-btn.undo { border-color:var(--border); background:none; color:var(--dim); font-size:0.75rem; letter-spacing:1px; }
.water-cups { display:flex; gap:3px; margin-top:12px; }
.water-cup { width:100%; height:10px; border-radius:4px; transition:background 0.3s, opacity 0.3s; }
.water-cup.filled { background:#38bdf8; opacity:1; }
.water-cup.empty { background:var(--border2); opacity:0.4; }

/* Food Search */
.food-search-wrap { background:var(--card); border:1px solid var(--border); border-radius:16px; overflow:hidden; margin-bottom:14px; }
.food-search-header { padding:16px 20px; border-bottom:1px solid var(--border); }
.food-search-title { font-family:'Bebas Neue',sans-serif; font-size:1.1rem; letter-spacing:1px; margin-bottom:10px; }
.food-search-row { display:flex; gap:8px; }
.food-search-input { flex:1; padding:10px 14px; background:var(--dark); border:1px solid var(--border); border-radius:10px; font-family:'Syne',sans-serif; font-size:0.88rem; color:var(--white); outline:none; }
.food-search-input:focus { border-color:#38bdf8; }
.food-search-input::placeholder { color:var(--dim); }
.btn-food-search { padding:10px 18px; background:var(--green-dim); border:1px solid rgba(74,222,128,0.25); border-radius:10px; color:var(--green); font-family:'Bebas Neue',sans-serif; font-size:0.9rem; letter-spacing:1.5px; cursor:pointer; white-space:nowrap; transition:all 0.2s; }
.btn-food-search:hover { background:rgba(74,222,128,0.2); }
.food-results { max-height:320px; overflow-y:auto; }
.food-result-item { display:grid; grid-template-columns:10px 1fr auto; align-items:center; gap:10px; padding:12px 20px; border-bottom:1px solid var(--border); transition:background 0.15s; cursor:pointer; }
.food-result-item:hover { background:rgba(255,255,255,0.03); }
.food-result-item:last-child { border-bottom:none; }
.fri-name { font-size:0.85rem; font-weight:600; color:var(--off); }
.fri-meta { font-size:0.72rem; color:var(--dim); margin-top:2px; }
.fri-cal { font-family:'Bebas Neue',sans-serif; font-size:1rem; color:var(--green); white-space:nowrap; }
.btn-log-food { padding:7px 12px; background:var(--green-dim); border:1px solid rgba(74,222,128,0.2); border-radius:8px; color:var(--green); font-family:'Bebas Neue',sans-serif; font-size:0.8rem; letter-spacing:1px; cursor:pointer; white-space:nowrap; }
.btn-log-food:hover { background:rgba(74,222,128,0.2); }
.food-search-empty { padding:24px; text-align:center; color:var(--dim); font-size:0.83rem; }
.food-search-loading { padding:24px; text-align:center; color:var(--dim); font-size:0.83rem; }

/* Serving modal */
.serving-modal { position:fixed; inset:0; background:rgba(0,0,0,0.85); backdrop-filter:blur(8px); z-index:900; display:none; align-items:center; justify-content:center; padding:20px; }
.serving-modal.open { display:flex; }
.serving-card { background:var(--dark); border:1px solid var(--border2); border-radius:20px; padding:28px; width:100%; max-width:380px; }
.serving-food-name { font-family:'Bebas Neue',sans-serif; font-size:1.4rem; letter-spacing:1px; margin-bottom:4px; }
.serving-macro-row { display:flex; gap:12px; margin:14px 0; }
.sm-chip { flex:1; text-align:center; padding:10px 6px; background:var(--card); border-radius:10px; border:1px solid var(--border); }
.sm-val { font-family:'Bebas Neue',sans-serif; font-size:1.2rem; }
.sm-label { font-size:0.62rem; color:var(--dim); letter-spacing:1px; text-transform:uppercase; }
.serving-size-row { display:flex; align-items:center; gap:10px; margin-bottom:16px; }
.serving-size-row label { font-size:0.8rem; color:var(--off); white-space:nowrap; }
.serving-size-input { flex:1; padding:9px 12px; background:var(--card); border:1px solid var(--border); border-radius:9px; font-family:'Syne',sans-serif; font-size:0.88rem; color:var(--white); outline:none; text-align:center; }
.serving-size-input:focus { border-color:var(--green); }
.serving-actions { display:flex; gap:10px; }
.btn-cancel-serving { flex:1; padding:12px; border:1px solid var(--border); border-radius:10px; background:none; color:var(--dim); font-family:'Syne',sans-serif; font-size:0.85rem; cursor:pointer; }
.btn-confirm-log { flex:2; padding:12px; background:var(--green); border:none; border-radius:10px; color:var(--black); font-family:'Bebas Neue',sans-serif; font-size:1rem; letter-spacing:2px; cursor:pointer; }

/* Settings */
.settings-input { width:100%; padding:10px 13px; background:var(--dark); border:1px solid var(--border); border-radius:9px; font-family:'Syne',sans-serif; font-size:0.87rem; color:var(--white); outline:none; }
.settings-input[readonly] { color:var(--dim); cursor:default; }

@media (max-width:768px) {
  /* Global */
  html, body { overflow-x:hidden !important; max-width:100vw !important; }
  .screen { max-width:100vw; overflow-x:hidden; }

  /* Nav */
  nav { padding:12px 16px; max-width:100vw; }
  .logo { font-size:1.5rem; }
  .nav-pill { display:none; }
  .nav-cta { padding:8px 14px; font-size:0.82rem; white-space:nowrap; }

  /* Onboarding hero */
  #screen-onboard .hero { padding:28px 16px 20px; max-width:100vw; }
  #ob-headline { font-size:clamp(2.4rem,11vw,3.5rem); }
  .line-accent { display:inline; }
  .hero-sub { font-size:0.88rem; max-width:100%; }
  .tier-selector { flex-direction:column; gap:8px; }
  .tier-btn { min-width:unset; width:100%; }

  /* Form */
  .main-layout { grid-template-columns:1fr; padding:0 16px 40px; gap:16px; max-width:100vw; }
  .form-card { padding:20px 16px; max-width:100%; }
  .form-row { grid-template-columns:1fr; gap:10px; }
  .split-selector { grid-template-columns:1fr 1fr; }
  .timeline-selector { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
  .tl-btn { padding:12px 8px; font-size:0.78rem; text-align:center; }
  .day-picker { gap:5px; flex-wrap:wrap; }
  .day-pill { padding:9px 10px; font-size:0.75rem; }
  .sidebar-info { display:none; }

  /* Results */
  #results-section { padding:0 16px 40px; max-width:100vw; overflow-x:hidden; }
  .results-banner { flex-direction:column; gap:10px; align-items:flex-start; }
  .results-banner h2 { font-size:1.5rem; }
  .results-tier-badge { font-size:0.8rem; }
  .results-grid { grid-template-columns:1fr; gap:12px; }
  .r-card { padding:18px 16px; max-width:100%; }
  .r-card h3 { font-size:1.1rem; }
  .r-card p, .r-card li { font-size:0.82rem; }
  .week-card { padding:18px 16px; }
  .week-card h3 { font-size:1rem; }
  .day-row { grid-template-columns:60px 1fr; gap:8px; }
  .day-name { font-size:0.68rem; }
  .day-workout { font-size:0.78rem; }
  .day-tag { display:none; }
  .cta-into-app { padding:28px 16px; }
  .cta-into-app h3 { font-size:1.6rem; }
  .cta-into-app p { font-size:0.82rem; }
  .btn-enter-app { padding:14px 24px; font-size:0.95rem; width:100%; justify-content:center; }

  /* Signup */
  .signup-wrap { grid-template-columns:1fr; padding:20px 16px 60px; gap:20px; max-width:100vw; }
  .signup-card { position:static; padding:22px 16px; }
  .signup-left h2 { font-size:2.2rem; }
  .ps-stats { grid-template-columns:1fr 1fr; }
  .sf-row { grid-template-columns:1fr; gap:10px; margin-bottom:0; }

  /* Dashboard shell */
  #screen-dash.active { display:flex !important; flex-direction:column; }
  .sidebar-nav { width:100%; flex-direction:row; padding:6px 8px; border-right:none; border-bottom:1px solid var(--border); overflow-x:auto; gap:2px; flex-wrap:nowrap; -webkit-overflow-scrolling:touch; }
  .sb-label { display:none; }
  .sb-btn { flex-shrink:0; padding:8px 10px; font-size:0.7rem; justify-content:center; border-radius:8px; white-space:nowrap; }
  .sb-btn .sb-icon { display:none; }
  .sb-badge { display:none; }

  /* Today */
  .today-grid { grid-template-columns:1fr 1fr; gap:10px; }
  .sc-val { font-size:1.7rem; }
  .sc-sub { font-size:0.72rem; }
  .workout-card { padding:14px; }
  .wc-header { flex-direction:column; gap:10px; align-items:flex-start; }
  .wc-name { font-size:1.1rem; }
  .btn-primary { width:100%; text-align:center; padding:12px; }
  .ex-row { grid-template-columns:30px 1fr; gap:8px; }
  .ex-row > .ex-detail { display:none; } /* hide standalone muscles column on mobile */

  /* Week */
  .week-stat-grid { grid-template-columns:1fr 1fr; gap:10px; }
  .week-stat-grid .stat-card:last-child { grid-column:1/-1; }
  .week-day-grid { grid-template-columns:repeat(4,1fr); gap:6px; }
  .wday { padding:10px 4px; }
  .wday-icon { font-size:1rem; }
  .wday-label { font-size:0.76rem; }
  .wday-name { font-size:0.66rem; }

  /* Nutrition */
  .macro-bar { grid-template-columns:1fr 1fr; gap:12px; padding:16px; }
  .mb-val { font-size:1.5rem; }
  .mb-label { font-size:0.55rem; }
  .lf-macros { grid-template-columns:1fr 1fr; }
  .meal-row { grid-template-columns:1fr auto auto; gap:8px; padding:12px; }
  .mr-name { font-size:0.82rem; }

  /* Progress */
  .progress-grid { grid-template-columns:1fr; }
  .prog-card.wide { grid-column:1; }
  .weight-big { font-size:2.8rem; }
  .stat-boxes { grid-template-columns:1fr 1fr; }

  /* Program */
  .page-title { font-size:1.5rem; }
  .page-sub { font-size:0.8rem; }

  /* Log forms */
  .log-toggle-header { padding:14px 16px; }
  .log-form { padding:0 14px 14px; }

  /* Settings */
  .settings-grid { grid-template-columns:1fr !important; }

  /* Workout env */
  #screen-workout.active { position:fixed !important; top:0; left:0; right:0; bottom:0; height:100vh !important; height:100dvh !important; overflow:hidden !important; display:flex !important; flex-direction:column !important; }
  .wo-header { padding:max(10px,env(safe-area-inset-top)) 14px 10px; flex-wrap:wrap; gap:8px; }
  .wo-title { font-size:1rem; width:100%; order:-1; }
  .wo-progress-wrap { flex:1; }
  .wo-back { padding:6px 12px; font-size:0.78rem; }
  .wo-body { flex-direction:column; overflow:hidden; flex:1; }
  .wo-left-panel { display:none !important; }
  .wo-main { width:100%; padding:0; overflow-y:auto; overflow-x:hidden; -webkit-overflow-scrolling:touch; flex:1; min-height:0; gap:0; display:block; }
  .ex-demo-wrap { display:none !important; }
  .ex-video-header { padding:16px 16px 8px; }
  .ex-video-title { font-size:1.5rem; }
  .sets-panel { margin:0 12px 12px; border-radius:12px; padding:14px; overflow:visible; }
  .sets-table { width:100%; }
  .sets-table th { font-size:0.62rem; padding:6px 2px; color:var(--off); text-align:center; }
  .sets-table th:first-child { text-align:left; }
  .sets-table td { padding:8px 2px; text-align:center; vertical-align:top; }
  .set-weight-input { width:72px !important; font-size:1rem !important; padding:10px 4px !important; height:44px; text-align:center; }
  .set-reps-input { width:60px !important; font-size:1rem !important; padding:10px 4px !important; height:44px; text-align:center; }
  .set-check { width:40px !important; height:40px !important; font-size:1.1rem !important; }
  .wo-nav-btns { flex-direction:column; gap:8px; padding:10px 14px calc(10px + env(safe-area-inset-bottom, 0px)); flex-shrink:0 !important; background:var(--dark); border-top:1px solid var(--border); z-index:10; }
  #wo-next-btn { width:100%; padding:16px; font-size:1rem; font-family:'Bebas Neue',sans-serif; letter-spacing:1.5px; border-radius:12px; border:none; background:var(--green); color:var(--black); cursor:pointer; }
  #wo-finish-btn { width:100%; padding:14px; font-size:0.9rem; }
  .rest-timer-btn { width:100%; padding:12px; font-size:0.88rem; border-radius:10px; }
  .wo-header { padding:max(10px,env(safe-area-inset-top)) 14px 10px; gap:6px; }
  .wo-title { font-size:0.85rem; flex:1; }
  .wo-back { padding:7px 12px; font-size:0.78rem; }
  .ex-video-header { padding:12px 14px 10px; flex-direction:column; gap:6px; align-items:flex-start; }
  .ex-video-title { font-size:1.2rem; }
  .ex-video-embed { padding:12px; }
  .ex-video-thumb { max-width:100%; }
  .btn-watch-demo { font-size:0.82rem; padding:10px 16px; width:100%; justify-content:center; }
  .sets-panel { padding:14px; overflow:visible; }
  .sets-header { flex-direction:row; gap:8px; align-items:center; justify-content:space-between; }
  .sets-table { font-size:0.85rem; }
  .sets-table th, .sets-table td { padding:6px 3px; }
  .wo-nav-btns { flex-direction:column; gap:8px; }
  .rest-timer-btn { font-size:0.82rem; padding:8px 12px; }
  .rest-card { padding:28px 20px; width:90vw; }
  .rest-countdown { font-size:4rem; }
}

/* ── MOBILE BOTTOM TAB BAR ── */
.mobile-tab-bar {
  display: none; /* hidden on desktop */
}
.mob-more-drawer {
  display: none;
}

@media (max-width: 768px) {
  /* Hide sidebar on mobile */
  .sidebar-nav { display: none !important; }
  
  /* Shell fills screen */
  .shell { 
    flex-direction: column; 
    height: calc(100vh - 60px); 
    overflow: hidden;
    display: flex;
  }
  .main-content { 
    flex: 1;
    min-height: 0;
    padding: 14px 14px 100px;
    width: 100%;
    box-sizing: border-box;
    overflow-x: hidden;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }

  /* Bottom tab bar - fixed to bottom of viewport */
  .mobile-tab-bar {
    display: flex !important;
    position: fixed !important;
    top: auto !important;
    bottom: 0 !important;
    left: 0 !important;
    right: 0 !important;
    width: 100% !important;
    height: 60px !important;
    padding-bottom: env(safe-area-inset-bottom, 6px);
    background: #111 !important;
    border-top: 1px solid rgba(255,255,255,0.1) !important;
    z-index: 9999 !important;
    align-items: stretch;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.5);
    transform: none !important;
  }
  /* Ensure screen-dash doesn't clip the fixed tab bar */
  #screen-dash { overflow: visible !important; }
  #screen-dash.active { overflow: visible !important; }
  .mob-tab {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 3px;
    background: none;
    border: none;
    color: rgba(255,255,255,0.68);
    cursor: pointer;
    transition: color 0.15s;
    padding: 6px 2px;
    -webkit-tap-highlight-color: transparent;
  }
  .mob-tab.active { color: var(--green); }
  .mob-tab-svg {
    width: 20px;
    height: 20px;
    flex-shrink: 0;
  }
  .mob-tab-label {
    font-family: 'Inter', sans-serif;
    font-size: 0.56rem;
    font-weight: 600;
    letter-spacing: 0.2px;
    white-space: nowrap;
  }

  /* More drawer */
  .mob-more-drawer {
    display: block;
    position: fixed;
    bottom: 60px;
    left: 0;
    right: 0;
    background: #161616;
    border-top: 1px solid var(--border);
    border-radius: 20px 20px 0 0;
    z-index: 999;
    transform: translateY(110%);
    transition: transform 0.28s cubic-bezier(0.4,0,0.2,1);
    padding-bottom: env(safe-area-inset-bottom, 0px);
  }
  .mob-more-drawer.open { transform: translateY(0); }
  .mob-more-handle {
    width: 36px; height: 4px;
    background: var(--border);
    border-radius: 2px;
    margin: 10px auto 6px;
  }
  .mob-more-item {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 16px 24px;
    font-family: 'Inter', sans-serif;
    font-size: 0.95rem;
    color: var(--white);
    cursor: pointer;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    -webkit-tap-highlight-color: transparent;
  }
  .mob-more-item:last-child { border-bottom: none; }
  .mob-more-item:active { background: rgba(255,255,255,0.04); }
}

/* Form readability */
/* Fullscreen mode for custom builder modal */
#unplanned-modal.fullscreen-builder {
  align-items: stretch !important;
  justify-content: stretch !important;
}
#unplanned-modal.fullscreen-builder #unplanned-modal-inner {
  max-height: none !important;
  height: 100% !important;
  max-width: none !important;
  border-radius: 0 !important;
  padding-top: max(env(safe-area-inset-top, 16px), 16px) !important;
  padding-bottom: max(env(safe-area-inset-bottom, 20px), 20px) !important;
  display: flex !important;
  flex-direction: column !important;
  overflow: hidden !important;
}
#unplanned-modal.fullscreen-builder #custom-builder {
  flex: 1 !important;
  min-height: 0 !important;
  display: flex !important;
  flex-direction: column !important;
  overflow: hidden !important;
}
#unplanned-modal.fullscreen-builder #custom-ex-list {
  flex: 1 !important;
  max-height: none !important;
  overflow-y: auto !important;
  -webkit-overflow-scrolling: touch !important;
  min-height: 0 !important;
}
.form-label { color: var(--off) !important; font-size: 0.72rem !important; }
.form-card h3, .form-card .section-title { color: var(--white) !important; }
input[type="text"], input[type="number"], select, textarea {
  color: var(--white) !important;
  background: var(--card) !important;
}
input::placeholder { color: var(--dim) !important; }
.tl-btn { color: var(--off) !important; }
.split-btn { color: var(--off) !important; }
.day-pill { color: var(--off) !important; }
.tier-desc { color: var(--off) !important; }
.tier-name { color: var(--white) !important; }
.tier-tag { color: var(--off) !important; }


/* Form label brightness fixes */
.form-group label, .form-group > label { color: var(--off) !important; font-size: 0.72rem; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 6px; display: block; }
.form-section-label, .sf-label { color: var(--off) !important; }
.tl-btn, .split-btn, .day-pill { color: var(--off) !important; font-size: 0.85rem !important; }
.form-card p, .form-card span:not(.tier-badge) { color: var(--off) !important; }

/* ── AI COACH ── */
.coach-chat-container { display:flex; flex-direction:column; flex:1; min-height:0; background:var(--dark); border:1px solid var(--border); border-radius:14px; overflow:hidden; }
.coach-messages { flex:1; overflow-y:auto; padding:16px; display:flex; flex-direction:column; gap:10px; -webkit-overflow-scrolling:touch; min-height:0; }
.coach-starters { display:flex; flex-direction:column; align-items:center; justify-content:center; flex:1; gap:20px; padding:20px 0; }
.coach-welcome { text-align:center; }
.coach-welcome-icon { margin-bottom:12px; }
.coach-welcome-title { font-family:'Bebas Neue',sans-serif; font-size:1.4rem; letter-spacing:2px; color:var(--white); margin-bottom:6px; }
.coach-welcome-sub { font-size:0.82rem; color:var(--dim); }
.coach-starter-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; max-width:480px; width:100%; }
.coach-starter-btn { background:var(--card); border:1px solid var(--border2); border-radius:14px; padding:14px 16px; color:var(--off); font-size:0.8rem; text-align:left; cursor:pointer; transition:all 0.2s; line-height:1.4; }
.coach-starter-btn:hover { border-color:var(--green); color:var(--green); background:var(--green-dim); }
.coach-starter-btn:active { transform:scale(0.97); }
.coach-bubble { max-width:85%; padding:12px 16px; border-radius:18px; font-size:0.84rem; line-height:1.55; word-wrap:break-word; white-space:pre-wrap; }
.coach-bubble.user { align-self:flex-end; background:linear-gradient(135deg, #4ADE80, #22c55e); color:#0a0a0a; border-bottom-right-radius:4px; font-weight:500; }
.coach-bubble.assistant { align-self:flex-start; background:var(--card); color:var(--off); border:1px solid var(--border); border-bottom-left-radius:4px; }
.coach-bubble.assistant strong { color:var(--white); }
.coach-typing { align-self:flex-start; padding:12px 16px; background:var(--card); border:1px solid var(--border); border-radius:14px; border-bottom-left-radius:4px; display:flex; gap:4px; align-items:center; }
.coach-typing-dot { width:6px; height:6px; border-radius:50%; background:var(--dim); animation:pulse 1.2s ease-in-out infinite; }
.coach-typing-dot:nth-child(2) { animation-delay:0.2s; }
.coach-typing-dot:nth-child(3) { animation-delay:0.4s; }
.coach-input-bar { display:flex; align-items:center; gap:8px; padding:10px 12px; border-top:1px solid var(--border); background:#0d0d0d; flex-shrink:0; }
.coach-text-input { flex:1; background:var(--card); border:1px solid var(--border2); border-radius:22px; padding:11px 16px; color:var(--white); font-size:0.84rem; outline:none; font-family:inherit; }
.coach-text-input:focus { border-color:var(--green); box-shadow:0 0 0 1px rgba(74,222,128,0.15); }
.coach-text-input::placeholder { color:var(--dim); }
.coach-send-btn { width:40px; height:40px; border-radius:50%; border:none; background:var(--green); color:var(--black); cursor:pointer; display:flex; align-items:center; justify-content:center; transition:opacity 0.2s; flex-shrink:0; }
.coach-send-btn:hover { opacity:0.85; }
.coach-send-btn:disabled { opacity:0.3; cursor:not-allowed; }
@media(max-width:600px) {
  .coach-chat-container { flex:1; min-height:0; border-radius:0; border-left:none; border-right:none; }
  .coach-starter-grid { grid-template-columns:1fr; }
  .coach-bubble { max-width:90%; }
}

</style>
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    // Inline service worker for offline caching
    const swCode = `
self.addEventListener('install', e => self.skipWaiting());
self.addEventListener('activate', e => e.waitUntil(clients.claim()));
self.addEventListener('fetch', e => {
  if (e.request.mode === 'navigate') {
    e.respondWith(fetch(e.request).catch(() => caches.match('/')));
  }
});
`;
    const blob = new Blob([swCode], {type: 'application/javascript'});
    const swUrl = URL.createObjectURL(blob);
    navigator.serviceWorker.register(swUrl, {scope: '/'}).catch(() => {});
  });
}
</script>
<script>
// Generate PWA icon via canvas and inject as apple-touch-icon
(function() {
  try {
    const c = document.createElement('canvas');
    c.width = 512; c.height = 512;
    const ctx = c.getContext('2d');
    // Background
    const bg = ctx.createLinearGradient(0,0,512,512);
    bg.addColorStop(0,'#111111'); bg.addColorStop(1,'#0a0a0a');
    ctx.fillStyle = bg;
    roundRect(ctx, 0, 0, 512, 512, 90);
    ctx.fill();
    // Dumbbell shape in green
    ctx.fillStyle = '#4ADE80';
    ctx.shadowColor = '#4ADE80'; ctx.shadowBlur = 20;
    // Left plate
    roundRect(ctx, 52, 188, 80, 136, 20); ctx.fill();
    // Left collar
    roundRect(ctx, 128, 208, 48, 96, 12); ctx.fill();
    // Bar
    roundRect(ctx, 172, 238, 168, 36, 8); ctx.fill();
    // Right collar
    roundRect(ctx, 336, 208, 48, 96, 12); ctx.fill();
    // Right plate
    roundRect(ctx, 380, 188, 80, 136, 20); ctx.fill();
    // "FS" text
    ctx.shadowBlur = 0;
    ctx.fillStyle = '#ffffff';
    ctx.font = 'bold 72px system-ui, -apple-system, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('FS', 256, 440);

    function roundRect(ctx, x, y, w, h, r) {
      ctx.beginPath();
      ctx.moveTo(x+r, y);
      ctx.lineTo(x+w-r, y);
      ctx.quadraticCurveTo(x+w, y, x+w, y+r);
      ctx.lineTo(x+w, y+h-r);
      ctx.quadraticCurveTo(x+w, y+h, x+w-r, y+h);
      ctx.lineTo(x+r, y+h);
      ctx.quadraticCurveTo(x, y+h, x, y+h-r);
      ctx.lineTo(x, y+r);
      ctx.quadraticCurveTo(x, y, x+r, y);
      ctx.closePath();
    }

    const iconUrl = c.toDataURL('image/png');
    // Inject apple-touch-icon
    ['180', '152', '167', '120'].forEach(size => {
      const link = document.createElement('link');
      link.rel = 'apple-touch-icon';
      link.setAttribute('sizes', size + 'x' + size);
      link.href = iconUrl;
      document.head.appendChild(link);
    });
    // Inject manifest with proper icon
    const manifest = {
      name: 'FitStart',
      short_name: 'FitStart',
      description: 'AI fitness plans and workout tracking',
      start_url: './',
      display: 'standalone',
      background_color: '#0a0a0a',
      theme_color: '#0a0a0a',
      orientation: 'portrait-primary',
      icons: [
        { src: iconUrl, sizes: '192x192', type: 'image/png', purpose: 'any maskable' },
        { src: iconUrl, sizes: '512x512', type: 'image/png', purpose: 'any maskable' }
      ]
    };
    const blob = new Blob([JSON.stringify(manifest)], {type:'application/manifest+json'});
    const mLink = document.createElement('link');
    mLink.rel = 'manifest';
    mLink.href = URL.createObjectURL(blob);
    document.head.appendChild(mLink);
  } catch(e) { console.log('Icon gen error:', e); }
})();
</script>
</head>
<body>

<!-- ══════════ ONBOARDING ══════════ -->
<div id="screen-onboard" class="screen active">
<nav>
  <div class="logo">FIT<span class="logo-dot" id="ob-logo-dot">●</span>START</div>
  <div class="nav-right">
    <div class="nav-pill">AI-Powered</div>
    <button class="nav-cta" onclick="document.getElementById('form-section').scrollIntoView({behavior:'smooth'})">Build My Plan</button>
  </div>
</nav>

<section id="hero-section" class="hero">
  <div class="hero-eyebrow"><span class="eyebrow-line"></span>Personalized fitness at every level</div>
  <div id="ob-headline">
    TRAIN<br>
    <span class="line-accent" id="ob-accent">SMARTER,</span>
    <span id="ob-headline-line3">NOT HARDER</span>
  </div>
  <p class="hero-sub">Tell us where you are and we'll build a plan that gets you where you want to go — whether you're just starting out or chasing a new personal best.</p>
  <div class="tier-selector">
    <button class="tier-btn active" data-tier="beginner" onclick="setTier('beginner',this)">
      <div class="tier-label">Beginner</div><div class="tier-desc">Just starting out, building the habit</div>
      <div class="tier-dots"><div class="tier-dot"></div><div class="tier-dot"></div><div class="tier-dot"></div></div>
    </button>
    <button class="tier-btn" data-tier="intermediate" onclick="setTier('intermediate',this)">
      <div class="tier-label">Intermediate</div><div class="tier-desc">6+ months in, ready to level up</div>
      <div class="tier-dots"><div class="tier-dot"></div><div class="tier-dot"></div><div class="tier-dot"></div></div>
    </button>
    <button class="tier-btn" data-tier="advanced" onclick="setTier('advanced',this)">
      <div class="tier-label">Advanced</div><div class="tier-desc">2+ years, chasing peak performance</div>
      <div class="tier-dots"><div class="tier-dot"></div><div class="tier-dot"></div><div class="tier-dot"></div></div>
    </button>
  </div>
</section>

<div class="main-layout" id="form-section">
  <div class="form-card">
    <div class="form-header">
      <div class="form-title">Build My Plan</div>
      <div class="tier-badge" id="tierBadge">● Beginner</div>
    </div>

    <div class="form-section-label">About You</div>
    <div class="form-row">
      <div class="form-group"><label>First Name</label><input type="text" id="ob-name" placeholder="e.g. Jake"></div>
      <div class="form-group"><label>Age</label><input type="number" id="ob-age" placeholder="e.g. 28" min="16" max="80"></div>
      <div class="form-group"><label>Gender</label>
        <select id="ob-gender">
          <option value="">Select...</option>
          <option>Male</option><option>Female</option><option>Prefer not to say</option>
        </select>
      </div>
      <div class="form-group"><label>Height</label>
        <div style="display:flex;gap:6px">
          <select id="ob-height-ft" style="flex:1">
            <option value="">ft</option>
            <option>4</option><option>5</option><option>6</option><option>7</option>
          </select>
          <select id="ob-height-in" style="flex:1">
            <option value="">in</option>
            <option>0</option><option>1</option><option>2</option><option>3</option><option>4</option>
            <option>5</option><option>6</option><option>7</option><option>8</option><option>9</option>
            <option>10</option><option>11</option>
          </select>
        </div>
      </div>
      <div class="form-group"><label>Current Weight (lbs)</label><input type="number" id="ob-weight" placeholder="e.g. 235"></div>
      <div class="form-group"><label>Goal Weight (lbs)</label><input type="number" id="ob-goal" placeholder="e.g. 215"></div>
      <div class="form-group" style="grid-column:1/-1"><label>Activity Level (outside gym)</label>
        <select id="ob-activity">
          <option value="">Select...</option>
          <option value="sedentary">Sedentary — desk job, little movement</option>
          <option value="light">Lightly Active — on feet some of the day</option>
          <option value="moderate">Moderately Active — physical job or daily walks</option>
          <option value="very">Very Active — labor job, sports, highly active</option>
        </select>
      </div>
    </div>

    <div class="form-section-label">Training Details</div>
    <div class="form-row">
      <div class="form-group" style="grid-column:1/-1"><label>Available Equipment</label>
        <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:4px" id="ob-equipment-picker">
          <div class="day-pill" data-equip="Full Gym">Full Gym</div>
          <div class="day-pill" data-equip="Barbells">Barbells</div>
          <div class="day-pill" data-equip="Dumbbells">Dumbbells</div>
          <div class="day-pill" data-equip="Cables">Cables</div>
          <div class="day-pill" data-equip="Machines">Machines</div>
          <div class="day-pill" data-equip="Kettlebells">Kettlebells</div>
          <div class="day-pill" data-equip="Resistance Bands">Bands</div>
          <div class="day-pill" data-equip="Bodyweight Only">Bodyweight Only</div>
        </div>
      </div>
      <div class="form-group" style="grid-column:1/-1"><label>Injuries or Limitations <span style="color:var(--dim);font-weight:400;text-transform:none;letter-spacing:0">(optional)</span></label>
        <input type="text" id="ob-injuries" placeholder="e.g. bad knees, lower back pain, shoulder impingement">
      </div>
    </div>

    <div class="form-section-label">Goal Timeline</div>
    <div class="timeline-selector" id="timeline-selector">
      <div class="tl-btn" data-weeks="12" onclick="selectTimeline(this)">12 Weeks<br><small style="font-size:0.62rem;opacity:0.6">Aggressive</small></div>
      <div class="tl-btn active" data-weeks="16" onclick="selectTimeline(this)">16 Weeks<br><small style="font-size:0.62rem;opacity:0.6">Balanced</small></div>
      <div class="tl-btn" data-weeks="24" onclick="selectTimeline(this)">24 Weeks<br><small style="font-size:0.62rem;opacity:0.6">Sustainable</small></div>
      <div class="tl-btn" data-weeks="36" onclick="selectTimeline(this)">36 Weeks<br><small style="font-size:0.62rem;opacity:0.6">Gradual</small></div>
    </div>

    <div class="form-section-label">Training Split</div>
    <div class="split-selector" id="split-selector">
      <div class="split-btn active" data-split="ppl" onclick="selectSplit(this)">
        <div class="split-btn-title">Push / Pull / Legs</div>
        <div class="split-btn-desc">Classic 3-way split, best for 4–6 days</div>
      </div>
      <div class="split-btn" data-split="ul" onclick="selectSplit(this)">
        <div class="split-btn-title">Upper / Lower</div>
        <div class="split-btn-desc">Balanced split, great for 3–4 days</div>
      </div>
      <div class="split-btn" data-split="fb" onclick="selectSplit(this)">
        <div class="split-btn-title">Full Body</div>
        <div class="split-btn-desc">Hit everything each session, 2–3 days</div>
      </div>
      <div class="split-btn" data-split="ai" onclick="selectSplit(this)">
        <div class="split-btn-title">AI Generated</div>
        <div class="split-btn-desc">Let us build the optimal split for you</div>
      </div>
    </div>

    <div class="form-section-label">Your Schedule</div>
    <div class="form-group" style="margin-bottom:12px">
      <label>Gym Days <span id="day-count-label" style="color:var(--dim);font-weight:400;text-transform:none;letter-spacing:0"></span></label>
      <div class="day-picker" id="ob-day-picker">
        <div class="day-pill" data-day="Monday">Mon</div>
        <div class="day-pill" data-day="Tuesday">Tue</div>
        <div class="day-pill" data-day="Wednesday">Wed</div>
        <div class="day-pill" data-day="Thursday">Thu</div>
        <div class="day-pill" data-day="Friday">Fri</div>
        <div class="day-pill" data-day="Saturday">Sat</div>
        <div class="day-pill" data-day="Sunday">Sun</div>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group" style="grid-column:1/-1"><label>Session Length</label>
        <select id="ob-duration">
          <option value="">Select...</option>
          <option>20–30 min</option><option>30–45 min</option><option>45–60 min</option><option>60–90 min</option>
        </select>
      </div>
    </div>

    <button class="btn-generate" id="generateBtn" onclick="generatePlan()">GENERATE MY PLAN</button>
    <p class="price-note">7-day free trial · Then $29.99/month · Cancel anytime</p>
  </div>

  <div class="sidebar-info">
    <div class="info-card">
      <div class="info-card-label" id="sidebar-label">What You Get — Beginner</div>
      <div id="tier-features"></div>
    </div>
  </div>
</div>

<div class="loading-wrap" id="loading">
  <div class="loader"><div class="loader-bar"></div><div class="loader-bar"></div><div class="loader-bar"></div><div class="loader-bar"></div><div class="loader-bar"></div></div>
  <p>Building your personalized plan...</p>
  <small id="loading-detail">Analyzing your profile</small>
</div>

<section id="results-section">
  <div class="cta-into-app" style="margin:0">
    <h3>YOUR PLAN IS READY</h3>
    <p>Start your full program, track macros, and log every workout inside the app.</p>
    <button class="btn-enter-app" onclick="goToDash()">ENTER THE APP →</button>
    <p class="cta-fine">7-day free trial · Then $29.99/month · Cancel anytime</p>
  </div>
  <!-- Hidden plan data for My Plan tab -->
  <div id="results-grid" style="display:none"></div>
  <div id="week-card" style="display:none"></div>
  <div id="results-banner" style="display:none"><h2 id="plan-name"></h2><p id="plan-tagline"></p><div id="results-tier-badge"></div></div>
</section>
</div><!-- /screen-onboard -->


<!-- ══════════ SIGNUP ══════════ -->
<div id="screen-signup" class="screen">
<nav>
  <div class="logo">FIT<span class="logo-dot" id="su-logo-dot">●</span>START</div>
  <div class="nav-right">
    <div class="nav-pill" id="su-tier-pill">Beginner Plan</div>
    <button class="nav-cta" style="background:transparent;border:1px solid var(--border);color:var(--off)" onclick="goBackToResults()">← Back to Plan</button>
  </div>
</nav>
<div class="signup-wrap">
  <div class="signup-left">
    <div class="signup-eyebrow"><span class="signup-eyebrow-line"></span>Your plan is ready</div>
    <h2>CLAIM YOUR<br><span id="su-accent">FREE</span><br>7-DAY TRIAL</h2>
    <p class="signup-tagline">You built a personalized plan. Don't lose it — start your free trial and get full access to your program, AI coach, macro tracker, and progress dashboard.</p>
    <div class="plan-summary">
      <div class="ps-header"><div class="ps-label">Your Generated Plan</div><div class="ps-tier-badge" id="su-tier-badge">Beginner</div></div>
      <div class="ps-plan-name" id="su-plan-name">—</div>
      <div class="ps-tagline" id="su-plan-tagline">—</div>
      <div class="ps-stats">
        <div class="ps-stat"><div class="ps-stat-val" id="su-cal">—</div><div class="ps-stat-label">Daily Calories</div></div>
        <div class="ps-stat"><div class="ps-stat-val" id="su-pro">—</div><div class="ps-stat-label">Daily Protein</div></div>
        <div class="ps-stat"><div class="ps-stat-val" id="su-days">—</div><div class="ps-stat-label">Gym Days/Week</div></div>
        <div class="ps-stat"><div class="ps-stat-val" id="su-timeline">—</div><div class="ps-stat-label">Your Timeline</div></div>
      </div>
    </div>
    <div style="font-size:0.6rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--dim);margin-bottom:12px">What's included</div>
    <div class="included-list">
      <div class="included-item"><div class="included-check">✓</div>Your personalized program saved to your dashboard</div>
      <div class="included-item"><div class="included-check">✓</div>Exercise-by-exercise workout tracking with exercise guides</div>
      <div class="included-item"><div class="included-check">✓</div>Macro tracker with calorie countdown</div>
      <div class="included-item"><div class="included-check">✓</div>Progress tracking with previous week comparison</div>
      <div class="included-item"><div class="included-check">✓</div>Cancel anytime — no questions asked</div>
    </div>
  </div>
  <div class="signup-card">
    <div class="trial-badge">★ 7 DAYS FREE — NO CHARGE TODAY</div>
    <div class="signup-form-title">CREATE YOUR ACCOUNT</div>
    <div class="signup-form-sub">$29.99/month after trial</div>
    <div class="sf-row">
      <div class="sf-group"><div class="sf-label">First Name</div><input class="sf-input" id="su-firstname" type="text" placeholder="Jake"></div>
      <div class="sf-group"><div class="sf-label">Last Name</div><input class="sf-input" id="su-lastname" type="text" placeholder="Davis"></div>
    </div>
    <div class="sf-group"><div class="sf-label">Email</div><input class="sf-input" id="su-email" type="email" placeholder="you@email.com"></div>
    <div class="sf-group">
      <div class="sf-label">Password</div>
      <input class="sf-input" id="su-password" type="password" placeholder="Min. 8 characters" oninput="checkPwStrength(this.value)">
      <div class="pw-strength"><div class="pw-bar" id="pw1"></div><div class="pw-bar" id="pw2"></div><div class="pw-bar" id="pw3"></div><div class="pw-bar" id="pw4"></div></div>
    </div>
    <div class="trial-breakdown">
      <div class="tb-row"><div class="tb-label">Today</div><div class="tb-val free">$0.00 FREE</div></div>
      <div class="tb-row"><div class="tb-label">Days 1–7</div><div class="tb-val">Full access, no charge</div></div>
      <div class="tb-row"><div class="tb-label">Day 8 onward</div><div class="tb-val after">$29.99/month — cancel anytime</div></div>
    </div>
    <button class="btn-start-trial" id="su-submit-btn" onclick="submitSignup()">START FREE TRIAL →</button>
    <div class="signup-fine">No credit card required · Cancel before day 7 to pay nothing · $29.99/month after</div>
    <div class="signup-login">Already have an account? <a onclick="goToDash()">Sign in</a></div>
  </div>
</div>
</div><!-- /screen-signup -->


<!-- ══════════ DASHBOARD ══════════ -->
<div id="screen-dash" class="screen">
<nav>
  <div class="logo">FIT<span class="logo-dot">●</span>START</div>
  <div class="nav-right">
    <div class="streak-pill"><svg viewBox="0 0 24 24" fill="currentColor" width="13" height="13" style="flex-shrink:0"><path d="M12 2c0 0-4 4.5-4 9a4 4 0 0 0 8 0c0-4.5-4-9-4-9zm0 11a2 2 0 0 1-2-2c0-2 2-5 2-5s2 3 2 5a2 2 0 0 1-2 2z"/></svg> <span id="dash-streak">1</span>-day streak</div>
    <div class="user-pill"><div class="avatar" id="dash-avatar">?</div><span id="dash-username">You</span></div>
  </div>
</nav>
<div class="shell">
  <div class="sidebar-nav">
    <div class="sb-label">Dashboard</div>
    <button class="sb-btn active" onclick="dashNav('today',this)"><span class="sb-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="15" height="15"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg></span>Today</button>
    <button class="sb-btn" onclick="dashNav('week',this)"><span class="sb-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="15" height="15"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></span>This Week<span class="sb-badge" id="week-badge">Wk 1</span></button>
    <button class="sb-btn" onclick="dashNav('nutrition',this)"><span class="sb-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="15" height="15"><path d="M12 2a5 5 0 0 1 5 5c0 4-5 11-5 11S7 11 7 7a5 5 0 0 1 5-5z"/><circle cx="12" cy="7" r="2"/></svg></span>Nutrition</button>
    <button class="sb-btn" onclick="dashNav('progress',this)"><span class="sb-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="15" height="15"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg></span>Progress</button>
    <button class="sb-btn" onclick="dashNav('coach',this)"><span class="sb-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="15" height="15"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></span>AI Coach</button>
    <div class="sb-label" style="margin-top:12px">Plan</div>
    <button class="sb-btn" onclick="dashNav('program',this)"><span class="sb-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="15" height="15"><path d="M6 4v6M6 14v6M18 4v6M18 14v6M3 7h6M15 7h6M3 17h6M15 17h6"/></svg></span>My Program</button>
    <button class="sb-btn" onclick="dashNav('myplan',this)"><span class="sb-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="15" height="15"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg></span>My Plan</button>
    <button class="sb-btn" onclick="dashNav('settings',this)"><span class="sb-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="15" height="15"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33H15a1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15H4.5a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68V4.5a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51v.18a1.65 1.65 0 0 0 1.82.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9v.18a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></span>Settings</button>
  </div>
  <div class="main-content">

    <!-- TODAY -->
    <div class="view active" id="view-today">
      <div class="page-header">
        <div class="page-title" id="dash-day-title">TODAY</div>
        <div class="page-sub" id="dash-day-sub">Week 1 of your program</div>
      </div>
      <div class="today-grid">
        <div class="stat-card"><div class="card-label">Calories Left</div><div class="sc-val" id="d-cal">—</div><div class="sc-sub" id="d-cal-sub">of — target</div><div class="prog-bar"><div class="prog-fill" id="d-cal-bar" style="width:0%"></div></div></div>
        <div class="stat-card"><div class="card-label">Protein Left</div><div class="sc-val" id="d-pro">—</div><div class="sc-sub" id="d-pro-sub">of —g target</div><div class="prog-bar"><div class="prog-fill" id="d-pro-bar" style="width:0%"></div></div></div>
        <div style="display:none" id="d-wkt-name" aria-hidden="true"></div><div style="display:none" id="d-wkt-sub" aria-hidden="true"></div><div style="display:none" id="d-wkt-bar" aria-hidden="true"></div>
      </div>
      <div class="log-toggle-card">
        <div style="display:flex;align-items:center;gap:10px;padding:14px 18px">
          <div style="font-family:'Bebas Neue',sans-serif;font-size:1rem;letter-spacing:1px;margin-right:4px">LOG FOOD</div>
          <button class="btn-cat-scan" onclick="openBarcodeScanner('other')" style="font-size:0.78rem"><svg viewBox="0 0 32 20" width="18" height="12" fill="currentColor"><rect x="0" y="0" width="2" height="20"/><rect x="4" y="0" width="1" height="20"/><rect x="7" y="0" width="3" height="20"/><rect x="12" y="0" width="1" height="20"/><rect x="15" y="0" width="2" height="20"/><rect x="19" y="0" width="1" height="20"/><rect x="22" y="0" width="3" height="20"/><rect x="27" y="0" width="1" height="20"/><rect x="30" y="0" width="2" height="20"/></svg> SCAN</button>
          <button class="btn-cat-add" onclick="openQuickFoodModal()">+ Search Food</button>
        </div>
        <div id="today-mini-log" style="border-top:1px solid var(--border)"></div>
      </div>
      <div class="workout-card" style="margin-top:16px">
        <div class="wc-header">
          <div>
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
              <div class="wc-badge" id="wc-badge">● Today</div>
              <button id="today-customize-btn" onclick="openCustomWorkoutBuilder()" style="padding:4px 10px;background:none;border:1px solid var(--border2);border-radius:6px;color:var(--dim);font-family:'Bebas Neue',sans-serif;font-size:0.62rem;letter-spacing:1.2px;cursor:pointer;display:flex;align-items:center;gap:4px;transition:all 0.15s" onmouseover="this.style.color='var(--white)';this.style.borderColor='var(--border)'" onmouseout="this.style.color='var(--dim)';this.style.borderColor='var(--border2)'">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="10" height="10"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
                CUSTOM
              </button>
            </div>
            <div class="wc-name" id="wc-name">YOUR WORKOUT</div>
          </div>
          <button class="btn-primary" id="today-start-btn" onclick="openWorkoutEnv(TODAY_IDX)">START WORKOUT</button>
        </div>
        <div class="ex-list" id="today-ex-list"></div>
      </div>
    </div>

    <!-- THIS WEEK -->
    <div class="view" id="view-week">
      <div class="page-header"><div class="page-title">THIS WEEK</div><div class="page-sub" id="week-view-sub">Week 1 · Tap any day to log</div></div>
      <div class="week-day-grid" id="week-grid"></div>
      <div class="week-stat-grid">
        <div class="stat-card"><div class="card-label">Workouts Done</div><div class="sc-val" id="wk-done">0</div><div class="sc-sub" id="wk-done-sub">of 0 scheduled</div><div class="prog-bar"><div class="prog-fill" id="wk-done-bar" style="width:0%"></div></div></div>
        <div class="stat-card"><div class="card-label">Avg Calories</div><div class="sc-val">—</div><div class="sc-sub">this week so far</div></div>
        <div class="stat-card"><div class="card-label">Avg Protein</div><div class="sc-val">—</div><div class="sc-sub" id="wk-pro-sub">goal: —g/day</div></div>
      </div>
    </div>

    <!-- NUTRITION -->
    <div class="view" id="view-nutrition">
      <div class="page-header"><div class="page-title">NUTRITION</div><div class="page-sub">Track food, water & macros</div></div>
      <div class="day-picker-nav" id="day-picker-nav"></div>

      <!-- MACRO BARS -->
      <div class="macro-bar" style="margin-bottom:14px">
        <div class="mb-item"><div class="mb-label">Calories Left</div><div class="mb-val" id="n-cal">—</div><div class="mb-target" id="n-cal-tgt">of —</div><div class="mb-bar"><div class="mb-fill" id="n-cal-bar" style="width:0%"></div></div></div>
        <div class="mb-item"><div class="mb-label">Protein Left</div><div class="mb-val" id="n-pro">—</div><div class="mb-target" id="n-pro-tgt">of —g</div><div class="mb-bar"><div class="mb-fill" id="n-pro-bar" style="width:0%"></div></div></div>
        <div class="mb-item"><div class="mb-label">Carbs Left</div><div class="mb-val" id="n-carb">—</div><div class="mb-target" id="n-carb-tgt">of —g</div><div class="mb-bar"><div class="mb-fill" id="n-carb-bar" style="width:0%"></div></div></div>
        <div class="mb-item"><div class="mb-label">Fat Left</div><div class="mb-val" id="n-fat">—</div><div class="mb-target" id="n-fat-tgt">of —g</div><div class="mb-bar"><div class="mb-fill" id="n-fat-bar" style="width:0%"></div></div></div>
      </div>

      <!-- WATER TRACKER -->
      <div class="water-section">
        <div class="water-header">
          <div class="water-title">WATER INTAKE</div>
          <div style="display:flex;align-items:center;gap:8px">
            <span style="font-size:0.85rem;color:var(--off);font-weight:600">Goal:</span>
            <input type="number" id="water-goal-input" value="64" min="16" max="300"
              style="width:60px;padding:5px 8px;background:var(--dark);border:1px solid var(--border2);border-radius:7px;font-family:'Inter',sans-serif;font-size:0.85rem;color:var(--green);font-weight:700;outline:none;text-align:center"
              onchange="updateWaterGoal(this.value)">
            <span style="font-size:0.85rem;color:var(--off);font-weight:600">oz / day</span>
          </div>
        </div>
        <div class="water-ring-wrap">
          <div class="water-ring">
            <svg width="100" height="100" viewBox="0 0 100 100">
              <circle class="water-ring-track" cx="50" cy="50" r="42"/>
              <circle class="water-ring-fill" id="water-ring-fill" cx="50" cy="50" r="42"
                stroke-dasharray="263.9" stroke-dashoffset="263.9"/>
            </svg>
            <div class="water-ring-text">
              <div class="water-oz" id="water-oz-display">0</div>
              <div class="water-oz-label">oz</div>
            </div>
          </div>
          <div style="flex:1">
            <div style="font-size:0.85rem;color:var(--off);margin-bottom:10px" id="water-status">Stay hydrated <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M6 4v6M6 14v6M18 4v6M18 14v6M3 7h6M15 7h6M3 17h6M15 17h6"/></svg></div>
            <div class="water-btns" style="flex-wrap:wrap;gap:8px">
              <button class="water-add-btn" onclick="addWater(8)">+8 oz</button>
              <button class="water-add-btn" onclick="addWater(16)">+16 oz</button>
              <button class="water-add-btn" onclick="addWater(32)">+32 oz</button>
              <button class="water-add-btn" onclick="toggleCustomWater()" id="water-custom-toggle" style="white-space:nowrap">+ Add</button>
            </div>
            <div id="water-custom-row" style="display:none;margin-top:10px;display:none;align-items:center;gap:8px">
              <input type="number" id="water-custom-input" placeholder="oz" min="1" max="200"
                style="width:72px;padding:7px 10px;background:var(--dark);border:1px solid rgba(56,189,248,0.3);border-radius:8px;font-family:'Syne',sans-serif;font-size:0.88rem;color:var(--white);outline:none;"
                onkeydown="if(event.key==='Enter')addCustomWater()">
              <button class="water-add-btn" onclick="addCustomWater()" style="white-space:nowrap;background:rgba(56,189,248,0.18)">LOG</button>
              <button onclick="toggleCustomWater()" style="background:none;border:none;color:var(--dim);cursor:pointer;font-size:0.85rem;padding:4px 6px">✕</button>
            </div>
          </div>
        </div>
        <div class="water-cups" id="water-cups"></div>
      </div>

      <!-- MEAL CATEGORIES (MFP-style) -->
      <div id="meal-categories"></div>
    </div>

    <!-- PROGRESS -->
    <div class="view" id="view-progress">
      <div class="page-header"><div class="page-title">PROGRESS</div><div class="page-sub">Your stats over time</div></div>

      <!-- STAT STRIP -->
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:14px">
        <div class="prog-card" style="padding:14px;text-align:center">
          <div class="sbox-val" id="stat-streak">0</div><div class="sbox-label">Streak</div>
        </div>
        <div class="prog-card" style="padding:14px;text-align:center">
          <div class="sbox-val" id="stat-workouts">0</div><div class="sbox-label">This Month</div>
        </div>
        <div class="prog-card" style="padding:14px;text-align:center">
          <div class="sbox-val" id="stat-lbs-lost" style="font-size:1.2rem">—</div><div class="sbox-label" id="stat-lbs-label">Lbs Lost</div>
        </div>
        <div class="prog-card" style="padding:14px;text-align:center">
          <div class="sbox-val" id="stat-avg-pro">—</div><div class="sbox-label">Avg Protein</div>
        </div>
      </div>

      <!-- WEIGHT CHART -->
      <div class="prog-card" style="margin-bottom:14px">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
          <div class="pc-title">BODY WEIGHT</div>
          <div style="display:flex;align-items:center;gap:8px">
            <input type="number" id="weight-log-input" placeholder="lbs" step="0.1" min="50" max="600"
              style="width:80px;padding:8px 10px;background:var(--dark);border:1px solid var(--border2);border-radius:8px;font-size:0.95rem;color:var(--white);outline:none;text-align:center"
              onkeydown="if(event.key==='Enter')logBodyWeight()">
            <button onclick="logBodyWeight()" style="padding:8px 14px;background:var(--green);border:none;border-radius:8px;color:var(--black);font-family:'Bebas Neue',sans-serif;font-size:0.85rem;letter-spacing:1px;cursor:pointer">LOG</button>
          </div>
        </div>
        <div id="weight-current-display" style="font-size:0.82rem;color:var(--off);margin-bottom:12px"></div>
        <div id="weight-chart-wrap" style="width:100%;height:160px;position:relative">
          <div id="weight-chart-empty" style="height:160px;display:flex;align-items:center;justify-content:center;color:var(--dim);font-size:0.82rem">Log your weight to see your trend</div>
          <svg id="weight-chart-svg" style="display:none;width:100%;height:160px" viewBox="0 0 400 160" preserveAspectRatio="none"></svg>
        </div>
        <div id="weight-history-list" style="margin-top:10px;display:flex;flex-direction:column;gap:4px;max-height:160px;overflow-y:auto"></div>
      </div>

      <!-- WORKOUT STREAK CALENDAR -->
      <div class="prog-card" style="margin-bottom:14px">
        <div class="pc-title" style="margin-bottom:12px">WORKOUT HISTORY — <span id="streak-month-label" style="color:var(--green)"></span></div>
        <div class="streak-cal" id="streak-cal"></div>
      </div>

      <!-- WORKOUT FREQUENCY CHART -->
      <div class="prog-card" style="margin-bottom:14px">
        <div class="pc-title" style="margin-bottom:14px">WORKOUTS PER WEEK (last 8 weeks)</div>
        <div id="freq-chart-wrap" style="width:100%;height:100px">
          <svg id="freq-chart-svg" width="100%" height="100" viewBox="0 0 400 100" preserveAspectRatio="none"></svg>
        </div>
      </div>

    </div>

    <!-- MY PROGRAM -->
    <div class="view" id="view-program">
      <div class="page-header"><div class="page-title">MY PROGRAM</div><div class="page-sub" id="prog-sub">Your personalized plan</div></div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;margin-bottom:20px">
        <div class="stat-card"><div class="card-label">Plan</div><div class="sc-val" style="font-size:1.1rem;line-height:1.4" id="prog-tier-val">—</div><div class="sc-sub" id="prog-plan-name">—</div></div>
        <div class="stat-card"><div class="card-label">Progress</div><div class="sc-val" id="prog-fraction">1 / —</div><div class="sc-sub">weeks completed</div><div class="prog-bar"><div class="prog-fill" id="prog-pct-bar" style="width:4%"></div></div></div>
        <div class="stat-card"><div class="card-label">Gym Days</div><div class="sc-val" style="font-size:0.95rem;line-height:1.5" id="prog-gym-days">—</div><div class="sc-sub" id="prog-days-count">— days/week</div></div>
      </div>
      <div id="week-accordion" style="display:flex;flex-direction:column;gap:10px"></div>
    </div>

    <!-- MY PLAN -->
    <div class="view" id="view-myplan">
      <div class="page-header"><div class="page-title">MY PLAN</div><div class="page-sub" id="myplan-sub">Your personalized fitness blueprint</div></div>
      <div id="myplan-banner" style="margin-bottom:14px"></div>
      <div id="myplan-body"></div>
    </div>

    <!-- SETTINGS -->
    <div class="view" id="view-settings">
      <div class="page-header"><div class="page-title">SETTINGS</div><div class="page-sub">Manage your plan, targets, and account</div></div>
      <div style="display:flex;flex-direction:column;gap:14px;max-width:680px">
        <div class="card">
          <div class="card-label" style="margin-bottom:16px">Profile</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px" class="settings-grid">
            <div><div style="font-size:0.65rem;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--dim);margin-bottom:6px">Name</div><input id="s-name" class="settings-input"></div>
            <div><div style="font-size:0.65rem;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--dim);margin-bottom:6px">Current Weight</div><input id="s-weight" class="settings-input"></div>
            <div><div style="font-size:0.65rem;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--dim);margin-bottom:6px">Goal Weight</div><input id="s-goal" class="settings-input"></div>
            <div><div style="font-size:0.65rem;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--dim);margin-bottom:6px">Experience Level</div><input id="s-tier" class="settings-input" readonly></div>
          </div>
        </div>
        <div class="card">
          <div class="card-label" style="margin-bottom:16px">Daily Macro Targets</div>
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px">
            <div><div style="font-size:0.6rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--off);margin-bottom:6px;text-align:center">Calories</div><input id="s-cal" type="number" style="width:100%;padding:10px 6px;background:var(--dark);border:1px solid var(--border);border-radius:9px;font-family:'Bebas Neue',sans-serif;font-size:1.4rem;color:var(--white);text-align:center;letter-spacing:1px;outline:none"></div>
            <div><div style="font-size:0.6rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--green);margin-bottom:6px;text-align:center">Protein g</div><input id="s-pro" type="number" style="width:100%;padding:10px 6px;background:var(--dark);border:1px solid var(--border);border-radius:9px;font-family:'Bebas Neue',sans-serif;font-size:1.4rem;color:var(--green);text-align:center;letter-spacing:1px;outline:none"></div>
            <div><div style="font-size:0.6rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--blue);margin-bottom:6px;text-align:center">Carbs g</div><input id="s-carb" type="number" style="width:100%;padding:10px 6px;background:var(--dark);border:1px solid var(--border);border-radius:9px;font-family:'Bebas Neue',sans-serif;font-size:1.4rem;color:var(--blue);text-align:center;letter-spacing:1px;outline:none"></div>
            <div><div style="font-size:0.6rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--orange);margin-bottom:6px;text-align:center">Fat g</div><input id="s-fat" type="number" style="width:100%;padding:10px 6px;background:var(--dark);border:1px solid var(--border);border-radius:9px;font-family:'Bebas Neue',sans-serif;font-size:1.4rem;color:var(--orange);text-align:center;letter-spacing:1px;outline:none"></div>
          </div>
        </div>
        <div class="card"><div class="card-label" style="margin-bottom:16px">Gym Days</div><div style="display:flex;gap:8px;flex-wrap:wrap" id="settings-gym-days"></div></div>
        <div class="card" style="border-color:rgba(251,146,60,0.2)">
          <div class="card-label" style="margin-bottom:12px">Subscription</div>
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><div style="font-size:0.95rem;font-weight:600;margin-bottom:3px">FitStart Pro &nbsp;<span style="color:var(--orange);font-size:0.75rem;font-weight:700">● ACTIVE</span></div><div style="font-family:'DM Mono',monospace;font-size:0.72rem;color:var(--dim)">$29.99/month · Cancel anytime</div></div>
            <button style="padding:9px 18px;border:1px solid var(--border);border-radius:9px;background:none;color:var(--dim);font-family:'Syne',sans-serif;font-size:0.78rem;cursor:pointer">Manage</button>
          </div>
        </div>
        <button id="save-btn" onclick="saveSettings()" style="padding:14px;background:var(--green);color:var(--black);border:none;border-radius:12px;font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:2px;cursor:pointer">SAVE CHANGES</button>
      </div>
    </div>

    <!-- AI COACH -->
    <div class="view" id="view-coach">
      <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px 8px">
        <div><span style="font-family:'Bebas Neue',sans-serif;font-size:1.15rem;letter-spacing:1.5px;color:var(--white)">AI COACH</span></div>
        <button id="coach-clear-btn" onclick="clearCoachHistory()" style="display:none;padding:5px 12px;background:none;border:1px solid var(--border);border-radius:7px;color:var(--dim);font-family:'DM Mono',monospace;font-size:0.65rem;cursor:pointer;letter-spacing:0.5px">Clear</button>
      </div>
      <div id="coach-chat-container" class="coach-chat-container">
        <div id="coach-messages" class="coach-messages">
          <div id="coach-starters" class="coach-starters">
            <div class="coach-welcome">
              <div class="coach-welcome-icon"><svg viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="1.5" width="32" height="32"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></div>
              <div class="coach-welcome-title">WHAT CAN I HELP WITH?</div>
              <div class="coach-welcome-sub">Ask me anything about training, nutrition, or recovery</div>
            </div>
            <div class="coach-starter-grid">
              <button class="coach-starter-btn" onclick="sendCoachStarter(this.textContent)">I had 2 eggs and toast for breakfast</button>
              <button class="coach-starter-btn" onclick="sendCoachStarter(this.textContent)">What should I eat to hit my protein today?</button>
              <button class="coach-starter-btn" onclick="sendCoachStarter(this.textContent)">Is my split good for hypertrophy?</button>
              <button class="coach-starter-btn" onclick="sendCoachStarter(this.textContent)">I missed 3 days — how do I get back on track?</button>
            </div>
          </div>
        </div>
        <div class="coach-input-bar">
          <input type="text" id="coach-input" class="coach-text-input" placeholder="Ask your coach..." onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendCoachMessage();}">
          <button class="coach-send-btn" id="coach-send-btn" onclick="sendCoachMessage()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          </button>
        </div>
      </div>
    </div>

  </div>
</div><!-- end shell -->

  <!-- Mobile Bottom Tab Bar (fixed, outside shell) -->
  <nav class="mobile-tab-bar" id="mobile-tab-bar">
    <button class="mob-tab active" id="mob-tab-today" onclick="dashNav('today',this);syncMobTab('today')">
      <svg class="mob-tab-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      <span class="mob-tab-label">Today</span>
    </button>
    <button class="mob-tab" id="mob-tab-week" onclick="dashNav('week',this);syncMobTab('week')">
      <svg class="mob-tab-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
      <span class="mob-tab-label">Week</span>
    </button>
    <button class="mob-tab" id="mob-tab-nutrition" onclick="dashNav('nutrition',this);syncMobTab('nutrition')">
      <svg class="mob-tab-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3zm0 0v7"/></svg>
      <span class="mob-tab-label">Nutrition</span>
    </button>
    <button class="mob-tab" id="mob-tab-coach" onclick="dashNav('coach',this);syncMobTab('coach')">
      <svg class="mob-tab-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
      <span class="mob-tab-label">Coach</span>
    </button>
    <button class="mob-tab" id="mob-tab-more" onclick="toggleMobMore()">
      <svg class="mob-tab-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
      <span class="mob-tab-label">More</span>
    </button>
  </nav>

  <!-- Mobile More Drawer -->
  <div class="mob-more-drawer" id="mob-more-drawer">
    <div class="mob-more-handle"></div>
    <div class="mob-more-item" onclick="mobNavTo('progress');closeMobMore()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
      Progress
    </div>
    <div class="mob-more-item" onclick="mobNavTo('program');closeMobMore()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>
      My Program
    </div>
    <div class="mob-more-item" onclick="mobNavTo('myplan');closeMobMore()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
      My Plan
    </div>
    <div class="mob-more-item" onclick="mobNavTo('settings');closeMobMore()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      Settings
    </div>
  </div>
</div><!-- /screen-dash -->


<!-- ══════════ WORKOUT ENVIRONMENT ══════════ -->
<div id="screen-workout" class="screen">
  <div class="wo-header" style="gap:20px">
    <button class="wo-back" onclick="exitWorkout()">← Exit Workout</button>
    <div class="wo-title" id="wo-title" style="font-size:1.1rem;letter-spacing:1px">WORKOUT</div>
    <button id="wo-customize-btn" style="display:none;align-items:center;gap:5px;background:none;border:1px solid var(--border);border-radius:8px;padding:5px 10px;color:var(--dim);font-family:'Bebas Neue',sans-serif;font-size:0.72rem;letter-spacing:1px;cursor:pointer;flex-shrink:0" title="Switch to custom or AI workout">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="13" height="13"><path d="M12 20h9M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
      CUSTOMIZE
    </button>
    <div class="wo-progress-wrap" style="flex:1">
      <div class="wo-progress-bar"><div class="wo-progress-fill" id="wo-prog-fill" style="width:0%"></div></div>
      <div class="wo-progress-label" id="wo-prog-label">0 / 0</div>
    </div>

  </div>
  <!-- REST TIMER BAR -->
  <div id="rest-timer-bar" style="display:flex;align-items:center;gap:0;background:#0d0d0d;border-bottom:1px solid var(--border);flex-shrink:0;height:56px">
    <button onclick="adjustRest(-15)" style="width:56px;height:56px;border:none;border-right:1px solid var(--border);background:none;color:var(--white);font-size:1.6rem;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center">−</button>
    <div style="flex:1;position:relative;overflow:hidden;height:56px;cursor:pointer" onclick="toggleRestTimer()">
      <div id="rest-timer-progress" style="position:absolute;top:0;left:0;height:100%;background:rgba(251,146,60,0.2);width:0%;pointer-events:none;transition:none"></div>
      <div style="position:relative;z-index:1;height:100%;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:2px">
        <span id="rest-timer-label" style="font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:2px;color:var(--white)">START REST</span>
        <span id="rest-timer-secs-display" style="font-family:'DM Mono',monospace;font-size:0.8rem;color:var(--orange)">3:00</span>
      </div>
    </div>
    <button onclick="adjustRest(15)" style="width:56px;height:56px;border:none;border-left:1px solid var(--border);background:none;color:var(--white);font-size:1.6rem;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center">+</button>
  </div>
  <div class="wo-body">
    <!-- LEFT: Exercise List -->
    <div class="wo-left-panel">
      <div class="wo-left-header">
        <div class="wo-left-title" id="wo-day-title">TODAY</div>
        <div class="wo-left-sub" id="wo-day-subtitle"></div>
      </div>
      <div class="wo-ex-sidebar" id="wo-ex-list"></div>
      <div style="padding:12px">
        <button class="btn-add-ex" style="width:100%;justify-content:center" onclick="openAddExModal()">+ ADD EXERCISE</button>
      </div>
    </div>

    <!-- CENTER: Demo + Sets -->
    <div class="wo-main elite" id="wo-main">
      <!-- Exercise Header -->
      <div class="wo-ex-header">
        <div>
          <div class="ex-video-title" id="wo-ex-title">Select an exercise</div>
          <div class="ex-muscles-tag" id="wo-muscles-tag" style="margin-top:4px">Muscles targeted</div>
        </div>
        <div class="ex-video-badge" id="wo-ex-badge"></div>
      </div>
      <div id="wo-phase-badge" style="display:none"></div>

      <!-- Form Demo Images -->
      <div class="ex-demo-wrap" id="wo-demo-wrap">
        <div class="ex-demo-frames" id="wo-demo-frames">
          <div class="demo-frame"><div class="demo-frame-img-placeholder"><div class="demo-frame-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M6 4v6M6 14v6M18 4v6M18 14v6M3 7h6M15 7h6M3 17h6M15 17h6"/></svg></div></div><div class="demo-frame-label">START</div></div>
          <div class="demo-frame"><div class="demo-frame-img-placeholder"><div class="demo-frame-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M6 4v6M6 14v6M18 4v6M18 14v6M3 7h6M15 7h6M3 17h6M15 17h6"/></svg></div></div><div class="demo-frame-label">MID</div></div>
          <div class="demo-frame"><div class="demo-frame-img-placeholder"><div class="demo-frame-icon" style="font-size:1.5rem;opacity:0.5">✓</div></div><div class="demo-frame-label">END</div></div>
        </div>
      </div>

      <!-- Sets Logger -->
      <div class="sets-panel">
        <div class="sets-header">
          <div class="sets-title">TRACK YOUR SETS</div>
          <div style="display:flex;gap:8px;align-items:center">
            <button onclick="addSet()" style="padding:6px 12px;background:var(--green-dim);border:1px solid rgba(74,222,128,0.2);border-radius:7px;color:var(--green);font-family:'Bebas Neue',sans-serif;font-size:0.8rem;letter-spacing:1px;cursor:pointer">+ SET</button>
            <span id="rest-timer-display" style="display:none;color:var(--orange);font-weight:700;font-size:0.9rem"></span>
          </div>
        </div>

        <table class="sets-table">
          <colgroup>
            <col style="width:55px">
            <col style="width:90px">
            <col style="width:75px">
            <col style="width:44px">
            <col style="width:36px">
          </colgroup>
          <thead><tr><th>Set</th><th>Weight</th><th>Reps</th><th>✓</th><th></th></tr></thead>
          <tbody id="sets-tbody"></tbody>
        </table>
      </div>

    </div>
  </div>
  <!-- Nav buttons OUTSIDE scroll area so they're always tappable -->
  <div class="wo-nav-btns">
    <button class="btn-prev-ex hidden" id="wo-prev-btn">← BACK</button>
    <button class="btn-next-ex" id="wo-next-btn">DONE →</button>
  </div>

</div>

<!-- Unplanned Workout Modal -->
<div id="unplanned-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.92);z-index:6000;align-items:flex-end;justify-content:center">
  <div id="unplanned-modal-inner" style="background:var(--dark);border:1px solid var(--border2);border-radius:24px 24px 0 0;width:100%;max-width:600px;padding:24px 20px 40px;max-height:92dvh;overflow-y:auto;transition:max-height 0.3s ease">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
      <div style="font-family:'Bebas Neue',sans-serif;font-size:1.4rem;letter-spacing:1.5px" id="unplanned-modal-title">START A WORKOUT</div>
      <button onclick="closeUnplannedModal()" style="background:none;border:none;color:var(--dim);font-size:1.4rem;cursor:pointer;padding:4px 8px">✕</button>
    </div>
    <div style="font-size:0.82rem;color:var(--dim);margin-bottom:24px" id="unplanned-modal-day"></div>

    <!-- Main options -->
    <div id="unplanned-options">
      <div onclick="startAIWorkout()" style="background:var(--green-dim);border:1px solid rgba(74,222,128,0.3);border-radius:16px;padding:20px 22px;margin-bottom:12px;cursor:pointer;transition:opacity 0.15s" onmousedown="this.style.opacity=0.7" onmouseup="this.style.opacity=1">
        <div style="font-family:'Bebas Neue',sans-serif;font-size:1.15rem;letter-spacing:1.5px;color:var(--green)">AI-GENERATED WORKOUT</div>
        <div style="font-size:0.78rem;color:var(--off);margin-top:4px">A smart workout built for your fitness level and goals</div>
      </div>
      <div onclick="showCustomBuilder()" style="background:var(--card);border:1px solid var(--border2);border-radius:16px;padding:20px 22px;cursor:pointer;transition:opacity 0.15s" onmousedown="this.style.opacity=0.7" onmouseup="this.style.opacity=1">
        <div style="font-family:'Bebas Neue',sans-serif;font-size:1.15rem;letter-spacing:1.5px;color:var(--white)">BUILD CUSTOM WORKOUT</div>
        <div style="font-size:0.78rem;color:var(--dim);margin-top:4px">Choose exercises from the library and set your own sets, reps & rest</div>
      </div>
    </div>

    <!-- AI: Generating spinner -->
    <div id="ai-workout-loading" style="display:none;text-align:center;padding:40px 0">
      <div style="font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:2px;color:var(--green);margin-bottom:8px">GENERATING YOUR WORKOUT</div>
      <div style="font-size:0.8rem;color:var(--dim)">Personalised to your level and goals...</div>
    </div>

    <!-- AI: Workout preview (shown before starting) -->
    <div id="ai-workout-preview" style="display:none">
      <div style="font-family:'Bebas Neue',sans-serif;font-size:0.85rem;letter-spacing:1px;color:var(--dim);margin-bottom:14px" id="ai-preview-label"></div>
      <div id="ai-debug-status" style="display:none;font-family:'DM Mono',monospace;font-size:0.7rem;color:var(--orange);background:rgba(251,146,60,0.1);border:1px solid rgba(251,146,60,0.2);border-radius:8px;padding:8px 12px;margin-bottom:12px;word-break:break-all;max-height:80px;overflow-y:auto"></div>
      <div id="ai-preview-list" style="display:flex;flex-direction:column;gap:8px;margin-bottom:20px"></div>
      <button onclick="launchAIWorkout()" style="width:100%;padding:16px;background:var(--green);border:none;border-radius:12px;color:var(--black);font-family:'Bebas Neue',sans-serif;font-size:1.15rem;letter-spacing:2px;cursor:pointer">BEGIN WORKOUT →</button>
      <button onclick="regenerateAIWorkout()" style="width:100%;padding:12px;background:none;border:1px solid var(--border);border-radius:12px;color:var(--dim);font-family:'Bebas Neue',sans-serif;font-size:0.85rem;letter-spacing:1px;cursor:pointer;margin-top:8px">↺ GENERATE ANOTHER</button>
    </div>

    <!-- Custom builder -->
    <div id="custom-builder" style="display:none;margin-top:4px">
      <div style="font-family:'Bebas Neue',sans-serif;font-size:0.9rem;letter-spacing:1px;margin-bottom:10px;color:var(--off)">SELECT EXERCISES</div>
      <input id="custom-ex-search" type="text" placeholder="Search exercises..." oninput="renderCustomExList()"
        style="width:100%;box-sizing:border-box;padding:11px 14px;background:var(--card);border:1px solid var(--border2);border-radius:10px;color:var(--white);font-size:0.88rem;outline:none;margin-bottom:10px">
      <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px" id="custom-cat-filters"></div>
      <div id="custom-ex-list" style="max-height:45dvh;overflow-y:auto;display:flex;flex-direction:column;gap:5px"></div>
      <div id="custom-selected" style="margin-top:16px;display:none">
        <div style="font-family:'Bebas Neue',sans-serif;font-size:0.85rem;letter-spacing:1px;color:var(--green);margin-bottom:10px">SELECTED — CONFIGURE SETS</div>
        <div id="custom-selected-list" style="display:flex;flex-direction:column;gap:8px;margin-bottom:14px"></div>
        <button onclick="launchCustomWorkout()" style="width:100%;padding:16px;background:var(--green);border:none;border-radius:12px;color:var(--black);font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:2px;cursor:pointer">BEGIN WORKOUT →</button>
      </div>
    </div>
  </div>
</div>

<!-- Food Search Modal -->
<!-- Barcode Modal -->
<div id="barcode-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:9999;flex-direction:column">
  <div style="display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--border)">
    <div style="font-family:'Bebas Neue',sans-serif;font-size:1.2rem;letter-spacing:1px">SCAN BARCODE</div>
    <button onclick="closeBarcodeModal()" style="background:none;border:none;color:var(--off);font-size:1.4rem;cursor:pointer">&#10005;</button>
  </div>
  <div style="padding:20px;border-bottom:1px solid var(--border)">
    <div style="font-size:0.78rem;color:var(--dim);margin-bottom:10px;text-align:center">Enter the barcode number from the package</div>
    <div style="display:flex;gap:10px">
      <input id="barcode-input" type="number" inputmode="numeric" placeholder="e.g. 049000042566"
        style="flex:1;padding:14px 16px;background:var(--card);border:1px solid var(--border2);border-radius:10px;font-family:'DM Mono',monospace;font-size:1.1rem;color:var(--white);outline:none;text-align:center;letter-spacing:1px"
        onkeydown="if(event.key==='Enter')submitBarcode()">
      <button onclick="submitBarcode()"
        style="padding:14px 24px;background:var(--green);border:none;border-radius:10px;color:var(--black);font-family:'Bebas Neue',sans-serif;font-size:1rem;letter-spacing:1.5px;cursor:pointer;font-weight:700;white-space:nowrap">LOOK UP</button>
    </div>
    <div id="barcode-lookup-status" style="font-size:0.72rem;margin-top:8px;color:var(--dim);text-align:center"></div>
  </div>
  <div style="flex:1;position:relative;overflow:hidden;background:#000">
    <video id="barcode-video" autoplay playsinline muted style="width:100%;height:100%;object-fit:cover"></video>
    <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none">
      <div style="width:260px;height:140px;border:2px solid var(--green);border-radius:10px;box-shadow:0 0 0 9999px rgba(0,0,0,0.55)"></div>
    </div>
    <div id="barcode-scan-status" style="position:absolute;bottom:16px;left:0;right:0;text-align:center;font-size:0.78rem;color:var(--off)"></div>
  </div>
  <div style="padding:12px 20px;border-top:1px solid var(--border);text-align:center">
    <button onclick="closeBarcodeModal()"
      style="padding:12px 32px;background:var(--card);border:1px solid var(--border);border-radius:10px;color:var(--off);font-family:'Bebas Neue',sans-serif;font-size:0.9rem;letter-spacing:1px;cursor:pointer">CANCEL</button>
  </div>
</div>

<div class="food-modal" id="food-modal">
  <div class="food-modal-header">
    <button class="food-modal-close" onclick="closeFoodModal()">✕</button>
    <div class="food-modal-title">ADD TO <span id="food-modal-cat-label">BREAKFAST</span></div>
  </div>
  <div class="food-modal-search-row">
    <input type="text" class="food-modal-input" id="food-modal-search-input"
      placeholder="Search 500k+ foods..."
      onkeydown="if(event.key==='Enter')searchFoodModal()">
    <button class="btn-food-modal-scan" onclick="openBarcodeScanner(activeFoodCat)" title="Scan barcode"><svg viewBox="0 0 32 20" width="18" height="12" fill="currentColor"><rect x="0" y="0" width="2" height="20"/><rect x="4" y="0" width="1" height="20"/><rect x="7" y="0" width="3" height="20"/><rect x="12" y="0" width="1" height="20"/><rect x="15" y="0" width="2" height="20"/><rect x="19" y="0" width="1" height="20"/><rect x="22" y="0" width="3" height="20"/><rect x="27" y="0" width="1" height="20"/><rect x="30" y="0" width="2" height="20"/></svg></button>
    <button class="btn-food-modal-search" onclick="searchFoodModal()">SEARCH</button>
  </div>
  <div class="food-modal-tabs">
    <div class="fmt-tab active" data-tab="search" onclick="showFoodModalTab('search')">Search</div>
    <div class="fmt-tab" data-tab="recent" onclick="showFoodModalTab('recent')">Recent</div>
    <div class="fmt-tab" data-tab="custom" onclick="showFoodModalTab('custom')">My Foods</div>
  </div>
  <div class="food-modal-results" id="food-modal-results">
    <div class="food-modal-empty">Search above or scan a barcode to find foods</div>
  </div>
</div>

<!-- Manual Food Entry Modal -->
<div class="serving-modal" id="manual-food-modal">
  <div class="serving-card" style="max-width:420px">
    <div class="serving-food-name">CREATE CUSTOM FOOD</div>
    <div style="font-size:0.75rem;color:var(--dim);margin-bottom:16px">Saved to "My Foods" for future use</div>
    <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:16px">
      <input id="mf-name" placeholder="Food name *" style="padding:10px 12px;background:var(--card);border:1px solid var(--border);border-radius:9px;font-family:'Syne',sans-serif;font-size:0.85rem;color:var(--white);outline:none;">
      <input id="mf-serving" placeholder="Serving size (e.g. 1 cup, 100g)" style="padding:10px 12px;background:var(--card);border:1px solid var(--border);border-radius:9px;font-family:'Syne',sans-serif;font-size:0.85rem;color:var(--white);outline:none;">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div><div style="font-size:0.65rem;color:var(--green);font-weight:700;margin-bottom:4px">CALORIES</div><input id="mf-cal" type="number" placeholder="0" style="width:100%;padding:9px 10px;background:var(--card);border:1px solid var(--border);border-radius:9px;font-family:'Syne',sans-serif;font-size:0.85rem;color:var(--white);outline:none;box-sizing:border-box"></div>
        <div><div style="font-size:0.65rem;color:#60a5fa;font-weight:700;margin-bottom:4px">PROTEIN (g)</div><input id="mf-pro" type="number" placeholder="0" style="width:100%;padding:9px 10px;background:var(--card);border:1px solid var(--border);border-radius:9px;font-family:'Syne',sans-serif;font-size:0.85rem;color:var(--white);outline:none;box-sizing:border-box"></div>
        <div><div style="font-size:0.65rem;color:var(--orange);font-weight:700;margin-bottom:4px">CARBS (g)</div><input id="mf-carb" type="number" placeholder="0" style="width:100%;padding:9px 10px;background:var(--card);border:1px solid var(--border);border-radius:9px;font-family:'Syne',sans-serif;font-size:0.85rem;color:var(--white);outline:none;box-sizing:border-box"></div>
        <div><div style="font-size:0.65rem;color:#f472b6;font-weight:700;margin-bottom:4px">FAT (g)</div><input id="mf-fat" type="number" placeholder="0" style="width:100%;padding:9px 10px;background:var(--card);border:1px solid var(--border);border-radius:9px;font-family:'Syne',sans-serif;font-size:0.85rem;color:var(--white);outline:none;box-sizing:border-box"></div>
      </div>
    </div>
    <div class="serving-actions">
      <button class="btn-cancel-serving" onclick="closeManualFoodModal()">Cancel</button>
      <button class="btn-confirm-log" onclick="saveManualFood()">SAVE & LOG</button>
    </div>
  </div>
</div>

<!-- Serving Size Modal -->
<div class="serving-modal" id="serving-modal">
  <div class="serving-card">
    <div class="serving-food-name" id="sm-food-name">Food Name</div>
    <div style="font-size:0.78rem;color:var(--dim);margin-bottom:12px" id="sm-food-brand"></div>
    
    <!-- Quick serving buttons -->
    <div id="sm-quick-servings" style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap"></div>

    <!-- Macro display -->
    <div class="serving-macro-row">
      <div class="sm-chip"><div class="sm-val" id="sm-cal" style="color:var(--green)">0</div><div class="sm-label">Cal</div></div>
      <div class="sm-chip"><div class="sm-val" id="sm-pro" style="color:#60a5fa">0g</div><div class="sm-label">Protein</div></div>
      <div class="sm-chip"><div class="sm-val" id="sm-carb" style="color:var(--orange)">0g</div><div class="sm-label">Carbs</div></div>
      <div class="sm-chip"><div class="sm-val" id="sm-fat" style="color:#f472b6">0g</div><div class="sm-label">Fat</div></div>
    </div>
    <div style="font-size:0.7rem;color:var(--dim);text-align:center;margin-bottom:12px;font-family:'DM Mono',monospace" id="sm-per-note">Values shown for current amount</div>

    <!-- Custom amount -->
    <div style="font-size:0.72rem;color:var(--dim);font-weight:700;letter-spacing:1px;text-transform:uppercase;margin-bottom:6px">Custom Amount</div>
    <div class="serving-size-row">
      <input type="number" class="serving-size-input" id="sm-grams" value="100" min="0.1" step="0.1" oninput="updateServingCalc()" style="flex:1">
      <select id="sm-unit" onchange="updateServingCalc()" style="padding:9px 10px;background:var(--card);border:1px solid var(--border);border-radius:9px;font-family:'Inter',sans-serif;font-size:0.82rem;color:var(--white);outline:none;cursor:pointer">
        <option value="g">grams</option>
        <option value="oz">oz</option>
        <option value="ml">ml</option>
        <option value="serving">serving</option>
      </select>
    </div>
    <div class="serving-actions">
      <button class="btn-cancel-serving" onclick="closeServingModal()">Cancel</button>
      <button class="btn-confirm-log" onclick="confirmLogFood()">LOG IT</button>
    </div>
  </div>
</div>

<!-- Add Exercise Modal -->
<div class="add-ex-modal" id="add-ex-modal">
  <div class="add-ex-sheet" style="position:relative;overflow:hidden">
    <div class="aes-header">
      <div class="aes-title">ADD EXERCISE</div>
      <button class="aes-close" onclick="closeAddExModal()">✕</button>
    </div>
    <div class="aes-search">
      <input type="text" id="aes-search-input" placeholder="Search exercises..." oninput="filterExModal()">
    </div>
    <div class="aes-cats" id="aes-cats">
      <div class="aes-cat active" data-cat="All" onclick="selectExCat(this)">All</div>
    </div>
    <div class="aes-list" id="aes-list"></div>
  </div>
</div>

<!-- Dashboard Exercise Picker (Substitute / Add Superset) -->
<div class="add-ex-modal" id="dash-ex-picker-modal">
  <div class="add-ex-sheet">
    <div class="aes-header">
      <div class="aes-title" id="dash-ex-picker-title">CHOOSE EXERCISE</div>
      <button class="aes-close" onclick="closeDashExPicker()">✕</button>
    </div>
    <div class="aes-search">
      <input type="text" id="dash-ex-picker-search" placeholder="Search exercises..." oninput="filterDashExPicker()">
    </div>
    <div class="aes-filters" id="dash-ex-picker-filters">
      <button class="aes-filter-btn" id="aes-filter-muscle-btn" onclick="toggleAesDropdown('muscle',this)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12"><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>
        <span id="aes-filter-muscle-label">MUSCLE GROUP</span>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="10" height="10"><polyline points="6 9 12 15 18 9"/></svg>
      </button>
      <button class="aes-filter-btn" id="aes-filter-equip-btn" onclick="toggleAesDropdown('equip',this)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12"><rect x="11" y="5" width="2" height="14" rx="1"/><rect x="7" y="3" width="4" height="8" rx="1"/><rect x="13" y="3" width="4" height="8" rx="1"/><rect x="2" y="4" width="5" height="6" rx="1.5"/><rect x="17" y="4" width="5" height="6" rx="1.5"/></svg>
        <span id="aes-filter-equip-label">EQUIPMENT</span>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="10" height="10"><polyline points="6 9 12 15 18 9"/></svg>
      </button>
    </div>
    <div class="aes-list" id="dash-ex-picker-list"></div>
    <!-- Build mode: selected tray + begin button -->
    <div id="aes-build-tray" style="display:none;border-top:1px solid var(--border);padding:14px 16px;background:var(--dark)">
      <div id="aes-build-selected" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px;min-height:28px"></div>
      <button onclick="beginCustomWorkoutFromPicker()" id="aes-begin-btn" style="display:none;width:100%;padding:13px;background:var(--green);border:none;border-radius:10px;color:var(--black);font-family:'Bebas Neue',sans-serif;font-size:1rem;letter-spacing:2px;cursor:pointer">BEGIN WORKOUT →</button>
    </div>

    <!-- Quick config overlay — sets/reps/rest before adding to list -->
    <div id="aes-config-overlay" style="display:none;position:absolute;inset:0;background:rgba(0,0,0,0.92);border-radius:inherit;z-index:10;flex-direction:column;align-items:center;justify-content:center;padding:28px 24px">
      <div style="width:100%;max-width:320px">
        <div style="font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:2px;color:var(--white);margin-bottom:4px" id="aes-config-name">EXERCISE</div>
        <div style="font-size:0.72rem;color:var(--dim);margin-bottom:22px" id="aes-config-muscles"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:18px">
          <div>
            <div style="font-size:0.6rem;font-weight:700;letter-spacing:2px;color:var(--green);margin-bottom:7px">SETS</div>
            <div style="display:flex;align-items:center;border:1px solid var(--border);border-radius:10px;overflow:hidden;background:var(--card)">
              <button onclick="adjustAesConfig('sets',-1)" style="width:38px;height:44px;background:none;border:none;color:var(--white);font-size:1.3rem;cursor:pointer">−</button>
              <input id="aes-config-sets" type="number" min="1" max="10" style="flex:1;text-align:center;background:none;border:none;color:var(--white);font-family:'Bebas Neue',sans-serif;font-size:1.4rem;outline:none;width:0;padding:0">
              <button onclick="adjustAesConfig('sets',1)" style="width:38px;height:44px;background:none;border:none;color:var(--white);font-size:1.3rem;cursor:pointer">+</button>
            </div>
          </div>
          <div>
            <div style="font-size:0.6rem;font-weight:700;letter-spacing:2px;color:var(--green);margin-bottom:7px">REPS</div>
            <div style="display:flex;align-items:center;border:1px solid var(--border);border-radius:10px;overflow:hidden;background:var(--card)">
              <button onclick="adjustAesConfig('reps',-1)" style="width:38px;height:44px;background:none;border:none;color:var(--white);font-size:1.3rem;cursor:pointer">−</button>
              <input id="aes-config-reps" type="number" min="1" max="50" style="flex:1;text-align:center;background:none;border:none;color:var(--white);font-family:'Bebas Neue',sans-serif;font-size:1.4rem;outline:none;width:0;padding:0">
              <button onclick="adjustAesConfig('reps',1)" style="width:38px;height:44px;background:none;border:none;color:var(--white);font-size:1.3rem;cursor:pointer">+</button>
            </div>
          </div>
        </div>
        <div style="margin-bottom:22px">
          <div style="font-size:0.6rem;font-weight:700;letter-spacing:2px;color:var(--dim);margin-bottom:7px">REST (seconds)</div>
          <div style="display:flex;align-items:center;gap:8px">
            <button onclick="adjustAesConfig('rest',-15)" style="flex:1;padding:10px 0;background:var(--card);border:1px solid var(--border);border-radius:8px;color:var(--white);font-size:0.9rem;cursor:pointer">−15s</button>
            <div id="aes-config-rest-display" style="min-width:52px;text-align:center;font-family:'Bebas Neue',sans-serif;font-size:1.3rem;color:var(--white)">90s</div>
            <input id="aes-config-rest" type="hidden" value="90">
            <button onclick="adjustAesConfig('rest',15)" style="flex:1;padding:10px 0;background:var(--card);border:1px solid var(--border);border-radius:8px;color:var(--white);font-size:0.9rem;cursor:pointer">+15s</button>
          </div>
        </div>
        <div style="display:flex;gap:10px">
          <button onclick="closeAesConfig()" style="flex:1;padding:13px;background:none;border:1px solid var(--border);border-radius:10px;color:var(--dim);font-family:'Bebas Neue',sans-serif;font-size:0.9rem;letter-spacing:1px;cursor:pointer">CANCEL</button>
          <button onclick="confirmAesConfig()" style="flex:2;padding:13px;background:var(--green);border:none;border-radius:10px;color:var(--black);font-family:'Bebas Neue',sans-serif;font-size:1rem;letter-spacing:2px;cursor:pointer">ADD TO WORKOUT</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Rest Timer Overlay -->
<div class="rest-overlay" id="rest-overlay">
  <div class="rest-card">
    <div class="rest-label">REST TIME</div>
    <div class="rest-countdown" id="rest-countdown">90</div>
    <div class="rest-sub">seconds remaining</div>
    <button class="btn-skip-rest" onclick="skipRest()">Skip Rest →</button>
  </div>
</div>

<!-- ── SETS/REPS EDITOR MODAL ── -->
<div id="setrepedit-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.82);z-index:9500;align-items:center;justify-content:center;padding:20px" onclick="if(event.target===this)closeSetRepEditor()">
  <div style="background:var(--card);border:1px solid var(--border);border-radius:18px;padding:24px 22px;width:100%;max-width:340px" onclick="event.stopPropagation()">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
      <div style="font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:2px;color:var(--white)" id="sre-ex-name">EXERCISE</div>
      <button onclick="closeSetRepEditor()" style="background:none;border:none;color:var(--dim);font-size:1.2rem;cursor:pointer;padding:2px 6px">✕</button>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:18px">
      <div>
        <div style="font-size:0.6rem;font-weight:700;letter-spacing:2px;color:var(--green);margin-bottom:7px">SETS</div>
        <div style="display:flex;align-items:center;gap:0;border:1px solid var(--border);border-radius:10px;overflow:hidden;background:var(--dark)">
          <button onclick="adjustSRE('sets',-1)" style="width:38px;height:44px;background:none;border:none;color:var(--white);font-size:1.3rem;cursor:pointer;flex-shrink:0">−</button>
          <input id="sre-sets" type="number" min="1" max="10" style="flex:1;text-align:center;background:none;border:none;color:var(--white);font-family:'Bebas Neue',sans-serif;font-size:1.4rem;letter-spacing:1px;outline:none;width:0;padding:0">
          <button onclick="adjustSRE('sets',1)" style="width:38px;height:44px;background:none;border:none;color:var(--white);font-size:1.3rem;cursor:pointer;flex-shrink:0">+</button>
        </div>
      </div>
      <div>
        <div style="font-size:0.6rem;font-weight:700;letter-spacing:2px;color:var(--green);margin-bottom:7px">REPS</div>
        <div style="display:flex;align-items:center;gap:0;border:1px solid var(--border);border-radius:10px;overflow:hidden;background:var(--dark)">
          <button onclick="adjustSRE('reps',-1)" style="width:38px;height:44px;background:none;border:none;color:var(--white);font-size:1.3rem;cursor:pointer;flex-shrink:0">−</button>
          <input id="sre-reps" type="number" min="1" max="50" style="flex:1;text-align:center;background:none;border:none;color:var(--white);font-family:'Bebas Neue',sans-serif;font-size:1.4rem;letter-spacing:1px;outline:none;width:0;padding:0">
          <button onclick="adjustSRE('reps',1)" style="width:38px;height:44px;background:none;border:none;color:var(--white);font-size:1.3rem;cursor:pointer;flex-shrink:0">+</button>
        </div>
      </div>
    </div>
    <div style="margin-bottom:18px">
      <div style="font-size:0.6rem;font-weight:700;letter-spacing:2px;color:var(--dim);margin-bottom:7px">REST (seconds)</div>
      <div style="display:flex;align-items:center;gap:8px">
        <button onclick="adjustSRE('rest',-15)" style="padding:8px 14px;background:var(--dark);border:1px solid var(--border);border-radius:8px;color:var(--white);font-size:1rem;cursor:pointer">−15s</button>
        <div id="sre-rest-display" style="flex:1;text-align:center;font-family:'Bebas Neue',sans-serif;font-size:1.3rem;letter-spacing:1px;color:var(--white)">90s</div>
        <input id="sre-rest" type="hidden" value="90">
        <button onclick="adjustSRE('rest',15)" style="padding:8px 14px;background:var(--dark);border:1px solid var(--border);border-radius:8px;color:var(--white);font-size:1rem;cursor:pointer">+15s</button>
      </div>
    </div>
    <button onclick="applySetRepEdit()" style="width:100%;padding:13px;background:var(--green);border:none;border-radius:10px;color:var(--black);font-family:'Bebas Neue',sans-serif;font-size:1rem;letter-spacing:2px;cursor:pointer">APPLY</button>
  </div>
</div>

<!-- Modular JS -->

<script>
/* ═══════════════════════════════════════════ */
/* APP.JS — Exercise DB, State, Onboarding,    */
/*   Signup, Dashboard Init, Storage, API       */
/* ═══════════════════════════════════════════ */
// ═══════════════════════════════════════════
// APP.JS — Main App Initialization, Exercise DB,
//   State Management, Onboarding, Signup, Storage, API
// ═══════════════════════════════════════════

// ═══════════════════════════════════════════
// EXERCISE DATABASE — wger images (start/mid/end), categories, customizable
// Images from wger.de public API: /api/v2/exerciseimage/
// ═══════════════════════════════════════════

// wger exercise IDs map to their image URLs
// Format: { sets, reps, rest, muscles, category, wgerId }
// wger images: https://wger.de/en/exercise/{id}/view/name
// image base: https://wger.de/

const EXERCISE_DB = {
  // ── CHEST ──
  'Bench Press':           { sets:4, reps:'6-8',   rest:90, muscles:'Chest, Triceps, Shoulders', category:'Chest',     wgerId:192 },
  'Incline DB Press':      { sets:3, reps:'8-10',  rest:120, muscles:'Upper Chest, Triceps',       category:'Chest',     wgerId:211 },
  'Incline Barbell Press': { sets:4, reps:'6-8',   rest:90, muscles:'Upper Chest, Triceps',       category:'Chest',     wgerId:210 },
  'Dumbbell Bench Press':  { sets:3, reps:'8-10',  rest:120, muscles:'Chest, Triceps',             category:'Chest',     wgerId:97  },
  'Dumbbell Flyes':        { sets:3, reps:'10-12', rest:90,  muscles:'Chest',                      category:'Chest',     wgerId:28  },
  'Incline Dumbbell Flyes':{ sets:3, reps:'10-12', rest:90,  muscles:'Upper Chest',                category:'Chest',     wgerId:28  },
  'Cable Crossover':       { sets:3, reps:'12-15', rest:60,  muscles:'Chest, Anterior Delts',      category:'Chest',     wgerId:346 },
  'Push-Ups':              { sets:3, reps:'10-20', rest:60,  muscles:'Chest, Triceps, Shoulders',  category:'Chest',     wgerId:18  },
  'Diamond Push-Ups':      { sets:3, reps:'8-15',  rest:60,  muscles:'Triceps, Inner Chest',       category:'Chest',     wgerId:18  },
  'Decline Bench Press':   { sets:3, reps:'8-10',  rest:120, muscles:'Lower Chest, Triceps',       category:'Chest',     wgerId:213 },
  'Chest Dip':             { sets:3, reps:'8-12',  rest:90,  muscles:'Lower Chest, Triceps',       category:'Chest',     wgerId:37  },
  'Machine Chest Press':   { sets:3, reps:'10-12', rest:90,  muscles:'Chest, Triceps',             category:'Chest',     wgerId:null },
  'Pec Deck Machine':      { sets:3, reps:'12-15', rest:60,  muscles:'Chest',                      category:'Chest',     wgerId:null },
  'Landmine Press':        { sets:3, reps:'10-12', rest:90,  muscles:'Upper Chest, Shoulders',     category:'Chest',     wgerId:null },
  'Floor Press':           { sets:3, reps:'8-10',  rest:120, muscles:'Chest, Triceps',             category:'Chest',     wgerId:null },
  'Svend Press':           { sets:3, reps:'12-15', rest:60,  muscles:'Inner Chest',                category:'Chest',     wgerId:null },
  // ── BACK ──
  'Pull-Ups':              { sets:4, reps:'6-8',   rest:90, muscles:'Lats, Biceps, Rear Delts',   category:'Back',      wgerId:3   },
  'Chin-Ups':              { sets:3, reps:'6-10',  rest:120, muscles:'Lats, Biceps',               category:'Back',      wgerId:181 },
  'Barbell Row':           { sets:4, reps:'6-8',   rest:90, muscles:'Back, Biceps',               category:'Back',      wgerId:63  },
  'Pendlay Row':           { sets:4, reps:'5-8',   rest:90, muscles:'Back, Lats',                 category:'Back',      wgerId:63  },
  'Dumbbell Row':          { sets:3, reps:'8-12',  rest:90,  muscles:'Lats, Rhomboids, Biceps',    category:'Back',      wgerId:362 },
  'Lat Pulldown':          { sets:3, reps:'10-12', rest:90,  muscles:'Lats, Biceps',               category:'Back',      wgerId:122 },
  'Close-Grip Lat Pulldown':{ sets:3, reps:'10-12', rest:90, muscles:'Lats, Lower Back',           category:'Back',      wgerId:122 },
  'Cable Row':             { sets:3, reps:'10-12', rest:90,  muscles:'Mid Back, Biceps',           category:'Back',      wgerId:111 },
  'Seated Cable Row':      { sets:3, reps:'10-12', rest:90,  muscles:'Mid Back, Rhomboids',        category:'Back',      wgerId:111 },
  'Face Pulls':            { sets:3, reps:'15-20', rest:60,  muscles:'Rear Delts, Rotator Cuff',   category:'Back',      wgerId:313 },
  'Deadlift':              { sets:4, reps:'4-6',   rest:120, muscles:'Full Posterior Chain',        category:'Back',      wgerId:29  },
  'Conventional Deadlift': { sets:5, reps:'3-5',   rest:120, muscles:'Full Posterior Chain',        category:'Back',      wgerId:29  },
  'Sumo Deadlift':         { sets:4, reps:'4-6',   rest:120, muscles:'Glutes, Quads, Back',        category:'Back',      wgerId:29  },
  'Rack Pull':             { sets:3, reps:'5-8',   rest:90, muscles:'Upper Back, Traps, Glutes',  category:'Back',      wgerId:null },
  'T-Bar Row':             { sets:3, reps:'8-10',  rest:120, muscles:'Mid Back, Lats',             category:'Back',      wgerId:227 },
  'Hyperextensions':       { sets:3, reps:'12-15', rest:60,  muscles:'Lower Back, Glutes',         category:'Back',      wgerId:88  },
  'Meadows Row':           { sets:3, reps:'8-12',  rest:90,  muscles:'Lats, Rear Delts',           category:'Back',      wgerId:null },
  'Chest-Supported Row':   { sets:3, reps:'10-12', rest:90,  muscles:'Mid Back, Rear Delts',       category:'Back',      wgerId:null },
  'Straight-Arm Pulldown': { sets:3, reps:'12-15', rest:60,  muscles:'Lats',                       category:'Back',      wgerId:null },
  'Inverted Row':          { sets:3, reps:'8-15',  rest:60,  muscles:'Back, Biceps',               category:'Back',      wgerId:null },
  'Pullover':              { sets:3, reps:'10-12', rest:90,  muscles:'Lats, Chest, Serratus',      category:'Back',      wgerId:99  },
  'Shrugs':                { sets:3, reps:'12-15', rest:60,  muscles:'Traps',                      category:'Back',      wgerId:null },
  'Barbell Shrugs':        { sets:4, reps:'10-12', rest:90,  muscles:'Traps, Upper Back',          category:'Back',      wgerId:150 },
  // ── SHOULDERS ──
  'Shoulder Press':        { sets:3, reps:'8-10',  rest:120, muscles:'Shoulders, Triceps',         category:'Shoulders', wgerId:73  },
  'Overhead Press':        { sets:4, reps:'5-8',   rest:90, muscles:'Shoulders, Triceps, Core',   category:'Shoulders', wgerId:256 },
  'Dumbbell Shoulder Press':{ sets:3, reps:'8-10', rest:120, muscles:'Shoulders, Triceps',         category:'Shoulders', wgerId:73  },
  'Arnold Press':          { sets:3, reps:'10-12', rest:90,  muscles:'Shoulders (all heads)',       category:'Shoulders', wgerId:116 },
  'Lateral Raises':        { sets:3, reps:'12-15', rest:60,  muscles:'Side Delts',                 category:'Shoulders', wgerId:72  },
  'Cable Lateral Raise':   { sets:3, reps:'12-15', rest:60,  muscles:'Side Delts',                 category:'Shoulders', wgerId:72  },
  'Front Raises':          { sets:3, reps:'12-15', rest:60,  muscles:'Front Delts',                category:'Shoulders', wgerId:74  },
  'Upright Row':           { sets:3, reps:'10-12', rest:90,  muscles:'Shoulders, Traps',           category:'Shoulders', wgerId:75  },
  'Rear Delt Fly':         { sets:3, reps:'15-20', rest:60,  muscles:'Rear Delts',                 category:'Shoulders', wgerId:314 },
  'Reverse Pec Deck':      { sets:3, reps:'12-15', rest:60,  muscles:'Rear Delts',                 category:'Shoulders', wgerId:null },
  'Machine Shoulder Press': { sets:3, reps:'10-12', rest:90, muscles:'Shoulders, Triceps',         category:'Shoulders', wgerId:null },
  'Push Press':            { sets:3, reps:'5-8',   rest:90, muscles:'Shoulders, Triceps, Legs',   category:'Shoulders', wgerId:null },
  'Lu Raises':             { sets:3, reps:'10-12', rest:60,  muscles:'Front/Side Delts',           category:'Shoulders', wgerId:null },
  'Bradford Press':        { sets:3, reps:'8-10',  rest:90,  muscles:'Shoulders (all heads)',       category:'Shoulders', wgerId:null },
  'Cable Face Pull':       { sets:3, reps:'15-20', rest:60,  muscles:'Rear Delts, Rotator Cuff',   category:'Shoulders', wgerId:313 },
  // ── ARMS: BICEPS ──
  'Barbell Curl':          { sets:3, reps:'10-12', rest:60,  muscles:'Biceps',                     category:'Biceps',      wgerId:48  },
  'EZ Bar Curl':           { sets:3, reps:'10-12', rest:60,  muscles:'Biceps',                     category:'Biceps',      wgerId:48  },
  'Dumbbell Curl':         { sets:3, reps:'10-12', rest:60,  muscles:'Biceps',                     category:'Biceps',      wgerId:81  },
  'Hammer Curls':          { sets:3, reps:'10-12', rest:60,  muscles:'Biceps, Brachialis',         category:'Biceps',      wgerId:396 },
  'Incline DB Curl':       { sets:3, reps:'10-12', rest:60,  muscles:'Biceps (long head)',         category:'Biceps',      wgerId:218 },
  'Preacher Curl':         { sets:3, reps:'10-12', rest:60,  muscles:'Biceps (short head)',        category:'Biceps',      wgerId:175 },
  'Concentration Curl':    { sets:3, reps:'10-12', rest:60,  muscles:'Biceps (peak)',              category:'Biceps',      wgerId:52  },
  'Cable Curl':            { sets:3, reps:'12-15', rest:60,  muscles:'Biceps',                     category:'Biceps',      wgerId:null },
  'Spider Curl':           { sets:3, reps:'10-12', rest:60,  muscles:'Biceps (short head)',        category:'Biceps',      wgerId:null },
  'Reverse Curl':          { sets:3, reps:'12-15', rest:60,  muscles:'Forearms, Brachioradialis',  category:'Biceps',      wgerId:null },
  'Wrist Curls':           { sets:3, reps:'15-20', rest:45,  muscles:'Forearms',                   category:'Biceps',      wgerId:null },
  'Reverse Wrist Curls':   { sets:3, reps:'15-20', rest:45,  muscles:'Forearm Extensors',          category:'Biceps',      wgerId:null },
  'Zottman Curl':          { sets:3, reps:'10-12', rest:60,  muscles:'Biceps, Forearms',           category:'Biceps',      wgerId:null },
  // ── ARMS: TRICEPS ──
  'Tricep Dips':           { sets:3, reps:'10-12', rest:90,  muscles:'Triceps, Chest',             category:'Triceps',      wgerId:37  },
  'Tricep Pushdown':       { sets:3, reps:'12-15', rest:60,  muscles:'Triceps',                    category:'Triceps',      wgerId:26  },
  'Rope Pushdown':         { sets:3, reps:'12-15', rest:60,  muscles:'Triceps (lateral head)',     category:'Triceps',      wgerId:26  },
  'Skull Crushers':        { sets:3, reps:'10-12', rest:90,  muscles:'Triceps',                    category:'Triceps',      wgerId:25  },
  'Close Grip Bench':      { sets:3, reps:'8-10',  rest:120, muscles:'Triceps, Chest',             category:'Triceps',      wgerId:358 },
  'Overhead Tricep Extension': { sets:3, reps:'10-12', rest:60, muscles:'Triceps (long head)',     category:'Triceps',      wgerId:null },
  'Kickbacks':             { sets:3, reps:'12-15', rest:60,  muscles:'Triceps',                    category:'Triceps',      wgerId:null },
  'Diamond Push-Up':       { sets:3, reps:'10-15', rest:60,  muscles:'Triceps, Inner Chest',       category:'Triceps',      wgerId:null },
  'JM Press':              { sets:3, reps:'8-10',  rest:90,  muscles:'Triceps',                    category:'Triceps',      wgerId:null },
  // ── LEGS: QUADS ──
  'Back Squat':            { sets:4, reps:'5-8',   rest:90, muscles:'Quads, Glutes, Core',        category:'Legs',      wgerId:6   },
  'Front Squat':           { sets:4, reps:'6-8',   rest:90, muscles:'Quads, Core',                category:'Legs',      wgerId:null },
  'Goblet Squat':          { sets:3, reps:'10-15', rest:90,  muscles:'Quads, Glutes, Core',        category:'Legs',      wgerId:197 },
  'Hack Squat':            { sets:3, reps:'8-12',  rest:120, muscles:'Quads, Glutes',              category:'Legs',      wgerId:null },
  'Leg Press':             { sets:3, reps:'10-12', rest:120, muscles:'Quads, Glutes',              category:'Legs',      wgerId:45  },
  'Leg Extension':         { sets:3, reps:'12-15', rest:60,  muscles:'Quads',                      category:'Legs',      wgerId:41  },
  'Sissy Squat':           { sets:3, reps:'10-15', rest:60,  muscles:'Quads',                      category:'Legs',      wgerId:null },
  'Wall Sit':              { sets:3, reps:'30-60s', rest:60, muscles:'Quads, Glutes',              category:'Legs',      wgerId:null },
  'Box Squat':             { sets:4, reps:'5-8',   rest:90, muscles:'Quads, Glutes, Hips',        category:'Legs',      wgerId:null },
  'Smith Machine Squat':   { sets:3, reps:'8-12',  rest:120, muscles:'Quads, Glutes',              category:'Legs',      wgerId:null },
  // ── LEGS: HAMSTRINGS & GLUTES ──
  'Romanian Deadlift':     { sets:3, reps:'8-10',  rest:120, muscles:'Hamstrings, Glutes',         category:'Legs',      wgerId:113 },
  'Stiff-Leg Deadlift':    { sets:3, reps:'8-10',  rest:120, muscles:'Hamstrings, Lower Back',     category:'Legs',      wgerId:113 },
  'Leg Curl':              { sets:3, reps:'12-15', rest:60,  muscles:'Hamstrings',                 category:'Legs',      wgerId:42  },
  'Seated Leg Curl':       { sets:3, reps:'12-15', rest:60,  muscles:'Hamstrings',                 category:'Legs',      wgerId:42  },
  'Nordic Curl':           { sets:3, reps:'5-8',   rest:120, muscles:'Hamstrings',                 category:'Legs',      wgerId:null },
  'Good Mornings':         { sets:3, reps:'10-12', rest:90,  muscles:'Hamstrings, Lower Back',     category:'Legs',      wgerId:null },
  'Hip Thrust':            { sets:3, reps:'10-12', rest:90,  muscles:'Glutes, Hamstrings',         category:'Legs',      wgerId:332 },
  'Hip Thrusts':           { sets:3, reps:'10-12', rest:90,  muscles:'Glutes, Hamstrings',         category:'Legs',      wgerId:332 },
  'Glute Bridge':          { sets:3, reps:'15-20', rest:60,  muscles:'Glutes, Core',               category:'Legs',      wgerId:104 },
  'Cable Pull-Through':    { sets:3, reps:'12-15', rest:60,  muscles:'Glutes, Hamstrings',         category:'Legs',      wgerId:null },
  'Glute Kickback':        { sets:3, reps:'12-15', rest:60,  muscles:'Glutes',                     category:'Legs',      wgerId:null },
  'Reverse Lunge':         { sets:3, reps:'10/leg', rest:90, muscles:'Quads, Glutes',              category:'Legs',      wgerId:null },
  // ── LEGS: COMPOUND / FULL LEG ──
  'Lunges':                { sets:3, reps:'10/leg', rest:90, muscles:'Quads, Glutes, Hamstrings',  category:'Legs',      wgerId:19  },
  'Walking Lunges':        { sets:3, reps:'10 each', rest:60,muscles:'Quads, Glutes',              category:'Legs',      wgerId:19  },
  'Bulgarian Split Squat': { sets:3, reps:'8-10/leg',rest:120,muscles:'Quads, Glutes',             category:'Legs',      wgerId:399 },
  'Step-Ups':              { sets:3, reps:'10/leg', rest:60, muscles:'Quads, Glutes',              category:'Legs',      wgerId:null },
  'Pistol Squat':          { sets:3, reps:'5-8/leg',rest:120,muscles:'Quads, Glutes, Balance',     category:'Legs',      wgerId:null },
  'Calf Raises':           { sets:4, reps:'15-20', rest:60,  muscles:'Calves',                     category:'Legs',      wgerId:33  },
  'Seated Calf Raises':    { sets:4, reps:'15-20', rest:60,  muscles:'Soleus, Calves',             category:'Legs',      wgerId:null },
  'Donkey Calf Raises':    { sets:3, reps:'15-20', rest:60,  muscles:'Calves',                     category:'Legs',      wgerId:null },
  'Tibialis Raise':        { sets:3, reps:'15-20', rest:45,  muscles:'Tibialis Anterior',          category:'Legs',      wgerId:null },
  'Adductor Machine':      { sets:3, reps:'12-15', rest:60,  muscles:'Inner Thighs',               category:'Legs',      wgerId:null },
  'Abductor Machine':      { sets:3, reps:'12-15', rest:60,  muscles:'Outer Glutes',               category:'Legs',      wgerId:null },
  // ── CORE ──
  'Plank':                 { sets:3, reps:'30-60s', rest:60, muscles:'Core, Stability',            category:'Core',      wgerId:105 },
  'Side Plank':            { sets:3, reps:'30s/side',rest:60,muscles:'Obliques, Core',             category:'Core',      wgerId:null },
  'Dead Bug':              { sets:3, reps:'10/side', rest:60,muscles:'Core, Lower Back',           category:'Core',      wgerId:336 },
  'Bird Dog':              { sets:3, reps:'10/side', rest:60,muscles:'Core, Glutes',               category:'Core',      wgerId:337 },
  'Cable Crunch':          { sets:3, reps:'12-15', rest:60,  muscles:'Abs',                        category:'Core',      wgerId:168 },
  'Hanging Leg Raise':     { sets:3, reps:'10-15', rest:60,  muscles:'Abs, Hip Flexors',           category:'Core',      wgerId:56  },
  'Ab Wheel Rollout':      { sets:3, reps:'8-12',  rest:90,  muscles:'Core, Shoulders',            category:'Core',      wgerId:329 },
  'Russian Twist':         { sets:3, reps:'20 total',rest:60,muscles:'Obliques, Abs',              category:'Core',      wgerId:154 },
  'Bicycle Crunch':        { sets:3, reps:'20 total',rest:60,muscles:'Abs, Obliques',              category:'Core',      wgerId:null },
  'V-Ups':                 { sets:3, reps:'12-15', rest:60,  muscles:'Abs, Hip Flexors',           category:'Core',      wgerId:null },
  'Mountain Climbers':     { sets:3, reps:'30s',   rest:30,  muscles:'Core, Cardio',               category:'Core',      wgerId:null },
  'Pallof Press':          { sets:3, reps:'10/side', rest:60,muscles:'Core, Anti-Rotation',        category:'Core',      wgerId:null },
  'Dragon Flag':           { sets:3, reps:'5-8',   rest:90,  muscles:'Abs, Full Core',             category:'Core',      wgerId:null },
  'L-Sit':                 { sets:3, reps:'15-30s', rest:60, muscles:'Abs, Hip Flexors',           category:'Core',      wgerId:null },
  'Decline Sit-Up':        { sets:3, reps:'12-20', rest:60,  muscles:'Abs',                        category:'Core',      wgerId:null },
  'Woodchoppers':          { sets:3, reps:'12/side',rest:60, muscles:'Obliques, Core',             category:'Core',      wgerId:null },
  'Weighted Crunch':       { sets:3, reps:'12-15', rest:60,  muscles:'Abs',                        category:'Core',      wgerId:null },
  'Farmer Walk':           { sets:3, reps:'40m',   rest:90,  muscles:'Core, Grip, Traps',          category:'Core',      wgerId:null },
  'Suitcase Carry':        { sets:3, reps:'40m/side',rest:90,muscles:'Obliques, Core, Grip',       category:'Core',      wgerId:null },
  // ── CARDIO / CONDITIONING ──
  'Brisk Walk':            { sets:1, reps:'20-30 min',rest:0,muscles:'Cardio, Endurance',          category:'Cardio',    wgerId:null },
  'Brisk Walk / Cardio':   { sets:1, reps:'20-30 min',rest:0,muscles:'Cardio, Endurance',          category:'Cardio',    wgerId:null },
  'HIIT Intervals':        { sets:1, reps:'20 min',  rest:0, muscles:'Full Body, Cardio',          category:'Cardio',    wgerId:null },
  'Jump Rope':             { sets:3, reps:'3 min',   rest:60,muscles:'Cardio, Calves, Shoulders',  category:'Cardio',    wgerId:null },
  'Rowing Machine':        { sets:1, reps:'20 min',  rest:0, muscles:'Full Body, Cardio',          category:'Cardio',    wgerId:null },
  'Stair Climber':         { sets:1, reps:'20 min',  rest:0, muscles:'Legs, Cardio',               category:'Cardio',    wgerId:null },
  'Battle Ropes':          { sets:3, reps:'30s',   rest:60,  muscles:'Full Body, Cardio',          category:'Cardio',    wgerId:null },
  'Box Jumps':             { sets:3, reps:'8-12',  rest:90,  muscles:'Legs, Explosiveness',        category:'Cardio',    wgerId:null },
  'Burpees':               { sets:3, reps:'10-15', rest:60,  muscles:'Full Body, Cardio',          category:'Cardio',    wgerId:null },
  'Sled Push':             { sets:3, reps:'40m',   rest:120, muscles:'Legs, Core, Cardio',         category:'Cardio',    wgerId:null },
  'Kettlebell Swing':      { sets:3, reps:'15-20', rest:60,  muscles:'Glutes, Hips, Cardio',       category:'Cardio',    wgerId:null },
  'Assault Bike':          { sets:1, reps:'20 min',  rest:0, muscles:'Full Body, Cardio',          category:'Cardio',    wgerId:null },
  'Sprint Intervals':      { sets:6, reps:'30s on/60s off', rest:60, muscles:'Legs, Cardio',       category:'Cardio',    wgerId:null },

  // ── CHEST (additional) ──
  'Low Cable Fly':           { sets:3, reps:'12-15', rest:60,  muscles:'Upper Chest',                category:'Chest',     wgerId:null },
  'High Cable Fly':          { sets:3, reps:'12-15', rest:60,  muscles:'Lower Chest',                category:'Chest',     wgerId:null },
  'Guillotine Press':        { sets:3, reps:'8-10',  rest:120, muscles:'Upper Chest, Triceps',       category:'Chest',     wgerId:null },
  'Reverse Grip Bench Press':{ sets:3, reps:'8-10',  rest:120, muscles:'Upper Chest, Triceps',       category:'Chest',     wgerId:null },
  'Dumbbell Pullover':       { sets:3, reps:'10-12', rest:90,  muscles:'Chest, Lats',                category:'Chest',     wgerId:null },
  'Squeeze Press':           { sets:3, reps:'10-12', rest:90,  muscles:'Inner Chest',                category:'Chest',     wgerId:null },
  'Hex Press':               { sets:3, reps:'10-12', rest:90,  muscles:'Inner Chest, Triceps',       category:'Chest',     wgerId:null },
  'Pin Press':               { sets:3, reps:'5-8',   rest:120, muscles:'Chest, Triceps',             category:'Chest',     wgerId:null },
  'Board Press':             { sets:3, reps:'5-8',   rest:120, muscles:'Chest, Triceps',             category:'Chest',     wgerId:null },
  'Smith Machine Bench':     { sets:3, reps:'8-10',  rest:90,  muscles:'Chest, Triceps',             category:'Chest',     wgerId:null },

  // ── BACK (additional) ──
  'Kroc Row':                { sets:2, reps:'20-25', rest:120, muscles:'Lats, Traps, Grip',          category:'Back',      wgerId:null },
  'Yates Row':               { sets:4, reps:'6-10',  rest:90,  muscles:'Mid Back, Biceps',           category:'Back',      wgerId:null },
  'Seal Row':                { sets:3, reps:'8-12',  rest:90,  muscles:'Mid Back, Rhomboids',        category:'Back',      wgerId:null },
  'Banded Pull-Apart':       { sets:3, reps:'15-20', rest:45,  muscles:'Rear Delts, Rhomboids',      category:'Back',      wgerId:null },
  'Trap Bar Deadlift':       { sets:4, reps:'5-6',   rest:120, muscles:'Full Posterior Chain',       category:'Back',      wgerId:null },
  'Deficit Deadlift':        { sets:3, reps:'4-6',   rest:120, muscles:'Full Posterior Chain',       category:'Back',      wgerId:null },
  'Romanian Deadlift (DB)':  { sets:3, reps:'10-12', rest:90,  muscles:'Hamstrings, Glutes',         category:'Back',      wgerId:null },
  'Underhand Barbell Row':   { sets:3, reps:'8-10',  rest:90,  muscles:'Lats, Lower Back, Biceps',   category:'Back',      wgerId:null },
  'Wide-Grip Lat Pulldown':  { sets:3, reps:'10-12', rest:90,  muscles:'Lats, Teres Major',          category:'Back',      wgerId:null },
  'Reverse-Grip Lat Pulldown':{ sets:3, reps:'10-12',rest:90,  muscles:'Lats, Biceps',               category:'Back',      wgerId:null },
  'Low Row Machine':         { sets:3, reps:'10-12', rest:90,  muscles:'Mid Back, Lats',             category:'Back',      wgerId:null },
  'High Row Machine':        { sets:3, reps:'10-12', rest:90,  muscles:'Upper Back, Rear Delts',     category:'Back',      wgerId:null },

  // ── SHOULDERS (additional) ──
  'Z Press':                 { sets:3, reps:'8-10',  rest:90,  muscles:'Shoulders, Core',            category:'Shoulders', wgerId:null },
  'Prone Y-T-W Raises':      { sets:3, reps:'10-12', rest:60,  muscles:'Lower Traps, Rear Delts',    category:'Shoulders', wgerId:null },
  'Band Pull-Apart':         { sets:3, reps:'20-25', rest:30,  muscles:'Rear Delts, Rhomboids',      category:'Shoulders', wgerId:null },
  'Plate Raise':             { sets:3, reps:'12-15', rest:60,  muscles:'Front Delts, Traps',         category:'Shoulders', wgerId:null },
  'Dumbbell Shrug':          { sets:3, reps:'12-15', rest:60,  muscles:'Traps',                      category:'Shoulders', wgerId:null },
  'Snatch-Grip Press':       { sets:3, reps:'8-10',  rest:90,  muscles:'Shoulders, Upper Back',      category:'Shoulders', wgerId:null },
  'Seated DB Press':         { sets:3, reps:'8-12',  rest:90,  muscles:'Shoulders, Triceps',         category:'Shoulders', wgerId:null },
  'Single-Arm DB Press':     { sets:3, reps:'10-12', rest:90,  muscles:'Shoulders, Core',            category:'Shoulders', wgerId:null },
  'Cuban Press':             { sets:3, reps:'10-12', rest:60,  muscles:'Rotator Cuff, Shoulders',    category:'Shoulders', wgerId:null },
  'Crucifix Hold':           { sets:3, reps:'20-30s',rest:60,  muscles:'Side Delts, Traps',          category:'Shoulders', wgerId:null },

  // ── ARMS (additional) ──
  'Bayesian Curl':           { sets:3, reps:'10-12', rest:60,  muscles:'Biceps (long head)',         category:'Biceps',      wgerId:null },
  'Cross-Body Hammer Curl':  { sets:3, reps:'10-12', rest:60,  muscles:'Brachialis, Brachioradialis',category:'Biceps',      wgerId:null },
  'Wide-Grip Curl':          { sets:3, reps:'10-12', rest:60,  muscles:'Biceps (short head)',        category:'Biceps',      wgerId:null },
  'Drag Curl':               { sets:3, reps:'10-12', rest:60,  muscles:'Biceps (long head)',         category:'Biceps',      wgerId:null },
  '21s Curl':                { sets:3, reps:'21',    rest:90,  muscles:'Biceps (full)',              category:'Biceps',      wgerId:null },
  'Cable Hammer Curl':       { sets:3, reps:'12-15', rest:60,  muscles:'Brachialis',                 category:'Biceps',      wgerId:null },
  'Behind-the-Back Cable Curl':{ sets:3, reps:'12-15',rest:60, muscles:'Biceps (long head)',         category:'Biceps',      wgerId:null },
  'Tate Press':              { sets:3, reps:'10-12', rest:60,  muscles:'Triceps (medial head)',      category:'Triceps',      wgerId:null },
  'Lying Tricep Extension':  { sets:3, reps:'10-12', rest:90,  muscles:'Triceps',                    category:'Triceps',      wgerId:null },
  'Single-Arm Cable Pushdown':{ sets:3, reps:'12-15',rest:60,  muscles:'Triceps (lateral head)',     category:'Triceps',      wgerId:null },
  'Single-Arm Overhead Ext': { sets:3, reps:'10-12', rest:60,  muscles:'Triceps (long head)',        category:'Triceps',      wgerId:null },
  'Tricep Dip Machine':      { sets:3, reps:'10-12', rest:90,  muscles:'Triceps',                    category:'Triceps',      wgerId:null },
  'Reverse-Grip Pushdown':   { sets:3, reps:'12-15', rest:60,  muscles:'Triceps (medial head)',      category:'Triceps',      wgerId:null },
  'Band Tricep Pushdown':    { sets:3, reps:'15-20', rest:45,  muscles:'Triceps',                    category:'Triceps',      wgerId:null },

  // ── LEGS (additional) ──
  'Pause Squat':             { sets:4, reps:'4-6',   rest:120, muscles:'Quads, Glutes, Core',        category:'Legs',      wgerId:null },
  'Tempo Squat':             { sets:3, reps:'6-8',   rest:120, muscles:'Quads, Glutes',              category:'Legs',      wgerId:null },
  'Safety Bar Squat':        { sets:4, reps:'5-8',   rest:90,  muscles:'Quads, Glutes, Core',        category:'Legs',      wgerId:null },
  'Zercher Squat':           { sets:3, reps:'6-8',   rest:120, muscles:'Quads, Glutes, Core',        category:'Legs',      wgerId:null },
  'Leg Press (Close Foot)':  { sets:3, reps:'10-12', rest:90,  muscles:'Quads',                      category:'Legs',      wgerId:null },
  'Leg Press (Wide Foot)':   { sets:3, reps:'10-12', rest:90,  muscles:'Glutes, Inner Thighs',       category:'Legs',      wgerId:null },
  'Single-Leg Leg Press':    { sets:3, reps:'10-12/leg',rest:90,muscles:'Quads, Glutes',             category:'Legs',      wgerId:null },
  'Pendulum Squat':          { sets:3, reps:'10-12', rest:90,  muscles:'Quads, Glutes',              category:'Legs',      wgerId:null },
  'Lying Leg Curl':          { sets:3, reps:'12-15', rest:60,  muscles:'Hamstrings',                 category:'Legs',      wgerId:null },
  'Single-Leg Leg Curl':     { sets:3, reps:'12-15/leg',rest:60,muscles:'Hamstrings',                category:'Legs',      wgerId:null },
  'Glute-Ham Raise':         { sets:3, reps:'6-10',  rest:90,  muscles:'Hamstrings, Glutes',         category:'Legs',      wgerId:null },
  'Frog Pump':               { sets:3, reps:'15-20', rest:45,  muscles:'Glutes',                     category:'Legs',      wgerId:null },
  'Single-Leg Hip Thrust':   { sets:3, reps:'10-12/leg',rest:60,muscles:'Glutes, Hamstrings',        category:'Legs',      wgerId:null },
  'Cable Kickback':          { sets:3, reps:'15/leg', rest:45, muscles:'Glutes',                     category:'Legs',      wgerId:null },
  'Sumo Squat':              { sets:3, reps:'10-12', rest:90,  muscles:'Glutes, Inner Thighs, Quads',category:'Legs',      wgerId:null },
  'Curtsy Lunge':            { sets:3, reps:'10/leg', rest:60, muscles:'Glutes, Quads',              category:'Legs',      wgerId:null },
  'Lateral Lunge':           { sets:3, reps:'10/leg', rest:60, muscles:'Quads, Glutes, Adductors',   category:'Legs',      wgerId:null },
  'Jump Squat':              { sets:3, reps:'10-12', rest:60,  muscles:'Quads, Glutes, Explosive',   category:'Legs',      wgerId:null },
  'Broad Jump':              { sets:4, reps:'5',     rest:90,  muscles:'Glutes, Quads, Explosive',   category:'Legs',      wgerId:null },
  'Standing Calf Raise Machine':{ sets:4, reps:'15-20',rest:60,muscles:'Calves (gastrocnemius)',      category:'Legs',      wgerId:null },

  // ── CORE (additional) ──
  'Hollow Hold':             { sets:3, reps:'20-40s', rest:60, muscles:'Abs, Hip Flexors',           category:'Core',      wgerId:null },
  'Hollow Rock':             { sets:3, reps:'10-15', rest:60,  muscles:'Abs, Hip Flexors',           category:'Core',      wgerId:null },
  'Superman Hold':           { sets:3, reps:'10-15', rest:60,  muscles:'Lower Back, Glutes',         category:'Core',      wgerId:null },
  'Copenhagen Plank':        { sets:3, reps:'20-30s/side',rest:60,muscles:'Adductors, Core',         category:'Core',      wgerId:null },
  'Stir the Pot':            { sets:3, reps:'10/direction',rest:60,muscles:'Core, Stability',        category:'Core',      wgerId:null },
  'Cable Woodchop':          { sets:3, reps:'12/side', rest:60,muscles:'Obliques, Core',             category:'Core',      wgerId:null },
  'Landmine Rotation':       { sets:3, reps:'10/side', rest:60,muscles:'Obliques, Core, Shoulders',  category:'Core',      wgerId:null },
  'GHD Sit-Up':              { sets:3, reps:'10-15', rest:60,  muscles:'Abs, Hip Flexors',           category:'Core',      wgerId:null },
  'Toes to Bar':             { sets:3, reps:'8-12',  rest:60,  muscles:'Abs, Lats',                  category:'Core',      wgerId:null },
  'Knee Raise':              { sets:3, reps:'12-15', rest:60,  muscles:'Abs, Hip Flexors',           category:'Core',      wgerId:null },
  'Cable Oblique Crunch':    { sets:3, reps:'12/side', rest:60,muscles:'Obliques',                   category:'Core',      wgerId:null },
  'Windshield Wipers':       { sets:3, reps:'8-12',  rest:60,  muscles:'Obliques, Abs',              category:'Core',      wgerId:null },
  'Reverse Crunch':          { sets:3, reps:'12-15', rest:60,  muscles:'Lower Abs',                  category:'Core',      wgerId:null },
  'Toe Touch Crunch':        { sets:3, reps:'15-20', rest:45,  muscles:'Upper Abs',                  category:'Core',      wgerId:null },
  'McGill Crunch':           { sets:3, reps:'10/side', rest:45,muscles:'Abs, Spine Stability',       category:'Core',      wgerId:null },

  // ── CARDIO (additional) ──
  'Elliptical':              { sets:1, reps:'20-30 min',rest:0, muscles:'Full Body, Cardio',         category:'Cardio',    wgerId:null },
  'Cycling':                 { sets:1, reps:'20-45 min',rest:0, muscles:'Legs, Cardio',              category:'Cardio',    wgerId:null },
  'Swimming Laps':           { sets:1, reps:'20-30 min',rest:0, muscles:'Full Body, Cardio',         category:'Cardio',    wgerId:null },
  'Treadmill Run':           { sets:1, reps:'20-30 min',rest:0, muscles:'Cardio, Legs',              category:'Cardio',    wgerId:null },
  'Incline Walk':            { sets:1, reps:'20-30 min',rest:0, muscles:'Glutes, Cardio',            category:'Cardio',    wgerId:null },
  'Tabata':                  { sets:8, reps:'20s on/10s off',rest:10,muscles:'Full Body, Cardio',    category:'Cardio',    wgerId:null },
  'Prowler Push':            { sets:4, reps:'30m',   rest:120, muscles:'Legs, Core, Cardio',         category:'Cardio',    wgerId:null },
  'Medicine Ball Slam':      { sets:3, reps:'10-12', rest:60,  muscles:'Full Body, Power',           category:'Cardio',    wgerId:null },
  'Tire Flip':               { sets:3, reps:'8-10',  rest:120, muscles:'Full Body, Power',           category:'Cardio',    wgerId:null },
  'Clean and Press':         { sets:4, reps:'5-6',   rest:120, muscles:'Full Body, Power',           category:'Cardio',    wgerId:null },
  'Dumbbell Thruster':       { sets:3, reps:'10-12', rest:90,  muscles:'Legs, Shoulders, Cardio',    category:'Cardio',    wgerId:null },
  'Sandbag Carry':           { sets:3, reps:'40m',   rest:90,  muscles:'Full Body, Grip, Cardio',    category:'Cardio',    wgerId:null },
};

const EXERCISE_CATEGORIES = ['Chest','Back','Shoulders','Biceps','Triceps','Legs','Core','Cardio'];

function getExerciseData(name) {
  if (EXERCISE_DB[name]) return EXERCISE_DB[name];
  const key = Object.keys(EXERCISE_DB).find(k =>
    name.toLowerCase().includes(k.toLowerCase()) ||
    k.toLowerCase().includes(name.toLowerCase().split(' ')[0])
  );
  return key ? EXERCISE_DB[key] : { sets:3, reps:'8-12', rest:90, muscles:'Multiple muscle groups', category:'Other', wgerId:null };
}

// wger image URL builder — returns array of image URLs for an exercise
function getExerciseImages(wgerId) {
  if (!wgerId) return null;
  // wger hosts exercise images at this pattern
  return {
    start: `https://wger.de/en/exercise/${wgerId}/view/exercise`,
    // Use wger's exerciseimage API for actual images
    api: `https://wger.de/api/v2/exerciseimage/?exercise=${wgerId}&format=json`
  };
}

// ═══════════════════════════════════════════
// ONBOARDING STATE
// ═══════════════════════════════════════════
let currentTier = 'beginner';
let selectedSplit = 'ppl';
let selectedWeeks = 16;
let generatedPlan = null;
let USER = {};

const DAYS_SHORT = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
const DAYS_FULL  = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
const TODAY_IDX  = new Date().getDay() === 0 ? 6 : new Date().getDay() - 1;

const tierConfig = {
  beginner: {
    color:'var(--green)', badge:'● Beginner', badgeClass:'',
    sidebarLabel:'What You Get — Beginner',
    features:['Low-impact cardio & bodyweight exercises','No equipment required — home-friendly','Habit-building focus, short sessions','Macro guidance & calorie targets','Recovery and mobility basics']
  },
  intermediate: {
    color:'var(--orange)', badge:'◆ Intermediate', badgeClass:'intermediate',
    sidebarLabel:'What You Get — Intermediate',
    features:['Strength + cardio hybrid training','Progressive overload built in','Gym or home with dumbbells/bands','Macro tracking & nutrition strategy','Weekly intensity variation & deload']
  },
  advanced: {
    color:'var(--red)', badge:'▲ Advanced', badgeClass:'advanced',
    sidebarLabel:'What You Get — Advanced',
    features:['Heavy compound lifting with structured weekly progression','Track your max lifts and push for new personal records each week','Advanced techniques: drop sets, pause reps, and supersets built in','Built-in lighter recovery weeks every 4th week so you don\'t burn out','Conditioning work tailored to your sport or athletic goals']
  }
};

function setTier(tier, btn) {
  currentTier = tier;
  document.querySelectorAll('.tier-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.body.className = tier === 'beginner' ? '' : tier;
  const cfg = tierConfig[tier];
  document.getElementById('ob-logo-dot').style.color = cfg.color;
  // Headline change
  const accent = document.getElementById('ob-accent');
  const line3  = document.getElementById('ob-headline-line3');
  if (tier === 'beginner') {
    accent.textContent = 'SMARTER,';
    line3.textContent = 'NOT HARDER';
  } else {
    accent.textContent = 'SMARTER';
    line3.textContent = 'AND HARDER';
  }
  accent.style.color = cfg.color;
  const badge = document.getElementById('tierBadge');
  badge.textContent = cfg.badge; badge.className = 'tier-badge ' + cfg.badgeClass;
  document.getElementById('sidebar-label').textContent = cfg.sidebarLabel;
  document.getElementById('tier-features').innerHTML = cfg.features.map(f =>
    `<div class="feature-item"><div class="feature-dot"></div><div class="feature-text">${f}</div></div>`
  ).join('');
}

function selectSplit(btn) {
  document.querySelectorAll('.split-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  selectedSplit = btn.dataset.split;
}

function selectTimeline(btn) {
  document.querySelectorAll('.tl-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  selectedWeeks = parseInt(btn.dataset.weeks);
}

function initDayPicker() {
  document.querySelectorAll('#ob-day-picker .day-pill').forEach(p => {
    p.addEventListener('click', () => {
      p.classList.toggle('active');
      const count = document.querySelectorAll('#ob-day-picker .day-pill.active').length;
      const lbl = document.getElementById('day-count-label');
      if (lbl) lbl.textContent = count > 0 ? `— ${count} day${count!==1?'s':''} selected` : '';
    });
  });
  document.querySelectorAll('#ob-equipment-picker .day-pill').forEach(pill => {
    pill.addEventListener('click', () => {
      const isExclusive = pill.dataset.equip === 'Full Gym' || pill.dataset.equip === 'Bodyweight Only';
      if (isExclusive) {
        document.querySelectorAll('#ob-equipment-picker .day-pill').forEach(p => p.classList.remove('active'));
        pill.classList.add('active');
      } else {
        document.querySelectorAll('#ob-equipment-picker .day-pill').forEach(p => {
          if (p.dataset.equip === 'Full Gym' || p.dataset.equip === 'Bodyweight Only') p.classList.remove('active');
        });
        pill.classList.toggle('active');
      }
    });
  });
}

function getSelectedDays() { return [...document.querySelectorAll('#ob-day-picker .day-pill.active')].map(p => p.dataset.day).filter(d => d); }

// ── NUTRITION CALCULATOR ──
function calcNutrition(weightLbs, goalLbs, weeks, gender, age, heightCm, activityLevel) {
  // Mifflin-St Jeor BMR — requires real height
  const wKg = weightLbs * 0.453592;
  const hCm = heightCm || 175; // fallback if not provided
  const a = parseInt(age) || 30;
  let bmr;
  if (gender === 'Female') {
    bmr = 10 * wKg + 6.25 * hCm - 5 * a - 161;
  } else {
    bmr = 10 * wKg + 6.25 * hCm - 5 * a + 5;
  }

  // Activity multipliers (Harris-Benedict scale)
  // These represent TOTAL daily activity including gym training
  const activityMultipliers = {
    sedentary: 1.375,  // desk job + gym training
    light:     1.55,   // lightly active + gym
    moderate:  1.725,  // moderately active + gym
    very:      1.9     // very active + gym
  };
  const multiplier = activityMultipliers[activityLevel] || 1.55;
  const tdee = Math.round(bmr * multiplier);

  const diff = weightLbs - goalLbs; // positive = lose, negative = gain
  const mode = diff > 2 ? 'lose' : diff < -2 ? 'gain' : 'maintain';

  let calories, surplus, deficit, weeklyChange;

  if (mode === 'lose') {
    const totalDeficit = diff * 3500;
    const dailyDeficit = Math.round(totalDeficit / (weeks * 7));
    // Cap: max 1% body weight per week loss to preserve muscle
    const maxDailyDeficit = Math.round((weightLbs * 0.01 * 3500) / 7);
    deficit = Math.max(250, Math.min(750, dailyDeficit, maxDailyDeficit));
    calories = Math.max(1200, tdee - deficit);
    weeklyChange = (deficit * 7 / 3500).toFixed(1);
    surplus = 0;
  } else if (mode === 'gain') {
    const totalSurplus = Math.abs(diff) * 3500;
    const dailySurplus = Math.round(totalSurplus / (weeks * 7));
    surplus = Math.max(200, Math.min(500, dailySurplus)); // lean bulk: 200-500 cal surplus
    calories = tdee + surplus;
    weeklyChange = (surplus * 7 / 3500).toFixed(1);
    deficit = 0;
  } else {
    calories = tdee;
    surplus = 0; deficit = 0;
    weeklyChange = '0';
  }

  // Evidence-based protein targets (Helms et al., 2014; Morton et al., 2018)
  // Cutting: 1.0-1.2g/lb to preserve muscle in deficit
  // Bulking: 0.8-1.0g/lb sufficient for hypertrophy
  // Maintenance: 0.85g/lb
  const proteinPerLb = mode === 'lose' ? 1.1 : mode === 'gain' ? 0.9 : 0.85;
  const protein = Math.round(weightLbs * proteinPerLb);

  // Fat: minimum 20% of calories for hormonal health, target 25-30%
  const fat = Math.round(calories * 0.27 / 9);

  // Carbs: fill remaining calories — primary fuel for training performance
  const carbs = Math.round((calories - protein * 4 - fat * 9) / 4);

  return { calories, protein, fat, carbs, weeklyChange, tdee, deficit, surplus, mode, bmr: Math.round(bmr), multiplier };
}

// ── PLAN GENERATION ──
function getSelectedEquipment() {
  return Array.from(document.querySelectorAll('#ob-equipment-picker .day-pill.active')).map(el => el.dataset.equip);
}

async function generatePlan() {
  const name     = document.getElementById('ob-name').value.trim();
  const age      = document.getElementById('ob-age').value;
  const gender   = document.getElementById('ob-gender').value;
  const weight   = parseFloat(document.getElementById('ob-weight').value);
  const goal     = parseFloat(document.getElementById('ob-goal').value);
  const heightFt = parseInt(document.getElementById('ob-height-ft').value) || 0;
  const heightIn = parseInt(document.getElementById('ob-height-in').value) || 0;
  const activity = document.getElementById('ob-activity').value;
  const injuries = document.getElementById('ob-injuries').value.trim();
  const selDays  = getSelectedDays();
  const duration = document.getElementById('ob-duration').value;
  const equipment = getSelectedEquipment();

  // Validate each field individually for clear feedback
  const missing = [];
  if (!age) missing.push('Age');
  if (!gender) missing.push('Gender');
  if (!weight) missing.push('Current Weight');
  if (!goal) missing.push('Goal Weight');
  if (!heightFt) missing.push('Height (feet)');
  if (!activity) missing.push('Activity Level');
  if (selDays.length === 0) missing.push('Gym Days');
  if (!duration) missing.push('Session Length');
  if (equipment.length === 0) missing.push('Available Equipment');
  if (missing.length > 0) {
    alert('Please fill in: ' + missing.join(', '));
    return;
  }

  const heightCm = Math.round((heightFt * 12 + heightIn) * 2.54);
  const nutrition = calcNutrition(weight, goal, selectedWeeks, gender, age, heightCm, activity);
  USER = { name: name || 'You', age, gender, weight, goal, heightCm, heightFt, heightIn, activity, injuries, equipment, selDays, duration, tier: currentTier, weeks: selectedWeeks, split: selectedSplit, nutrition };

  document.getElementById('generateBtn').disabled = true;
  document.querySelector('.main-layout').style.display = 'none';
  document.getElementById('hero-section').style.display = 'none';
  document.getElementById('loading').style.display = 'block';
  document.getElementById('results-section').style.display = 'none';

  const msgs = [
    'Analyzing your body metrics...',
    'Calculating precise calorie & macro targets...',
    'Designing your periodized program...',
    'Selecting exercises for your equipment...',
    'Optimizing your training split...',
    'Finalizing your plan...'
  ];
  let mi = 0;
  const miv = setInterval(() => { mi=(mi+1)%msgs.length; document.getElementById('loading-detail').textContent = msgs[mi]; }, 1200);

  try {
    generatedPlan = await buildPlan(selDays);
    clearInterval(miv);
    lsSet('fs_plan', generatedPlan);
    lsSet('fs_user', USER);
    renderResults(generatedPlan);
  } catch(e) {
    clearInterval(miv);
    document.getElementById('generateBtn').disabled = false;
    document.querySelector('.main-layout').style.display = '';
    document.getElementById('hero-section').style.display = '';
    document.getElementById('loading').style.display = 'none';
    alert('Error: ' + (e.message || String(e)));
  }
}

async function buildPlan(selDays) {
  const u = USER;
  const n = u.nutrition;
  const heightStr = u.heightFt + "'" + u.heightIn + '"';
  const equipStr = u.equipment.join(', ') || 'Full Gym';
  const injuryStr = u.injuries || 'None';
  const splitLabel = { ppl:'Push/Pull/Legs', ul:'Upper/Lower', fb:'Full Body', ai:'AI Optimized (choose best for me)' }[u.split] || 'Push/Pull/Legs';
  const gymDaysStr = selDays.join(', ');
  const modeStr = n.mode === 'lose' ? 'fat loss' : n.mode === 'gain' ? 'muscle gain (lean bulk)' : 'body recomposition';

  const systemPrompt = `You are an elite strength & conditioning coach. You design evidence-based periodized programs using Renaissance Periodization volume landmarks and progressive overload principles. You respond ONLY with a single valid JSON object. No markdown, no code blocks, no explanation. Raw JSON only.`;

  const exPerSession = u.tier === 'beginner' ? '3-4' : u.tier === 'intermediate' ? '4-5' : '5-6';
  const userPrompt = `User: ${u.age}yo ${u.gender}, ${heightStr}, ${u.weight}lbs→${u.goal}lbs, ${u.activity} activity, ${u.tier} tier, goal: ${modeStr}.
Equipment: ${equipStr}. Injuries: ${injuryStr}.
Gym days: ${gymDaysStr} (${selDays.length}x/week), ${u.duration} sessions, ${splitLabel} split, ${u.weeks} weeks.
Calories: ${n.calories}, Protein: ${n.protein}g, Carbs: ${n.carbs}g, Fat: ${n.fat}g.

Return ONLY this JSON (no markdown):
{"planName":"...","tagline":"...","philosophy":"2 sentences max","schedule":[{"day":"Monday","type":"workout","badge":"Push Day","exercises":[{"name":"Bench Press","sets":4,"reps":"6-8","rest":120,"muscles":"Chest"}]},{"day":"Tuesday","type":"rest","badge":"Rest","exercises":[]}]}

Rules: All 7 days Mon-Sun. Gym days=${gymDaysStr}, rest days=everything else. ${exPerSession} exercises per workout. Equipment=${equipStr}. Avoid=${injuryStr}. Keep philosophy under 100 words. Keep exercise names concise.`;

  const raw = await callClaude(
    [{ role: 'user', content: userPrompt }],
    { system: systemPrompt, max_tokens: 8000 }
  );

  // Parse JSON response
  let parsed;
  try {
    const clean = raw.replace(/^```json\n?|^```\n?|```$/gm, '').trim();
    parsed = JSON.parse(clean);
  } catch(e) {
    throw new Error('JSON parse failed: ' + e.message + ' | Raw: ' + raw.substring(0, 200));
  }

  // Enrich exercises with DB data (sets/reps/rest overridden by AI, but pull muscle images etc.)
  const schedule = parsed.schedule.map(day => {
    if (day.type === 'rest') {
      return { day: day.day, type: 'rest', badge: 'Rest', workout: 'Rest day. Recover, hydrate, and let your muscles rebuild.', exercises: [] };
    }
    const exercises = (day.exercises || []).map(ex => {
      const db = getExerciseData(ex.name);
      return {
        name: ex.name,
        sets: ex.sets || db.sets,
        reps: ex.reps || db.reps,
        rest: ex.rest || db.rest,
        muscles: ex.muscles || db.muscles,
        ytId: db.yt || null
      };
    });
    return {
      day: day.day,
      type: 'workout',
      badge: day.badge,
      workout: exercises.map(e => e.name + ' ' + e.sets + '×' + e.reps).join(', '),
      exercises
    };
  });

  const nu = USER.nutrition;
  return {
    name: parsed.planName,
    tagline: parsed.tagline,
    philosophy: parsed.philosophy,
    calorie_target: nu.calories.toLocaleString() + ' cal/day',
    protein_target: nu.protein + 'g/day',
    weekly_loss: '~' + nu.weeklyChange + ' lbs/week',
    mode: nu.mode,
    timeline: u.weeks + ' weeks',
    workout_philosophy: parsed.philosophy,
    schedule
  };
}

function renderResults(plan) {
  document.getElementById('loading').style.display = 'none';
  const tier = currentTier;
  document.getElementById('plan-name').textContent = plan.name;
  document.getElementById('plan-tagline').textContent = plan.tagline;
  const rtb = document.getElementById('results-tier-badge');
  rtb.textContent = tier.charAt(0).toUpperCase() + tier.slice(1);
  rtb.className = 'results-tier-badge ' + (tier==='beginner'?'':tier);

  const n = USER.nutrition;
  // Populate myplan tab too
  const myplanGrid = document.getElementById('myplan-results-grid');
  const myplanBanner = document.getElementById('myplan-banner');
  if (myplanBanner) myplanBanner.innerHTML = `<div class="results-banner" style="border-radius:14px;margin-bottom:0"><div><h2>${plan.name}</h2><p>${plan.tagline}</p></div><div class="results-tier-badge">${USER.tier.charAt(0).toUpperCase()+USER.tier.slice(1)}</div></div>`;
  document.getElementById('results-grid').innerHTML = [
    { icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>', title:'YOUR GOAL', html:`<ul style="margin-top:4px;margin-left:14px"><li>Current weight: <strong>${USER.weight} lbs</strong></li><li>Goal weight: <strong>${USER.goal} lbs</strong></li><li>Timeline: <strong>${plan.timeline}</strong></li><li>${n.mode==='gain'?'Gaining':'Losing'} <strong>${Math.abs(parseFloat(n.weeklyChange))} lbs/week</strong></li></ul>` },
    { icon:'🥩', title:'NUTRITION TARGETS', html:`<p><strong>${plan.calorie_target}</strong> daily calories</p><p><strong>${plan.protein_target}</strong> protein</p><p style="margin-top:6px;color:var(--dim);font-size:0.83rem">Carbs: ${USER.nutrition.carbs}g · Fat: ${USER.nutrition.fat}g · TDEE: ${USER.nutrition.tdee} cal</p>` },
    { icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>', title:'TRAINING APPROACH', html:`<ul style="margin-top:4px;margin-left:14px">${(plan.workout_philosophy||plan.philosophy||'Personalized program built for your goals.').split('. ').filter(s=>s.trim()).map(s=>`<li style="margin-bottom:6px">${s.trim().replace(/\.$/,'')}</li>`).join('')}</ul>` },
  ].map(c=>`<div class="r-card"><div class="r-card-icon">${c.icon}</div><h3>${c.title}</h3>${c.html}</div>`).join('');

  document.getElementById('week-card').innerHTML = '<h3><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg> WEEK 1 SCHEDULE</h3>' +
    plan.weekly_schedule.map(d=>{
      const tagCls = d.type==='rest' ? 'rest' : 'workout '+(tier!=='beginner'?tier:'');
      return `<div class="day-row"><div class="day-name">${d.day}</div><div class="day-workout"><strong style="color:var(--off)">${d.badge}</strong> — ${d.workout.length>80?d.workout.slice(0,80)+'...':d.workout}</div><div class="day-tag ${tagCls}">${d.type==='rest'?'Rest':'Train'}</div></div>`;
    }).join('');

  const rs = document.getElementById('results-section');
  rs.style.display = 'block';
  rs.scrollIntoView({behavior:'smooth',block:'start'});
  document.getElementById('generateBtn').disabled = false;
  renderMyPlan(generatedPlan);
}

// ── SIGNUP ──
function enterApp() {
  // Hide the CTA section permanently
  const cta = document.querySelector('.cta-into-app');
  if (cta) cta.style.display = 'none';
  lsSet('fs_entered', true);
  goToDash();
}

function goBackToResults() {
  document.getElementById('screen-signup').classList.remove('active');
  document.getElementById('screen-onboard').style.display = 'block';
  document.getElementById('results-section').scrollIntoView({behavior:'smooth',block:'start'});
}

function checkPwStrength(val) {
  const bars = ['pw1','pw2','pw3','pw4'].map(id=>document.getElementById(id));
  bars.forEach(b=>b.className='pw-bar');
  if (!val) return;
  const score = (val.length>=8?1:0)+(/[A-Z]/.test(val)?1:0)+(/[0-9]/.test(val)?1:0)+(/[^A-Za-z0-9]/.test(val)?1:0);
  const cls = score<=1?'weak':score<=2?'ok':'strong';
  for(let i=0;i<score;i++) bars[i].className='pw-bar '+cls;
}

function submitSignup() {
  const first = document.getElementById('su-firstname').value.trim();
  const email = document.getElementById('su-email').value.trim();
  const pw    = document.getElementById('su-password').value;
  if (!first) { document.getElementById('su-firstname').style.borderColor='var(--red)'; setTimeout(()=>document.getElementById('su-firstname').style.borderColor='',1500); return; }
  if (!email||!email.includes('@')) { document.getElementById('su-email').style.borderColor='var(--red)'; setTimeout(()=>document.getElementById('su-email').style.borderColor='',1500); return; }
  if (pw.length<8) { document.getElementById('su-password').style.borderColor='var(--red)'; setTimeout(()=>document.getElementById('su-password').style.borderColor='',1500); return; }
  const last = document.getElementById('su-lastname').value.trim();
  USER.name = first+(last?' '+last:'');
  USER.email = email;
  const btn = document.getElementById('su-submit-btn');
  btn.disabled = true;
  btn.innerHTML = '<div class="spinner"></div> CREATING YOUR ACCOUNT...';
  setTimeout(()=>{
    btn.innerHTML = '✓ REDIRECTING TO CHECKOUT...';
    setTimeout(()=>{ window.location.href = 'https://link.fastpaydirect.com/payment-link/699794d31a8400387302a088'; }, 600);
  }, 1400);
}

function goToDash() {
  // Restore plan from localStorage if not in memory (e.g. after page reload)
  if (!generatedPlan) {
    const saved = lsGet('fs_plan');
    const savedUser = lsGet('fs_user');
    if (saved && savedUser) {
      generatedPlan = saved;
      USER = savedUser;
    }
  }
  const cta = document.querySelector('.cta-into-app');
  if (cta && lsGet('fs_entered')) cta.style.display = 'none';
  // Hide all screens with inline style to override any CSS specificity
  document.querySelectorAll('.screen').forEach(s => {
    s.classList.remove('active');
    s.style.display = 'none';
  });
  initDashboard();
  const dash = document.getElementById('screen-dash');
  // Must use inline flex — CSS #screen-dash{display:none} beats .screen.active{display:block}
  dash.style.display = 'flex';
  dash.style.flexDirection = 'column';
  dash.style.minHeight = '100vh';
  dash.classList.add('active');
  window.scrollTo(0,0);
}

// ═══════════════════════════════════════════
// DASHBOARD
// ═══════════════════════════════════════════
let TARGETS = { cal:2000, pro:150, carb:200, fat:55 };
let GYM_DAYS = [];
let DAY_WORKOUTS = {};
let TOTAL_WEEKS = 16;
let CURRENT_WEEK = 1;
// PERIODIZATION: training phases — hypertrophy (wks 1-4), strength (5-8), power (9-12), peak (13-16)
// Every 4th week is a deload (60% volume)
const TRAINING_PHASES = [
  { name:'HYPERTROPHY', weeks:[1,2,3,4], repRange:'8-12', setMultiplier:1.0,  intensityLabel:'Moderate weight, high reps. Focus on the squeeze and muscle connection.' },
  { name:'STRENGTH',    weeks:[5,6,7,8], repRange:'5-8',  setMultiplier:1.1,  intensityLabel:'Heavier weight, lower reps. Control the eccentric. Rest fully between sets.' },
  { name:'POWER',       weeks:[9,10,11,12], repRange:'3-6', setMultiplier:1.2, intensityLabel:'Near maximal loads. Explosive concentric. Take 2-3 min rest between sets.' },
  { name:'PEAK',        weeks:[13,14,15,16], repRange:'4-6', setMultiplier:1.15, intensityLabel:'Maintain intensity. Reduce volume. Nail technique at heavy loads.' },
];
function getTrainingPhase(week) {
  return TRAINING_PHASES.find(p => p.weeks.includes(week)) || TRAINING_PHASES[0];
}
function isDeloadWeek(week) { return week % 4 === 0; }
function getPhaseExerciseModifier(week) {
  if (isDeloadWeek(week)) return { setMult: 0.6, repRange: null, label: 'DELOAD' };
  const ph = getTrainingPhase(week);
  return { setMult: ph.setMultiplier, repRange: ph.repRange, label: ph.name };
}
let mealLogs = Object.fromEntries(Array.from({length:7},(_,i)=>[i,[]]));
let wktDone = new Set();
let nutDay = TODAY_IDX;

// localStorage keys
const LS = {
  mealLogs: 'fs_mealLogs',
  wktDone:  'fs_wktDone',
  setLogs:  'fs_setLogs',  // { 'dayIdx_exIdx_setIdx': { weight, reps, date } }
  targets:  'fs_targets',
  woDraft:  'fs_wo_draft', // { [dayIdx]: { sets: woSets, extraSets: woExtraSets } } — every keystroke persisted
};

function lsGet(key) { try { return JSON.parse(localStorage.getItem(key)); } catch(e) { return null; } }
function lsSet(key, val) { try { localStorage.setItem(key, JSON.stringify(val)); } catch(e) {} }

// ── ANTHROPIC API (via Cloudflare Worker proxy) ──
const AI_PROXY = 'https://fitstart-api.noah-0c3.workers.dev';

async function callClaude(messages, opts = {}) {
  const body = {
    model: opts.model || 'claude-sonnet-4-20250514',
    max_tokens: opts.max_tokens || 2048,
    messages: messages
  };
  if (opts.system) body.system = opts.system;
  const controller = new AbortController();
  const timeout = setTimeout(() => controller.abort(), 60000);
  try {
    const response = await fetch(AI_PROXY, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
      signal: controller.signal
    });
    clearTimeout(timeout);
    if (!response.ok) {
      const err = await response.json().catch(() => ({}));
      if (response.status === 429) throw new Error('Slow down — too many requests. Try again in a minute.');
      throw new Error(err.error?.message || 'AI is temporarily unavailable. Try again shortly.');
    }
    const data = await response.json();
    return (data.content?.[0]?.text || '').trim();
  } catch(e) {
    clearTimeout(timeout);
    if (e.name === 'AbortError') throw new Error('Request timed out. Try again.');
    throw e;
  }
}

function loadFromStorage() {
  const ml = lsGet(LS.mealLogs); if (ml) mealLogs = ml;
  const wd = lsGet(LS.wktDone);  if (wd) wktDone = new Set(wd);
  const tg = lsGet(LS.targets);  if (tg) TARGETS = tg;
  // Calculate current training week from program start date
  const startDate = lsGet('fs_program_start');
  if (startDate) {
    const msElapsed = Date.now() - new Date(startDate).getTime();
    const weeksElapsed = Math.floor(msElapsed / (7 * 24 * 60 * 60 * 1000)) + 1;
    CURRENT_WEEK = Math.min(weeksElapsed, TOTAL_WEEKS);
  } else {
    lsSet('fs_program_start', new Date().toISOString());
    CURRENT_WEEK = 1;
  }
}

function saveToStorage() {
  lsSet(LS.mealLogs, mealLogs);
  lsSet(LS.wktDone, [...wktDone]);
  lsSet(LS.targets, TARGETS);
  // Refresh charts if on progress tab
  if (document.getElementById('view-progress') &&
      document.getElementById('view-progress').style.display !== 'none') {
    renderNutritionChart();
  }
}

// Set log: store previous week's weights/reps
// ── EXERCISE LOG — keyed by exercise name, not day slot ──
function getExLogs() { return lsGet('fs_exlogs') || {}; }

function saveSet(dayIdx, exIdx, setIdx, weight, reps) {
  // Allow partial saves for draft; full write to exlogs only when both present
  const exName = (woWorkout && woWorkout.exercises[exIdx]) ? woWorkout.exercises[exIdx].name : null;
  if (!exName) return;
  const hasWeight = weight != null && String(weight).trim() !== '';
  const hasReps = reps != null && String(reps).trim() !== '';
  if (hasWeight && hasReps) {
    // Persist to set logs and exlogs for completed set
    const logs = lsGet(LS.setLogs) || {};
    logs[`${dayIdx}_${exIdx}_${setIdx}`] = { weight, reps, date: new Date().toLocaleDateString() };
    lsSet(LS.setLogs, logs);
    const exlogs = getExLogs();
    if (!exlogs[exName]) exlogs[exName] = [];
    const today = todayDateStr();
    let session = exlogs[exName].find(s => s.date === today);
    if (!session) {
      session = { date: today, sets: [] };
      exlogs[exName].unshift(session);
      exlogs[exName] = exlogs[exName].slice(0, 30);
    }
    session.sets[setIdx] = { weight: parseFloat(weight), reps: parseInt(reps) };
    lsSet('fs_exlogs', exlogs);
  }
}

function getPrevSet(dayIdx, exIdx, setIdx) {
  const exName = (woWorkout && woWorkout.exercises[exIdx]) ? woWorkout.exercises[exIdx].name : null;
  if (exName) {
    const exlogs = getExLogs();
    const sessions = exlogs[exName] || [];
    const today = todayDateStr();
    const prev = sessions.find(s => s.date !== today);
    if (prev && prev.sets && prev.sets[setIdx]) {
      return { weight: prev.sets[setIdx].weight, reps: prev.sets[setIdx].reps, date: prev.date };
    }
  }
  const logs = lsGet(LS.setLogs) || {};
  return logs[`${dayIdx}_${exIdx}_${setIdx}`] || null;
}

function getWorkoutDraft(dayIdx) {
  const all = lsGet(LS.woDraft) || {};
  return all[String(dayIdx)] || null;
}

function persistWorkoutDraft() {
  if (woWorkout == null) return;
  const all = lsGet(LS.woDraft) || {};
  all[String(woDay)] = { sets: JSON.parse(JSON.stringify(woSets)), extraSets: JSON.parse(JSON.stringify(woExtraSets)) };
  lsSet(LS.woDraft, all);
}

function getLastSessionSummary(exName) {
  if (!exName) return null;
  const exlogs = getExLogs();
  const sessions = exlogs[exName] || [];
  const today = todayDateStr();
  const prev = sessions.find(s => s.date !== today);
  if (!prev || !prev.sets || !prev.sets.length) return null;
  const setStr = prev.sets.filter(Boolean).map(s => `${s.weight}×${s.reps}`).join(', ');
  return `${setStr} · ${prev.date}`;
}

function _getOverloadSuggestion(exName) {
  const exlogs = getExLogs();
  const sessions = exlogs[exName] || [];
  const today = todayDateStr();
  const prev = sessions.find(s => s.date !== today);
  if (!prev || !prev.sets || !prev.sets.length) return null;
  // Find the best set from last time (highest weight)
  let bestW = 0, bestR = 0;
  prev.sets.filter(Boolean).forEach(s => {
    const w = parseFloat(s.weight) || 0;
    const r = parseInt(s.reps) || 0;
    if (w > bestW || (w === bestW && r > bestR)) { bestW = w; bestR = r; }
  });
  if (!bestW) return null;
  // Suggest: if reps < 10, try +1 rep same weight; if reps >= 10, try +5lbs same reps
  if (bestR >= 10) {
    return `Try ${bestW + 5}lbs × ${bestR} today (last: ${bestW}×${bestR})`;
  } else {
    return `Try ${bestW}lbs × ${bestR + 1} today (last: ${bestW}×${bestR})`;
  }
}

// Helper: get fresh exercise list for a workout name + tier (used by plan auto-update)
function _getFreshExercises(workoutName, tier) {
  const workoutExercises = {
    'Push Day': {
      beginner:     ['Bench Press','Shoulder Press','Incline DB Press','Lateral Raises','Tricep Pushdown'],
      intermediate: ['Bench Press','Incline DB Press','Shoulder Press','Lateral Raises','Cable Crossover','Tricep Pushdown'],
      advanced:     ['Bench Press','Incline DB Press','Shoulder Press','Lateral Raises','Cable Crossover','Skull Crushers']
    },
    'Pull Day': {
      beginner:     ['Barbell Row','Lat Pulldown','Cable Row','Face Pulls','Barbell Curl'],
      intermediate: ['Barbell Row','Lat Pulldown','Cable Row','Face Pulls','Barbell Curl','Hammer Curls'],
      advanced:     ['Deadlift','Barbell Row','Lat Pulldown','Face Pulls','Barbell Curl','Hammer Curls']
    },
    'Legs': {
      beginner:     ['Goblet Squat','Romanian Deadlift','Leg Press','Leg Curl','Calf Raises'],
      intermediate: ['Back Squat','Romanian Deadlift','Leg Press','Leg Curl','Calf Raises'],
      advanced:     ['Back Squat','Romanian Deadlift','Leg Press','Walking Lunges','Leg Curl','Calf Raises']
    },
    'Upper Body': {
      beginner:     ['Bench Press','Barbell Row','Shoulder Press','Lat Pulldown','Barbell Curl'],
      intermediate: ['Bench Press','Barbell Row','Shoulder Press','Lat Pulldown','Hammer Curls'],
      advanced:     ['Bench Press','Barbell Row','Shoulder Press','Lat Pulldown','Lateral Raises','Hammer Curls']
    },
    'Lower Body': {
      beginner:     ['Goblet Squat','Romanian Deadlift','Leg Press','Calf Raises'],
      intermediate: ['Back Squat','Romanian Deadlift','Leg Press','Calf Raises'],
      advanced:     ['Back Squat','Romanian Deadlift','Leg Press','Leg Curl','Calf Raises']
    },
    'Full Body': {
      beginner:     ['Goblet Squat','Bench Press','Barbell Row','Shoulder Press','Plank'],
      intermediate: ['Back Squat','Bench Press','Barbell Row','Shoulder Press','Plank'],
      advanced:     ['Back Squat','Bench Press','Barbell Row','Shoulder Press','Romanian Deadlift','Dead Bug']
    }
  };
  const exNames = workoutExercises[workoutName] && workoutExercises[workoutName][tier];
  if (!exNames) return null;
  return exNames.map(name => {
    const db = getExerciseData(name);
    return { name, sets: db.sets, reps: db.reps, rest: db.rest, muscles: db.muscles, ytId: db.yt };
  });
}

function initDashboard() {
  if (!generatedPlan) {
    // Show error on dashboard so it's not blank
    const dash = document.getElementById('screen-dash');
    if (dash) {
      const errDiv = document.createElement('div');
      errDiv.style.cssText = 'padding:40px;color:#fff;font-size:1rem;text-align:center';
      errDiv.innerHTML = '<h2 style="margin-bottom:16px">⚠️ No plan found</h2><p style="color:#aaa;margin-bottom:20px">Your plan data was not found. Please go back and generate your plan again.</p><button onclick="location.reload()" style="padding:12px 24px;background:#4ADE80;border:none;border-radius:8px;font-weight:700;cursor:pointer">Reload Page</button>';
      dash.appendChild(errDiv);
    }
    return;
  }

  // Auto-update workout exercises if plan was generated with old templates (v2 = compound-first)
  const PLAN_VERSION = 3;
  if (generatedPlan._v !== PLAN_VERSION && generatedPlan.weekly_schedule && USER) {
    const t = USER.tier || 'beginner';
    generatedPlan.weekly_schedule.forEach(d => {
      if (d.type !== 'workout' || !d.badge) return;
      const freshExList = _getFreshExercises(d.badge, t);
      if (freshExList) {
        d.exercises = freshExList;
        d.workout = freshExList.map(e => `${e.name} ${e.sets}×${e.reps}`).join(', ');
      }
    });
    generatedPlan._v = PLAN_VERSION;
    lsSet('fs_plan', generatedPlan);
  }

  loadFromStorage();

  TARGETS = {
    cal:  USER.nutrition.calories,
    pro:  USER.nutrition.protein,
    carb: USER.nutrition.carbs,
    fat:  USER.nutrition.fat
  };
  TOTAL_WEEKS = USER.weeks || 16;

  // Build DAY_WORKOUTS from plan
  GYM_DAYS = [];
  DAY_WORKOUTS = {};
  generatedPlan.weekly_schedule.forEach((d, i) => {
    if (d.type === 'workout' && d.exercises && d.exercises.length > 0) {
      GYM_DAYS.push(i);
      DAY_WORKOUTS[i] = {
        name: d.badge,
        focus: d.workout.slice(0,80),
        exercises: d.exercises
      };
    }
  });

  // Nav/header
  const initials = USER.name ? USER.name.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2) : '?';
  document.getElementById('dash-avatar').textContent = initials;
  document.getElementById('dash-username').textContent = USER.name || 'You';
  document.getElementById('dash-day-title').textContent = DAYS_FULL[TODAY_IDX].toUpperCase();
  const _phMod = getPhaseExerciseModifier(CURRENT_WEEK);
  const _phaseLabel = isDeloadWeek(CURRENT_WEEK) ? '⚡ DELOAD WEEK' : _phMod.label + ' PHASE';
  document.getElementById('dash-day-sub').textContent = `Week ${CURRENT_WEEK} of ${TOTAL_WEEKS} · ${_phaseLabel} · ${generatedPlan.name}`;
  const pvs=document.getElementById('prog-view-sub'); if(pvs) pvs.textContent = `Week ${CURRENT_WEEK} · ${generatedPlan.name}`;
  const wps=document.getElementById('wk-pro-sub'); if(wps) wps.textContent = `goal: ${TARGETS.pro}g/day`;

  // Settings defaults
  document.getElementById('s-name').value   = USER.name || '';
  document.getElementById('s-weight').value = USER.weight ? USER.weight + ' lbs' : '';
  document.getElementById('s-goal').value   = USER.goal ? USER.goal + ' lbs' : '';
  document.getElementById('s-tier').value   = USER.tier ? USER.tier.charAt(0).toUpperCase()+USER.tier.slice(1) : '';
  document.getElementById('s-cal').value    = TARGETS.cal;
  document.getElementById('s-pro').value    = TARGETS.pro;
  document.getElementById('s-carb').value   = TARGETS.carb;
  document.getElementById('s-fat').value    = TARGETS.fat;

  // Progress (null-safe - elements may not exist in all views)
  const pwCur = document.getElementById('pw-current');
  if (pwCur) pwCur.innerHTML = USER.weight + ' <span style="font-size:1.2rem;color:var(--dim)">lbs</span>';
  const pwDet = document.getElementById('pw-detail');
  if (pwDet) pwDet.textContent = 'Goal: ' + USER.goal + ' lbs';
  const pwRng = document.getElementById('pw-range');
  if (pwRng) pwRng.innerHTML = '<span>'+USER.weight+' lbs</span><span>Today</span><span>'+USER.goal+' lbs</span>';

  // Program stats
  const ptv=document.getElementById('prog-tier-val'); if(ptv) ptv.textContent = USER.tier ? USER.tier.charAt(0).toUpperCase()+USER.tier.slice(1) : '—';
  const ppn=document.getElementById('prog-plan-name'); if(ppn) ppn.textContent = generatedPlan.name;
  const pgd=document.getElementById('prog-gym-days'); if(pgd) pgd.textContent = GYM_DAYS.map(i=>DAYS_SHORT[i]).join(' · ');
  const pdc=document.getElementById('prog-days-count'); if(pdc) pdc.textContent = GYM_DAYS.length + ' days/week';
  const pf=document.getElementById('prog-fraction'); if(pf) pf.textContent = `${CURRENT_WEEK} / ${TOTAL_WEEKS}`;
  const ppb=document.getElementById('prog-pct-bar'); if(ppb) ppb.style.width = (CURRENT_WEEK/TOTAL_WEEKS*100) + '%';

  nutDay = TODAY_IDX;

  // ── AI Adaptive Intelligence ──
  // Runs weekly: checks weight trend, strength progress, and adjusts macros/workouts
  _runAdaptiveCheck();

  try {
    renderTodayWorkout(); renderTodayMiniLog();
    refreshDashMacros();
    renderWeek();
    renderStreak();
    renderWeightHistory();
    renderNutritionChart();
    renderFreqChart();
    renderNutritionChart();
    renderProgram();
    renderSettingsGymDays();
    renderMyPlan(generatedPlan);
    saveToStorage();
  } catch(e) {
    console.error('Dashboard render error:', e);
    const main = document.querySelector('#screen-dash .main-content');
    if (main) main.innerHTML = '<div style="padding:40px;color:#fff"><h2 style="color:#F43F5E;margin-bottom:12px">Error Loading Dashboard</h2><pre style="background:#111;padding:16px;border-radius:8px;font-size:0.8rem;color:#aaa;white-space:pre-wrap">' + e.stack + '</pre><button onclick="localStorage.clear();location.reload()" style="margin-top:16px;padding:12px 24px;background:#4ADE80;border:none;border-radius:8px;font-weight:700;cursor:pointer">Clear Data & Restart</button></div>';
  }
}

// ═══════════════════════════════════════════
// AI ADAPTIVE INTELLIGENCE
// Checks weight trend & workout performance weekly, adjusts macros & workout intensity
// ═══════════════════════════════════════════
function _runAdaptiveCheck() {
  try {
    const lastCheck = lsGet('fs_adaptive_last');
    const now = Date.now();
    // Run at most once per 3 days
    if (lastCheck && (now - lastCheck) < 3 * 24 * 60 * 60 * 1000) return;

    const weightLog = lsGet('fs_weightLog') || [];
    if (weightLog.length < 2) return; // Need at least 2 weigh-ins

    // Calculate weight trend (last 2 weeks vs previous 2 weeks)
    const sorted = [...weightLog].sort((a,b) => new Date(b.date) - new Date(a.date));
    const recent = sorted.slice(0, Math.min(5, sorted.length));
    const older = sorted.slice(Math.min(5, sorted.length), Math.min(10, sorted.length));
    if (older.length === 0) return;

    const avgRecent = recent.reduce((s,w) => s + w.weight, 0) / recent.length;
    const avgOlder = older.reduce((s,w) => s + w.weight, 0) / older.length;
    const weeklyChange = avgRecent - avgOlder;

    // Calculate workout volume trend
    const exLogs = getExLogs();
    let recentVolume = 0, olderVolume = 0;
    const twoWeeksAgo = new Date(now - 14 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
    const fourWeeksAgo = new Date(now - 28 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
    Object.values(exLogs).forEach(sessions => {
      sessions.forEach(s => {
        const vol = (s.sets || []).reduce((sum, set) => sum + ((set?.weight || 0) * (set?.reps || 0)), 0);
        if (s.date >= twoWeeksAgo) recentVolume += vol;
        else if (s.date >= fourWeeksAgo) olderVolume += vol;
      });
    });

    const mode = USER?.nutrition?.mode || 'lose';
    const currentCal = TARGETS.cal;
    let newCal = currentCal;
    let adaptMsg = '';

    if (mode === 'lose') {
      if (weeklyChange > 0.5) {
        // Gaining weight while trying to lose — reduce calories
        newCal = Math.max(1200, currentCal - 150);
        adaptMsg = `You've gained ~${weeklyChange.toFixed(1)} lbs recently. Reducing daily target to ${newCal} cal to get back on track.`;
      } else if (weeklyChange < -2) {
        // Losing too fast — increase slightly to preserve muscle
        newCal = currentCal + 100;
        adaptMsg = `You're losing ${Math.abs(weeklyChange).toFixed(1)} lbs/week — great progress! Bumping calories slightly to ${newCal} to preserve muscle.`;
      } else if (weeklyChange >= -1 && weeklyChange <= -0.3) {
        adaptMsg = `On track — losing ${Math.abs(weeklyChange).toFixed(1)} lbs/week. Keep it up.`;
      }
    } else if (mode === 'gain') {
      if (weeklyChange < 0) {
        // Losing weight while trying to gain — increase calories
        newCal = currentCal + 200;
        adaptMsg = `You've lost weight while bulking. Increasing target to ${newCal} cal to fuel muscle growth.`;
      } else if (weeklyChange > 1.5) {
        // Gaining too fast — reduce surplus to limit fat gain
        newCal = currentCal - 100;
        adaptMsg = `Gaining ${weeklyChange.toFixed(1)} lbs/week is too fast. Reducing to ${newCal} cal to minimize fat gain.`;
      }
    }

    // Strength progress insight
    let strengthMsg = '';
    if (olderVolume > 0 && recentVolume > 0) {
      const volumeChange = ((recentVolume - olderVolume) / olderVolume * 100);
      if (volumeChange > 10) {
        strengthMsg = `Strength is up ${volumeChange.toFixed(0)}% — your progressive overload is working.`;
      } else if (volumeChange < -10) {
        strengthMsg = `Volume dropped ${Math.abs(volumeChange).toFixed(0)}%. Consider a deload week, then push harder.`;
      }
    }

    // Apply calorie adjustment
    if (newCal !== currentCal) {
      TARGETS.cal = newCal;
      // Scale macros proportionally
      const ratio = newCal / currentCal;
      TARGETS.carb = Math.round(TARGETS.carb * ratio);
      TARGETS.fat = Math.round(TARGETS.fat * ratio);
      // Protein stays the same or increases
      lsSet('fs_targets', TARGETS);
      if (USER && USER.nutrition) {
        USER.nutrition.calories = newCal;
        USER.nutrition.carbs = TARGETS.carb;
        USER.nutrition.fat = TARGETS.fat;
        lsSet('fs_user', USER);
      }
    }

    // Periodization insight
    let periodMsg = '';
    if (isDeloadWeek(CURRENT_WEEK)) {
      periodMsg = `Week ${CURRENT_WEEK} is your DELOAD week — volume is automatically reduced to 60%. Your body is recovering and will come back stronger.`;
    } else {
      const ph = getTrainingPhase(CURRENT_WEEK);
      periodMsg = `${ph.name} PHASE (Week ${CURRENT_WEEK}): ${ph.intensityLabel}`;
    }

    // Show insight card on dashboard
    const fullMsg = [periodMsg, adaptMsg, strengthMsg].filter(Boolean).join(' ');
    if (fullMsg) {
      lsSet('fs_adaptive_insight', fullMsg);
      lsSet('fs_adaptive_last', now);
    }
    _showAdaptiveInsight();

    // Weekly AI progress report (runs once per week)
    const lastReport = lsGet('fs_weekly_report_ts');
    if (!lastReport || (now - lastReport) > 6 * 24 * 60 * 60 * 1000) {
      _generateWeeklyProgressReport(weeklyChange, recentVolume, olderVolume);
    }
  } catch(e) {
    console.log('Adaptive check error:', e);
  }
}

// ── WEEKLY AI PROGRESS REPORT ──
async function _generateWeeklyProgressReport(weightChange, recentVol, olderVol) {
  if (!USER) return;
  try {
    const workoutDates = new Set(lsGet('fs_workout_dates') || []);
    const ph = getTrainingPhase(CURRENT_WEEK);
    const deload = isDeloadWeek(CURRENT_WEEK);
    const volChange = olderVol > 0 ? ((recentVol - olderVol) / olderVol * 100).toFixed(0) : 'N/A';
    const prompt = `Generate a concise weekly fitness progress report for ${USER.name || 'this user'}.

Data:
- Program: Week ${CURRENT_WEEK} of ${TOTAL_WEEKS}, ${deload ? 'DELOAD WEEK' : ph.name + ' PHASE'}
- Goal: ${USER.nutrition?.mode === 'lose' ? 'Weight loss' : 'Muscle gain'} (current: ${USER.weight}lbs, target: ${USER.goal}lbs)
- Weekly weight change: ${weightChange > 0 ? '+' : ''}${weightChange.toFixed(1)} lbs
- Training volume change (recent vs 2wks prior): ${volChange !== 'N/A' ? volChange + '%' : 'insufficient data'}
- Workouts completed: ${workoutDates.size} total
- Daily calorie target: ${TARGETS.cal} cal / ${TARGETS.pro}g protein

Write 3-4 sentences covering: 1) progress assessment, 2) what to focus on this week, 3) one specific, actionable tip. Be direct and motivating. Reference their actual numbers. No fluff.`;

    const report = await callClaude([{ role: 'user', content: prompt }], { max_tokens: 300 });
    if (report) {
      lsSet('fs_weekly_report', report);
      lsSet('fs_weekly_report_ts', Date.now());
      // Update insight card with report
      lsSet('fs_adaptive_insight', report);
      _showAdaptiveInsight();
    }
  } catch(e) {
    console.log('Weekly report error:', e);
  }
}

function _showAdaptiveInsight() {
  const msg = lsGet('fs_adaptive_insight');
  if (!msg) return;
  let card = document.getElementById('ai-insight-card');
  if (!card) {
    card = document.createElement('div');
    card.id = 'ai-insight-card';
    card.style.cssText = 'background:linear-gradient(135deg,rgba(74,222,128,0.08),rgba(74,222,128,0.02));border:1px solid rgba(74,222,128,0.2);border-radius:14px;padding:16px;margin-bottom:16px;position:relative';
    const todayView = document.getElementById('view-today');
    if (todayView) todayView.insertBefore(card, todayView.firstChild);
  }
  const phMod2 = getPhaseExerciseModifier(CURRENT_WEEK);
  const phLabel2 = isDeloadWeek(CURRENT_WEEK) ? '⚡ DELOAD' : phMod2.label;
  card.innerHTML = `<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><span style="font-size:1.1rem">🧠</span><span style="font-family:'Bebas Neue',sans-serif;font-size:0.85rem;letter-spacing:1.5px;color:var(--green)">AI INSIGHT</span><span style="font-size:0.62rem;font-weight:700;letter-spacing:1.5px;background:rgba(74,222,128,0.1);border:1px solid rgba(74,222,128,0.2);border-radius:4px;padding:2px 7px;color:var(--green)">${phLabel2} · WK ${CURRENT_WEEK}</span><button onclick="this.parentElement.parentElement.remove();lsSet('fs_adaptive_insight',null)" style="margin-left:auto;background:none;border:none;color:var(--dim);cursor:pointer;font-size:0.8rem">✕</button></div><p style="font-size:0.82rem;color:var(--off);line-height:1.5;margin:0">${msg}</p><div style="margin-top:10px;display:flex;gap:8px"><button onclick="_generateWeeklyProgressReport(0,0,0)" style="padding:5px 12px;background:rgba(74,222,128,0.1);border:1px solid rgba(74,222,128,0.2);border-radius:6px;color:var(--green);font-size:0.72rem;font-weight:700;cursor:pointer;letter-spacing:0.5px">↻ REFRESH REPORT</button><button onclick="dashNav('coach');document.getElementById('coach-input').value='Give me my weekly progress report and what I should focus on this week';sendCoachMsg()" style="padding:5px 12px;background:rgba(96,165,250,0.1);border:1px solid rgba(96,165,250,0.2);border-radius:6px;color:var(--blue);font-size:0.72rem;font-weight:700;cursor:pointer">ASK COACH →</button></div>`;
}

// ── INIT (called from index.html after all modules load) ──
function _bootApp() {
  setTier('beginner', document.querySelector('.tier-btn[data-tier="beginner"]'));
  initDayPicker();

  // Attach workout nav listeners reliably (more robust than onclick on iOS)
  const prev = document.getElementById('wo-prev-btn');
  const next = document.getElementById('wo-next-btn');
  if (prev) prev.addEventListener('click', function(e) { e.stopPropagation(); prevExercise(); });
  if (next) next.addEventListener('click', function(e) { e.stopPropagation(); nextExercise(); });

  // Auto-skip to dashboard if user already has a saved plan
  const savedPlan = lsGet('fs_plan');
  const savedUser = lsGet('fs_user');
  const hasNewFields = savedUser && savedUser.heightCm && savedUser.activity && savedUser.equipment;
  if (savedPlan && savedUser && hasNewFields) {
    generatedPlan = savedPlan;
    USER = savedUser;
    goToDash();
  } else if (savedPlan || savedUser) {
    localStorage.removeItem('fs_plan');
    localStorage.removeItem('fs_user');
    localStorage.removeItem('fs_entered');
  }
}


// ── MOBILE BOTTOM NAV ──
function syncMobTab(view) {
  document.querySelectorAll('.mob-tab').forEach(t => t.classList.remove('active'));
  const tab = document.getElementById('mob-tab-' + view);
  if (tab) tab.classList.add('active');
  closeMobMore();
}

function toggleMobMore() {
  const drawer = document.getElementById('mob-more-drawer');
  drawer.classList.toggle('open');
}

function closeMobMore() {
  const drawer = document.getElementById('mob-more-drawer');
  if (drawer) drawer.classList.remove('open');
}

function mobNavTo(view) {
  // Find the matching sidebar button and use it
  const sidebarBtns = document.querySelectorAll('.sb-btn');
  let matchBtn = null;
  sidebarBtns.forEach(btn => {
    if (btn.getAttribute('onclick') && btn.getAttribute('onclick').includes("'" + view + "'")) {
      matchBtn = btn;
    }
  });
  if (matchBtn) {
    dashNav(view, matchBtn);
  } else {
    // Fallback: just switch views directly
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    const viewEl = document.getElementById('view-' + view);
    if (viewEl) viewEl.classList.add('active');
    if (view === 'program') renderProgram();
    if (view === 'settings') renderSettingsGymDays();
  }
  closeMobMore();
}

// Close more drawer when tapping outside
document.addEventListener('click', function(e) {
  const drawer = document.getElementById('mob-more-drawer');
  const moreBtn = document.getElementById('mob-tab-more');
  if (drawer && drawer.classList.contains('open') && !drawer.contains(e.target) && e.target !== moreBtn && !moreBtn.contains(e.target)) {
    closeMobMore();
  }
});

// Session restore happens only when user explicitly clicks "Enter App"
// Auto-redirect removed to allow users to regenerate their plan

function renderMyPlan(plan) {
  const body = document.getElementById('myplan-body');
  if (!body || !plan) return;
  const n = USER.nutrition || {};
  const days = plan.weekly_schedule || [];
  const gymCount = days.filter(d => d.type === 'workout').length;
  const weekHtml = days.map((d, i) => {
    const isRest = d.type !== 'workout';
    const dayLabel = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'][i];
    const exNames = (!isRest && d.exercises) ? d.exercises.slice(0,3).map(e=>e.name).join(', ') + (d.exercises.length>3?' +more':'') : '';
    return `<div style="display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid var(--border)">
      <div style="width:32px;font-family:'DM Mono',monospace;font-size:0.72rem;font-weight:600;color:var(--dim);flex-shrink:0">${dayLabel}</div>
      <div style="flex:1;min-width:0">
        <div style="font-size:0.9rem;font-weight:600;color:${isRest?'var(--dim)':'var(--white)'}">${isRest ? 'Rest Day' : (d.badge || d.workout || 'Training')}</div>
        ${exNames ? `<div style="font-size:0.73rem;color:var(--dim);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${exNames}</div>` : ''}
      </div>
      <div style="font-size:0.62rem;font-weight:700;letter-spacing:1px;text-transform:uppercase;padding:4px 9px;border-radius:6px;white-space:nowrap;background:${isRest?'rgba(255,255,255,0.05)':'var(--green-dim)'};color:${isRest?'var(--dim)':'var(--green)'};border:1px solid ${isRest?'transparent':'rgba(74,222,128,0.2)'};">${isRest ? 'Rest' : 'Train'}</div>
    </div>`;
  }).join('');

  // Update banner
  const banner = document.getElementById('myplan-banner');
  if (banner) banner.innerHTML = `<div style="background:linear-gradient(135deg,var(--card),var(--dark));border:1px solid var(--border2);border-radius:16px;padding:20px 22px">
    <div style="font-family:'Bebas Neue',sans-serif;font-size:1.8rem;color:var(--white);margin-bottom:4px">${plan.name}</div>
    <div style="font-size:0.85rem;color:var(--off);margin-bottom:12px">${plan.tagline}</div>
    <span style="font-size:0.65rem;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;background:var(--tier-dim);color:var(--tier-color);padding:5px 12px;border-radius:6px">${USER.tier?USER.tier.charAt(0).toUpperCase()+USER.tier.slice(1):''}</span>
  </div>`;

  body.innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px">
      <div style="background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px">
        <div style="font-size:0.6rem;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--dim);margin-bottom:6px">Training Days</div>
        <div style="font-size:2rem;font-weight:700;color:var(--green)">${gymCount}<span style="font-size:0.85rem;font-weight:400;color:var(--dim);margin-left:2px">/ week</span></div>
      </div>
      <div style="background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px">
        <div style="font-size:0.6rem;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--dim);margin-bottom:6px">Program Length</div>
        <div style="font-size:2rem;font-weight:700;color:var(--white)">${USER.weeks||16}<span style="font-size:0.85rem;font-weight:400;color:var(--dim);margin-left:2px">wks</span></div>
      </div>
      <div style="background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px">
        <div style="font-size:0.6rem;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--dim);margin-bottom:6px">Daily Calories</div>
        <div style="font-size:2rem;font-weight:700;color:var(--white)">${(n.calories||0).toLocaleString()}<span style="font-size:0.85rem;font-weight:400;color:var(--dim);margin-left:2px">cal</span></div>
      </div>
      <div style="background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px">
        <div style="font-size:0.6rem;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--dim);margin-bottom:6px">Protein Target</div>
        <div style="font-size:2rem;font-weight:700;color:#60a5fa">${n.protein||0}<span style="font-size:0.85rem;font-weight:400;color:var(--dim);margin-left:2px">g/day</span></div>
      </div>
    </div>
    <div style="background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px 18px 4px;margin-bottom:14px">
      <div style="font-size:0.68rem;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--dim);margin-bottom:4px">Weekly Schedule</div>
      ${weekHtml}
    </div>
    <div style="background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px;margin-bottom:14px">
      <div style="font-size:0.68rem;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--dim);margin-bottom:14px">Daily Macros</div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px">
        <div style="text-align:center;padding:14px 8px;background:var(--dark);border-radius:12px">
          <div style="font-size:1.5rem;font-weight:700;color:var(--orange)">${n.carbs||0}g</div>
          <div style="font-size:0.65rem;color:var(--dim);margin-top:4px;font-weight:600;letter-spacing:1px">CARBS</div>
        </div>
        <div style="text-align:center;padding:14px 8px;background:var(--dark);border-radius:12px">
          <div style="font-size:1.5rem;font-weight:700;color:#60a5fa">${n.protein||0}g</div>
          <div style="font-size:0.65rem;color:var(--dim);margin-top:4px;font-weight:600;letter-spacing:1px">PROTEIN</div>
        </div>
        <div style="text-align:center;padding:14px 8px;background:var(--dark);border-radius:12px">
          <div style="font-size:1.5rem;font-weight:700;color:#f472b6">${n.fat||0}g</div>
          <div style="font-size:0.65rem;color:var(--dim);margin-top:4px;font-weight:600;letter-spacing:1px">FAT</div>
        </div>
      </div>
    </div>
    <div style="background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px;margin-bottom:14px">
      <div style="font-size:0.68rem;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--dim);margin-bottom:12px">Your Profile</div>
      ${[
        ['Name', USER.name],
        ['Goal', USER.goal],
        ['Current Weight', USER.weight ? USER.weight+' lbs' : null],
        ['Goal Weight', USER.goalWeight ? USER.goalWeight+' lbs' : null],
        ['Training Split', USER.split],
      ].filter(r=>r[1]).map(([k,v])=>`<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)"><span style="color:var(--dim);font-size:0.82rem">${k}</span><span style="color:var(--white);font-size:0.82rem;font-weight:600">${v}</span></div>`).join('')}
    </div>
  `;
}


/* ═══════════════════════════════════════════ */
/* SCORING.JS — Strength Score (0-1000) Math   */
/* ═══════════════════════════════════════════ */
// ═══════════════════════════════════════════
// SCORING.JS — Strength Score (0-1000) Math
// ═══════════════════════════════════════════
// Dependencies: woWorkout, woSets, USER, todayDateStr(), getExLogs()
// Exposes: _computeWorkoutStrengthScore(), _showWorkoutSummary()

function _computeWorkoutStrengthScore() {
  if (!woWorkout) return { score: 0, prevScore: 0 };
  var rawScore = 0, rawPrev = 0;
  var today = todayDateStr();
  woWorkout.exercises.forEach(function(ex){
    var exlogs = getExLogs();
    var sessions = exlogs[ex.name] || [];
    var todaySession = sessions.find(function(s){ return s.date === today; });
    if (todaySession && todaySession.sets) {
      todaySession.sets.forEach(function(s){
        if (s && s.weight && s.reps) rawScore += s.weight * s.reps;
      });
    }
    var prev = sessions.find(function(s){ return s.date !== today; });
    if (prev && prev.sets) {
      prev.sets.forEach(function(s){
        if (s && s.weight && s.reps) rawPrev += s.weight * s.reps;
      });
    }
  });

  // Normalize to 0-1000 using user profile baseline
  // Baseline = expected total volume for a session based on bodyweight, age, experience
  var bw = (USER && USER.weight) ? parseFloat(USER.weight) : 160;
  var age = (USER && USER.age) ? parseInt(USER.age) : 25;
  var tier = (USER && USER.tier) || 'beginner';
  // Age multiplier: peak at 25, declines gently
  var ageMult = age <= 25 ? 1.0 : Math.max(0.6, 1.0 - (age - 25) * 0.008);
  // Tier multiplier: advanced lifters move more total volume
  var tierMult = tier === 'advanced' ? 1.8 : tier === 'intermediate' ? 1.3 : 1.0;
  // Baseline: a "1000-score" session = roughly 1.0x bodyweight * 5 exercises * 4 sets * 10 reps * tierMult * ageMult
  var maxBaseline = bw * 5 * 4 * 10 * tierMult * ageMult;
  // Floor baseline so beginners still get meaningful scores
  if (maxBaseline < 5000) maxBaseline = 5000;

  var score = Math.round(Math.min(1000, (rawScore / maxBaseline) * 1000));
  var prevScore = Math.round(Math.min(1000, (rawPrev / maxBaseline) * 1000));
  return { score: score, prevScore: prevScore };
}

function _showWorkoutSummary(workoutName, prs) {
  var result = _computeWorkoutStrengthScore();
  var score = result.score;
  var prevScore = result.prevScore;
  var totalSets = woWorkout ? woWorkout.exercises.reduce(function(a,e){ return a + (e.sets||3); }, 0) : 0;
  var loggedSets = 0;
  if (woWorkout && woSets) {
    woWorkout.exercises.forEach(function(_,i){
      var s = woSets[i];
      if (s) for (var j=0;j<s.length;j++) if (s[j] && s[j].done) loggedSets++;
    });
  }
  // Gauge fills based on score/1000 — 95pts = 9.5% fill, not sets completed
  var fillPct = Math.min(100, (score / 1000) * 100);
  var arcLen = 251.2;
  var offset = arcLen - (arcLen * fillPct / 100);

  var overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.88);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;animation:fadeUp 0.3s ease';
  overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };

  var pct = prevScore > 0 ? Math.round(((score - prevScore) / prevScore) * 100) : 0;
  var deltaText = prevScore > 0 ? (pct >= 0 ? '+'+pct+'% vs last time' : pct+'% vs last time') : '';
  var prRows = (prs || []).map(function(p){
    return '<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border)"><div style="font-size:0.88rem;color:var(--white)">'+p.exercise+'</div><div style="font-family:\'DM Mono\',monospace;font-size:0.82rem;color:var(--green)">'+p.weight+'lbs × '+p.reps+' <span style="font-size:0.65rem;font-weight:700">▲ PR</span></div></div>';
  }).join('');

  overlay.innerHTML = '<div style="background:var(--card);border:1px solid var(--border);border-radius:20px;padding:28px 24px;max-width:380px;width:100%;text-align:center" onclick="event.stopPropagation()">'+
    '<div style="font-family:\'Bebas Neue\',sans-serif;font-size:1.2rem;letter-spacing:3px;color:var(--dim);margin-bottom:20px">WORKOUT COMPLETE</div>'+
    '<div style="position:relative;width:200px;height:110px;margin:0 auto 20px">'+
    '<svg viewBox="0 0 200 110" style="width:100%;height:100%">'+
    '<path d="M 20 100 A 80 80 0 0 1 180 100" fill="none" stroke="rgba(255,255,255,0.06)" stroke-width="12" stroke-linecap="round"/>'+
    '<path id="gauge-fill" d="M 20 100 A 80 80 0 0 1 180 100" fill="none" stroke="var(--green)" stroke-width="12" stroke-linecap="round" stroke-dasharray="251.2" stroke-dashoffset="'+offset+'"/>'+
    '</svg>'+
    '<div style="position:absolute;bottom:0;left:50%;transform:translateX(-50%);font-family:\'Bebas Neue\',sans-serif;font-size:2rem;letter-spacing:2px;color:var(--green)">'+score+'<span style="font-size:0.8rem;color:var(--dim)">/1000</span></div>'+
    '</div>'+
    '<div style="font-size:0.62rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--dim);margin-bottom:4px">Strength Score</div>'+
    (deltaText ? '<div style="font-size:0.8rem;color:var(--green);margin-bottom:16px">'+deltaText+'</div>' : '<div style="margin-bottom:16px"></div>')+
    (prRows ? '<div style="text-align:left;border-top:1px solid var(--border);padding-top:14px;margin-top:14px"><div style="font-size:0.65rem;font-weight:700;letter-spacing:2px;color:var(--green);margin-bottom:10px">PRs HIT TODAY</div>'+prRows+'</div>' : '')+
    '<button id="wo-summary-done-btn" style="margin-top:20px;padding:12px 32px;background:var(--green);border:none;border-radius:10px;color:var(--black);font-family:\'Bebas Neue\',sans-serif;font-size:1rem;letter-spacing:1.5px;cursor:pointer">DONE</button>'+
    '</div>';
  document.body.appendChild(overlay);
  document.getElementById('wo-summary-done-btn').onclick = function(){ overlay.remove(); };
}



/* ═══════════════════════════════════════════ */
/* LOGGER.JS — Workout UI, Nutrition, Food,    */
/*   Progress, Exercise Modals                  */
/* ═══════════════════════════════════════════ */
// ═══════════════════════════════════════════
// LOGGER.JS — Dashboard UI, Workout Environment, 
//   Nutrition/Food Tracking, Progress, Exercise Modals
// ═══════════════════════════════════════════
// Dependencies: All globals from app.js, scoring.js functions

function dashNav(view, btn) {
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.querySelectorAll('.sb-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('view-'+view).classList.add('active');
  if (btn) btn.classList.add('active');
  // Toggle coach-active class on main-content for full-screen coach layout
  const mainContent = document.querySelector('.main-content');
  if (mainContent) {
    if (view === 'coach') mainContent.classList.add('coach-active');
    else mainContent.classList.remove('coach-active');
  }
  // Sync mobile bottom tabs
  const mobViews = ['today','week','nutrition','coach'];
  document.querySelectorAll('.mob-tab').forEach(t=>t.classList.remove('active'));
  if (mobViews.includes(view)) {
    const mobTab = document.getElementById('mob-tab-'+view);
    if (mobTab) mobTab.classList.add('active');
  }
  if (view==='nutrition') renderNutrition();
  if (view==='myplan') { /* already rendered on plan generation */ }
  if (view==='week') renderWeek();
  if (view==='progress') { renderStreak(); renderWeightHistory(); renderNutritionChart(); renderFreqChart(); }
  if (view==='today') { renderTodayWorkout(); refreshDashMacros(); }
  if (view==='program') renderProgram();
  if (view==='settings') renderSettingsGymDays();
  if (view==='coach') initCoach();
}

// ── TODAY ──
function renderTodayWorkout() {
  const workout = DAY_WORKOUTS[TODAY_IDX];
  if (!workout) {
    document.getElementById('d-wkt-name').textContent = 'Rest Day';
    document.getElementById('d-wkt-sub').textContent = 'Recovery & mobility';
    document.getElementById('wc-badge').textContent = '● Rest Day';
    document.getElementById('wc-name').textContent = 'ACTIVE RECOVERY';
    const startBtn = document.getElementById('today-start-btn');
    startBtn.style.display = '';
    startBtn.textContent = '+ LOG UNPLANNED WORKOUT';
    startBtn.style.background = 'rgba(251,146,60,0.15)';
    startBtn.style.border = '1px solid rgba(251,146,60,0.3)';
    startBtn.style.color = 'var(--orange)';
    startBtn.onclick = () => openUnplannedWorkout(TODAY_IDX);
    document.getElementById('today-ex-list').innerHTML = '<div style="padding:16px;color:var(--off);font-size:0.86rem">Rest day — stretch, hydrate, recover. Or log an unplanned workout.</div>';
    const custBtn = document.getElementById('today-customize-btn');
    if (custBtn) custBtn.style.display = 'none';
    return;
  }
  // Show customize button on gym days
  const custBtn2 = document.getElementById('today-customize-btn');
  if (custBtn2) custBtn2.style.display = 'flex';
  const exes = workout.exercises, total = exes.length;
  const done = exes.filter((_,i) => getPrevSet(TODAY_IDX, i, 0) !== null).length;
  document.getElementById('d-wkt-name').textContent = workout.name;
  document.getElementById('d-wkt-sub').textContent = (wktDone.has(TODAY_IDX)?total:0)+' / '+total+' done';
  document.getElementById('d-wkt-bar').style.width = (wktDone.has(TODAY_IDX)?100:0)+'%';
  document.getElementById('wc-badge').textContent = '● Today · '+workout.name;
  document.getElementById('wc-name').textContent = workout.name.toUpperCase();
  const btn = document.getElementById('today-start-btn');
  btn.style.display = '';
  if (wktDone.has(TODAY_IDX)) { btn.textContent = '✓ COMPLETE'; btn.classList.add('done'); }
  else { btn.textContent = 'START WORKOUT'; btn.classList.remove('done'); }
  document.getElementById('today-ex-list').innerHTML = exes.map((ex,i)=>{
    const prev = getPrevSet(TODAY_IDX,i,0);
    return `<div class="ex-row ${wktDone.has(TODAY_IDX)?'done':''}" onclick="openWorkoutEnv(${TODAY_IDX})">
      <button class="ex-row-dots" onclick="event.stopPropagation();toggleExRowMenu(event,${i})" title="Options">⋮</button>
      <div><div class="ex-name">${ex.name}</div><div class="ex-detail">${ex.sets}×${ex.reps} · Rest ${ex.rest}s${prev?` · Last: ${prev.weight}lbs×${prev.reps}`:''}</div></div>
      <div class="ex-detail">${ex.muscles}</div>
    </div>`;
  }).join('');
}

// ── Portal dropdown (appended to body, never clipped) ──
let _exMenuEl = null;
function toggleExRowMenu(ev, idx) {
  ev.stopPropagation();
  closeExRowMenu();
  const btn = ev.currentTarget;
  const rect = btn.getBoundingClientRect();
  _exMenuEl = document.createElement('div');
  _exMenuEl.className = 'ex-row-dropdown-portal';
  _exMenuEl.style.cssText = `position:fixed;top:${rect.bottom+4}px;left:${rect.left}px;background:#1a1a1a;border:1px solid rgba(255,255,255,0.15);border-radius:10px;padding:6px 0;min-width:180px;z-index:99999;box-shadow:0 12px 40px rgba(0,0,0,0.7);animation:fadeUp 0.15s ease`;
  _exMenuEl.innerHTML = `
    <span onclick="openDashExPicker('superset',${idx});closeExRowMenu()" style="display:block;padding:12px 16px;font-size:0.85rem;color:#E2DFD8;cursor:pointer">Add Superset</span>
    <span onclick="openDashExPicker('substitute',${idx});closeExRowMenu()" style="display:block;padding:12px 16px;font-size:0.85rem;color:#E2DFD8;cursor:pointer">Substitute</span>
    <span onclick="deleteTodayExercise(${idx});closeExRowMenu()" style="display:block;padding:12px 16px;font-size:0.85rem;color:#F43F5E;cursor:pointer">Delete</span>`;
  _exMenuEl.querySelectorAll('span').forEach(s => {
    s.onmouseenter = () => s.style.background = 'rgba(255,255,255,0.06)';
    s.onmouseleave = () => s.style.background = 'none';
  });
  document.body.appendChild(_exMenuEl);
  // Close on any tap outside
  setTimeout(() => {
    document.addEventListener('click', function _close(e) {
      if (_exMenuEl && !_exMenuEl.contains(e.target)) closeExRowMenu();
      document.removeEventListener('click', _close);
    }, { once: true });
  }, 10);
}

function closeExRowMenu() {
  if (_exMenuEl && _exMenuEl.parentNode) {
    _exMenuEl.parentNode.removeChild(_exMenuEl);
  }
  _exMenuEl = null;
}

function deleteTodayExercise(idx) {
  const workout = DAY_WORKOUTS[TODAY_IDX];
  if (!workout || workout.exercises.length <= 1) { alert('Need at least one exercise.'); return; }
  workout.exercises.splice(idx, 1);
  persistTodayWorkout();
  renderTodayWorkout();
}

var _dashExPickerMode = null;
var _dashExPickerIdx = null;
var _dashExPickerCat = 'All';

var _buildPickerSelected = []; // [{name, sets, reps, rest, muscles}]
var _aesFilterMuscle = 'All';
var _aesFilterEquip = 'All';
var _aesDropdownEl = null;

// Equipment inference from exercise name/muscles
const EQUIPMENT_MAP = {
  'Barbell': ['Barbell','Conventional Deadlift','Sumo Deadlift','Rack Pull','Pendlay Row','Yates Row','Underhand Barbell Row','Barbell Row','Barbell Curl','EZ Bar Curl','Overhead Press','Barbell Shrugs','Bradford Press','Zercher Squat','Safety Bar Squat','Box Squat','Back Squat','Front Squat','Good Mornings','Board Press','Pin Press','Reverse Grip Bench Press','Guillotine Press','Bench Press','Incline Barbell Press','Decline Bench Press','Close Grip Bench'],
  'Dumbbell': ['Dumbbell','DB','Arnold Press','Zottman Curl','Incline DB','Dumbbell Bench','Dumbbell Flyes','Dumbbell Row','Dumbbell Curl','Hammer Curl','Concentration Curl','DB Press','Lateral Raises','Front Raises','Rear Delt Fly','Kickbacks','Dumbbell Shrug','Dumbbell Thruster','Dumbbell Pullover','Romanian Deadlift (DB)'],
  'Cable': ['Cable','Rope Pushdown','Cable Row','Seated Cable Row','Cable Crossover','Face Pull','Cable Face Pull','Straight-Arm Pulldown','Cable Crunch','Pallof Press','Cable Curl','Cable Hammer Curl','Cable Kickback','Cable Woodchop','Cable Oblique','Behind-the-Back Cable','Low Cable','High Cable','Single-Arm Cable'],
  'Machine': ['Machine','Leg Press','Leg Extension','Leg Curl','Seated Leg Curl','Lying Leg Curl','Pec Deck','Hack Squat','Adductor Machine','Abductor Machine','Lat Pulldown','Close-Grip Lat Pulldown','Wide-Grip Lat Pulldown','Reverse-Grip Lat Pulldown','Low Row Machine','High Row Machine','Tricep Dip Machine','Machine Shoulder Press','Seated Calf Raise Machine','Standing Calf Raise Machine','Pendulum Squat','Smith Machine','Chest Press Machine'],
  'Bodyweight': ['Push-Ups','Diamond Push','Pull-Ups','Chin-Ups','Dips','Plank','Side Plank','Dead Bug','Bird Dog','Mountain Climbers','Hollow','V-Ups','Bicycle','Superman','Burpees','Box Jumps','Jump Squat','Pistol Squat','Inverted Row','Nordic Curl','Glute Bridge','Frog Pump','L-Sit','Dragon Flag','Toes to Bar','Knee Raise','Windshield','Hollow Rock','Hollow Hold','Reverse Crunch','Copenhagen','Stir the Pot','GHD Sit-Up','Curtsy Lunge','Lateral Lunge'],
  'Kettlebell': ['Kettlebell'],
  'Resistance Band': ['Band','Banded'],
  'Cardio Machine': ['Rowing Machine','Stair Climber','Elliptical','Cycling','Treadmill','Assault Bike'],
};

function _getEquipment(name) {
  for (var equip in EQUIPMENT_MAP) {
    var keywords = EQUIPMENT_MAP[equip];
    for (var k = 0; k < keywords.length; k++) {
      if (name.toLowerCase().indexOf(keywords[k].toLowerCase()) !== -1) return equip;
    }
  }
  return 'Barbell'; // default
}

const MUSCLE_COLORS = {
  'Chest': '#f87171', 'Back': '#60a5fa', 'Shoulders': '#c084fc',
  'Biceps': '#fb923c', 'Triceps': '#f97316', 'Biceps': '#fb923c', 'Triceps': '#f97316', 'Arms': '#fb923c', 'Legs': '#4ade80', 'Core': '#facc15', 'Cardio': '#38bdf8'
};

function openDashExPicker(mode, exIdx) {
  _dashExPickerMode = mode;
  _dashExPickerIdx = exIdx;
  var modal = document.getElementById('dash-ex-picker-modal');
  modal.classList.add('open');
  var isBuild = mode === 'build';
  document.getElementById('dash-ex-picker-title').textContent = isBuild ? 'BUILD CUSTOM WORKOUT' : (mode==='substitute' ? 'SUBSTITUTE EXERCISE' : 'ADD SUPERSET');
  document.getElementById('dash-ex-picker-search').value = '';
  _aesFilterMuscle = 'All';
  _aesFilterEquip = 'All';
  _updateAesFilterLabels();
  // Show/hide build tray
  var tray = document.getElementById('aes-build-tray');
  if (tray) tray.style.display = isBuild ? 'block' : 'none';
  if (isBuild) { _buildPickerSelected = []; _updateBuildTray(); }
  renderDashExPickerList();
}

function _updateAesFilterLabels() {
  var mLabel = document.getElementById('aes-filter-muscle-label');
  var eLabel = document.getElementById('aes-filter-equip-label');
  var mBtn = document.getElementById('aes-filter-muscle-btn');
  var eBtn = document.getElementById('aes-filter-equip-btn');
  if (mLabel) mLabel.textContent = _aesFilterMuscle === 'All' ? 'MUSCLE GROUP' : _aesFilterMuscle.toUpperCase();
  if (eLabel) eLabel.textContent = _aesFilterEquip === 'All' ? 'EQUIPMENT' : _aesFilterEquip.toUpperCase();
  if (mBtn) mBtn.classList.toggle('active', _aesFilterMuscle !== 'All');
  if (eBtn) eBtn.classList.toggle('active', _aesFilterEquip !== 'All');
}

function toggleAesDropdown(type, btn) {
  // Close any open dropdown
  if (_aesDropdownEl) { _aesDropdownEl.remove(); _aesDropdownEl = null; return; }
  var rect = btn.getBoundingClientRect();
  var options = type === 'muscle'
    ? ['All','Chest','Back','Shoulders','Biceps','Triceps','Legs','Core','Cardio']
    : ['All','Barbell','Dumbbell','Cable','Machine','Bodyweight','Kettlebell','Resistance Band','Cardio Machine'];
  var current = type === 'muscle' ? _aesFilterMuscle : _aesFilterEquip;
  _aesDropdownEl = document.createElement('div');
  _aesDropdownEl.className = 'aes-dropdown';
  _aesDropdownEl.style.cssText = 'top:' + (rect.bottom + 4) + 'px;left:' + rect.left + 'px;';
  _aesDropdownEl.innerHTML = options.map(function(opt) {
    var safeOpt = opt.replace(/'/g, "\\'");
    return '<div class="aes-dropdown-item' + (opt === current ? ' selected' : '') + '" onclick="_setAesFilter(\'' + type + '\',\'' + safeOpt + '\')">' + (opt === 'All' ? 'All' : opt) + '</div>';
  }).join('');
  document.body.appendChild(_aesDropdownEl);
  setTimeout(function() {
    document.addEventListener('click', function _closeDD(e) {
      if (_aesDropdownEl && !_aesDropdownEl.contains(e.target) && e.target !== btn) {
        _aesDropdownEl.remove(); _aesDropdownEl = null;
      }
      document.removeEventListener('click', _closeDD);
    }, { once: true });
  }, 10);
}

function _setAesFilter(type, value) {
  if (type === 'muscle') _aesFilterMuscle = value;
  else _aesFilterEquip = value;
  if (_aesDropdownEl) { _aesDropdownEl.remove(); _aesDropdownEl = null; }
  _updateAesFilterLabels();
  renderDashExPickerList();
}

function closeDashExPicker() {
  document.getElementById('dash-ex-picker-modal').classList.remove('open');
  _dashExPickerMode = null;
  _dashExPickerIdx = null;
}

function filterDashExPicker() { renderDashExPickerList(); }

function renderDashExPickerList() {
  var search = (document.getElementById('dash-ex-picker-search')||{}).value.toLowerCase();
  var list = document.getElementById('dash-ex-picker-list');
  var filtered = Object.keys(EXERCISE_DB).filter(function(name){
    var data = EXERCISE_DB[name];
    var muscleMatch = _aesFilterMuscle === 'All' || data.category === _aesFilterMuscle;
    var equipMatch = _aesFilterEquip === 'All' || _getEquipment(name) === _aesFilterEquip;
    var searchMatch = !search || name.toLowerCase().indexOf(search)!==-1 || (data.muscles||'').toLowerCase().indexOf(search)!==-1;
    return muscleMatch && equipMatch && searchMatch;
  });
  // Sort: selected first, then alphabetical
  filtered.sort(function(a, b) {
    var aSelected = _dashExPickerMode === 'build' && _buildPickerSelected.some(function(e){ return e.name === a; });
    var bSelected = _dashExPickerMode === 'build' && _buildPickerSelected.some(function(e){ return e.name === b; });
    if (aSelected && !bSelected) return -1;
    if (!aSelected && bSelected) return 1;
    return a.localeCompare(b);
  });
  list.innerHTML = filtered.map(function(name){
    var data = EXERCISE_DB[name];
    var safeName = name.replace(/'/g,"\\'");
    var isSelected = _dashExPickerMode === 'build' && _buildPickerSelected.some(function(e){ return e.name === name; });
    var dotColor = MUSCLE_COLORS[data.category] || 'var(--dim)';
    return '<div class="aes-item" onclick="selectDashEx(\''+safeName+'\')" style="'+(isSelected?'border-color:rgba(74,222,128,0.3);background:rgba(74,222,128,0.05)':'')+'">'+
      '<div class="aes-muscle-dot" style="background:'+dotColor+'"></div>'+
      '<div><div class="aes-item-name">'+name+'</div><div class="aes-item-cat">'+(data.muscles||'').toUpperCase()+'</div></div>'+
      '<button class="aes-item-add" style="'+(isSelected?'background:var(--green);color:var(--black)':'')+'">'+(isSelected?'✓':'+')+'</button></div>';
  }).join('');
  if (!filtered.length) list.innerHTML = '<div style="text-align:center;padding:24px;color:var(--dim);font-size:0.83rem">No exercises found</div>';
}

function selectDashEx(name) {
  var db = getExerciseData(name);
  if (_dashExPickerMode === 'build') {
    // If already selected, remove it; otherwise open config to set sets/reps/rest
    var idx = _buildPickerSelected.findIndex(function(e){ return e.name === name; });
    if (idx >= 0) {
      _buildPickerSelected.splice(idx, 1);
      _updateBuildTray();
      renderDashExPickerList();
    } else {
      _openAesConfig(name, db);
    }
    return;
  }
  var workout = DAY_WORKOUTS[TODAY_IDX];
  if (!workout) { closeDashExPicker(); return; }
  var newEx = { name: name, sets: db.sets, reps: db.reps, rest: db.rest, muscles: db.muscles };
  if (_dashExPickerMode === 'substitute') {
    workout.exercises[_dashExPickerIdx] = newEx;
  } else {
    workout.exercises.splice(_dashExPickerIdx + 1, 0, newEx);
  }
  persistTodayWorkout();
  renderTodayWorkout();
  closeDashExPicker();
}

function _updateBuildTray() {
  var sel = document.getElementById('aes-build-selected');
  var beginBtn = document.getElementById('aes-begin-btn');
  if (!sel) return;
  if (_buildPickerSelected.length === 0) {
    sel.innerHTML = '<span style="font-size:0.75rem;color:var(--dim)">Tap exercises to add them</span>';
    if (beginBtn) beginBtn.style.display = 'none';
  } else {
    sel.innerHTML = _buildPickerSelected.map(function(e, i){
      return '<span style="display:inline-flex;align-items:center;gap:4px;background:var(--green-dim);border:1px solid rgba(74,222,128,0.2);border-radius:6px;padding:3px 8px;font-size:0.7rem;color:var(--green);font-family:\'Bebas Neue\',sans-serif;letter-spacing:0.5px">'
        + e.name + ' ' + e.sets + '×' + e.reps
        + '<button onclick="_removeBuildEx('+i+')" style="background:none;border:none;color:var(--green);cursor:pointer;padding:0;margin-left:2px;font-size:0.75rem;opacity:0.7">✕</button></span>';
    }).join('');
    if (beginBtn) beginBtn.style.display = 'block';
  }
}

function _removeBuildEx(idx) {
  _buildPickerSelected.splice(idx, 1);
  _updateBuildTray();
  renderDashExPickerList();
}

var _aesConfigPending = null; // {name, db}

function _openAesConfig(name, db) {
  _aesConfigPending = { name: name, db: db };
  document.getElementById('aes-config-name').textContent = name.toUpperCase();
  document.getElementById('aes-config-muscles').textContent = (db.muscles || '').toUpperCase();
  document.getElementById('aes-config-sets').value = db.sets || 3;
  var repsRaw = String(db.reps || '10');
  document.getElementById('aes-config-reps').value = parseInt(repsRaw.split('-')[0]) || 10;
  var rest = db.rest || 90;
  document.getElementById('aes-config-rest').value = rest;
  document.getElementById('aes-config-rest-display').textContent = rest + 's';
  var overlay = document.getElementById('aes-config-overlay');
  overlay.style.display = 'flex';
}

function closeAesConfig() {
  document.getElementById('aes-config-overlay').style.display = 'none';
  _aesConfigPending = null;
}

function adjustAesConfig(field, delta) {
  if (field === 'sets') {
    var el = document.getElementById('aes-config-sets');
    el.value = Math.max(1, Math.min(10, (parseInt(el.value)||3) + delta));
  } else if (field === 'reps') {
    var el = document.getElementById('aes-config-reps');
    el.value = Math.max(1, Math.min(50, (parseInt(el.value)||10) + delta));
  } else if (field === 'rest') {
    var el = document.getElementById('aes-config-rest');
    var newVal = Math.max(15, Math.min(300, (parseInt(el.value)||90) + delta));
    el.value = newVal;
    document.getElementById('aes-config-rest-display').textContent = newVal + 's';
  }
}

function confirmAesConfig() {
  if (!_aesConfigPending) return;
  var sets = parseInt(document.getElementById('aes-config-sets').value) || 3;
  var reps = parseInt(document.getElementById('aes-config-reps').value) || 10;
  var rest = parseInt(document.getElementById('aes-config-rest').value) || 90;
  var db = _aesConfigPending.db;
  _buildPickerSelected.push({
    name: _aesConfigPending.name,
    sets: sets,
    reps: reps,
    rest: rest,
    muscles: db.muscles
  });
  closeAesConfig();
  _updateBuildTray();
  renderDashExPickerList();
}

function beginCustomWorkoutFromPicker() {
  if (!_buildPickerSelected.length) return;
  _unplannedDayIdx = TODAY_IDX;
  closeDashExPicker();
  _launchUnplannedEnv(_buildPickerSelected.map(function(e){
    return { name: e.name, sets: e.sets || 3, reps: e.reps || '8-10', rest: e.rest || 90, muscles: e.muscles };
  }));
}

function persistTodayWorkout() {
  var workout = DAY_WORKOUTS[TODAY_IDX];
  if (!workout || !generatedPlan) return;
  var sched = generatedPlan.weekly_schedule[TODAY_IDX];
  if (sched && sched.type === 'workout') {
    sched.exercises = workout.exercises;
    lsSet('fs_plan', generatedPlan);
  }
}

document.addEventListener('click', function(){ closeExRowMenu(); });

// ── MACROS ──
function refreshDashMacros() {
  const t = getAllEntries(TODAY_IDX).reduce((a,e)=>({cal:a.cal+e.cal,pro:a.pro+e.pro}),{cal:0,pro:0});
  const calRem = TARGETS.cal - t.cal, proRem = TARGETS.pro - t.pro;
  const calEl = document.getElementById('d-cal'); if (!calEl) return;
  calEl.textContent = (calRem<0?'+':'')+Math.abs(calRem).toLocaleString();
  calEl.className = 'sc-val'+(calRem<0?' over':'');
  document.getElementById('d-cal-sub').textContent = 'of '+TARGETS.cal.toLocaleString()+' target';
  const proEl = document.getElementById('d-pro');
  proEl.textContent = (proRem<0?'+':'')+Math.abs(proRem)+'g';
  proEl.className = 'sc-val'+(proRem<0?' over':'');
  document.getElementById('d-pro-sub').textContent = 'of '+TARGETS.pro+'g target';
  document.getElementById('d-cal-bar').style.width = Math.min(t.cal/TARGETS.cal*100,100)+'%';
  document.getElementById('d-pro-bar').style.width = Math.min(t.pro/TARGETS.pro*100,100)+'%';
  document.getElementById('d-cal-bar').className = 'prog-fill'+(calRem<0?' over':'');
  document.getElementById('d-pro-bar').className = 'prog-fill'+(proRem<0?' over':'');
}

// ── WEEK ──
function renderWeek() {
  const gymCount = GYM_DAYS.length;
  document.getElementById('wk-done-sub').textContent = 'of '+gymCount+' scheduled';
  document.getElementById('week-grid').innerHTML = DAYS_FULL.map((day,i)=>{
    const isGym = GYM_DAYS.includes(i), isToday = i===TODAY_IDX, isDone = wktDone.has(i);
    const workout = DAY_WORKOUTS[i];
    let cls = 'wday';
    if (isToday) cls += ' is-today'; else if (isDone) cls += ' is-done';
    const svgCheck = '<svg viewBox="0 0 24 24" fill="none" stroke="#4ADE80" stroke-width="2.5" width="22" height="22"><polyline points="20 6 9 17 4 12"/></svg>';
    const svgDumbbell = '<svg viewBox="0 0 28 14" fill="none" xmlns="http://www.w3.org/2000/svg" width="24" height="12" style="opacity:0.6;color:var(--tier-color)"><rect x="11" y="5" width="6" height="4" rx="1" fill="currentColor"/><rect x="7" y="3" width="4" height="8" rx="1" fill="currentColor"/><rect x="17" y="3" width="4" height="8" rx="1" fill="currentColor"/><rect x="3" y="4" width="4" height="6" rx="1.5" fill="currentColor"/><rect x="21" y="4" width="4" height="6" rx="1.5" fill="currentColor"/></svg>';
    const svgRestBlank = '<svg viewBox="0 0 24 24" fill="none" width="20" height="20" style="opacity:0.18"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="1.5"/><path d="M8 12h8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>';
    const icon = isDone ? svgCheck : isGym ? svgDumbbell : svgRestBlank;
    const label = workout ? workout.name : 'Rest';
    const clickFn = DAY_WORKOUTS[i] ? `openWorkoutEnv(${i})` : `openUnplannedWorkout(${i})`;
    return `<div class="${cls}" onclick="${clickFn}"><div class="wday-name">${DAYS_SHORT[i]}</div><div class="wday-icon">${icon}</div><div class="wday-label">${label}</div></div>`;
  }).join('');
  const doneCount = [...wktDone].length;
  document.getElementById('wk-done').textContent = doneCount;
  document.getElementById('wk-done-bar').style.width = (gymCount?doneCount/gymCount*100:0)+'%';
}

// ── NUTRITION ──
// ── WATER TRACKING ──
let WATER_GOAL = 64; // oz per day — updated dynamically
let waterLogs = {}; // { dayKey: oz }

function getWaterKey(dayIdx) {
  const d = new Date(); d.setDate(d.getDate() - (TODAY_IDX - dayIdx));
  return d.toISOString().split('T')[0];
}

function getWaterOz(dayIdx) {
  return waterLogs[getWaterKey(dayIdx)] || 0;
}

function setWaterOz(dayIdx, oz) {
  waterLogs[getWaterKey(dayIdx)] = Math.max(0, oz);
  lsSet('fs_water', waterLogs);
}

function updateWaterGoal(val) {
  const oz = parseInt(val);
  if (!oz || oz < 16) return;
  lsSet('fs_water_goal', oz);
  renderWater();
}

function getWaterGoal() {
  return lsGet('fs_water_goal') || 64;
}

function toggleCustomWater() {
  const row = document.getElementById('water-custom-row');
  const isHidden = row.style.display === 'none' || row.style.display === '';
  row.style.display = isHidden ? 'flex' : 'none';
  if (isHidden) {
    const inp = document.getElementById('water-custom-input');
    if (inp) { inp.value = ''; setTimeout(function(){ inp.focus(); }, 50); }
  }
}

function addCustomWater() {
  const input = document.getElementById('water-custom-input');
  const oz = parseFloat(input.value);
  if (!oz || oz <= 0) return;
  addWater(oz);
  input.value = '';
  const row = document.getElementById('water-custom-row');
  if (row) row.style.display = 'none';
}

function addWater(oz) {
  const current = getWaterOz(nutDay);
  setWaterOz(nutDay, current + oz);
  renderWater();
}

function undoWater() {
  const current = getWaterOz(nutDay);
  setWaterOz(nutDay, Math.max(0, current - 8));
  renderWater();
}

function renderWater() {
  WATER_GOAL = getWaterGoal();
  const goalInput = document.getElementById('water-goal-input');
  if (goalInput) goalInput.value = WATER_GOAL;
  const oz = getWaterOz(nutDay);
  const pct = Math.min(oz / WATER_GOAL, 1);
  const circumference = 263.9;
  const offset = circumference * (1 - pct);

  document.getElementById('water-oz-display').textContent = oz;
  document.getElementById('water-ring-fill').style.strokeDashoffset = offset;

  const cups = Math.floor(oz / 8);
  const totalCups = Math.min(Math.ceil(WATER_GOAL / 8), 16);
  document.getElementById('water-cups').innerHTML =
    Array.from({length: totalCups}, (_,i) =>
      `<div class="water-cup ${i < cups ? 'filled' : 'empty'}"></div>`
    ).join('');

  const pctInt = Math.round(pct * 100);
  let status = 'Stay hydrated <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M6 4v6M6 14v6M18 4v6M18 14v6M3 7h6M15 7h6M3 17h6M15 17h6"/></svg>';
  if (pct >= 1) status = 'Goal reached! Great work! ★';
  else if (pct >= 0.75) status = `${pctInt}% — almost there!`;
  else if (pct >= 0.5) status = `${pctInt}% — halfway there`;
  else if (pct >= 0.25) status = `${pctInt}% — keep drinking!`;
  else if (oz > 0) status = `${pctInt}% — just getting started`;
  document.getElementById('water-status').innerHTML = status;
}

// ── MEAL CATEGORIES (MFP-style) ──
const MEAL_CATS = [
  { id:'breakfast', icon:'', label:'Breakfast' },
  { id:'lunch',     icon:'', label:'Lunch' },
  { id:'dinner',    icon:'', label:'Dinner' },
  { id:'snacks',    icon:'', label:'Snacks' },
  { id:'other',     icon:'', label:'Other' },
];

let activeFoodCat = 'breakfast'; // which category we're adding to
let currentFoodItem = null;
let foodModalTab = 'search'; // 'search' | 'recent' | 'custom'

function getMealCatEntries(dayIdx, catId) {
  if (!mealLogs[dayIdx]) mealLogs[dayIdx] = {};
  if (Array.isArray(mealLogs[dayIdx])) {
    // Migrate old flat array to category format
    const old = mealLogs[dayIdx];
    mealLogs[dayIdx] = { breakfast:[], lunch:[], dinner:[], snacks:[], other:[] };
    mealLogs[dayIdx].other = old;
  }
  if (!mealLogs[dayIdx][catId]) mealLogs[dayIdx][catId] = [];
  return mealLogs[dayIdx][catId];
}

function getAllEntries(dayIdx) {
  const cats = ['breakfast','lunch','dinner','snacks','other'];
  return cats.flatMap(c => getMealCatEntries(dayIdx, c));
}

function renderMealCategories() {
  const el = document.getElementById('meal-categories');
  if (!el) return;
  el.innerHTML = MEAL_CATS.map(cat => {
    const entries = getMealCatEntries(nutDay, cat.id);
    const totalCal = entries.reduce((s,e) => s+e.cal, 0);
    const totalPro = entries.reduce((s,e) => s+e.pro, 0);
    const totalCarb = entries.reduce((s,e) => s+e.carb, 0);
    const totalFat = entries.reduce((s,e) => s+e.fat, 0);
    const entryRows = entries.map((e,i) =>
      `<div class="meal-entry-row">
        <div><div class="mer-name">${e.name}</div><div class="mer-macros">${e.pro}g P · ${e.carb}g C · ${e.fat}g F</div></div>
        <div class="mer-cal">${e.cal}</div>
        <button class="mer-del" onclick="deleteCatMeal('${cat.id}',${i})">✕</button>
      </div>`
    ).join('');
    const totalRow = entries.length ? `<div class="meal-cat-total"><span>${totalPro}g protein</span><span>${totalCarb}g carbs</span><span>${totalFat}g fat</span><span style="color:var(--green)">${totalCal} cal</span></div>` : '';
    return `<div class="meal-cat-card">
      <div class="meal-cat-header">
        <div class="meal-cat-left" style="gap:10px;flex:1">
          <div><div class="meal-cat-name">${cat.label}</div>${totalCal>0?`<div class="meal-cat-cals">${totalCal} cal</div>`:''}</div>
          <button class="btn-cat-add" onclick="openFoodModal('${cat.id}')">+ ADD</button>
          <button class="btn-cat-scan" onclick="openBarcodeScanner('${cat.id}')" title="Scan barcode" style="font-size:0.72rem"><svg viewBox="0 0 32 20" width="18" height="12" fill="currentColor"><rect x="0" y="0" width="2" height="20"/><rect x="4" y="0" width="1" height="20"/><rect x="7" y="0" width="3" height="20"/><rect x="12" y="0" width="1" height="20"/><rect x="15" y="0" width="2" height="20"/><rect x="19" y="0" width="1" height="20"/><rect x="22" y="0" width="3" height="20"/><rect x="27" y="0" width="1" height="20"/><rect x="30" y="0" width="2" height="20"/></svg></button>
        </div>
      </div>
      ${entryRows ? `<div class="meal-cat-entries">${entryRows}${totalRow}</div>` : ''}
    </div>`;
  }).join('');
}

function deleteCatMeal(catId, idx) {
  getMealCatEntries(nutDay, catId).splice(idx, 1);
  renderMealCategories(); renderMacros(); saveToStorage();
}

// ── FOOD MODAL ──
function openFoodModal(catId) {
  activeFoodCat = catId;
  foodModalTab = 'search';
  document.getElementById('food-modal').classList.add('open');
  document.getElementById('food-modal-cat-label').textContent =
    MEAL_CATS.find(c=>c.id===catId)?.label || catId;
  document.getElementById('food-modal-search-input').value = '';
  document.getElementById('food-modal-results').innerHTML = '';
  showFoodModalTab('search');
  renderRecentFoods();
  setTimeout(()=>document.getElementById('food-modal-search-input').focus(), 100);
}

function closeFoodModal() {
  document.getElementById('food-modal').classList.remove('open');
}

function showFoodModalTab(tab) {
  foodModalTab = tab;
  document.querySelectorAll('.fmt-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
  const resultsEl = document.getElementById('food-modal-results');
  if (tab === 'recent') renderRecentFoodsInModal();
  else if (tab === 'custom') renderCustomFoodsInModal();
  else resultsEl.innerHTML = '<div class="food-modal-empty">Search above or scan a barcode to find foods</div>';
}

// Recent foods
function getRecentFoods() { return lsGet('fs_recent_foods') || []; }
function saveRecentFood(item) {
  let recents = getRecentFoods();
  recents = [item, ...recents.filter(r => r.name !== item.name)].slice(0, 20);
  lsSet('fs_recent_foods', recents);
}

function renderRecentFoods() {
  const recents = getRecentFoods();
  if (!recents.length) return;
  const resultsEl = document.getElementById('food-modal-results');
  if (foodModalTab === 'recent') renderRecentFoodsInModal();
}

function renderRecentFoodsInModal() {
  const recents = getRecentFoods();
  const resultsEl = document.getElementById('food-modal-results');
  if (!recents.length) {
    resultsEl.innerHTML = '<div class="food-modal-empty">No recent foods yet. Search to find and log foods.</div>';
    return;
  }
  resultsEl.innerHTML = `<div class="recent-foods-section"><div class="rfs-label">Recently Logged</div></div>` +
    recents.map((item, i) =>
      `<div class="food-modal-item" onclick="openServingModal(${i}, 'recent')">
        <div>
          <div class="fmi-name">${item.name}</div>
          ${item.brand ? `<div class="fmi-brand">${item.brand}</div>` : ''}
          <div class="fmi-macros">${item.pro100 ? Math.round(item.pro100)+'g P · '+Math.round(item.carb100)+'g C · '+Math.round(item.fat100)+'g F per 100g' : item.pro+'g P · '+item.carb+'g C · '+item.fat+'g F'}</div>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <div class="fmi-cal">${Math.round(item.cal100 || item.cal)}</div>
          <button class="fmi-add">+</button>
        </div>
      </div>`
    ).join('');
  window._recentResults = recents;
}

// Custom foods
function getCustomFoods() { return lsGet('fs_custom_foods') || []; }
function saveCustomFood(item) {
  let customs = getCustomFoods();
  customs = [item, ...customs.filter(c => c.name !== item.name)];
  lsSet('fs_custom_foods', customs);
}

function renderCustomFoodsInModal() {
  const customs = getCustomFoods();
  const resultsEl = document.getElementById('food-modal-results');
  if (!customs.length) {
    resultsEl.innerHTML = `<div class="food-modal-empty">No custom foods saved yet.<br><br>
      <button onclick="openManualFoodEntry()" style="padding:10px 20px;background:var(--green-dim);border:1px solid rgba(74,222,128,0.2);border-radius:10px;color:var(--green);font-family:'Bebas Neue',sans-serif;font-size:0.9rem;letter-spacing:1.5px;cursor:pointer">+ CREATE CUSTOM FOOD</button>
    </div>`;
    return;
  }
  resultsEl.innerHTML = `<div style="padding:12px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:flex-end">
    <button onclick="openManualFoodEntry()" style="padding:8px 14px;background:var(--green-dim);border:1px solid rgba(74,222,128,0.2);border-radius:8px;color:var(--green);font-family:'Bebas Neue',sans-serif;font-size:0.78rem;letter-spacing:1px;cursor:pointer">+ NEW CUSTOM FOOD</button>
  </div>` +
  customs.map((item, i) =>
    `<div class="food-modal-item" onclick="openServingModal(${i}, 'custom')">
      <div>
        <div class="fmi-name">${item.name}</div>
        <div class="fmi-macros">${item.pro}g P · ${item.carb}g C · ${item.fat}g F per serving</div>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <div class="fmi-cal">${item.cal}</div>
        <button class="fmi-add">+</button>
      </div>
    </div>`
  ).join('');
  window._customResults = customs;
}

function openManualFoodEntry() {
  closeFoodModal();
  document.getElementById('manual-food-modal').classList.add('open');
}

function closeManualFoodModal() {
  document.getElementById('manual-food-modal').classList.remove('open');
  ['mf-name','mf-cal','mf-pro','mf-carb','mf-fat','mf-serving'].forEach(id => {
    document.getElementById(id).value = '';
  });
}

function saveManualFood() {
  const name = document.getElementById('mf-name').value.trim();
  const cal = parseInt(document.getElementById('mf-cal').value) || 0;
  const pro = parseInt(document.getElementById('mf-pro').value) || 0;
  const carb = parseInt(document.getElementById('mf-carb').value) || 0;
  const fat = parseInt(document.getElementById('mf-fat').value) || 0;
  const serving = document.getElementById('mf-serving').value.trim() || '1 serving';
  if (!name) { alert('Please enter a food name'); return; }
  const item = { name, cal, pro, carb, fat, serving, isCustom: true };
  saveCustomFood(item);
  closeManualFoodModal();
  // Log it immediately
  getMealCatEntries(nutDay, activeFoodCat).push({ name, cal, pro, carb, fat });
  renderMealCategories(); renderMacros(); saveToStorage();
}

// ── FOOD SEARCH ──
// Normalize query: fix common brand spellings and strip extra punctuation
function normalizeQuery(q) {
  return q.trim()
    .replace(/chic+\s*fil+\s*a/i, 'Chick-fil-A')
    .replace(/mcdonalds?/i, "McDonald's")
    .replace(/chipotles?/i, 'Chipotle')
    .replace(/starbucks?/i, 'Starbucks')
    .replace(/[‘’]/g, "'");
}

// ── FOOD SEARCH ──
// wger.de: free, no API key, CORS-open, English food database (primary)
// Open Food Facts: branded/packaged foods, 5s timeout (secondary)

async function fetchWger(query) {
  const url = `https://wger.de/api/v2/ingredient/?format=json&language=2&name=${encodeURIComponent(query)}&limit=30`;
  const res = await fetch(url);
  if (!res.ok) throw new Error('wger ' + res.status);
  const data = await res.json();
  const wgerSeen = new Set();
  let results = (data.results || []).filter(f => {
    if (!f.name || !f.energy || !/^[\x20-\x7E]+$/.test(f.name)) return false;
    const key = f.name.toLowerCase().replace(/[^a-z0-9]/g,'');
    if (wgerSeen.has(key)) return false;
    wgerSeen.add(key);
    return true;
  });
  if (!results.length) {
    const url2 = `https://wger.de/en/user/api/ingredient-search/?format=json&term=${encodeURIComponent(query)}`;
    const data2 = await fetch(url2).then(r=>r.json()).catch(()=>({}));
    const suggestions = data2.suggestions || [];
    const fetches = suggestions.slice(0, 8).map(s =>
      fetch(`https://wger.de/api/v2/ingredient/${s.data.id}/?format=json`)
        .then(r => r.json()).catch(() => null)
    );
    const items = (await Promise.all(fetches)).filter(i => i && i.energy > 0);
    results = items;
  }
  return results.map(f => {
    // Use shared smartServingG + label lookup
    let servingG = smartServingG(f.name);
    let servingLabel;
    if (servingG === 0) { servingG = 100; servingLabel = '100g'; }
    else {
      const sg = servingG;
      const n = (f.name || '').toLowerCase();
      if (sg === 50) servingLabel = '1 egg (50g)';
      else if (sg === 30) servingLabel = '1 slice (30g)';
      else if (sg === 28) servingLabel = '1 oz (28g)';
      else if (sg === 240) servingLabel = '1 cup (240ml)';
      else if (sg === 120) servingLabel = '1 medium (120g)';
      else if (sg === 170) servingLabel = '6 oz (170g)';
      else if (sg === 195) servingLabel = '1 cup cooked (195g)';
      else if (sg === 14) servingLabel = '1 tbsp (14g)';
      else if (sg === 110) servingLabel = '2 pancakes (110g)';
      else if (sg === 150) servingLabel = '1 medium (150g)';
      else if (sg === 32) servingLabel = '2 tbsp (32g)';
      else if (sg === 55) servingLabel = '1 cup (55g)';
      else servingLabel = sg + 'g';
    }
    const cal100 = Math.round(f.energy || 0);
    const pro100 = Math.round(parseFloat(f.protein) || 0);
    const carb100 = Math.round(parseFloat(f.carbohydrates) || 0);
    const fat100 = Math.round(parseFloat(f.fat) || 0);
    const factor = servingG / 100;
    return {
      name: f.name.charAt(0).toUpperCase() + f.name.slice(1),
      brand: '',
      cal: Math.round(cal100 * factor),
      pro: Math.round(pro100 * factor),
      carb: Math.round(carb100 * factor),
      fat: Math.round(fat100 * factor),
      serving: servingLabel,
      servingG,
      cal100, pro100, carb100, fat100,
    };
  });
}

function smartServingG(name) {
  const n = (name || '').toLowerCase().replace(/[^a-z0-9 ]/g, ' ');
  if (n.includes('shake') || n.includes('core power') || n.includes('fairlife') || n.includes('protein milk') || n.includes('muscle milk')) return 414;
  if (n.includes('protein bar') || n.includes('quest bar') || n.includes('rx bar') || n.includes('clif bar')) return 60;
  if (n.includes('egg')) return 50;
  if (n.includes('bread') || n.includes('slice') || n.includes('tortilla')) return 45;
  if (n.includes('cheese') || n.includes('string')) return 28;
  if (n.includes('greek yogurt')) return 113;
  if (n.includes('milk') || n.includes('yogurt') || n.includes('kefir')) return 240;
  if (n.includes('juice') || n.includes('drink') || n.includes('beverage') || n.includes('water')) return 355;
  if (n.includes('banana') || n.includes('apple') || n.includes('orange')) return 120;
  if (n.includes('chicken') || n.includes('beef') || n.includes('salmon') || n.includes('tuna') || n.includes('turkey') || n.includes('steak') || n.includes('pork') || n.includes('fish')) return 170;
  if (n.includes('rice') || n.includes('oat') || n.includes('quinoa')) return 195;
  if (n.includes('pasta') || n.includes('noodle') || n.includes('spaghetti')) return 140;
  if (n.includes('pancake') || n.includes('waffle')) return 110;
  if (n.includes('almond') || n.includes('cashew') || n.includes('walnut') || n.includes('peanut')) return 28;
  if (n.includes('butter') || n.includes('peanut butter') || n.includes('almond butter')) return 32;
  if (n.includes('oil') || n.includes('olive')) return 14;
  if (n.includes('protein powder') || n.includes('whey') || n.includes('casein') || n.includes('scoop')) return 30;
  if (n.includes('granola') || n.includes('cereal')) return 55;
  if (n.includes('cookie') || n.includes('brownie') || n.includes('muffin')) return 55;
  if (n.includes('avocado')) return 150;
  if (n.includes('sweet potato') || n.includes('potato')) return 150;
  if (n.includes('cottage cheese') || n.includes('sour cream')) return 113;
  if (n.includes('hummus')) return 56;
  if (n.includes('ground beef') || n.includes('ground turkey') || n.includes('ground pork')) return 113;
  if (n.includes('mixed nuts') || n.includes('trail mix') || n.includes('sunflower')) return 28;
  if (n.includes('soup') || n.includes('broth')) return 245;
  if (n.includes('cracker') || n.includes('pretzel') || n.includes('chip')) return 28;
  if (n.includes('broccoli') || n.includes('spinach') || n.includes('kale') || n.includes('salad')) return 85;
  if (n.includes('corn') || n.includes('peas') || n.includes('green bean')) return 85;
  if (n.includes('tofu') || n.includes('tempeh') || n.includes('edamame')) return 85;
  if (n.includes('blueberry') || n.includes('strawberry') || n.includes('raspberry')) return 148;
  return 0; // no smart default, use 100g
}

async function fetchOFF(query) {
  const url = 'https://world.openfoodfacts.org/api/v2/search?search_terms=' + encodeURIComponent(query) + '&fields=product_name,brands,nutriments,serving_size,serving_quantity,lang,lc&page_size=30&sort_by=unique_scans_n&lc=en&cc=us';
  const fetchPromise = fetch(url).then(function(r) { return r.json(); });
  const timeoutPromise = new Promise(function(_, rej) { setTimeout(function(){ rej(new Error('timeout')); }, 6000); });
  const res_data = await Promise.race([fetchPromise, timeoutPromise]);
  const data = res_data;
  const seen = new Set();
  const _nonEnFood = /\b(fromage|lait|beurre|yaourt|jus de|blanc|noir|doux|pâté|crème|frais|confiture|noisette|fraise|vanille|sucre|farine|huile|vinaigre|miel|légume|poisson|poulet|boeuf|porc|lentille|haricot|oignon|carotte|pomme de terre|perly|jaouda|jben|lactel|président|bjorg|bonduelle|paysan|breton|vache|leche|queso|mantequilla|harina|arroz|aceite|azucar)\b/i;
  return (data.products || []).filter(p =>
    p.product_name && /^[\x20-\x7E]+$/.test(p.product_name) &&
    !_nonEnFood.test(p.product_name) &&
    p.nutriments && (p.nutriments['energy-kcal_100g'] > 0 || p.nutriments['energy-kcal'] > 0)
  ).map(p => {
    const cal100 = p.nutriments['energy-kcal_100g'] || p.nutriments['energy-kcal'] || 0;
    const pro100 = p.nutriments['proteins_100g'] || 0;
    const carb100 = p.nutriments['carbohydrates_100g'] || 0;
    const fat100 = p.nutriments['fat_100g'] || 0;
    // Use OFF serving if available, else smart default, else 100g
    let sg = parseFloat(p.serving_quantity) || 0;
    let servingLabel = p.serving_size || '';
    if (!sg) {
      sg = smartServingG(p.product_name);
    }
    // Build a nice label if we don't have one from OFF
    if (!servingLabel && sg > 0) {
      const n = (p.product_name||'').toLowerCase();
      if (sg === 28) servingLabel = '1 oz (28g)';
      else if (sg === 50) servingLabel = '1 egg (50g)';
      else if (sg === 30) servingLabel = '1 slice (30g)';
      else if (sg === 45) servingLabel = '1 tortilla (45g)';
      else if (sg === 240) servingLabel = '1 cup (240ml)';
      else if (sg === 414) servingLabel = '1 bottle (414ml)';
      else if (sg === 170) servingLabel = '6 oz (170g)';
      else if (sg === 195) servingLabel = '1 cup cooked (195g)';
      else if (sg === 14) servingLabel = '1 tbsp (14g)';
      else if (sg === 32) servingLabel = '2 tbsp (32g)';
      else if (sg === 110) servingLabel = '2 pancakes (110g)';
      else if (sg === 60) servingLabel = '1 bar (60g)';
      else if (sg === 30) servingLabel = '1 scoop (30g)';
      else servingLabel = sg + 'g';
    }
    if (!servingLabel) servingLabel = '100g';
    if (!sg) sg = 100;
    const factor = sg / 100;
    return {
      name: p.product_name, brand: (p.brands || '').split(',')[0].trim(),
      cal: Math.round(cal100 * factor), pro: Math.round(pro100 * factor),
      carb: Math.round(carb100 * factor), fat: Math.round(fat100 * factor),
      cal100, pro100, carb100, fat100,
      serving: servingLabel, servingG: sg,
    };
  }).filter(p => {
    // Deduplicate: keep first occurrence of each name
    const key = p.name.toLowerCase().replace(/[^a-z0-9]/g, '');
    if (seen.has(key)) return false;
    seen.add(key);
    // Relevance guard: at least one query word must appear in name or brand
    // Prevents OFF returning totally unrelated popular items (cream cheese for "chicken")
    const haystack = (p.name + ' ' + (p.brand || '')).toLowerCase();
    const qw = query.toLowerCase().split(/\s+/).filter(w => w.length > 1);
    return qw.some(w => haystack.includes(w));
  });
}

function renderFoodResults(results, resultsEl) {
  window._searchResults = results;
  if (!results.length) {
    resultsEl.innerHTML = '<div class="food-modal-empty">No matching results. Try a shorter search term.</div>';
    return;
  }
  resultsEl.innerHTML = results.slice(0, 30).map((item, i) => {
    const srcBadge = item._source === 'usda_branded'
      ? '<span style="font-size:0.58rem;font-weight:700;letter-spacing:0.8px;background:rgba(74,222,128,0.1);color:var(--green);border:1px solid rgba(74,222,128,0.2);border-radius:3px;padding:1px 5px;margin-left:5px">USDA</span>'
      : item._source === 'usda_foundation'
      ? '<span style="font-size:0.58rem;font-weight:700;letter-spacing:0.8px;background:rgba(96,165,250,0.1);color:var(--blue);border:1px solid rgba(96,165,250,0.2);border-radius:3px;padding:1px 5px;margin-left:5px">USDA</span>'
      : '';
    return `<div class="food-modal-item" onclick="openServingModal(${i}, 'search')">
      <div style="flex:1;min-width:0">
        <div class="fmi-name">${item.name}${srcBadge}</div>
        ${item.brand ? `<div class="fmi-brand">${item.brand}</div>` : ''}
        <div class="fmi-macros">${item.pro}g P · ${item.carb}g C · ${item.fat}g F · <span style="color:var(--dim)">per ${item.serving || '100g'}</span></div>
      </div>
      <div style="display:flex;align-items:center;gap:8px;flex-shrink:0">
        <div class="fmi-cal">${item.cal}<span style="font-size:0.6rem;color:var(--dim)"> cal</span></div>
        <button class="fmi-add">+</button>
      </div>
    </div>`;
  }).join('');
}

async function searchFoodModal() {
  const rawQuery = document.getElementById('food-modal-search-input').value.trim();
  if (!rawQuery) return;
  const resultsEl = document.getElementById('food-modal-results');
  resultsEl.innerHTML = '<div class="food-modal-loading"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg> Searching...</div>';

  const query = normalizeQuery(rawQuery);

  // Words that are brand/filler words — should NOT dominate scoring
  // "just", "bare", "simple", "pure", etc. are brand names or adjectives, not food nouns
  const FILLER_WORDS = new Set(['just','bare','simply','pure','real','natural','organic','fresh',
    'original','classic','the','and','with','in','of','for','my','your','our','new',
    'easy','quick','good','best','great','big','little','small','light','lite','low','high',
    'free','no','non','ultra','super','mega','extra','premium','select','choice','true','clean']);

  // Split query into food-noun words vs filler words
  const allQWords = query.toLowerCase().split(/\s+/).filter(function(w){ return w.length > 1; });
  const foodWords  = allQWords.filter(function(w){ return !FILLER_WORDS.has(w); });
  const fillerWords = allQWords.filter(function(w){ return FILLER_WORDS.has(w); });

  // If user typed only filler (e.g. "just"), fall back to full query
  const coreWords = foodWords.length > 0 ? foodWords : allQWords;

  // Build multiple search queries to maximize recall:
  // 1. Full query ("just bare chicken") — catches exact brand matches
  // 2. Core food noun only ("chicken") — catches all chicken products
  // 3. Brand-only words ("just bare") + food noun — catches "Just Bare" branded items
  const coreQuery = coreWords.join(' ');
  const brandQuery = fillerWords.length > 0 ? fillerWords.join(' ') + ' ' + coreWords[0] : null;

  const searches = [
    _searchUSDA_branded(query),           // exact brand phrase
    _searchUSDA_branded(coreQuery),       // food noun only (broadest)
    _searchUSDA_foundation(coreQuery),    // whole foods
    fetchOFF(query)
  ];
  // If there are brand/filler words, fire an extra search combining brand + first food noun
  if (brandQuery && brandQuery !== query && brandQuery !== coreQuery) {
    searches.push(_searchUSDA_branded(brandQuery));
  }

  const settled = await Promise.allSettled(searches);

  const allItems = [];
  settled.forEach(function(r) {
    if (r.status === 'fulfilled') {
      r.value.forEach(function(item) { allItems.push(item); });
    }
  });

  // WEIGHTED scoring:
  // - Each FOOD WORD match in name: 20 pts
  // - Each FOOD WORD match in brand: 8 pts
  // - Each FILLER WORD match: 2 pts (much lower — "bare" matching "bare muffin" shouldn't compete with "chicken")
  // - Exact full-query match anywhere: 30 pts bonus
  // - All food words present: 15 pts bonus (the result contains every core word)
  // - Penalty: each extra word in result name beyond query length: -3 pts
  function scoreItem(item) {
    const nameLower  = (item.name  || '').toLowerCase();
    const brandLower = (item.brand || '').toLowerCase();
    const haystack   = nameLower + ' ' + brandLower;
    let score = 0;

    foodWords.forEach(function(w) {
      if (nameLower.includes(w))  score += 20;
      if (brandLower.includes(w)) score += 8;
    });
    fillerWords.forEach(function(w) {
      if (haystack.includes(w)) score += 2;
    });

    // Big bonus if EVERY food word is in the name (e.g. "chicken" AND "breast" both present)
    const allFoodWordsInName = foodWords.every(function(w){ return nameLower.includes(w); });
    if (allFoodWordsInName && foodWords.length > 0) score += 15;

    // Exact full query bonus
    if (haystack.includes(query.toLowerCase())) score += 30;

    // Penalty for long result names (keeps specific results above generic ones)
    const resultWordCount = nameLower.split(/\s+/).length;
    score -= Math.max(0, resultWordCount - allQWords.length - 1) * 3;

    // USDA Branded is most reliable source
    if (item._source === 'usda_branded') score += 4;

    return score;
  }

  // Merge, deduplicate, filter to items scoring > 0
  const seen = new Set();
  const merged = [];
  for (let i = 0; i < allItems.length; i++) {
    const item = allItems[i];
    const key = ((item.name || '') + '|' + (item.brand || '')).toLowerCase().replace(/[^a-z0-9|]/g, '');
    if (seen.has(key)) continue;
    seen.add(key);
    item._score = scoreItem(item);
    if (item._score > 0) merged.push(item);
  }

  merged.sort(function(a, b) { return b._score - a._score; });

  if (merged.length) {
    renderFoodResults(merged, resultsEl);
  } else {
    resultsEl.innerHTML = '<div class="food-modal-empty">'
      + '<div style="font-size:1.2rem;margin-bottom:8px">\uD83D\uDD0D</div>'
      + 'No results for "<strong>' + rawQuery + '</strong>".<br><br>'
      + 'Try a shorter term like <em>chicken breast</em> or <em>white rice</em>, or add it manually.<br><br>'
      + '<button onclick="searchFoodModal()" style="padding:10px 20px;background:var(--card);border:1px solid var(--border2);border-radius:10px;color:var(--green);font-family:\'Bebas Neue\',sans-serif;font-size:0.85rem;letter-spacing:1px;cursor:pointer">\u21BA RETRY</button>'
      + ' <button onclick="openManualFoodEntry()" style="padding:10px 20px;background:var(--green-dim);border:1px solid rgba(74,222,128,0.2);border-radius:10px;color:var(--green);font-family:\'Bebas Neue\',sans-serif;font-size:0.85rem;letter-spacing:1px;cursor:pointer">+ ADD CUSTOM</button>'
      + '</div>';
  }
}

// ── SERVING MODAL ──
function openServingModal(idx, source) {
  let item;
  if (source === 'search') {
    const p = window._searchResults[idx];
    // All sources (USDA, OFF, wger) now use unified format with cal100/pro100/carb100/fat100
    item = { name: p.name, brand: p.brand,
      cal100:  p.cal100  != null ? p.cal100  : p.cal,
      pro100:  p.pro100  != null ? p.pro100  : p.pro,
      carb100: p.carb100 != null ? p.carb100 : p.carb,
      fat100:  p.fat100  != null ? p.fat100  : p.fat,
      serving_quantity: p.servingG || 100,
      serving_size: p.serving || '100g',
      isFlat: true };
  } else if (source === 'recent') {
    item = window._recentResults[idx];
  } else if (source === 'custom') {
    const c = window._customResults[idx];
    item = { name: c.name, cal100: c.cal, pro100: c.pro, carb100: c.carb, fat100: c.fat, isCustom: true };
  }
  if (!item) return;
  currentFoodItem = item;
  document.getElementById('sm-food-name').textContent = item.name;
  document.getElementById('sm-food-brand').textContent = item.brand || '';
  
  // Build quick serving buttons
  const quickEl = document.getElementById('sm-quick-servings');
  const servings = [];
  if (item.serving_quantity && item.serving_size) {
    servings.push({ label: item.serving_size, grams: parseFloat(item.serving_quantity) });
  } else if (item.serving_quantity) {
    servings.push({ label: `1 serving (${item.serving_quantity}g)`, grams: parseFloat(item.serving_quantity) });
  }
  servings.push({ label: '100g', grams: 100 });
  if (item.isCustom) servings.splice(0, 0, { label: '1 serving', grams: 100 });
  
  quickEl.innerHTML = servings.map((s,i) => 
    `<button onclick="setServingQuick(${s.grams})" style="padding:6px 12px;background:var(--dark);border:1px solid var(--border);border-radius:8px;color:var(--off);font-family:'Inter',sans-serif;font-size:0.78rem;cursor:pointer;transition:all 0.15s" 
    onmouseover="this.style.borderColor='var(--green)';this.style.color='var(--green)'" 
    onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--off)'">${s.label}</button>`
  ).join('');
  
  // Default to serving size if available, else 100g
  const defaultGrams = (item.serving_quantity ? parseFloat(item.serving_quantity) : 100);
  document.getElementById('sm-grams').value = defaultGrams;
  document.getElementById('sm-unit').value = 'g';
  updateServingCalc();
  document.getElementById('serving-modal').classList.add('open');
}

function setServingQuick(grams) {
  document.getElementById('sm-grams').value = grams;
  document.getElementById('sm-unit').value = 'g';
  updateServingCalc();
}

function updateServingCalc() {
  if (!currentFoodItem) return;
  const amt = parseFloat(document.getElementById('sm-grams').value) || 100;
  const unit = document.getElementById('sm-unit').value;
  let factor;
  if (unit === 'g') factor = amt / 100;
  else if (unit === 'oz') factor = (amt * 28.3495) / 100;
  else if (unit === 'ml') factor = amt / 100; // approximate for liquids
  else factor = amt / 100;
  document.getElementById('sm-cal').textContent = Math.round((currentFoodItem.cal100 || 0) * factor);
  document.getElementById('sm-pro').textContent = Math.round((currentFoodItem.pro100 || 0) * factor) + 'g';
  document.getElementById('sm-carb').textContent = Math.round((currentFoodItem.carb100 || 0) * factor) + 'g';
  document.getElementById('sm-fat').textContent = Math.round((currentFoodItem.fat100 || 0) * factor) + 'g';
}

function closeServingModal() {
  document.getElementById('serving-modal').classList.remove('open');
  currentFoodItem = null;
}

function confirmLogFood() {
  if (!currentFoodItem) return;
  const amt = parseFloat(document.getElementById('sm-grams').value) || 100;
  const unit = document.getElementById('sm-unit').value;
  let factor;
  if (unit === 'g') factor = amt / 100;
  else if (unit === 'oz') factor = (amt * 28.3495) / 100;
  else if (unit === 'ml') factor = amt / 100;
  else factor = amt / 100;
  const entry = {
    name: currentFoodItem.name + ` (${amt}${unit})`,
    cal: Math.round((currentFoodItem.cal100 || 0) * factor),
    pro: Math.round((currentFoodItem.pro100 || 0) * factor),
    carb: Math.round((currentFoodItem.carb100 || 0) * factor),
    fat: Math.round((currentFoodItem.fat100 || 0) * factor),
  };
  getMealCatEntries(nutDay, activeFoodCat).push(entry);
  saveRecentFood(currentFoodItem);
  closeServingModal();
  renderMealCategories(); renderMacros(); saveToStorage();
}

// ── BARCODE SCANNER ──
let barcodeStream = null;
let barcodeDetectorInterval = null;

function openBarcodeScanner(catId) {
  activeFoodCat = catId;
  const modal = document.getElementById('barcode-modal');
  if (!modal) return;
  document.getElementById('barcode-input').value = '';
  modal.style.display = 'flex';
  startCameraScanner();
}

function closeBarcodeModal() {
  stopCameraScanner();
  document.getElementById('barcode-modal').style.display = 'none';
}

async function startCameraScanner() {
  const video = document.getElementById('barcode-video');
  const status = document.getElementById('barcode-scan-status');
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    if (status) status.textContent = 'Camera not supported — enter barcode below';
    return;
  }
  try {
    if (status) status.textContent = 'Starting camera...';
    barcodeStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: 'environment' }, width: { ideal: 1280 }, height: { ideal: 720 } }
    });
    video.srcObject = barcodeStream;
    await video.play();
    if (status) status.textContent = 'Point camera at barcode';

    // Try native BarcodeDetector first (Chrome/Android)
    if ('BarcodeDetector' in window) {
      const detector = new BarcodeDetector({ formats: ['ean_13','ean_8','upc_a','upc_e','code_128','code_39'] });
      barcodeDetectorInterval = setInterval(async () => {
        if (video.readyState < 2) return;
        try {
          const codes = await detector.detect(video);
          if (codes.length > 0) {
            const code = codes[0].rawValue;
            stopCameraScanner();
            document.getElementById('barcode-modal').style.display = 'none';
            lookupBarcode(code);
          }
        } catch(e) {}
      }, 350);
    } else {
      // Fallback: canvas-based barcode scanning for Safari/iOS
      if (status) status.textContent = 'Scanning... hold barcode steady';
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d', { willReadFrequently: true });
      barcodeDetectorInterval = setInterval(() => {
        if (video.readyState < 2) return;
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);
        // Read the center strip of the image for barcode-like patterns
        // Use manual barcode entry as primary fallback
      }, 500);
      if (status) status.textContent = 'Auto-detect not available on this browser — enter barcode number below';
    }
  } catch(e) {
    console.error('Camera error:', e.name, e.message);
    if (e.name === 'NotAllowedError') {
      if (status) status.textContent = 'Camera permission denied — check browser settings, or enter barcode below';
    } else {
      if (status) status.textContent = 'Camera unavailable — enter barcode below';
    }
  }
}

function stopCameraScanner() {
  if (barcodeDetectorInterval) { clearInterval(barcodeDetectorInterval); barcodeDetectorInterval = null; }
  if (barcodeStream) { barcodeStream.getTracks().forEach(t => t.stop()); barcodeStream = null; }
  const video = document.getElementById('barcode-video');
  if (video) video.srcObject = null;
}

function submitBarcode() {
  const code = document.getElementById('barcode-input').value.trim();
  if (!code) return;
  const status = document.getElementById('barcode-lookup-status');
  if (status) { status.textContent = 'Looking up...'; status.style.color = 'var(--green)'; }
  closeBarcodeModal();
  lookupBarcode(code);
}

async function lookupBarcode(barcode) {
  // Show loading in food modal
  const foodModal = document.getElementById('food-modal');
  if (foodModal) {
    foodModal.style.display = 'flex';
    const resultsEl = document.getElementById('food-modal-results');
    if (resultsEl) resultsEl.innerHTML = '<div class="food-modal-loading">Looking up barcode...</div>';
  }
  try {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 10000);
    const res = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`, { method: 'GET', mode: 'cors', credentials: 'omit', signal: controller.signal });
    clearTimeout(timeout);
    const data = await res.json();
    if (data.status !== 1 || !data.product) {
      const resultsEl = document.getElementById('food-modal-results');
      if (resultsEl) resultsEl.innerHTML = `<div class="food-modal-empty">Product not found for barcode ${barcode}. Try searching by name instead.</div>`;
      return;
    }
    const p = data.product;
    const n = p.nutriments || {};
    const cal100 = Math.round(n['energy-kcal_100g'] || n['energy-kcal'] || 0);
    const pro100 = Math.round(n['proteins_100g'] || 0);
    const carb100 = Math.round(n['carbohydrates_100g'] || 0);
    const fat100 = Math.round(n['fat_100g'] || 0);
    let sg = parseFloat(p.serving_quantity) || 0;
    let servingLabel = p.serving_size || '';
    if (!sg) { sg = smartServingG(p.product_name || ''); }
    if (!servingLabel && sg > 0) servingLabel = sg + 'g';
    if (!servingLabel) servingLabel = '100g';
    if (!sg) sg = 100;
    const factor = sg / 100;
    const formatted = {
      name: p.product_name || 'Unknown Product',
      brand: (p.brands || '').split(',')[0].trim(),
      cal: Math.round(cal100 * factor), pro: Math.round(pro100 * factor),
      carb: Math.round(carb100 * factor), fat: Math.round(fat100 * factor),
      cal100, pro100, carb100, fat100,
      serving: servingLabel, servingG: sg
    };
    window._searchResults = [formatted];
    openServingModal(0, 'search');
  } catch(e) {
    const resultsEl = document.getElementById('food-modal-results');
    if (resultsEl) resultsEl.innerHTML = `<div class="food-modal-empty">Barcode lookup failed. Try searching by name.</div>`;
  }
}

// Compatibility shim for old logMeal/deleteMeal
function logMeal() {
  const name = document.getElementById('n-name')?.value?.trim() || 'Meal';
  const cal = parseInt(document.getElementById('n-cal-in')?.value) || 0;
  const pro = parseInt(document.getElementById('n-pro-in')?.value) || 0;
  const carb = parseInt(document.getElementById('n-carb-in')?.value) || 0;
  const fat = parseInt(document.getElementById('n-fat-in')?.value) || 0;
  getMealCatEntries(nutDay, 'other').push({name,cal,pro,carb,fat});
  renderMealCategories(); renderMacros(); saveToStorage();
}
function deleteMeal(i) { /* handled by deleteCatMeal now */ }

function renderNutrition() {
  document.getElementById('day-picker-nav').innerHTML = DAYS_SHORT.map((d,i)=>
    `<button class="dp-btn ${i===nutDay?'active':''}" onclick="selectNutDay(${i},this)">${d}${i===TODAY_IDX?' · Today':''}</button>`
  ).join('');
  document.getElementById('n-cal-tgt').textContent = 'of '+TARGETS.cal.toLocaleString();
  document.getElementById('n-pro-tgt').textContent = 'of '+TARGETS.pro+'g';
  document.getElementById('n-carb-tgt').textContent = 'of '+TARGETS.carb+'g';
  document.getElementById('n-fat-tgt').textContent = 'of '+TARGETS.fat+'g';
  // Load water logs from storage
  waterLogs = lsGet('fs_water') || {};
  renderWater();
  renderMacros(); renderMealCategories();
  renderTodayMiniLog();
}

function selectNutDay(idx, btn) {
  nutDay = idx;
  document.querySelectorAll('.dp-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderWater(); renderMacros(); renderMealCategories();
}

function renderMacros() {
  const allEntries = getAllEntries(nutDay);
  const t = allEntries.reduce((a,e)=>({cal:a.cal+e.cal,pro:a.pro+e.pro,carb:a.carb+e.carb,fat:a.fat+e.fat}),{cal:0,pro:0,carb:0,fat:0});
  [['cal',TARGETS.cal,'','n-cal','n-cal-bar'],['pro',TARGETS.pro,'g','n-pro','n-pro-bar'],['carb',TARGETS.carb,'g','n-carb','n-carb-bar'],['fat',TARGETS.fat,'g','n-fat','n-fat-bar']].forEach(([k,tgt,u,vid,bid])=>{
    const rem = tgt-t[k], over = rem<0, pct = Math.min(t[k]/tgt*100,100);
    const el = document.getElementById(vid), bar = document.getElementById(bid);
    el.textContent = (over?'+':'')+Math.abs(rem)+u;
    el.className = 'mb-val'+(over?' over':'');
    bar.style.width = pct+'%';
    bar.className = 'mb-fill'+(over?' over':'');
  });
  if (nutDay===TODAY_IDX) { refreshDashMacros(); renderTodayMiniLog(); }
}

function renderMealList() {
  const entries = mealLogs[nutDay];
  const list = document.getElementById('meal-list');
  if (!entries.length) { list.innerHTML = '<div class="empty"><div class="empty-icon">🍽️</div>No meals logged yet.</div>'; return; }
  list.innerHTML = entries.map((e,i)=>
    `<div class="meal-row"><div><div class="mr-name">${e.name}</div><div class="mr-macros"><span class="mp">${e.pro}g P</span><span class="mc">${e.carb}g C</span><span class="mf">${e.fat}g F</span></div></div><div class="mr-cal">${e.cal} cal</div><button class="mr-del" onclick="deleteMeal(${i})">✕</button></div>`
  ).join('');
}

function logMeal() {
  const name = document.getElementById('n-name').value.trim()||'Meal';
  const cal = parseInt(document.getElementById('n-cal-in').value)||0;
  const pro = parseInt(document.getElementById('n-pro-in').value)||0;
  const carb = parseInt(document.getElementById('n-carb-in').value)||0;
  const fat = parseInt(document.getElementById('n-fat-in').value)||0;
  mealLogs[nutDay].push({name,cal,pro,carb,fat});
  ['n-name','n-cal-in','n-pro-in','n-carb-in','n-fat-in'].forEach(id=>document.getElementById(id).value='');
  toggleLog('nt-log-form','nt-plus');
  renderMacros(); renderMealList(); saveToStorage();
}

function quickLog() {
  openQuickFoodModal();
}
function deleteMeal(i) { mealLogs[nutDay].splice(i,1); renderMacros(); renderMealList(); saveToStorage(); }

function toggleLog(formId, iconId) {
  const open = document.getElementById(formId).classList.toggle('open');
  document.getElementById(iconId).textContent = open ? '−' : '+';
}

// ── BODY WEIGHT LOGGING ──
function getWeightLog() { return lsGet('fs_weight_log') || []; }

function logBodyWeight() {
  const input = document.getElementById('weight-log-input');
  const lbs = parseFloat(input.value);
  if (!lbs || lbs < 50 || lbs > 600) { alert('Please enter a valid weight (50–600 lbs)'); return; }
  const log = getWeightLog();
  const today = new Date().toISOString().split('T')[0];
  // Replace today's entry if exists
  const existing = log.findIndex(e => e.date === today);
  if (existing >= 0) log[existing].lbs = lbs;
  else log.push({ date: today, lbs });
  lsSet('fs_weight_log', log);
  input.value = '';
  renderWeightHistory();
  renderNutritionChart();
}

function drawSVGLine(svgId, points, color, fillColor, W, H, padL, padR, padT, padB) {
  const svg = document.getElementById(svgId);
  if (!svg || !points.length) return;
  const xs = points.map(p => p[0]), ys = points.map(p => p[1]);
  const minX = Math.min(...xs), maxX = Math.max(...xs);
  const minY = Math.min(...ys), maxY = Math.max(...ys);
  const rangeY = maxY - minY || 1;
  const chartW = W - padL - padR, chartH = H - padT - padB;
  const px = x => padL + ((x - minX) / (maxX - minX || 1)) * chartW;
  const py = y => padT + chartH - ((y - minY) / rangeY) * chartH;
  const pts = points.map(p => `${px(p[0]).toFixed(1)},${py(p[1]).toFixed(1)}`).join(' ');
  let path = `M ${pts.split(' ').join(' L ')}`;
  let fill = '';
  if (fillColor) {
    const first = points[0], last = points[points.length-1];
    fill = `<path d="M ${px(first[0]).toFixed(1)},${(padT+chartH).toFixed(1)} L ${pts.split(' ').join(' L ')} L ${px(last[0]).toFixed(1)},${(padT+chartH).toFixed(1)} Z" fill="${fillColor}" stroke="none"/>`;
  }
  // Y axis grid lines
  let grid = '';
  for (let i = 0; i <= 2; i++) {
    const yv = minY + (rangeY * i / 2);
    const ypos = py(yv).toFixed(1);
    grid += `<line x1="${padL}" y1="${ypos}" x2="${padL+chartW}" y2="${ypos}" stroke="rgba(255,255,255,0.06)" stroke-width="1"/>`;
    grid += `<text x="${padL-4}" y="${parseFloat(ypos)+4}" font-size="9" fill="rgba(255,255,255,0.3)" text-anchor="end" font-family="DM Mono,monospace">${yv.toFixed(i===0?0:1)}</text>`;
  }
  // Dots
  const dots = points.map((p,i) => `<circle cx="${px(p[0]).toFixed(1)}" cy="${py(p[1]).toFixed(1)}" r="3" fill="${color}" stroke="var(--dark)" stroke-width="1.5"/>`).join('');
  svg.innerHTML = `${grid}${fill}<polyline points="${pts}" fill="none" stroke="${color}" stroke-width="2" stroke-linejoin="round" stroke-linecap="round"/>${dots}`;
}

function renderWeightHistory() {
  const log = getWeightLog();
  const currentEl = document.getElementById('weight-current-display');
  const histEl = document.getElementById('weight-history-list');
  const chartEmptyEl = document.getElementById('weight-chart-empty');
  const deltaBadge = document.getElementById('weight-delta-badge');
  const lbsChangeEl = document.getElementById('stat-lbs-change');
  const lbsLabelEl = document.getElementById('stat-lbs-label');

  if (!log.length) {
    if (currentEl) currentEl.innerHTML = 'No weight logged yet — log your first weigh-in above';
    if (histEl) histEl.innerHTML = '<div style="color:var(--dim);font-size:0.84rem;padding:8px 0">No entries yet</div>';
    if (chartEmptyEl) chartEmptyEl.style.display = 'flex';
    return;
  }

  const sorted = [...log].sort((a,b) => new Date(a.date)-new Date(b.date));
  const latest = sorted[sorted.length-1];
  const start = sorted[0];
  const diff = latest.lbs - start.lbs;
  const mode = USER && USER.goal < USER.weight ? 'lose' : 'gain';

  // Weight chart
  if (chartEmptyEl && sorted.length >= 2) {
    chartEmptyEl.style.display = 'none';
    const svgEl = document.getElementById('weight-chart');
    const W = svgEl.parentElement.offsetWidth || 300;
    const pts = sorted.map((e, i) => [i, parseFloat(e.lbs)]);
    drawSVGLine('weight-chart', pts, '#4ADE80', 'rgba(74,222,128,0.08)', W, 140, 34, 8, 8, 20);
    // X labels
    const labelsEl = document.getElementById('weight-chart-labels');
    if (labelsEl && sorted.length > 1) {
      const step = Math.max(1, Math.floor(sorted.length / 5));
      const shown = sorted.filter((_, i) => i % step === 0 || i === sorted.length-1);
      labelsEl.innerHTML = shown.map(e => `<span>${e.date.slice(5)}</span>`).join('');
    }
  }

  // Delta badge
  if (deltaBadge) {
    const arrow = diff < 0 ? '↓' : diff > 0 ? '↑' : '→';
    const good = (mode==='lose' && diff<0) || (mode==='gain' && diff>0);
    const color = good ? '#4ADE80' : diff===0 ? 'var(--dim)' : '#f87171';
    deltaBadge.innerHTML = `<span style="color:${color}">${arrow} ${Math.abs(diff).toFixed(1)} lbs</span> <span style="color:var(--dim);font-size:0.72rem">from start</span>`;
  }

  // Stat boxes
  const totalChange = Math.abs(diff).toFixed(1);
  if (lbsChangeEl) lbsChangeEl.textContent = totalChange;
  if (lbsLabelEl) lbsLabelEl.textContent = mode === 'gain' ? 'LBS GAINED' : 'LBS LOST';

  // Current weight display
  if (currentEl) {
    currentEl.innerHTML = `<span style="font-size:1.8rem;font-family:'Bebas Neue',sans-serif;color:var(--white)">${latest.lbs}</span> <span style="color:var(--dim)">lbs</span>`;
  }

  // History list (compact)
  if (histEl) {
    const rev = [...sorted].reverse();
    histEl.innerHTML = rev.slice(0,10).map((e,i) => {
      const prev = rev[i+1];
      const change = prev ? (e.lbs - prev.lbs) : 0;
      const changeStr = change === 0 ? '' : `<span style="font-size:0.72rem;color:${change<0?'#4ADE80':'#f87171'}">${change>0?'+':''}${change.toFixed(1)}</span>`;
      return `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border)">
        <div style="font-size:0.82rem;color:var(--off)">${e.date}</div>
        <div style="display:flex;align-items:center;gap:10px">
          ${changeStr}
          <div style="font-family:'Bebas Neue',sans-serif;font-size:0.95rem;color:var(--white)">${e.lbs} lbs</div>
          <button onclick="deleteWeightEntry('${e.date}')" style="width:20px;height:20px;border-radius:4px;border:1px solid var(--border);background:none;color:var(--dim);cursor:pointer;font-size:0.6rem">✕</button>
        </div>
      </div>`;
    }).join('');
  }
}

function renderNutritionChart() {
  // Build 14-day calorie + protein trend from mealLogs
  const days = [];
  const today = new Date();
  for (let i = 13; i >= 0; i--) {
    const d = new Date(today);
    d.setDate(d.getDate() - i);
    const key = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
    const dayLog = mealLogs[key];
    let cal = 0, pro = 0;
    if (dayLog) {
      Object.values(dayLog).forEach(cat => cat.forEach(e => { cal += e.cal||0; pro += e.pro||0; }));
    }
    days.push({ key, cal, pro, label: String(d.getDate()) });
  }

  const hasFoodData = days.some(d => d.cal > 0);
  const emptyEl = document.getElementById('nutrition-chart-empty');
  if (emptyEl) emptyEl.style.display = hasFoodData ? 'none' : 'flex';
  if (!hasFoodData) return;

  const svgEl = document.getElementById('nutrition-chart');
  if (!svgEl) return;
  const W = svgEl.parentElement.offsetWidth || 300;

  // Draw calories line (normalised to chart height)
  const calPts = days.map((d,i) => [i, d.cal]);
  const proPts = days.map((d,i) => [i, d.pro]);

  const maxCal = Math.max(...days.map(d => d.cal), 1);
  const maxPro = Math.max(...days.map(d => d.pro), 1);

  // Draw two lines sharing same SVG - normalise independently
  const padL = 36, padR = 8, padT = 8, padB = 16;
  const chartW = W - padL - padR, chartH = 120 - padT - padB;
  const pxFn = (i, total) => padL + (i / (total-1||1)) * chartW;
  const pyCal = v => padT + chartH - (v / maxCal) * chartH;
  const pyPro = v => padT + chartH - (v / maxPro) * chartH;

  let calPoly = days.map((d,i) => `${pxFn(i,days.length).toFixed(1)},${pyCal(d.cal).toFixed(1)}`).join(' ');
  let proPoly = days.map((d,i) => `${pxFn(i,days.length).toFixed(1)},${pyPro(d.pro).toFixed(1)}`).join(' ');

  // Grid
  let grid = '';
  for (let i=0;i<=2;i++) {
    const y = padT + (chartH * i / 2);
    grid += `<line x1="${padL}" y1="${y.toFixed(1)}" x2="${padL+chartW}" y2="${y.toFixed(1)}" stroke="rgba(255,255,255,0.06)" stroke-width="1"/>`;
    const calV = Math.round(maxCal * (1 - i/2));
    grid += `<text x="${padL-4}" y="${(y+4).toFixed(1)}" font-size="9" fill="rgba(255,255,255,0.3)" text-anchor="end" font-family="DM Mono,monospace">${calV}</text>`;
  }

  // Target line
  const targetCal = TARGETS && TARGETS.cal ? TARGETS.cal : 0;
  let targetLine = '';
  if (targetCal > 0 && targetCal <= maxCal * 1.5) {
    const ty = pyCal(targetCal).toFixed(1);
    targetLine = `<line x1="${padL}" y1="${ty}" x2="${padL+chartW}" y2="${ty}" stroke="rgba(255,255,255,0.2)" stroke-width="1" stroke-dasharray="4,3"/>`;
    targetLine += `<text x="${padL+4}" y="${(parseFloat(ty)-3).toFixed(1)}" font-size="8" fill="rgba(255,255,255,0.3)" font-family="DM Mono,monospace">target</text>`;
  }

  svgEl.innerHTML = `${grid}${targetLine}
    <polyline points="${calPoly}" fill="none" stroke="#4ADE80" stroke-width="2" stroke-linejoin="round" stroke-linecap="round"/>
    <polyline points="${proPoly}" fill="none" stroke="#60a5fa" stroke-width="1.5" stroke-linejoin="round" stroke-linecap="round" stroke-dasharray="none"/>`;

  // X labels (every 2 days)
  const labelsEl = document.getElementById('nutrition-chart-labels');
  if (labelsEl) {
    labelsEl.innerHTML = days.filter((_,i) => i%2===0 || i===days.length-1).map(d => `<span>${d.label}</span>`).join('');
  }

  // Update avg protein stat
  const daysWithFood = days.filter(d => d.cal > 0);
  const avgPro = daysWithFood.length ? Math.round(daysWithFood.reduce((s,d) => s+d.pro, 0) / daysWithFood.length) : null;
  const proEl = document.getElementById('stat-avg-protein');
  if (proEl) proEl.textContent = avgPro ? avgPro + 'g' : '—';
}

function deleteWeightEntry(date) {
  const log = getWeightLog().filter(e => e.date !== date);
  lsSet('fs_weight_log', log);
  renderWeightHistory();
}

// ── STREAK ──
function getWorkoutDates() {
  return new Set(lsGet('fs_workout_dates') || []);
}
function recordWorkoutDate() {
  const dates = getWorkoutDates();
  dates.add(todayDateStr());
  lsSet('fs_workout_dates', [...dates]);
}
function todayDateStr() {
  const d = new Date();
  return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
}
function renderFreqChart() {
  const svg = document.getElementById('freq-chart-svg');
  if (!svg) return;
  const dates = getWorkoutDates();
  const weeks = [];
  const now = new Date();
  for (let w = 7; w >= 0; w--) {
    const weekStart = new Date(now);
    weekStart.setDate(now.getDate() - now.getDay() - w * 7);
    let count = 0;
    for (let d = 0; d < 7; d++) {
      const day = new Date(weekStart);
      day.setDate(weekStart.getDate() + d);
      const key = day.getFullYear() + '-' + String(day.getMonth()+1).padStart(2,'0') + '-' + String(day.getDate()).padStart(2,'0');
      if (dates.has(key)) count++;
    }
    weeks.push(count);
  }
  const maxCount = Math.max(...weeks, 1);
  const W = 400, H = 100, padB = 20, padT = 8, padLR = 12;
  const barW = (W - padLR * 2) / 8;
  const chartH = H - padT - padB;
  const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  svg.innerHTML = weeks.map((count, i) => {
    const x = padLR + i * barW + barW * 0.15;
    const bw = barW * 0.7;
    const bh = (count / maxCount) * chartH;
    const by = padT + chartH - bh;
    const wkDate = new Date(now);
    wkDate.setDate(now.getDate() - now.getDay() - (7 - i) * 7);
    const lbl = i === 7 ? 'Now' : monthNames[wkDate.getMonth()] + ' ' + wkDate.getDate();
    const isThisWeek = i === 7;
    return `
      <rect x="${x.toFixed(1)}" y="${by.toFixed(1)}" width="${bw.toFixed(1)}" height="${Math.max(bh,2).toFixed(1)}"
        rx="3" fill="${isThisWeek ? 'var(--green)' : 'rgba(74,222,128,0.35)'}"/>
      <text x="${(x + bw/2).toFixed(1)}" y="${H}" font-size="8" fill="rgba(255,255,255,0.4)"
        text-anchor="middle" font-family="DM Mono,monospace">${lbl}</text>
      ${count > 0 ? `<text x="${(x + bw/2).toFixed(1)}" y="${(by - 3).toFixed(1)}" font-size="9" fill="${isThisWeek ? 'var(--green)' : 'rgba(255,255,255,0.5)'}" text-anchor="middle" font-family="DM Mono,monospace">${count}</text>` : ''}
    `;
  }).join('');
}

function renderStreak() {
  const now = new Date();
  const year = now.getFullYear(), month = now.getMonth();
  const daysInMonth = new Date(year, month+1, 0).getDate();
  const today = now.getDate();
  const workoutDates = getWorkoutDates();

  // Calculate current streak (consecutive days back from today)
  let streak = 0;
  for (let i = 0; i < 60; i++) {
    const d = new Date(year, month, today - i);
    const key = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
    if (workoutDates.has(key)) streak++;
    else if (i > 0) break; // gap breaks streak (day 0 = today, might not be done yet)
  }

  // Update streak stat strip
  const streakEl = document.getElementById('stat-streak');
  if (streakEl) streakEl.textContent = streak;

  // Update month label
  const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const monthLabelEl = document.getElementById('streak-month-label');
  if (monthLabelEl) monthLabelEl.textContent = monthNames[month].toUpperCase() + ' ' + year;
  // Render calendar
  document.getElementById('streak-cal').innerHTML = Array.from({length:daysInMonth}, (_,i) => {
    const d = i + 1;
    const key = year + '-' + String(month+1).padStart(2,'0') + '-' + String(d).padStart(2,'0');
    const cls = d === today ? 'today' : workoutDates.has(key) ? 'done' : '';
    return `<div class="sc-day ${cls}" title="${key}">${d}</div>`;
  }).join('');

  // Update workout count this month
  let monthCount = 0;
  for (let i=1; i<=daysInMonth; i++) {
    const key = year + '-' + String(month+1).padStart(2,'0') + '-' + String(i).padStart(2,'0');
    if (workoutDates.has(key)) monthCount++;
  }
  const wktCountEl = document.getElementById('stat-workouts');
  if (wktCountEl) wktCountEl.textContent = monthCount;
}

// ── MY PROGRAM ──
function renderProgram() {
  if (!generatedPlan) return;
  const accordion = document.getElementById('week-accordion');
  accordion.innerHTML = '';
  for (let w=1; w<=TOTAL_WEEKS; w++) {
    const isDone = w<CURRENT_WEEK, isCurrent = w===CURRENT_WEEK;
    const card = document.createElement('div');
    card.className = 'log-toggle-card'; card.style.borderRadius='14px';
    const wPhase = getTrainingPhase(w);
    const wDeload = isDeloadWeek(w);
    const phaseTag = wDeload
      ? '<span style="font-size:0.6rem;font-weight:700;letter-spacing:1px;text-transform:uppercase;background:rgba(251,146,60,0.1);color:var(--orange);padding:2px 7px;border-radius:4px;border:1px solid rgba(251,146,60,0.2)">⚡ DELOAD</span>'
      : '<span style="font-size:0.6rem;font-weight:700;letter-spacing:1px;text-transform:uppercase;background:rgba(74,222,128,0.07);color:var(--green);padding:2px 7px;border-radius:4px;border:1px solid rgba(74,222,128,0.15)">'+wPhase.name+'</span>';
    const badge = isDone
      ? '<span style="font-size:0.65rem;font-weight:700;letter-spacing:1px;text-transform:uppercase;background:var(--green-dim);color:var(--green);padding:3px 9px;border-radius:5px">✓ Done</span>'
      : isCurrent
      ? '<span style="font-size:0.65rem;font-weight:700;letter-spacing:1px;text-transform:uppercase;background:var(--orange-dim);color:var(--orange);padding:3px 9px;border-radius:5px">In Progress</span>'
      : '';
    const rowId = 'wrow-'+w;
    const days = GYM_DAYS.map(i=>{
      const wo = DAY_WORKOUTS[i];
      return `<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:var(--dark);border:1px solid var(--border);border-radius:9px"><div style="font-size:0.83rem;color:var(--off)">${DAYS_FULL[i]} · ${wo?wo.name:'Workout'}</div><div style="font-size:0.7rem;font-family:'DM Mono',monospace;color:${isDone?'var(--green)':'var(--dim)'}">${isDone?'✓ Complete':'Upcoming'}</div></div>`;
    }).join('');
    card.innerHTML = `<div class="log-toggle-header" onclick="toggleWeekRow('${rowId}')" style="padding:16px 20px">
      <div style="display:flex;align-items:center;gap:10px"><div style="font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:1px;color:${isCurrent?'var(--white)':'var(--dim)'}">WEEK ${w}</div>${phaseTag}${badge}</div>
      <div style="font-family:'DM Mono',monospace;font-size:0.72rem;color:var(--dim)">${isDone?GYM_DAYS.length+'/'+GYM_DAYS.length+' workouts':isCurrent?'0/'+GYM_DAYS.length+' workouts':'Upcoming'}</div></div>
      <div id="${rowId}" style="display:${isCurrent?'block':'none'};padding:0 20px 16px"><div style="display:flex;flex-direction:column;gap:8px">${days}</div></div>`;
    accordion.appendChild(card);
  }
}

function toggleWeekRow(id) { const r=document.getElementById(id); if(r) r.style.display=r.style.display==='block'?'none':'block'; }

// ── SETTINGS ──
function renderSettingsGymDays() {
  const container = document.getElementById('settings-gym-days'); if (!container) return;
  container.innerHTML = '';
  DAYS_SHORT.forEach((d,i)=>{
    const active = GYM_DAYS.includes(i);
    const el = document.createElement('div');
    el.textContent = d; el.dataset.idx = i; if(active) el.dataset.active='1';
    el.style.cssText = `padding:10px 16px;border-radius:8px;border:1px solid ${active?'var(--green)':'var(--border)'};background:${active?'var(--green-dim)':'var(--dark)'};color:${active?'var(--green)':'var(--dim)'};font-family:'DM Mono',monospace;font-size:0.8rem;cursor:pointer;transition:all 0.2s`;
    el.onclick = function(){
      const now = !this.dataset.active; this.dataset.active=now?'1':'';
      this.style.borderColor=now?'var(--green)':'var(--border)';
      this.style.background=now?'var(--green-dim)':'var(--dark)';
      this.style.color=now?'var(--green)':'var(--dim)';
    };
    container.appendChild(el);
  });
}

function saveSettings() {
  // Update user profile
  const newName   = document.getElementById('s-name').value.trim();
  const newWeight = parseFloat(document.getElementById('s-weight').value);
  const newGoal   = parseFloat(document.getElementById('s-goal').value);
  if (newName && USER) USER.name = newName;
  if (newWeight && USER) {
    USER.weight = newWeight;
    // Recalculate macros if weight changed meaningfully (>1 lb diff)
    const prevWeight = parseFloat(USER.weight) || newWeight;
    if (Math.abs(prevWeight - newWeight) > 0.5) {
      const n = calcNutrition(newWeight, newGoal || USER.goal, USER.weeks || 12, USER.gender || 'Male', USER.age || 30, USER.heightCm || 175, USER.activity || 'moderate');
      USER.nutrition = n;
      TARGETS.cal  = n.calories;
      TARGETS.pro  = n.protein;
      TARGETS.carb = n.carbs;
      TARGETS.fat  = n.fat;
      document.getElementById('s-cal').value  = n.calories;
      document.getElementById('s-pro').value  = n.protein;
      document.getElementById('s-carb').value = n.carbs;
      document.getElementById('s-fat').value  = n.fat;
    }
  }
  if (newGoal && USER) USER.goal = newGoal;
  lsSet('fs_user', USER);

  // Also allow manual override of macro targets
  TARGETS.cal  = parseInt(document.getElementById('s-cal').value)  || TARGETS.cal;
  TARGETS.pro  = parseInt(document.getElementById('s-pro').value)  || TARGETS.pro;
  TARGETS.carb = parseInt(document.getElementById('s-carb').value) || TARGETS.carb;
  TARGETS.fat  = parseInt(document.getElementById('s-fat').value)  || TARGETS.fat;
  refreshDashMacros(); renderMacros(); saveToStorage();

  const btn = document.getElementById('save-btn'), orig = btn.textContent;
  btn.textContent='✓ SAVED'; btn.style.background='var(--green-dim)'; btn.style.color='var(--green)'; btn.style.border='1px solid rgba(74,222,128,0.3)';
  setTimeout(()=>{ btn.textContent=orig; btn.style.background='var(--green)'; btn.style.color='var(--black)'; btn.style.border='none'; }, 1800);
}

// ═══════════════════════════════════════════
// WORKOUT ENVIRONMENT
// ═══════════════════════════════════════════
let woDay = 0;
let woCurrentEx = 0;
let woWorkout = null;
let woSets = {};
let woExtraSets = {};
let woPRs = []; // Track PRs hit during this workout session
let restTimerInterval = null;

function openWorkoutEnv(dayIdx) {
  const workout = DAY_WORKOUTS[dayIdx];
  if (!workout || !workout.exercises.length) {
    openUnplannedWorkout(dayIdx);
    return;
  }
  woDay = dayIdx;
  woCurrentEx = 0;
  woWorkout = workout;
  woPRs = [];
  const draft = getWorkoutDraft(dayIdx);
  if (draft && draft.sets) {
    woSets = draft.sets;
    if (draft.extraSets) woExtraSets = draft.extraSets;
  } else {
    woSets = {}; woExtraSets = {};
  }

  document.getElementById('wo-title').textContent = workout.name.toUpperCase() + ' — ' + DAYS_FULL[dayIdx].toUpperCase();
  const dayTitleEl = document.getElementById('wo-day-title');
  if (dayTitleEl) dayTitleEl.textContent = workout.name.toUpperCase();
  const daySubEl = document.getElementById('wo-day-subtitle');
  if (daySubEl) daySubEl.textContent = DAYS_FULL[dayIdx];

  // Show workout screen (position:fixed covers full viewport)
  document.getElementById('screen-dash').style.display = 'none';
  const woEl = document.getElementById('screen-workout');
  woEl.classList.add('active');
  woEl.style.display = 'flex';
  document.body.style.overflow = 'hidden';
  window.scrollTo(0, 0);

  // Progress bar
  const fill = document.getElementById('wo-prog-fill');
  const label = document.getElementById('wo-prog-label');
  if (fill) fill.style.width = '0%';
  if (label) label.textContent = `0 / ${workout.exercises.length}`;

  renderEcList();
  loadExercise(0);
  restoreRestTimerIfActive();
}


function exitWorkout() {
  stopRestTimer();
  const woEl2 = document.getElementById('screen-workout');
  woEl2.classList.remove('active');
  woEl2.style.display = '';
  document.body.style.overflow = '';
  const dashRestore = document.getElementById('screen-dash');
  dashRestore.style.display = 'flex';
  window.scrollTo(0, 0);
  renderTodayWorkout();
  renderWeek();
}

function finishWorkout() {
  recordWorkoutDate();
  wktDone.add(woDay);
  saveToStorage();
  stopRestTimer();
  lsSet('fs_rest_timer', null);

  // Collect PR summary before clearing workout state
  const prList = woPRs.slice();
  const workoutName = woWorkout ? woWorkout.name : 'Workout';

  const woEl2 = document.getElementById('screen-workout');
  woEl2.classList.remove('active');
  woEl2.style.display = '';
  document.body.style.overflow = '';
  const dashRestore = document.getElementById('screen-dash');
  dashRestore.style.display = 'flex';
  window.scrollTo(0, 0);
  renderTodayWorkout();
  renderWeek();

  _showWorkoutSummary(workoutName, prList);
}

function loadExercise(idx) {
  woCurrentEx = idx;
  const exes = woWorkout.exercises;
  const ex = exes[idx];
  if (!ex) return;

  document.getElementById('wo-ex-title').textContent = ex.name;
  const _badgeEl = document.getElementById('wo-ex-badge');
  _badgeEl.innerHTML = 
    `<div style="display:flex;align-items:center;justify-content:space-between;gap:8px">` +
    `<span>${ex.sets} × ${ex.reps}</span>` +
    `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="11" height="11" style="opacity:0.6;flex-shrink:0"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>` +
    `</div>` +
    `<span style="font-size:0.6rem;opacity:0.7;letter-spacing:0.5px">REST ${ex.rest}s</span>`;
  _badgeEl.onclick = function() { openSetRepEditor(idx); };
  _badgeEl.title = 'Tap to edit sets & reps';
  // Update header title on mobile to show current exercise
  const titleEl = document.getElementById('wo-title');
  if (titleEl && window.innerWidth <= 768) {
    titleEl.textContent = `${idx+1}/${exes.length} — ${ex.name.toUpperCase()}`;
  }

  // Exercise demo — form cues + phase info + wger images
  const db = getExerciseData(ex.name);
  // Show current training phase badge
  const phMod = getPhaseExerciseModifier(CURRENT_WEEK);
  const phBadgeEl = document.getElementById('wo-phase-badge');
  if (phBadgeEl) {
    if (isDeloadWeek(CURRENT_WEEK)) {
      phBadgeEl.textContent = '⚡ DELOAD WEEK — 60% volume, focus on form';
      phBadgeEl.style.cssText = 'display:block;background:rgba(251,146,60,0.1);border:1px solid rgba(251,146,60,0.3);border-radius:8px;padding:8px 14px;font-size:0.75rem;color:var(--orange);margin-bottom:10px';
    } else {
      const ph = getTrainingPhase(CURRENT_WEEK);
      phBadgeEl.textContent = `${ph.name} PHASE · ${ph.intensityLabel}`;
      phBadgeEl.style.cssText = 'display:block;background:rgba(74,222,128,0.07);border:1px solid rgba(74,222,128,0.2);border-radius:8px;padding:8px 14px;font-size:0.75rem;color:var(--green);margin-bottom:10px';
    }
  }
  document.getElementById('wo-muscles-tag').textContent = `Muscles: ${ex.muscles || db.muscles}`;
  const framesEl = document.getElementById('wo-demo-frames');
  // Try to load wger.de exercise image; fallback to text cues
  const wgerId = db.wgerId;
  if (wgerId) {
    renderDemoPlaceholder(framesEl, ex.name, ex.muscles || db.muscles); // show immediately
    _loadExerciseImage(framesEl, wgerId, ex.name, ex.muscles || db.muscles);
  } else {
    renderDemoPlaceholder(framesEl, ex.name, ex.muscles || db.muscles);
  }

  // Initialize dynamic set count if not set
  if (!woExtraSets[idx]) woExtraSets[idx] = ex.sets;
  renderSetsTable(idx, ex);

  // Rest timer button
  stopRestTimer();
  restTotalSecs = ex.rest;
  buildRestSelect();
  updateRestDisplay();

  // Nav buttons
  document.getElementById('wo-next-btn').textContent = idx < exes.length-1 ? `DONE — NEXT: ${exes[idx+1]?.name.toUpperCase() || ''}` : 'FINISH WORKOUT ✓';
  const prevBtn = document.getElementById('wo-prev-btn');
  if (prevBtn) {
    if (idx === 0) {
      prevBtn.classList.add('hidden');
    } else {
      prevBtn.classList.remove('hidden');
      prevBtn.style.opacity = '1';
      prevBtn.style.pointerEvents = 'auto';
    }
  }

  renderEcList();
}

function renderSetsTable(idx, ex) {
  const tbody = document.getElementById('sets-tbody');
  if (!tbody) return;
  // Apply deload week volume reduction (60% of normal sets, min 2)
  let baseSets = ex.sets;
  if (isDeloadWeek(CURRENT_WEEK)) baseSets = Math.max(2, Math.round(baseSets * 0.6));
  const numSets = woExtraSets[idx] || baseSets;
  tbody.innerHTML = '';
  for (let s=0; s<numSets; s++) {
    const prev = getPrevSet(woDay, idx, s);
    const isSaved = woSets[idx] && woSets[idx][s];
    const savedW = isSaved && (woSets[idx][s].weight != null) ? String(woSets[idx][s].weight) : '';
    const savedR = isSaved && (woSets[idx][s].reps != null) ? String(woSets[idx][s].reps) : '';
    const isDone = isSaved && woSets[idx][s].done;
    const prevW = prev ? String(prev.weight) : '—';
    const prevR = prev ? String(prev.reps) : '—';
    const valW = savedW;
    const valR = savedR;
    const tr = document.createElement('tr');
    tr.innerHTML = '<td style="color:var(--dim);font-family:\'DM Mono\',monospace;font-size:0.78rem;white-space:nowrap">Set '+(s+1)+'</td>'+
      '<td class="set-cell-weight"><input class="set-weight-input '+(isDone?'done':'')+'" id="w-'+idx+'-'+s+'" type="number" inputmode="decimal" placeholder="'+prevW+'" value="'+escapeAttr(valW)+'" min="0" '+(isDone?'readonly':'')+' oninput="autoSaveSet('+idx+','+s+','+ex.rest+')"></td>'+
      '<td class="set-cell-reps"><input class="set-reps-input '+(isDone?'done':'')+'" id="r-'+idx+'-'+s+'" type="number" inputmode="numeric" placeholder="'+prevR+'" value="'+escapeAttr(valR)+'" min="0" '+(isDone?'readonly':'')+' oninput="autoSaveSet('+idx+','+s+','+ex.rest+')"></td>'+
      '<td><button class="set-check '+(isDone?'done':'')+'" id="sd-'+idx+'-'+s+'" '+(isDone?'disabled':'')+' onclick="completeSet('+idx+','+s+','+ex.rest+')" title="Mark done">✓</button></td>'+
      '<td><button class="set-del-btn" onclick="deleteSet('+idx+','+s+')" title="Delete set">✕</button></td>';
    tbody.appendChild(tr);
  }
}

function escapeAttr(str) {
  if (str == null) return '';
  return String(str).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function addSet() {
  if (woCurrentEx === null || !woWorkout) return;
  const idx = woCurrentEx;
  const ex = woWorkout.exercises[idx];
  woExtraSets[idx] = (woExtraSets[idx] || ex.sets) + 1;
  renderSetsTable(idx, ex);
  persistWorkoutDraft();
}

function deleteSet(exIdx, setIdx) {
  const ex = woWorkout.exercises[exIdx];
  const current = woExtraSets[exIdx] || ex.sets;
  if (current <= 1) return; // keep at least 1
  woExtraSets[exIdx] = current - 1;
  if (woSets[exIdx]) {
    woSets[exIdx].splice(setIdx, 1);
  }
  renderSetsTable(exIdx, ex);
  persistWorkoutDraft();
}

function autoSaveSet(exIdx, setIdx, restSecs) {
  const wEl = document.getElementById(`w-${exIdx}-${setIdx}`);
  const rEl = document.getElementById(`r-${exIdx}-${setIdx}`);
  if (!wEl || !rEl) return;
  const weight = (wEl.value || '').trim();
  const reps = (rEl.value || '').trim();
  if (!woSets[exIdx]) woSets[exIdx] = [];
  if (!woSets[exIdx][setIdx]) woSets[exIdx][setIdx] = {};
  woSets[exIdx][setIdx].weight = weight;
  woSets[exIdx][setIdx].reps = reps;
  persistWorkoutDraft();
  if (weight && reps) saveSet(woDay, exIdx, setIdx, weight, reps);
}

function isPR(exIdx, setIdx, weight, reps) {
  const exName = woWorkout?.exercises?.[exIdx]?.name;
  if (!exName || !weight || !reps) return false;
  const w = parseFloat(weight), r = parseInt(reps);
  if (!w || !r) return false;
  const currentE1RM = w * (1 + r / 30);
  const exlogs = getExLogs();
  const sessions = exlogs[exName] || [];
  const today = todayDateStr();
  let bestE1RM = 0;
  for (const session of sessions) {
    if (session.date === today) continue;
    for (const set of (session.sets || [])) {
      if (set && set.weight && set.reps) {
        const e1rm = set.weight * (1 + set.reps / 30);
        if (e1rm > bestE1RM) bestE1RM = e1rm;
      }
    }
  }
  return bestE1RM > 0 && currentE1RM > bestE1RM;
}

function completeSet(exIdx, setIdx, restSecs) {
  const wEl = document.getElementById(`w-${exIdx}-${setIdx}`);
  const rEl = document.getElementById(`r-${exIdx}-${setIdx}`);
  const weight = wEl.value || wEl.placeholder || '0';
  const reps   = rEl.value || rEl.placeholder || '0';

  saveSet(woDay, exIdx, setIdx, weight, reps);

  const btn = document.getElementById(`sd-${exIdx}-${setIdx}`);
  const wasAlreadyDone = woSets[exIdx] && woSets[exIdx][setIdx] && woSets[exIdx][setIdx].done;

  if (wasAlreadyDone) {
    // TOGGLE OFF — user is correcting a mistake
    if (woSets[exIdx] && woSets[exIdx][setIdx]) woSets[exIdx][setIdx].done = false;
    btn.classList.remove('done');
    wEl.classList.remove('done');
    rEl.classList.remove('done');
    persistWorkoutDraft();
    return;
  }

  btn.classList.add('done');
  if (!woSets[exIdx]) woSets[exIdx] = [];
  if (!woSets[exIdx][setIdx]) woSets[exIdx][setIdx] = {};
  woSets[exIdx][setIdx].weight = weight;
  woSets[exIdx][setIdx].reps = reps;
  woSets[exIdx][setIdx].done = true;
  persistWorkoutDraft();

  // Mark inputs done (green tint) but keep them editable — user can fix typos
  wEl.classList.add('done');
  rEl.classList.add('done');

  // Focus the next set's Weight input
  const numSets = woExtraSets[exIdx] || woWorkout.exercises[exIdx].sets;
  const nextSetIdx = setIdx + 1;
  if (nextSetIdx < numSets) {
    const nextW = document.getElementById(`w-${exIdx}-${nextSetIdx}`);
    if (nextW) { nextW.focus(); }
  }

  var pr = isPR(exIdx, setIdx, weight, reps);
  if (pr) {
    var exName = woWorkout.exercises[exIdx] ? woWorkout.exercises[exIdx].name : 'Exercise';
    woPRs.push({ exercise: exName, weight: weight, reps: reps, set: setIdx + 1 });
    var row = btn.closest('tr');
    if (row) {
      row.style.background = 'rgba(74,222,128,0.12)';
      row.style.transition = 'background 0.3s';
      setTimeout(function(){ row.style.background = ''; }, 2000);
    }
  }

  // Auto-start rest timer if not last set
  const ex = woWorkout.exercises[exIdx];
  const numSetsForTimer = woExtraSets[exIdx] || ex.sets;
  const allSets = Array.from({length:numSetsForTimer},(_,i)=>document.getElementById(`sd-${exIdx}-${i}`));
  const allDone = allSets.every(b=>b&&b.disabled);
  if (!allDone && restSecs > 0) startRestTimerSecs(restTotalSecs);
}

const EXERCISE_CUES = {
  default:            { start:["Set up in position","Brace your core","Neutral spine"], mid:["Control the movement","Stay tight through the lift","Drive through the rep"], end:["Full range of motion","Squeeze at the top","Lower with control"] },
  "Pull-Ups":         { start:["Dead hang, arms fully extended","Grip shoulder-width apart","Engage lats — pull shoulders down"], mid:["Drive elbows toward hips","Pull chest toward the bar","Keep core tight, no swinging"], end:["Chin clears the bar","Squeeze back and biceps","Lower slowly — full extension"] },
  "Barbell Row":      { start:["Hip hinge 45°, bar over mid-foot","Overhand grip just outside legs","Big breath, chest up, lats engaged"], mid:["Pull bar to lower chest/belly","Drive elbows straight back","Squeeze shoulder blades hard together"], end:["Bar touches torso — hold 1 sec","Scapulae fully retracted","Lower with control, keep back flat"] },
  "Bench Press":      { start:["5-point contact: feet, glutes, upper back, head","Retract scapulae into bench","Unrack bar directly over lower chest"], mid:["Lower bar to lower chest","Elbows at 45-75 degrees","Stay tight throughout"], end:["Press to lockout directly above chest","Full elbow extension at top","Control descent — 2-3 sec down"] },
  "Back Squat":       { start:["Bar on upper traps, chest tall","Feet just outside shoulders, slight toe-out","Big breath into belly, brace hard"], mid:["Break hips and knees simultaneously","Knees track over toes throughout","Hit parallel or below — thighs level"], end:["Drive through full foot","Hips and shoulders rise at same rate","Lock out hips and knees at top"] },
  "Deadlift":         { start:["Bar over mid-foot (1 inch from shins)","Hip-width stance, grip just outside legs","Hips down, chest up, lats tight"], mid:["Push floor away — legs drive first","Bar drags up the shins and thighs","Hips and shoulders rise together"], end:["Stand tall — hips fully extended","Glutes squeeze at lockout","Lower: hinge hips back first, then bend knees"] },
  "Romanian Deadlift":{ start:["Stand tall, slight knee bend","Hip-width grip, bar against thighs","Chest up, shoulders back, brace core"], mid:["Push hips straight back — not down","Bar stays close, drags down thighs","Feel deep hamstring stretch at bottom"], end:["Drive hips forward to stand","Squeeze glutes hard at top","Keep back flat the entire rep"] },
  "Overhead Press":   { start:["Bar at collarbone, elbows slightly forward","Grip just outside shoulders","Legs hip-width, glutes and core tight"], mid:["Press straight up, head moves back slightly","Bar clears forehead — then head forward","Full arm extension, biceps near ears"], end:["Lock out overhead — shrug traps at top","Bar stacked over heels","Lower to clavicle with control"] },
  "Leg Press":        { start:["Feet shoulder-width on plate, mid-height","Full back contact with pad","Unlock safety bars, control from there"], mid:["Lower platform until 90 degrees at knee","Knees track in line with toes","Lower back stays flat on pad always"], end:["Press through heels and full foot","Extend until almost locked — soft knees","Keep knees tracking over toes"] },
  "Leg Curl":         { start:["Lie face down, pads just above heels","Adjust so knee joint aligns with pivot","Relax hips flat into pad"], mid:["Curl heel toward glutes — full range","Squeeze hamstrings at peak contraction","Keep hips pressed down throughout"], end:["Hold peak for 1-2 seconds","Lower slowly — 3 sec eccentric","Full extension at bottom each rep"] },
  "Calf Raises":      { start:["Ball of foot on edge of platform","Full stretch — heel below platform level","Hold support lightly for balance only"], mid:["Rise onto toes — full plantar flexion","Keep knees straight or slightly bent","Push through big toe side"], end:["Hold peak 2 sec — squeeze hard","Lower all the way down to full stretch","Each rep: full stretch to full contraction"] },
  "Lat Pulldown":     { start:["Wide overhand grip, thumbs around bar","Sit tall, slight backward lean","Depress shoulders — pull them down from ears"], mid:["Pull bar to upper chest","Drive elbows down and back","Arch chest slightly toward bar"], end:["Bar touches upper chest","Squeeze lats hard","Extend arms fully — feel full lat stretch"] },
  "Cable Row":        { start:["Sit tall with slight forward lean","Grip handle, arms extended","Brace core — neutral spine"], mid:["Pull handle to mid-torso","Drive elbows straight back","Squeeze shoulder blades together at end"], end:["Hold contraction 1 sec","Lean forward slightly on the return","Full arm extension — feel the stretch"] },
  "Face Pulls":       { start:["Cable set at face height","Rope grip — thumbs pointing back","Step back until arms fully extended"], mid:["Pull rope to face level, hands toward ears","Elbows flare high and wide","External rotate at end of pull"], end:["Hands beside ears, palms facing forward","Squeeze rear delts and rotator cuff","Return slowly — control the eccentric"] },
  "Barbell Curl":     { start:["Shoulder-width supinated grip","Elbows pinned at sides throughout","Stand tall, slight forward lean"], mid:["Curl without swinging — strict form","Keep elbows stationary throughout","Squeeze biceps hard at the top"], end:["Full flexion — forearm toward bicep","Hold peak 1-2 sec","Lower slowly 3 sec — full extension"] },
  "Incline DB Press": { start:["45 degree incline, feet flat on floor","DBs at chest level, elbows below wrists","Retract scapulae into pad"], mid:["Press up and slightly inward in an arc","Control the path — no extreme flare","Full extension at top"], end:["DBs nearly touch at top — squeeze chest","Lower slowly to chest level","Full range every rep"] },
  "Arnold Press":     { start:["DBs at shoulder height, palms facing you","Sit tall on bench — core braced","Slight forward lean for stability"], mid:["Press up while rotating palms outward","Elbows flare wide as you press up","Smooth rotation throughout the lift"], end:["Lockout overhead — palms fully facing forward","Pause at top 1 sec","Reverse the rotation on the way down"] },
  "Lateral Raises":   { start:["DBs at sides, very slight elbow bend","Stand shoulder-width, slight forward lean","Avoid shrugging — keep traps relaxed"], mid:["Raise to shoulder height — lead with elbows","Pinky slightly higher than thumb at top","Keep slight bend in arms throughout"], end:["Pause at shoulder height 1 sec","Lower slowly — 3 sec eccentric","Shoulders stay down throughout"] },
  "Conventional Deadlift": { start:["Bar over mid-foot","Hip-width stance, grip just outside legs","Hips down, chest up, lats tight"], mid:["Push floor away","Bar drags close to shins and thighs","Hips and shoulders rise together"], end:["Full hip extension, glutes locked","Stand completely tall","Lower with control: hips back first"] },
  "Tricep Pushdown":  { start:["Cable at chest height","Elbows tucked at sides","Slight forward lean"], mid:["Push down to full extension","Keep elbows stationary","Squeeze triceps hard"], end:["Lock out arms","Hold 1 sec at bottom","Control the return slowly"] },
};


function renderDemoPlaceholder(el, name, muscles) {
  const cues = EXERCISE_CUES[name] || EXERCISE_CUES.default;
  const phases = [
    { label:'START POSITION', color:'#60a5fa', cues:cues.start },
    { label:'MID MOVEMENT',   color:'#4ADE80', cues:cues.mid },
    { label:'END / LOCKOUT',  color:'#f472b6', cues:cues.end },
  ];
  el.innerHTML = phases.map((p,pi) => `
    <div style="flex:1;display:flex;flex-direction:column;background:var(--dark);border-radius:14px;overflow:hidden;border:1px solid var(--border)">
      <div style="padding:10px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;background:rgba(255,255,255,0.02)">
        <div style="width:22px;height:22px;border-radius:50%;background:${p.color}22;display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',sans-serif;font-size:0.7rem;color:${p.color};flex-shrink:0">${pi+1}</div>
        <div style="font-family:'Bebas Neue',sans-serif;font-size:0.8rem;letter-spacing:1px;color:${p.color}">${p.label}</div>
      </div>
      <div style="padding:12px 14px;display:flex;flex-direction:column;gap:9px;flex:1">
        ${p.cues.map(c=>`<div style="display:flex;align-items:flex-start;gap:8px"><div style="width:4px;height:4px;border-radius:50%;background:${p.color};margin-top:6px;flex-shrink:0"></div><div style="font-size:0.79rem;color:var(--off);line-height:1.45">${c}</div></div>`).join('')}
      </div>
    </div>`
  ).join('');
}

// ── EXERCISE IMAGE LOADER (wger.de) ──
const _wgerImageCache = {};
async function _loadExerciseImage(framesEl, wgerId, name, muscles) {
  if (_wgerImageCache[wgerId] === null) return; // known to have no image
  if (_wgerImageCache[wgerId]) {
    _renderImageFrame(framesEl, _wgerImageCache[wgerId], name, muscles);
    return;
  }
  try {
    const resp = await fetch(`https://wger.de/api/v2/exerciseimage/?exercise=${wgerId}&format=json&limit=2`);
    if (!resp.ok) throw new Error('no image');
    const data = await resp.json();
    const imgs = data.results || [];
    if (!imgs.length) { _wgerImageCache[wgerId] = null; return; }
    // Prefer the main image (is_main=true)
    const main = imgs.find(i => i.is_main) || imgs[0];
    _wgerImageCache[wgerId] = main.image;
    _renderImageFrame(framesEl, main.image, name, muscles);
  } catch(e) {
    _wgerImageCache[wgerId] = null; // cache miss
  }
}
function _renderImageFrame(framesEl, imageUrl, name, muscles) {
  // Show image + keep one cue card
  const cues = EXERCISE_CUES[name] || EXERCISE_CUES.default;
  framesEl.innerHTML = `
    <div style="flex:1.6;display:flex;flex-direction:column;background:var(--dark);border-radius:14px;overflow:hidden;border:1px solid var(--border)">
      <div style="padding:8px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;background:rgba(255,255,255,0.02)">
        <div style="font-family:'Bebas Neue',sans-serif;font-size:0.8rem;letter-spacing:1px;color:#60a5fa">EXERCISE DEMO</div>
        <div style="margin-left:auto;font-size:0.65rem;color:var(--dim)">wger.de</div>
      </div>
      <div style="flex:1;display:flex;align-items:center;justify-content:center;padding:8px;min-height:140px">
        <img src="${imageUrl}" alt="${name}" style="max-width:100%;max-height:200px;object-fit:contain;border-radius:8px" onerror="this.parentElement.parentElement.parentElement.remove()">
      </div>
    </div>
    <div style="flex:1;display:flex;flex-direction:column;background:var(--dark);border-radius:14px;overflow:hidden;border:1px solid var(--border)">
      <div style="padding:10px 14px;border-bottom:1px solid var(--border);background:rgba(255,255,255,0.02)">
        <div style="font-family:'Bebas Neue',sans-serif;font-size:0.8rem;letter-spacing:1px;color:#4ADE80">FORM CUES</div>
      </div>
      <div style="padding:12px 14px;display:flex;flex-direction:column;gap:8px;flex:1">
        ${cues.start.concat(cues.mid).slice(0,4).map(c=>`<div style="display:flex;align-items:flex-start;gap:8px"><div style="width:4px;height:4px;border-radius:50%;background:#4ADE80;margin-top:6px;flex-shrink:0"></div><div style="font-size:0.79rem;color:var(--off);line-height:1.45">${c}</div></div>`).join('')}
      </div>
    </div>`;
}

// ── EXERCISE CUSTOMIZER ──
let _unplannedDayIdx = 0;
let _customBuilderSelected = []; // [{name, sets, reps, rest, muscles}]

function openCustomWorkoutBuilder() {
  // Use the same exercise picker modal as superset/substitute — build mode
  openDashExPicker('build', -1);
}

function openUnplannedWorkout(dayIdx) {
  _unplannedDayIdx = dayIdx;
  _customBuilderSelected = [];
  _aiGeneratedExercises = [];
  const dayNames = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
  // Reset ALL sub-panels
  const ids = ['unplanned-options','custom-builder','ai-workout-loading','ai-workout-preview'];
  ids.forEach(id => { const el = document.getElementById(id); if (el) el.style.display = id === 'unplanned-options' ? 'block' : 'none'; });
  document.getElementById('unplanned-modal-title').textContent = 'START A WORKOUT';
  document.getElementById('unplanned-modal-day').textContent = dayNames[dayIdx].toUpperCase() + ' — CHOOSE HOW TO START';
  document.getElementById('unplanned-modal').style.display = 'flex';
}

function closeUnplannedModal() {
  document.getElementById('unplanned-modal').style.display = 'none';
  document.getElementById('unplanned-modal').classList.remove('fullscreen-builder');
  const inner = document.getElementById('unplanned-modal-inner');
  if (inner) { inner.style.maxHeight = ''; inner.style.height = ''; inner.style.maxWidth = ''; inner.style.borderRadius = ''; inner.style.paddingTop = ''; inner.style.paddingBottom = ''; }
}

// Quick Start removed

let _aiGeneratedExercises = [];

async function startAIWorkout() {
  document.getElementById('unplanned-options').style.display = 'none';
  document.getElementById('unplanned-modal-title').textContent = 'AI WORKOUT';

  // Show preset IMMEDIATELY so user always sees something
  const tier = (USER && USER.tier) || 'beginner';
  // Derive actual goal text from weight data (USER.goal is goal WEIGHT, not goal text)
  let goalText = 'general fitness';
  if (USER && USER.goal && USER.weight) {
    goalText = USER.goal < USER.weight ? 'lose weight and get lean' : 'build muscle and gain strength';
  }
  _aiGeneratedExercises = _getPreset(tier);
  _showAIPreview(_aiGeneratedExercises, tier, goalText, 'SUGGESTED');

  // Debug status helper — shows on screen since can't see console on iPhone
  const dbg = document.getElementById('ai-debug-status');
  function _dbg(msg) {
    console.log('AI-WKT: ' + msg);
    if (dbg) { dbg.style.display = 'block'; dbg.textContent = msg; }
  }

  _dbg('Requesting AI workout...');

  // Use the SAME callClaude function that the coach chat uses (which works)
  try {
    const dayNames = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
    const day = dayNames[_unplannedDayIdx] || 'Monday';
    
    const aiText = await callClaude([{
      role: 'user',
      content: `Generate a ${day} gym workout for a ${tier} lifter whose goal is to ${goalText}.

Return ONLY a valid JSON array of 4-6 exercises. Each object must have these fields:
{"name":"string","sets":number,"reps":"string","rest":number,"muscles":"string"}

Example:
[{"name":"Back Squat","sets":4,"reps":"8-10","rest":120,"muscles":"Quads, Glutes"}]

No markdown, no backticks, no explanation — just the raw JSON array.`
    }], {
      system: 'You are a fitness workout generator. Respond with ONLY a valid JSON array. No markdown fences, no backticks, no explanation text, no preamble. Just the raw JSON array starting with [ and ending with ].',
      max_tokens: 800
    });
    
    _dbg('Got: ' + (aiText ? aiText.substring(0, 60) : '(empty)'));
    
    if (!aiText) {
      _dbg('Empty response from API');
      return;
    }
    
    const parsed = _parseExerciseJSON(aiText);
    if (parsed) {
      _aiGeneratedExercises = parsed;
      if (document.getElementById('unplanned-modal').style.display !== 'none') {
        _showAIPreview(_aiGeneratedExercises, tier, goalText, 'AI-GENERATED');
        if (dbg) dbg.style.display = 'none';
      }
    } else {
      _dbg('Parse fail: ' + aiText.substring(0, 100));
    }
  } catch(e) {
    _dbg('ERR: ' + (e.name === 'AbortError' ? 'Timeout 20s' : e.message));
  }
}

// Robust JSON array extraction from AI text response
function _parseExerciseJSON(text) {
  if (!text) return null;
  try {
    // Try direct parse first
    let cleaned = text.trim();
    // Strip markdown fences
    cleaned = cleaned.replace(/```(?:json)?\s*/g, '').replace(/```\s*/g, '').trim();
    // Try to find a JSON array in the text
    const arrMatch = cleaned.match(/\[[\s\S]*\]/);
    if (arrMatch) cleaned = arrMatch[0];
    const parsed = JSON.parse(cleaned);
    if (Array.isArray(parsed) && parsed.length >= 3 && parsed[0].name) {
      return parsed;
    }
  } catch(e) {
    console.log('Exercise JSON parse failed:', e.message, 'Raw:', text.substring(0, 200));
  }
  return null;
}

async function regenerateAIWorkout() {
  const tier = (USER && USER.tier) || 'beginner';
  let goalText = 'general fitness';
  if (USER && USER.goal && USER.weight) {
    goalText = USER.goal < USER.weight ? 'lose weight and get lean' : 'build muscle and gain strength';
  }
  document.getElementById('ai-workout-preview').style.display = 'none';
  document.getElementById('ai-workout-loading').style.display = 'block';
  
  try {
    const dayNames = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
    const day = dayNames[_unplannedDayIdx] || 'Monday';
    
    const aiText = await callClaude([{
      role: 'user',
      content: `Generate a different ${day} gym workout for a ${tier} lifter whose goal is to ${goalText}. Make it different from a standard workout. Return ONLY a valid JSON array of 4-6 exercises. Each object: {"name":"string","sets":number,"reps":"string","rest":number,"muscles":"string"}. No markdown, no explanation, just the JSON array.`
    }], {
      system: 'You are a fitness workout generator. Respond with ONLY a valid JSON array. No markdown fences, no backticks, no explanation text. Just the raw JSON array starting with [ and ending with ].',
      max_tokens: 800
    });
    
    const parsed = _parseExerciseJSON(aiText);
    if (parsed) {
      _aiGeneratedExercises = parsed;
      _showAIPreview(_aiGeneratedExercises, tier, goalText, 'AI-GENERATED');
      return;
    }
  } catch(e) {
    console.error('AI regenerate failed:', e.message);
  }
  // Fallback
  _aiGeneratedExercises = _getPreset(tier);
  _showAIPreview(_aiGeneratedExercises, tier, goalText, 'SUGGESTED');
}

function _getPreset(tier) {
  // Properly programmed presets: compound-first, accessories follow.
  // 6 templates cycling by day: Push, Pull, Legs, Upper, Lower, Full Body
  const dayIdx = _unplannedDayIdx !== undefined ? _unplannedDayIdx : new Date().getDay();
  const templates = {
    beginner: [
      // Day 0: Push — Bench first, then pressing accessories
      [ {name:'Bench Press',sets:3,reps:'8-10',rest:120,muscles:'Chest, Triceps, Shoulders'},{name:'Shoulder Press',sets:3,reps:'8-10',rest:90,muscles:'Shoulders, Triceps'},{name:'Incline DB Press',sets:3,reps:'10-12',rest:90,muscles:'Upper Chest'},{name:'Lateral Raises',sets:3,reps:'12-15',rest:60,muscles:'Side Delts'},{name:'Tricep Pushdown',sets:3,reps:'12-15',rest:60,muscles:'Triceps'} ],
      // Day 1: Pull — Heavy row first, then vertical pull, then accessories
      [ {name:'Barbell Row',sets:3,reps:'8-10',rest:120,muscles:'Back, Biceps'},{name:'Lat Pulldown',sets:3,reps:'10-12',rest:90,muscles:'Lats, Biceps'},{name:'Cable Row',sets:3,reps:'10-12',rest:90,muscles:'Mid Back'},{name:'Face Pulls',sets:3,reps:'15-20',rest:60,muscles:'Rear Delts'},{name:'Barbell Curl',sets:3,reps:'10-12',rest:60,muscles:'Biceps'} ],
      // Day 2: Legs — Squat first, then hamstrings/calves
      [ {name:'Goblet Squat',sets:3,reps:'10-12',rest:90,muscles:'Quads, Glutes'},{name:'Romanian Deadlift',sets:3,reps:'10-12',rest:90,muscles:'Hamstrings, Glutes'},{name:'Leg Press',sets:3,reps:'10-12',rest:90,muscles:'Quads'},{name:'Leg Curl',sets:3,reps:'12-15',rest:60,muscles:'Hamstrings'},{name:'Calf Raises',sets:3,reps:'15-20',rest:45,muscles:'Calves'} ],
      // Day 3: Upper — Bench + Row superset style, then shoulders/arms
      [ {name:'Bench Press',sets:3,reps:'8-10',rest:120,muscles:'Chest, Triceps'},{name:'Barbell Row',sets:3,reps:'8-10',rest:120,muscles:'Back, Biceps'},{name:'Arnold Press',sets:3,reps:'10-12',rest:90,muscles:'Shoulders'},{name:'Lat Pulldown',sets:3,reps:'10-12',rest:90,muscles:'Lats'},{name:'Hammer Curls',sets:3,reps:'10-12',rest:60,muscles:'Biceps, Forearms'} ],
      // Day 4: Lower — Squat first, then single-leg and hamstring work
      [ {name:'Back Squat',sets:3,reps:'8-10',rest:120,muscles:'Quads, Glutes'},{name:'Romanian Deadlift',sets:3,reps:'10-12',rest:90,muscles:'Hamstrings, Glutes'},{name:'Walking Lunges',sets:3,reps:'10 each',rest:60,muscles:'Quads, Glutes'},{name:'Leg Curl',sets:3,reps:'12-15',rest:60,muscles:'Hamstrings'},{name:'Calf Raises',sets:3,reps:'15-20',rest:45,muscles:'Calves'} ],
      // Day 5: Full Body — one big compound per body part
      [ {name:'Back Squat',sets:3,reps:'8-10',rest:120,muscles:'Quads, Glutes'},{name:'Bench Press',sets:3,reps:'8-10',rest:120,muscles:'Chest, Triceps'},{name:'Barbell Row',sets:3,reps:'8-10',rest:120,muscles:'Back, Biceps'},{name:'Shoulder Press',sets:3,reps:'10-12',rest:90,muscles:'Shoulders'},{name:'Barbell Curl',sets:2,reps:'10-12',rest:60,muscles:'Biceps'} ],
    ],
    intermediate: [
      // Day 0: Push — Heavy bench, then chest/shoulder/tricep accessories
      [ {name:'Bench Press',sets:4,reps:'6-8',rest:90,muscles:'Chest, Triceps, Shoulders'},{name:'Incline DB Press',sets:3,reps:'8-10',rest:120,muscles:'Upper Chest'},{name:'Shoulder Press',sets:3,reps:'8-10',rest:120,muscles:'Shoulders, Triceps'},{name:'Lateral Raises',sets:4,reps:'12-15',rest:60,muscles:'Side Delts'},{name:'Cable Crossover',sets:3,reps:'12-15',rest:60,muscles:'Chest'},{name:'Skull Crushers',sets:3,reps:'10-12',rest:60,muscles:'Triceps'} ],
      // Day 1: Pull — Heavy row first, pull-ups second, then isolation
      [ {name:'Barbell Row',sets:4,reps:'6-8',rest:90,muscles:'Back, Biceps'},{name:'Pull-Ups',sets:4,reps:'6-8',rest:120,muscles:'Lats, Biceps'},{name:'Cable Row',sets:3,reps:'10-12',rest:90,muscles:'Mid Back'},{name:'Face Pulls',sets:3,reps:'15-20',rest:60,muscles:'Rear Delts'},{name:'Barbell Curl',sets:3,reps:'10-12',rest:60,muscles:'Biceps'},{name:'Hammer Curls',sets:3,reps:'10-12',rest:60,muscles:'Biceps, Forearms'} ],
      // Day 2: Legs — Heavy squat, then posterior chain + accessories
      [ {name:'Back Squat',sets:4,reps:'5-8',rest:90,muscles:'Quads, Glutes'},{name:'Romanian Deadlift',sets:3,reps:'8-10',rest:120,muscles:'Hamstrings, Glutes'},{name:'Leg Press',sets:3,reps:'10-12',rest:120,muscles:'Quads'},{name:'Leg Curl',sets:3,reps:'12-15',rest:60,muscles:'Hamstrings'},{name:'Walking Lunges',sets:3,reps:'10 each',rest:60,muscles:'Quads, Glutes'},{name:'Calf Raises',sets:4,reps:'15-20',rest:45,muscles:'Calves'} ],
      // Day 3: Upper — Bench + Pull-ups, then shoulders and arms
      [ {name:'Bench Press',sets:4,reps:'6-8',rest:90,muscles:'Chest, Triceps'},{name:'Pull-Ups',sets:4,reps:'6-8',rest:120,muscles:'Lats, Biceps'},{name:'Arnold Press',sets:3,reps:'10-12',rest:90,muscles:'Shoulders'},{name:'Cable Row',sets:3,reps:'10-12',rest:90,muscles:'Mid Back'},{name:'Dumbbell Flyes',sets:3,reps:'12-15',rest:60,muscles:'Chest'},{name:'Tricep Pushdown',sets:3,reps:'12-15',rest:60,muscles:'Triceps'} ],
      // Day 4: Lower — Heavy deadlift, then quad/ham accessories
      [ {name:'Deadlift',sets:4,reps:'4-6',rest:120,muscles:'Full Posterior Chain'},{name:'Leg Press',sets:3,reps:'10-12',rest:120,muscles:'Quads'},{name:'Leg Curl',sets:3,reps:'12-15',rest:60,muscles:'Hamstrings'},{name:'Leg Extension',sets:3,reps:'12-15',rest:60,muscles:'Quads'},{name:'Hip Thrusts',sets:3,reps:'10-12',rest:90,muscles:'Glutes'},{name:'Calf Raises',sets:4,reps:'15-20',rest:45,muscles:'Calves'} ],
      // Day 5: Full Body — big compounds across all body parts
      [ {name:'Back Squat',sets:3,reps:'8-10',rest:120,muscles:'Quads, Glutes'},{name:'Bench Press',sets:3,reps:'8-10',rest:120,muscles:'Chest, Triceps'},{name:'Barbell Row',sets:3,reps:'8-10',rest:120,muscles:'Back, Biceps'},{name:'Shoulder Press',sets:3,reps:'8-10',rest:120,muscles:'Shoulders'},{name:'Barbell Curl',sets:3,reps:'10-12',rest:60,muscles:'Biceps'},{name:'Tricep Pushdown',sets:3,reps:'12-15',rest:60,muscles:'Triceps'} ],
    ],
    advanced: [
      // Day 0: Push — Heavy bench 5x, strength accessories
      [ {name:'Bench Press',sets:5,reps:'4-6',rest:90,muscles:'Chest, Triceps, Shoulders'},{name:'Incline DB Press',sets:4,reps:'6-8',rest:120,muscles:'Upper Chest'},{name:'Shoulder Press',sets:4,reps:'6-8',rest:120,muscles:'Shoulders, Triceps'},{name:'Lateral Raises',sets:4,reps:'12-15',rest:60,muscles:'Side Delts'},{name:'Cable Crossover',sets:3,reps:'12-15',rest:60,muscles:'Chest'},{name:'Skull Crushers',sets:4,reps:'8-10',rest:60,muscles:'Triceps'} ],
      // Day 1: Pull — Heavy deadlift, then rows, then vertical pull + biceps
      [ {name:'Deadlift',sets:5,reps:'3-5',rest:120,muscles:'Full Posterior Chain'},{name:'Barbell Row',sets:4,reps:'6-8',rest:90,muscles:'Back, Biceps'},{name:'Lat Pulldown',sets:3,reps:'10-12',rest:90,muscles:'Lats, Biceps'},{name:'Face Pulls',sets:3,reps:'15-20',rest:60,muscles:'Rear Delts'},{name:'Barbell Curl',sets:4,reps:'8-10',rest:60,muscles:'Biceps'},{name:'Hammer Curls',sets:3,reps:'10-12',rest:60,muscles:'Biceps, Forearms'} ],
      // Day 2: Legs — Heavy squat, then posterior chain + unilateral
      [ {name:'Back Squat',sets:5,reps:'4-6',rest:90,muscles:'Quads, Glutes'},{name:'Romanian Deadlift',sets:4,reps:'6-8',rest:120,muscles:'Hamstrings, Glutes'},{name:'Leg Press',sets:4,reps:'8-10',rest:120,muscles:'Quads'},{name:'Walking Lunges',sets:3,reps:'10 each',rest:60,muscles:'Quads, Glutes'},{name:'Leg Curl',sets:4,reps:'10-12',rest:60,muscles:'Hamstrings'},{name:'Calf Raises',sets:5,reps:'12-15',rest:45,muscles:'Calves'} ],
      // Day 3: Upper — Bench + Pull-ups heavy, then accessories
      [ {name:'Bench Press',sets:4,reps:'5-7',rest:90,muscles:'Chest, Triceps'},{name:'Pull-Ups',sets:4,reps:'6-8',rest:120,muscles:'Lats, Biceps'},{name:'Arnold Press',sets:4,reps:'8-10',rest:120,muscles:'Shoulders'},{name:'Cable Row',sets:3,reps:'10-12',rest:90,muscles:'Mid Back'},{name:'Incline DB Press',sets:3,reps:'8-10',rest:90,muscles:'Upper Chest'},{name:'Close Grip Bench',sets:3,reps:'8-10',rest:90,muscles:'Triceps'} ],
      // Day 4: Lower — Heavy deadlift, then squat + accessories
      [ {name:'Conventional Deadlift',sets:5,reps:'3-5',rest:120,muscles:'Full Posterior Chain'},{name:'Leg Press',sets:4,reps:'8-10',rest:120,muscles:'Quads'},{name:'Walking Lunges',sets:3,reps:'10 each',rest:90,muscles:'Quads, Glutes'},{name:'Leg Curl',sets:4,reps:'10-12',rest:60,muscles:'Hamstrings'},{name:'Hip Thrusts',sets:3,reps:'10-12',rest:90,muscles:'Glutes'},{name:'Hyperextensions',sets:3,reps:'12-15',rest:60,muscles:'Lower Back'} ],
      // Day 5: Full Body — strength focus, one compound per movement pattern
      [ {name:'Back Squat',sets:4,reps:'6-8',rest:90,muscles:'Quads, Glutes'},{name:'Bench Press',sets:4,reps:'5-7',rest:90,muscles:'Chest, Triceps'},{name:'Barbell Row',sets:4,reps:'5-7',rest:90,muscles:'Back, Biceps'},{name:'Shoulder Press',sets:3,reps:'8-10',rest:120,muscles:'Shoulders'},{name:'Barbell Curl',sets:3,reps:'10-12',rest:60,muscles:'Biceps'},{name:'Skull Crushers',sets:3,reps:'10-12',rest:60,muscles:'Triceps'} ],
    ],
  };
  const t = templates[tier] || templates.intermediate;
  return t[dayIdx % t.length];
}

async function _generateAIWorkout() {
  const tier = (USER && USER.tier) || 'beginner';
  let goal = 'general fitness';
  if (USER && USER.goal && USER.weight) {
    goal = USER.goal < USER.weight ? 'lose weight and get lean' : 'build muscle and gain strength';
  }
  const dayNames = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
  const day = dayNames[_unplannedDayIdx];

  // Get recent workout history to avoid repeating muscle groups
  const workoutDates = getWorkoutDates();
  const recentMuscles = [];
  const exLogs = lsGet('fs_exerciseLogs') || {};
  const now = new Date();
  for (let i = 1; i <= 3; i++) {
    const check = new Date(now);
    check.setDate(now.getDate() - i);
    const key = check.getFullYear() + '-' + String(check.getMonth()+1).padStart(2,'0') + '-' + String(check.getDate()).padStart(2,'0');
    if (workoutDates.has(key)) {
      // Check what muscles were hit by looking at exercise logs
      for (const [exName, logs] of Object.entries(exLogs)) {
        if (logs.some(l => l.date === key)) {
          const dbEntry = EXERCISE_DB[exName];
          if (dbEntry) recentMuscles.push(dbEntry.muscles);
        }
      }
    }
  }

  let usedAI = false;
  try {
    const recentNote = recentMuscles.length > 0
      ? `\nThey recently trained: ${recentMuscles.join(', ')}. Avoid overlapping those muscle groups.`
      : '';
    const text = await callClaude([{
      role: 'user',
      content: `Generate a ${day} gym workout for a ${tier} level person whose goal is to ${goal}.${recentNote}

Return ONLY a valid JSON array of 4-6 exercises. Each object must have exactly these fields:
- "name": string (exercise name)
- "sets": number
- "reps": string (like "8-10" or "30s")
- "rest": number (seconds)
- "muscles": string (target muscles)

No markdown fences, no explanation, no commentary — just the raw JSON array.`
    }], { max_tokens: 800 });
    const cleaned = text.replace(/```json|```/g, '').trim();
    const parsed = _parseExerciseJSON(text);
    if (Array.isArray(parsed) && parsed.length >= 3 && parsed[0].name) {
      _aiGeneratedExercises = parsed;
      usedAI = true;
    }
  } catch(e) {
    console.log('AI workout generation failed:', e.message);
  }

  if (!usedAI) {
    _aiGeneratedExercises = _getPreset(tier);
  }

  // Update the preview if modal is still open
  if (document.getElementById('unplanned-modal').style.display !== 'none') {
    const label = usedAI ? 'AI-GENERATED' : 'SUGGESTED';
    _showAIPreview(_aiGeneratedExercises, tier, goal, label);
  }
}

function _showAIPreview(exercises, tier, goal, badge) {
  document.getElementById('ai-workout-loading').style.display = 'none';
  document.getElementById('ai-preview-label').textContent =
    `${badge || 'AI-GENERATED'} · ${(tier || 'BEGINNER').toUpperCase()} · ${(goal || 'BUILD MUSCLE').toUpperCase()} · ${exercises.length} EXERCISES`;
  _renderAIPreviewList();
  document.getElementById('ai-workout-preview').style.display = 'block';
}

function _renderAIPreviewList() {
  const exercises = _aiGeneratedExercises;
  document.getElementById('ai-preview-list').innerHTML = exercises.map((ex, i) =>
    `<div style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px 16px;">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div style="flex:1;min-width:0">
          <div style="font-family:'Bebas Neue',sans-serif;font-size:1rem;letter-spacing:1px;color:var(--white)">${ex.name}</div>
          <div style="font-size:0.75rem;color:var(--dim);margin-top:2px">${ex.muscles}</div>
        </div>
        <div style="text-align:right;flex-shrink:0;margin-left:12px">
          <div style="font-family:'Bebas Neue',sans-serif;font-size:0.95rem;color:var(--green)">${ex.sets} × ${ex.reps}</div>
          <div style="font-size:0.7rem;color:var(--dim)">REST ${ex.rest}s</div>
        </div>
      </div>
      <div style="display:flex;gap:8px;margin-top:10px;border-top:1px solid var(--border);padding-top:10px">
        <button onclick="_aiSwapExercise(${i})" style="flex:1;padding:7px 0;background:none;border:1px solid var(--border2);border-radius:8px;color:var(--off);font-size:0.72rem;font-family:'Inter',sans-serif;cursor:pointer">↻ Swap</button>
        <button onclick="_aiEditSetsReps(${i})" style="flex:1;padding:7px 0;background:none;border:1px solid var(--border2);border-radius:8px;color:var(--off);font-size:0.72rem;font-family:'Inter',sans-serif;cursor:pointer">✎ Edit</button>
        <button onclick="_aiRemoveExercise(${i})" style="padding:7px 12px;background:none;border:1px solid rgba(244,63,94,0.25);border-radius:8px;color:var(--red);font-size:0.72rem;font-family:'Inter',sans-serif;cursor:pointer">✕</button>
      </div>
    </div>`
  ).join('') +
  `<button onclick="_aiAddExercise()" style="width:100%;padding:14px;background:var(--card);border:1px dashed var(--border2);border-radius:12px;color:var(--dim);font-family:'Bebas Neue',sans-serif;font-size:0.9rem;letter-spacing:1.5px;cursor:pointer;margin-top:4px">+ ADD EXERCISE</button>`;
  // Update the exercise count in the label
  const label = document.getElementById('ai-preview-label');
  if (label) {
    label.textContent = label.textContent.replace(/\d+ EXERCISES/, exercises.length + ' EXERCISES');
  }
}

function _aiRemoveExercise(idx) {
  if (_aiGeneratedExercises.length <= 1) return; // keep at least 1
  _aiGeneratedExercises.splice(idx, 1);
  _renderAIPreviewList();
}

function _aiEditSetsReps(idx) {
  const ex = _aiGeneratedExercises[idx];
  const card = document.getElementById('ai-preview-list').children[idx];
  if (!card) return;
  // Replace the edit row with inline inputs
  const editRow = card.querySelector('div:last-child');
  editRow.innerHTML = `
    <div style="display:flex;gap:6px;align-items:center;width:100%">
      <div style="flex:1;text-align:center">
        <div style="font-size:0.58rem;color:var(--dim);letter-spacing:1px;margin-bottom:3px">SETS</div>
        <input type="number" id="_ai-edit-sets-${idx}" value="${ex.sets}" min="1" max="10"
          style="width:100%;padding:7px 4px;background:var(--dark);border:1px solid var(--border2);border-radius:7px;color:var(--white);text-align:center;font-family:'DM Mono',monospace;font-size:0.9rem;outline:none">
      </div>
      <div style="flex:1;text-align:center">
        <div style="font-size:0.58rem;color:var(--dim);letter-spacing:1px;margin-bottom:3px">REPS</div>
        <input type="text" id="_ai-edit-reps-${idx}" value="${ex.reps}"
          style="width:100%;padding:7px 4px;background:var(--dark);border:1px solid var(--border2);border-radius:7px;color:var(--white);text-align:center;font-family:'DM Mono',monospace;font-size:0.9rem;outline:none">
      </div>
      <div style="flex:1;text-align:center">
        <div style="font-size:0.58rem;color:var(--dim);letter-spacing:1px;margin-bottom:3px">REST</div>
        <input type="number" id="_ai-edit-rest-${idx}" value="${ex.rest}" min="0" step="15"
          style="width:100%;padding:7px 4px;background:var(--dark);border:1px solid var(--border2);border-radius:7px;color:var(--white);text-align:center;font-family:'DM Mono',monospace;font-size:0.9rem;outline:none">
      </div>
      <button onclick="_aiSaveEdit(${idx})" style="padding:7px 14px;background:var(--green);border:none;border-radius:7px;color:var(--black);font-size:0.75rem;font-family:'Bebas Neue',sans-serif;letter-spacing:1px;cursor:pointer;align-self:flex-end">SAVE</button>
    </div>`;
}

function _aiSaveEdit(idx) {
  const s = document.getElementById('_ai-edit-sets-' + idx);
  const r = document.getElementById('_ai-edit-reps-' + idx);
  const t = document.getElementById('_ai-edit-rest-' + idx);
  if (s) _aiGeneratedExercises[idx].sets = parseInt(s.value) || _aiGeneratedExercises[idx].sets;
  if (r && r.value.trim()) _aiGeneratedExercises[idx].reps = r.value.trim();
  if (t) _aiGeneratedExercises[idx].rest = parseInt(t.value) || _aiGeneratedExercises[idx].rest;
  _renderAIPreviewList();
}

// Swap picker: shows a mini exercise list to pick a replacement
function _aiSwapExercise(idx) {
  const ex = _aiGeneratedExercises[idx];
  // Find exercises in the same category or targeting similar muscles
  const targetMuscle = (ex.muscles || '').split(',')[0].trim().toLowerCase();
  const usedNames = new Set(_aiGeneratedExercises.map(e => e.name));
  const candidates = Object.entries(EXERCISE_DB)
    .filter(([name, db]) => !usedNames.has(name))
    .sort((a, b) => {
      // Prioritize same muscle group
      const aMatch = a[1].muscles.toLowerCase().includes(targetMuscle) ? 0 : 1;
      const bMatch = b[1].muscles.toLowerCase().includes(targetMuscle) ? 0 : 1;
      if (aMatch !== bMatch) return aMatch - bMatch;
      return a[0].localeCompare(b[0]);
    });

  const card = document.getElementById('ai-preview-list').children[idx];
  if (!card) return;
  const editRow = card.querySelector('div:last-child');
  editRow.innerHTML = `
    <div style="width:100%">
      <input type="text" placeholder="Search exercises..." oninput="_aiFilterSwap(${idx},this.value)"
        style="width:100%;box-sizing:border-box;padding:8px 12px;background:var(--dark);border:1px solid var(--border2);border-radius:8px;color:var(--white);font-size:0.82rem;outline:none;margin-bottom:6px">
      <div id="_ai-swap-list-${idx}" style="max-height:180px;overflow-y:auto;display:flex;flex-direction:column;gap:4px">
        ${candidates.slice(0, 15).map(([name, db]) =>
          `<div onclick="_aiDoSwap(${idx},'${name.replace(/'/g, "\\'")}')" style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:var(--dark);border:1px solid var(--border);border-radius:8px;cursor:pointer">
            <div><div style="font-size:0.82rem;color:var(--white)">${name}</div><div style="font-size:0.68rem;color:var(--dim)">${db.muscles}</div></div>
            <div style="font-size:0.68rem;color:var(--green)">${db.sets}×${db.reps}</div>
          </div>`
        ).join('')}
      </div>
      <button onclick="_renderAIPreviewList()" style="width:100%;padding:7px;background:none;border:1px solid var(--border);border-radius:8px;color:var(--dim);font-size:0.72rem;cursor:pointer;margin-top:6px">Cancel</button>
    </div>`;
}

function _aiFilterSwap(idx, query) {
  const q = query.toLowerCase();
  const usedNames = new Set(_aiGeneratedExercises.map(e => e.name));
  const results = Object.entries(EXERCISE_DB)
    .filter(([name]) => !usedNames.has(name) && name.toLowerCase().includes(q))
    .slice(0, 15);
  const list = document.getElementById('_ai-swap-list-' + idx);
  if (!list) return;
  list.innerHTML = results.map(([name, db]) =>
    `<div onclick="_aiDoSwap(${idx},'${name.replace(/'/g, "\\'")}')" style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:var(--dark);border:1px solid var(--border);border-radius:8px;cursor:pointer">
      <div><div style="font-size:0.82rem;color:var(--white)">${name}</div><div style="font-size:0.68rem;color:var(--dim)">${db.muscles}</div></div>
      <div style="font-size:0.68rem;color:var(--green)">${db.sets}×${db.reps}</div>
    </div>`
  ).join('') || '<div style="padding:12px;color:var(--dim);font-size:0.78rem;text-align:center">No matches</div>';
}

function _aiDoSwap(idx, name) {
  const db = EXERCISE_DB[name];
  if (!db) return;
  _aiGeneratedExercises[idx] = {
    name: name,
    sets: db.sets,
    reps: db.reps,
    rest: db.rest,
    muscles: db.muscles
  };
  _renderAIPreviewList();
}

// Add exercise picker
function _aiAddExercise() {
  const usedNames = new Set(_aiGeneratedExercises.map(e => e.name));
  const candidates = Object.entries(EXERCISE_DB)
    .filter(([name]) => !usedNames.has(name))
    .sort((a, b) => a[0].localeCompare(b[0]));

  const listEl = document.getElementById('ai-preview-list');
  // Replace the add button at the bottom with a picker
  const addBtn = listEl.querySelector('button:last-child');
  if (addBtn) {
    addBtn.outerHTML = `
    <div id="_ai-add-panel" style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px 16px;margin-top:4px">
      <input type="text" placeholder="Search exercises to add..." oninput="_aiFilterAdd(this.value)"
        style="width:100%;box-sizing:border-box;padding:8px 12px;background:var(--dark);border:1px solid var(--border2);border-radius:8px;color:var(--white);font-size:0.82rem;outline:none;margin-bottom:8px">
      <div id="_ai-add-list" style="max-height:200px;overflow-y:auto;display:flex;flex-direction:column;gap:4px">
        ${candidates.slice(0, 20).map(([name, db]) =>
          `<div onclick="_aiDoAdd('${name.replace(/'/g, "\\'")}')" style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:var(--dark);border:1px solid var(--border);border-radius:8px;cursor:pointer">
            <div><div style="font-size:0.82rem;color:var(--white)">${name}</div><div style="font-size:0.68rem;color:var(--dim)">${db.muscles}</div></div>
            <div style="color:var(--green);font-size:1rem;font-weight:700">+</div>
          </div>`
        ).join('')}
      </div>
      <button onclick="_renderAIPreviewList()" style="width:100%;padding:7px;background:none;border:1px solid var(--border);border-radius:8px;color:var(--dim);font-size:0.72rem;cursor:pointer;margin-top:8px">Cancel</button>
    </div>`;
  }
}

function _aiFilterAdd(query) {
  const q = query.toLowerCase();
  const usedNames = new Set(_aiGeneratedExercises.map(e => e.name));
  const results = Object.entries(EXERCISE_DB)
    .filter(([name]) => !usedNames.has(name) && name.toLowerCase().includes(q))
    .slice(0, 20);
  const list = document.getElementById('_ai-add-list');
  if (!list) return;
  list.innerHTML = results.map(([name, db]) =>
    `<div onclick="_aiDoAdd('${name.replace(/'/g, "\\'")}')" style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:var(--dark);border:1px solid var(--border);border-radius:8px;cursor:pointer">
      <div><div style="font-size:0.82rem;color:var(--white)">${name}</div><div style="font-size:0.68rem;color:var(--dim)">${db.muscles}</div></div>
      <div style="color:var(--green);font-size:1rem;font-weight:700">+</div>
    </div>`
  ).join('') || '<div style="padding:12px;color:var(--dim);font-size:0.78rem;text-align:center">No matches</div>';
}

function _aiDoAdd(name) {
  const db = EXERCISE_DB[name];
  if (!db) return;
  _aiGeneratedExercises.push({
    name: name,
    sets: db.sets,
    reps: db.reps,
    rest: db.rest,
    muscles: db.muscles
  });
  _renderAIPreviewList();
}

function launchAIWorkout() {
  closeUnplannedModal();
  _launchUnplannedEnv(_aiGeneratedExercises);
}

function showCustomBuilder() {
  document.getElementById('unplanned-options').style.display = 'none';
  document.getElementById('custom-builder').style.display = 'block';
  document.getElementById('unplanned-modal-title').textContent = 'CUSTOM WORKOUT';
  document.getElementById('unplanned-modal-day').textContent = 'Select exercises and configure your workout';
  // Force fullscreen via CSS class (works reliably on iOS Safari)
  document.getElementById('unplanned-modal').classList.add('fullscreen-builder');
  _customBuilderSelected = [];
  _customCatFilter = 'All';
  if (document.getElementById('custom-ex-search')) document.getElementById('custom-ex-search').value = '';
  renderCustomExList();
  renderCustomSelected();
  const cats = [...new Set(Object.values(EXERCISE_DB).map(e => e.category))].sort();
  document.getElementById('custom-cat-filters').innerHTML =
    ['All', ...cats].map(c =>
      `<button onclick="filterCustomExCat('${c}',this)" class="custom-cat-btn" style="padding:5px 12px;border-radius:20px;border:1px solid var(--border);background:${c==='All'?'var(--green)':'var(--card)'};color:${c==='All'?'var(--black)':'var(--off)'};font-size:0.72rem;cursor:pointer">${c}</button>`
    ).join('');
}

let _customCatFilter = 'All';
function filterCustomExCat(cat, btn) {
  _customCatFilter = cat;
  document.querySelectorAll('.custom-cat-btn').forEach(b => {
    b.style.background = 'var(--card)'; b.style.color = 'var(--off)';
  });
  btn.style.background = 'var(--green)'; btn.style.color = 'var(--black)';
  renderCustomExList();
}

function filterCustomExList() {
  renderCustomExList();
}

function renderCustomExList() {
  const search = (document.getElementById('custom-ex-search')?.value || '').toLowerCase();
  const entries = Object.entries(EXERCISE_DB).filter(([name, ex]) => {
    const matchCat = _customCatFilter === 'All' || ex.category === _customCatFilter;
    const matchSearch = !search || name.toLowerCase().includes(search);
    return matchCat && matchSearch;
  });
  const list = document.getElementById('custom-ex-list');
  if (!list) return;
  list.innerHTML = entries.map(([name, ex]) => {
    const selected = _customBuilderSelected.find(e => e.name === name);
    return `<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:${selected?'var(--green-dim)':'var(--card)'};border:1px solid ${selected?'rgba(74,222,128,0.3)':'var(--border)'};border-radius:10px;cursor:pointer" onclick="toggleCustomEx('${name}')">
      <div>
        <div style="font-size:0.88rem;font-weight:600;color:var(--white)">${name}</div>
        <div style="font-size:0.72rem;color:var(--dim)">${ex.muscles} · ${ex.sets}×${ex.reps}</div>
      </div>
      <div style="font-size:1.2rem;color:${selected?'var(--green)':'var(--dim)'}">
        ${selected ? '✓' : '+'}
      </div>
    </div>`;
  }).join('');
}

function toggleCustomEx(name) {
  const db = EXERCISE_DB[name];
  const idx = _customBuilderSelected.findIndex(e => e.name === name);
  if (idx >= 0) {
    _customBuilderSelected.splice(idx, 1);
  } else {
    // Start blank so user fills in their own values
    _customBuilderSelected.push({ name, sets: '', reps: '', rest: '', muscles: db.muscles });
  }
  renderCustomExList();
  renderCustomSelected();
}

function updateCustomEx(name, field, value) {
  const ex = _customBuilderSelected.find(e => e.name === name);
  if (ex) {
    ex[field] = field === 'sets' || field === 'rest' ? parseInt(value) || ex[field] : value;
  }
}

function renderCustomSelected() {
  const wrap = document.getElementById('custom-selected');
  const list = document.getElementById('custom-selected-list');
  if (!list) return;
  if (!_customBuilderSelected.length) { wrap.style.display = 'none'; return; }
  wrap.style.display = 'block';
  list.innerHTML = _customBuilderSelected.map((ex, i) =>
    `<div style="background:var(--dark);border:1px solid var(--border2);border-radius:12px;padding:12px 14px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
        <div style="font-family:'Bebas Neue',sans-serif;font-size:0.95rem;color:var(--white);letter-spacing:0.5px">${ex.name}</div>
        <button onclick="toggleCustomEx('${ex.name}')" style="background:none;border:none;color:var(--dim);cursor:pointer;font-size:1rem;padding:0 4px">✕</button>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px">
        <div>
          <div style="font-size:0.62rem;color:var(--dim);font-weight:600;letter-spacing:1px;margin-bottom:4px">SETS</div>
          <input type="number" placeholder="3" value="${ex.sets}" min="1" max="10"
            oninput="updateCustomEx('${ex.name}','sets',this.value)"
            style="width:100%;box-sizing:border-box;padding:10px 6px;background:var(--card);border:1px solid var(--border2);border-radius:8px;color:var(--white);font-size:1rem;text-align:center;outline:none">
        </div>
        <div>
          <div style="font-size:0.62rem;color:var(--dim);font-weight:600;letter-spacing:1px;margin-bottom:4px">REPS</div>
          <input type="text" placeholder="8-10" value="${ex.reps}"
            oninput="updateCustomEx('${ex.name}','reps',this.value)"
            style="width:100%;box-sizing:border-box;padding:10px 6px;background:var(--card);border:1px solid var(--border2);border-radius:8px;color:var(--white);font-size:1rem;text-align:center;outline:none">
        </div>
        <div>
          <div style="font-size:0.62rem;color:var(--dim);font-weight:600;letter-spacing:1px;margin-bottom:4px">REST (s)</div>
          <input type="number" placeholder="90" value="${ex.rest}" min="15" max="600" step="15"
            oninput="updateCustomEx('${ex.name}','rest',this.value)"
            style="width:100%;box-sizing:border-box;padding:10px 6px;background:var(--card);border:1px solid var(--border2);border-radius:8px;color:var(--white);font-size:1rem;text-align:center;outline:none">
        </div>
      </div>
    </div>`
  ).join('');
}

function launchCustomWorkout() {
  if (!_customBuilderSelected.length) return;
  // Fill in sensible defaults for any blank fields
  const exercises = _customBuilderSelected.map(ex => ({
    ...ex,
    sets: parseInt(ex.sets) || 3,
    reps: ex.reps || '8-10',
    rest: parseInt(ex.rest) || 90,
  }));
  closeUnplannedModal();
  _launchUnplannedEnv(exercises);
}

function _launchUnplannedEnv(exercises) {
  woDay = _unplannedDayIdx;
  const dayNames = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
  woWorkout = { dayName: dayNames[woDay] + ' — Workout', exercises: exercises };
  woCurrentEx = 0;
  woPRs = [];
  // Always start fresh for custom workouts — never load stale draft
  // exercises already have correct sets/reps from user config
  woSets = {};
  woExtraSets = {};
  exercises.forEach(function(ex, i) {
    if (ex.sets) woExtraSets[i] = ex.sets;
  });
  document.getElementById('screen-dash').style.display = 'none';
  const woEl = document.getElementById('screen-workout');
  woEl.classList.add('active');
  woEl.style.display = 'flex';
  document.body.style.overflow = 'hidden';
  window.scrollTo(0, 0);
  const dayTitleEl = document.getElementById('wo-day-title');
  if (dayTitleEl) dayTitleEl.textContent = woWorkout.dayName;
  document.getElementById('wo-day-subtitle').textContent = '';
  renderEcList();
  loadExercise(0);
  restoreRestTimerIfActive();
}

function openQuickFoodModal() {
  // Opens food modal targeting 'other' category on today
  nutDay = TODAY_IDX;
  openFoodModal('other');
}

function renderTodayMiniLog() {
  const entries = getAllEntries(TODAY_IDX);
  const el = document.getElementById('today-mini-log');
  if (!el) return;
  if (!entries.length) {
    el.innerHTML = '<div style="padding:12px 18px;font-size:0.84rem;color:var(--dim)">No food logged today yet.</div>';
    return;
  }
  const last5 = entries.slice(-5).reverse();
  el.innerHTML = last5.map(e =>
    `<div style="display:flex;justify-content:space-between;align-items:center;padding:9px 18px;border-bottom:1px solid rgba(255,255,255,0.04)">
      <div style="font-size:0.84rem;color:var(--off)">${e.name}</div>
      <div style="font-family:'Bebas Neue',sans-serif;font-size:0.9rem;color:var(--green)">${e.cal} cal</div>
    </div>`
  ).join('') + (entries.length > 5 ? `<div style="padding:8px 18px;font-size:0.75rem;color:var(--dim);text-align:center">+${entries.length-5} more · <a onclick="dashNav('nutrition',document.querySelector('.sb-btn:nth-child(4)'))" style="color:var(--green);cursor:pointer">View all in Nutrition</a></div>` : '');
}

function renderEcList() {
  const exes = woWorkout.exercises;
  const list = document.getElementById('wo-ex-list');
  if (!list) return;
  list.innerHTML = exes.map((ex,i) => {
    const isDone = woSets[i] && woSets[i].some(s => s.done);
    return `<div class="wo-ex-sidebar-item ${i===woCurrentEx?'active':''}" onclick="loadExercise(${i})">
      <div class="wo-ex-sidebar-num">${i+1}</div>
      <div class="wo-ex-sidebar-info">
        <div class="wo-ex-sidebar-name">${ex.name}</div>
        <div class="wo-ex-sidebar-sets">${ex.sets}×${ex.reps}</div>
      </div>
      ${isDone ? '<div class="wo-ex-sidebar-done">✓</div>' : ''}
      <button class="wo-ex-del" onclick="event.stopPropagation();removeExerciseFromWorkout(${i})" title="Remove">✕</button>
    </div>`;
  }).join('');
}


function removeExercise(e, idx) {
  e.stopPropagation();
  if (woWorkout.exercises.length <= 1) { alert('Need at least one exercise.'); return; }
  woWorkout.exercises.splice(idx, 1);
  // Save custom workout to localStorage
  saveCustomWorkout();
  if (woCurrentEx >= woWorkout.exercises.length) woCurrentEx = woWorkout.exercises.length - 1;
  renderEcList();
  renderEcList();
  loadExercise(woCurrentEx);
}

function saveCustomWorkout() {
  const key = `fs_custom_workout_${woDay}`;
  lsSet(key, woWorkout.exercises);
}

function loadCustomWorkout(dayIdx) {
  const key = `fs_custom_workout_${dayIdx}`;
  return lsGet(key);
}

// ── ADD EXERCISE MODAL ──
let aesCurrentCat = 'All';

function removeExerciseFromWorkout(idx) {
  if (woWorkout.exercises.length <= 1) return;
  woWorkout.exercises.splice(idx, 1);
  saveCustomWorkout(woDay, woWorkout.exercises);
  if (woCurrentEx >= woWorkout.exercises.length) woCurrentEx = woWorkout.exercises.length - 1;
  renderEcList();
  loadExercise(woCurrentEx);
}

function openAddExModal() {
  const modal = document.getElementById('add-ex-modal');
  modal.classList.add('open');
  // Build category pills
  const catsEl = document.getElementById('aes-cats');
  catsEl.innerHTML = ['All',...EXERCISE_CATEGORIES].map(c =>
    `<div class="aes-cat ${c==='All'?'active':''}" data-cat="${c}" onclick="selectExCat(this)">${c}</div>`
  ).join('');
  aesCurrentCat = 'All';
  document.getElementById('aes-search-input').value = '';
  renderExModalList();
}

function closeAddExModal() {
  document.getElementById('add-ex-modal').classList.remove('open');
}

function selectExCat(btn) {
  document.querySelectorAll('.aes-cat').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  aesCurrentCat = btn.dataset.cat;
  renderExModalList();
}

function filterExModal() { renderExModalList(); }

function renderExModalList() {
  const search = document.getElementById('aes-search-input').value.toLowerCase();
  const currentNames = woWorkout.exercises.map(e => e.name);
  const list = document.getElementById('aes-list');
  const filtered = Object.entries(EXERCISE_DB).filter(([name, data]) => {
    const catMatch = aesCurrentCat === 'All' || data.category === aesCurrentCat;
    const searchMatch = !search || name.toLowerCase().includes(search) || data.muscles.toLowerCase().includes(search);
    return catMatch && searchMatch;
  });
  list.innerHTML = filtered.map(([name, data]) => {
    const isAdded = currentNames.includes(name);
    return `<div class="aes-item ${isAdded?'added':''}" onclick="addExerciseToWorkout('${name.replace(/'/g,"\'")}')">
      <div><div class="aes-item-name">${name}</div><div class="aes-item-cat">${data.muscles}</div></div>
      <div class="aes-item-cat">${data.sets}×${data.reps}</div>
      <button class="aes-item-add ${isAdded?'done':''}">${isAdded?'✓':'+'}</button>
    </div>`;
  }).join('');
  if (!filtered.length) list.innerHTML = '<div style="text-align:center;padding:24px;color:var(--dim);font-size:0.83rem">No exercises found</div>';
}

function addExerciseToWorkout(name) {
  const db = getExerciseData(name);
  const already = woWorkout.exercises.find(e => e.name === name);
  if (already) { closeAddExModal(); return; }
  woWorkout.exercises.push({
    name, sets: db.sets, reps: db.reps, rest: db.rest, muscles: db.muscles
  });
  saveCustomWorkout();
  renderExModalList();
  renderEcList();
  renderWoExList();
  // Auto-navigate to the new exercise
  loadExercise(woWorkout.exercises.length - 1);
  closeAddExModal();
}

function nextExercise() {
  const exes = woWorkout.exercises;
  if (woCurrentEx < exes.length-1) {
    loadExercise(woCurrentEx+1);
  } else {
    finishWorkout();
  }
}

function prevExercise() {
  console.log('prevExercise called, woCurrentEx=', woCurrentEx);
  if (woCurrentEx > 0) {
    woCurrentEx--;
    loadExercise(woCurrentEx);
  }
}

// ── REST TIMER (timestamp-based for background accuracy) ──
let restTotalSecs = 90;
let restTimerEndAt = 0;

function buildRestSelect() { /* no-op — rest time set by restTotalSecs = ex.rest */ }

function updateRestDisplay() {
  const lbl = document.getElementById('rest-timer-label');
  const secs = document.getElementById('rest-timer-secs-display');
  if (lbl) lbl.textContent = 'START REST TIMER';
  if (secs) secs.textContent = restTotalSecs + 's';
}

function adjustRest(delta) {
  if (restTimerInterval) return;
  restTotalSecs = Math.max(15, Math.min(600, restTotalSecs + delta));
  updateRestDisplay();
}

function toggleRestTimer() {
  if (restTimerInterval) {
    skipRest();
  } else {
    startRestTimerSecs(restTotalSecs);
  }
}

function startRestTimer() {
  startRestTimerSecs(restTotalSecs);
}

// Pre-create AudioContext on first user tap so iOS allows audio later
let _audioCtx = null;
function _getAudioCtx() {
  if (!_audioCtx) {
    const Ctx = window.AudioContext || window.webkitAudioContext;
    if (Ctx) _audioCtx = new Ctx();
  }
  if (_audioCtx && _audioCtx.state === 'suspended') _audioCtx.resume();
  return _audioCtx;
}
document.addEventListener('touchstart', function() { _getAudioCtx(); }, { once: true });
document.addEventListener('click', function() { _getAudioCtx(); }, { once: true });

function playRestChime() {
  try {
    // Always create a fresh AudioContext for the chime — iOS kills suspended ones
    const Ctx = window.AudioContext || window.webkitAudioContext;
    if (!Ctx) return;
    const ctx = new Ctx();
    // Resume immediately — we're inside a setInterval tick which is close enough to user interaction on most iOS versions
    const doPlay = function() {
      const notes = [1047, 1319, 1568]; // C6, E6, G6
      notes.forEach(function(freq, i) {
        setTimeout(function() {
          try {
            const o = ctx.createOscillator();
            const g = ctx.createGain();
            o.connect(g);
            g.connect(ctx.destination);
            o.frequency.value = freq;
            o.type = 'sine';
            g.gain.setValueAtTime(0.7, ctx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.5);
            o.start(ctx.currentTime);
            o.stop(ctx.currentTime + 0.5);
          } catch(e2) {}
        }, i * 200);
      });
      // Close context after last note finishes
      setTimeout(function() { try { ctx.close(); } catch(e3) {} }, 1500);
    };
    if (ctx.state === 'suspended') {
      ctx.resume().then(doPlay).catch(function() { doPlay(); });
    } else {
      doPlay();
    }
    // Haptic: 3 strong bursts
    if (navigator.vibrate) navigator.vibrate([250, 100, 250, 100, 350]);
  } catch (e) {}
}

function startRestTimerSecs(secs) {
  stopRestTimer();
  // Pre-warm audio on iOS so it can play when timer ends
  _getAudioCtx();
  restTotalSecs = secs;
  restTimerEndAt = Date.now() + secs * 1000;
  lsSet('fs_rest_timer', { endAt: restTimerEndAt, total: secs });
  const label = document.getElementById('rest-timer-label');
  const secsDisplay = document.getElementById('rest-timer-secs-display');
  const bar = document.getElementById('rest-timer-progress');
  if (label) label.textContent = 'TAP TO STOP';
  if (secsDisplay) secsDisplay.textContent = secs + 's';
  if (bar) { bar.style.transition = 'none'; bar.style.width = '0%'; }
  if (navigator.vibrate) navigator.vibrate(50);
  restTimerInterval = setInterval(() => {
    const remaining = Math.ceil((restTimerEndAt - Date.now()) / 1000);
    if (secsDisplay) secsDisplay.textContent = Math.max(0, remaining) + 's';
    if (bar) {
      const elapsed = secs - remaining;
      const pct = Math.min(100, (elapsed / secs) * 100);
      bar.style.transition = 'width 0.5s linear';
      bar.style.width = pct + '%';
    }
    if (remaining <= 0) {
      if (navigator.vibrate) navigator.vibrate([150, 80, 150, 80, 150]);
      playRestChime();
      skipRest();
      if (label) label.textContent = 'DONE! TAP TO RESTART';
    }
  }, 500);
}

function skipRest() {
  stopRestTimer();
  restTimerEndAt = 0;
  lsSet('fs_rest_timer', null);
  const label = document.getElementById('rest-timer-label');
  const bar = document.getElementById('rest-timer-progress');
  if (label) label.textContent = 'START REST TIMER';
  if (bar) { bar.style.transition = 'none'; bar.style.width = '0%'; }
  updateRestDisplay();
}

function stopRestTimer() {
  if (restTimerInterval) { clearInterval(restTimerInterval); restTimerInterval = null; }
}

function restoreRestTimerIfActive() {
  const saved = lsGet('fs_rest_timer');
  if (!saved || !saved.endAt || saved.endAt <= Date.now()) return;
  restTotalSecs = saved.total || 90;
  restTimerEndAt = saved.endAt;
  startRestTimerSecs(restTotalSecs);
}

document.addEventListener('visibilitychange', function() {
  if (document.visibilityState === 'visible' && restTimerInterval && restTimerEndAt > 0) {
    const remaining = Math.ceil((restTimerEndAt - Date.now()) / 1000);
    const secsDisplay = document.getElementById('rest-timer-secs-display');
    const bar = document.getElementById('rest-timer-progress');
    const label = document.getElementById('rest-timer-label');
    if (secsDisplay) secsDisplay.textContent = Math.max(0, remaining) + 's';
    if (remaining <= 0 && label) {
      playRestChime();
      skipRest();
    } else if (bar && restTotalSecs > 0) {
      const pct = Math.min(100, ((restTotalSecs - remaining) / restTotalSecs) * 100);
      bar.style.width = pct + '%';
    }
  }
});


/* ═══════════════════════════════════════════ */
/* COACH.JS — AI Coach Chat & Food Logging     */
/* ═══════════════════════════════════════════ */
// ═══════════════════════════════════════════
// COACH.JS — AI Coach Chat & Food Logging via Coach
// ═══════════════════════════════════════════
// Dependencies: USER, TARGETS, GYM_DAYS, DAY_WORKOUTS, CURRENT_WEEK,
//   callClaude(), getMealCatEntries(), saveToStorage(), renderMealCategories(),
//   renderMacros(), refreshDashMacros(), TODAY_IDX, mealLogs, getAllEntries()

// ── AI COACH ──
let _coachHistory = [];
let _coachStreaming = false;
const COACH_LS_KEY = 'fs_coach_history';
const COACH_MAX_MESSAGES = 50;

function _loadCoachHistory() {
  try {
    const stored = localStorage.getItem(COACH_LS_KEY);
    if (stored) _coachHistory = JSON.parse(stored);
  } catch(e) { _coachHistory = []; }
}

function _saveCoachHistory() {
  // Keep last N messages to avoid bloating localStorage
  if (_coachHistory.length > COACH_MAX_MESSAGES) {
    _coachHistory = _coachHistory.slice(-COACH_MAX_MESSAGES);
  }
  try { localStorage.setItem(COACH_LS_KEY, JSON.stringify(_coachHistory)); } catch(e) {}
}

function initCoach() {
  _loadCoachHistory();
  const container = document.getElementById('coach-messages');
  const starters = document.getElementById('coach-starters');
  const clearBtn = document.getElementById('coach-clear-btn');
  if (!container) return;

  if (_coachHistory.length > 0) {
    if (starters) starters.style.display = 'none';
    if (clearBtn) clearBtn.style.display = 'block';
    const existing = container.querySelectorAll('.coach-bubble');
    existing.forEach(b => b.remove());
    for (const msg of _coachHistory) {
      const bubble = document.createElement('div');
      bubble.className = 'coach-bubble ' + msg.role;
      bubble.innerHTML = _formatCoachText(msg.content);
      container.appendChild(bubble);
    }
    container.scrollTop = container.scrollHeight;
  } else {
    if (starters) starters.style.display = '';
    if (clearBtn) clearBtn.style.display = 'none';
  }
}

// Handle iOS keyboard: when keyboard opens, visualViewport shrinks. 
// Adjust the coach fixed overlay to match.
if (window.visualViewport) {
  window.visualViewport.addEventListener('resize', () => {
    const coach = document.querySelector('.main-content.coach-active #view-coach.active');
    if (!coach) return;
    // On iOS when keyboard opens, viewport height shrinks. Adjust bottom to keep input visible.
    const vvh = window.visualViewport.height;
    const fullH = window.innerHeight;
    if (vvh < fullH - 50) {
      // Keyboard is open — shrink the overlay
      coach.style.height = vvh + 'px';
      coach.style.bottom = 'auto';
      coach.style.paddingBottom = '0';
    } else {
      // Keyboard closed — restore
      coach.style.height = '';
      coach.style.bottom = '';
      coach.style.paddingBottom = '';
    }
    // Scroll to bottom of messages
    const msgs = document.getElementById('coach-messages');
    if (msgs) setTimeout(() => msgs.scrollTop = msgs.scrollHeight, 50);
  });
}

function clearCoachHistory() {
  _coachHistory = [];
  localStorage.removeItem(COACH_LS_KEY);
  const container = document.getElementById('coach-messages');
  if (container) {
    const bubbles = container.querySelectorAll('.coach-bubble');
    bubbles.forEach(b => b.remove());
  }
  const starters = document.getElementById('coach-starters');
  if (starters) starters.style.display = '';
  const clearBtn = document.getElementById('coach-clear-btn');
  if (clearBtn) clearBtn.style.display = 'none';
}

function _getCoachSystemPrompt() {
  const weightLog = getWeightLog();
  const currentWeight = weightLog.length ? weightLog[weightLog.length - 1].lbs : (USER ? USER.weight : '?');
  const goalWeight = USER ? USER.goal : '?';
  const goalDirection = goalWeight > currentWeight ? 'build muscle / gain weight' : 'lose weight';
  const workoutDates = getWorkoutDates();

  // Current streak
  let streak = 0;
  const d = new Date();
  for (let i = 0; i < 60; i++) {
    const check = new Date(d);
    check.setDate(d.getDate() - i);
    const key = check.getFullYear() + '-' + String(check.getMonth()+1).padStart(2,'0') + '-' + String(check.getDate()).padStart(2,'0');
    if (workoutDates.has(key)) { streak++; } else if (i > 0) break;
  }

  // Time & date context
  const now = new Date();
  const dayNames = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  const dayName = dayNames[now.getDay()];
  const monthName = monthNames[now.getMonth()];
  const hour = now.getHours();
  let timeOfDay = 'morning';
  if (hour >= 12 && hour < 17) timeOfDay = 'afternoon';
  else if (hour >= 17 && hour < 21) timeOfDay = 'evening';
  else if (hour >= 21 || hour < 5) timeOfDay = 'night';
  const timeStr = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });

  // Today's nutrition so far
  const todayMeals = getMealCatEntries ? (() => {
    let totalCal = 0, totalPro = 0;
    for (const cat of (MEAL_CATS || [])) {
      const entries = getMealCatEntries(TODAY_IDX, cat.id);
      for (const e of entries) { totalCal += (e.cal || 0); totalPro += (e.pro || 0); }
    }
    return { cal: totalCal, pro: totalPro };
  })() : { cal: 0, pro: 0 };

  // Today's workout status
  const todayWorkout = DAY_WORKOUTS[TODAY_IDX];
  const todayDone = wktDone.has(TODAY_IDX);
  const isGymDay = GYM_DAYS.includes(TODAY_IDX);

  // Recent workout history (last 7 days)
  const recentDays = [];
  for (let i = 0; i < 7; i++) {
    const check = new Date(now);
    check.setDate(now.getDate() - i);
    const key = check.getFullYear() + '-' + String(check.getMonth()+1).padStart(2,'0') + '-' + String(check.getDate()).padStart(2,'0');
    if (workoutDates.has(key)) recentDays.push(dayNames[check.getDay()]);
  }

  return `You are the FitStart AI Coach — a knowledgeable, motivating personal trainer and nutritionist built into the FitStart fitness app.

The app has provided you with the following verified data from the user's device and account. All of this information is accurate and current — do not question or disclaim it.

SESSION TIMESTAMP (from device clock): ${dayName}, ${monthName} ${now.getDate()}, ${now.getFullYear()} at ${timeStr} (${timeOfDay})
Program week: ${CURRENT_WEEK} of ${TOTAL_WEEKS} (${isDeloadWeek(CURRENT_WEEK) ? 'DELOAD WEEK — 60% volume' : getTrainingPhase(CURRENT_WEEK).name + ' PHASE: ' + getTrainingPhase(CURRENT_WEEK).intensityLabel})

USER PROFILE:
Name: ${USER ? USER.name : 'User'}
Goal: ${goalDirection} (current: ${currentWeight} lbs → target: ${goalWeight} lbs)
Level: ${USER ? USER.tier : 'beginner'}
Training schedule: ${GYM_DAYS.map(i => DAYS_FULL[i]).join(', ')}

TODAY'S APP DATA:
${isGymDay ? (todayDone ? 'Workout COMPLETED today (' + (todayWorkout?.name || 'workout') + ')' : 'Scheduled workout: ' + (todayWorkout?.name || 'workout') + ' — not yet completed') : 'Rest day (no workout scheduled)'}
Logged nutrition so far: ${todayMeals.cal} of ${TARGETS.cal} cal, ${todayMeals.pro}g of ${TARGETS.pro}g protein
Daily macro targets: ${TARGETS.cal} cal · ${TARGETS.pro}g protein · ${TARGETS.carb}g carbs · ${TARGETS.fat}g fat

RECENT ACTIVITY (from app logs):
Workout streak: ${streak} day${streak !== 1 ? 's' : ''}
Workouts this week: ${recentDays.length > 0 ? recentDays.join(', ') : 'none yet'}
All-time workouts: ${workoutDates.size}

BEHAVIOR:
- You have access to the full message history with this user. Reference past conversations naturally when relevant.
- Be concise and practical — 2-4 short paragraphs max.
- Use their name occasionally.
- Reference their actual numbers, schedule, and progress.
- Adjust energy to the time of day.
- Use **bold** sparingly for key points.
- If they mention pain or injury, recommend a medical professional.
- Never say you don't have access to real-time data — the app provides it to you above.

FOOD LOGGING:
When the user tells you what they ate, include a FOODLOG JSON block at the END of your response so the app can auto-log it.

IMPORTANT — BRAND ACCURACY IS CRITICAL:
When a user mentions a SPECIFIC BRAND, you MUST log the correct macros for that exact brand and serving size. Do NOT guess or use generic category values. Here is a reference table:

Protein Powders (per scoop):
  Ballerina Farm Farmer Protein Vanilla (1 scoop/37g): 120cal 24P 6C 1F
  Ballerina Farm Farmer Protein Chocolate (1 scoop): 140cal 24P 7C 1.5F
  Equate Whey: 130cal 25P 3C 1.5F | ON Gold Standard: 120cal 24P 3C 1F
  Dymatize ISO100: 120cal 25P 2C 0.5F | MyProtein Impact Whey: 110cal 21P 1C 1.5F
  Ghost Whey: 130cal 25P 4C 1.5F | Muscle Milk Powder: 150cal 16P 8C 6F
  Body Fortress Whey: 200cal 30P 8C 4F | Six Star Whey: 140cal 23P 6C 3F

Ready-to-Drink:
  Premier Protein Shake (11oz): 160cal 30P 5C 3F | Muscle Milk (14oz): 230cal 25P 9C 9F
  Fairlife Core Power (14oz): 230cal 42P 8C 4.5F | Fairlife Core Power Light: 150cal 26P 6C 2F
  Orgain Protein Shake (11oz): 150cal 16P 15C 3F

Dairy:
  Fairlife Fat Free Milk (1 cup): 80cal 13P 6C 0F | Fairlife 2% (1 cup): 130cal 13P 6C 4.5F
  Chobani 0% Greek Yogurt (5.3oz): 80cal 14P 6C 0F | Fage 0% (7oz): 100cal 18P 6C 0F
  Oikos Triple Zero (5.3oz): 90cal 15P 7C 0F
  Horizon Organic Whole Milk (1 cup): 150cal 8P 12C 8F

Bars:
  Quest Bar: 200cal 21P 21C 8F | RXBar: 210cal 12P 24C 9F
  Kind Protein Bar: 250cal 12P 17C 17F | ONE Bar: 220cal 20P 23C 8F
  Clif Bar: 250cal 10P 44C 5F | Nature Valley Protein Bar: 190cal 10P 29C 5F
  Built Bar: 130cal 17P 15C 3F | Barebells: 200cal 20P 18C 7F

Bread/Pancakes:
  Kodiak Protein Pancakes (3): 390cal 33P 54C 6F | Kodiak Waffle (2): 260cal 22P 36C 4F
  Dave's Killer Bread (1 slice): 120cal 5P 22C 1.5F | Ezekiel (1 slice): 80cal 4P 15C 0.5F

Jerky & Meat Snacks (per 1oz/28g unless noted):
  Old Trapper Peppered Beef Jerky (1oz): 70cal 12P 3C 1F
  Old Trapper Original Beef Jerky (1oz): 70cal 11P 4C 1F
  Old Trapper Teriyaki Beef Jerky (1oz): 70cal 11P 5C 1F
  Jack Link's Original Beef Jerky (1oz): 80cal 12P 5C 1F
  Jack Link's Teriyaki Beef Jerky (1oz): 80cal 11P 7C 1F
  Jack Link's Peppered Beef Jerky (1oz): 80cal 12P 5C 1F
  Chomps Original Beef Stick (1 stick/1.15oz): 90cal 10P 0C 6F
  Epic Venison Sea Salt Bar (1 bar/1.3oz): 100cal 10P 5C 4F
  Country Archer Original Beef Jerky (1oz): 70cal 10P 5C 1F
  Tillamook Country Smoker (1oz): 70cal 11P 3C 1F
  Slim Jim Original (1 stick/0.28oz): 40cal 2P 1C 3F | Slim Jim Giant: 150cal 6P 2C 13F

Frozen Chicken & Prepared Meats:
  Just Bare Lightly Breaded Chicken Breast Chunks (3oz/85g): 150cal 13P 10C 6F
  Just Bare Lightly Breaded Chicken Breast Strips (3oz/85g): 150cal 14P 11C 5F
  Just Bare Chicken Breast Nuggets (5 nuggets/84g): 150cal 13P 10C 6F
  Tyson Chicken Nuggets (5 pieces/90g): 230cal 12P 15C 14F
  Tyson Grilled Chicken Breast Strips (3oz): 110cal 19P 2C 3F
  Perdue Chicken Breast Tenders (3oz): 170cal 12P 12C 8F
  Foster Farms Crispy Strips (3 pieces/84g): 210cal 14P 14C 10F
  Banquet Chicken Nuggets (6 pieces/85g): 220cal 10P 16C 14F

Snacks:
  Goldfish Crackers (1oz/55 pieces): 140cal 3P 20C 5F
  Cheez-Its (1oz/27 crackers): 150cal 3P 17C 8F
  Ritz Crackers (5 crackers): 80cal 1P 10C 4F
  Lays Classic Chips (1oz): 160cal 2P 15C 10F
  SkinnyPop Popcorn (1oz): 140cal 2P 15C 9F
  Rice Krispies Treat (1 bar): 90cal 1P 17C 2F
  String Cheese (1 stick): 80cal 7P 1C 5F
  Babybel Original (1 piece): 70cal 5P 0C 5F

Cereal & Oats:
  Quaker Oats (1/2 cup dry): 150cal 5P 27C 3F
  Cheerios (1 cup): 100cal 3P 20C 2F
  Magic Spoon (1 cup): 140cal 13P 15C 7F

CRITICAL SERVING SIZE RULE: When a user specifies an exact weight (e.g. "2.68oz" or "7 ounces"), you MUST:
1. Find the per-serving macros from the table above (note the serving size listed — e.g. "per 1oz" or "per 3oz/85g")
2. Calculate how many servings their amount equals: (their amount) ÷ (serving size)
3. Multiply ALL macros by that number
4. Round to nearest whole number

Example: Just Bare Chicken Nuggets are 150cal/13P/10C/6F per 3oz serving. If user says "7oz":
  7oz ÷ 3oz = 2.33 servings
  Cal: 150 × 2.33 = 350 | Pro: 13 × 2.33 = 30 | Carb: 10 × 2.33 = 23 | Fat: 6 × 2.33 = 14
  Log: 350cal 30P 23C 14F

Example: Old Trapper Peppered Jerky is 70cal/12P/3C/1F per 1oz. If user says "2.68oz":
  2.68 × 70 = 188cal | 2.68 × 12 = 32P | 2.68 × 3 = 8C | 2.68 × 1 = 3F
  Log: 188cal 32P 8C 3F

NEVER estimate or round the serving count to a whole number. Always use the exact multiplier.

If the user says a brand NOT in this list:
1. The app will automatically search its nutrition database and provide results in a [NUTRITION DATABASE RESULTS] section. USE THOSE VALUES — they come from real product labels.
2. If database results are provided, find the best match and use its exact macros. Scale to the user's serving size using the per-100g values.
3. If no database results are provided or none match, tell the user you don't have exact macros and ask them to check the label.
4. NEVER silently default to generic category values (e.g. don't use "generic beef jerky" when they said a specific brand)

If the user says just "protein shake" or "whey protein" WITHOUT a brand, ASK which brand before logging. Say something like "Which brand? That way I can log the exact macros."

WHEN DATABASE RESULTS ARE PROVIDED: Always use them. They contain real nutrition label data. Example:
If database says "Real Good Chicken Chunks (Real Good Foods) — per 141g: 200cal 28P 3C 9F (per 100g: 142cal 20P 2C 6F)"
And user says "8oz (2 servings)": 8oz = 227g. Using per-100g: 227/100 × 142 = 322cal, 227/100 × 20 = 45P, 227/100 × 2 = 5C, 227/100 × 6 = 14F.
Log: 322cal 45P 5C 14F.

FOODLOG FORMAT (must be at the very end of your response):
\`\`\`FOODLOG
{"meal":"breakfast","items":[{"name":"Large Eggs (2)","cal":140,"pro":12,"carb":1,"fat":10}]}
\`\`\`

Rules:
- "meal": "breakfast", "lunch", "dinner", or "snacks"
- Infer meal from context or time: before 11am=breakfast, 11am-2pm=lunch, 2-5pm=snacks, after 5pm=dinner
- Include brand + quantity in the "name" field
- cal, pro, carb, fat must be integers
- ONLY include FOODLOG when the user describes food they ate — NOT for general nutrition questions
- The FOODLOG block must be the LAST thing in your response`;
}

function sendCoachStarter(text) {
  const starters = document.getElementById('coach-starters');
  if (starters) starters.style.display = 'none';
  const clearBtn = document.getElementById('coach-clear-btn');
  if (clearBtn) clearBtn.style.display = 'block';
  _sendCoachMsg(text);
}

function sendCoachMessage() {
  const input = document.getElementById('coach-input');
  const text = (input.value || '').trim();
  if (!text || _coachStreaming) return;
  input.value = '';
  const starters = document.getElementById('coach-starters');
  if (starters) starters.style.display = 'none';
  const clearBtn = document.getElementById('coach-clear-btn');
  if (clearBtn) clearBtn.style.display = 'block';
  _sendCoachMsg(text);
}

function _appendCoachBubble(role, content) {
  const container = document.getElementById('coach-messages');
  const bubble = document.createElement('div');
  bubble.className = 'coach-bubble ' + role;
  bubble.innerHTML = _formatCoachText(content);
  container.appendChild(bubble);
  container.scrollTop = container.scrollHeight;
  return bubble;
}

function _formatCoachText(text) {
  return text
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\n/g, '<br>');
}

async function _sendCoachMsg(text) {
  _coachStreaming = true;
  const sendBtn = document.getElementById('coach-send-btn');
  if (sendBtn) sendBtn.disabled = true;

  _appendCoachBubble('user', text);
  _coachHistory.push({ role: 'user', content: text });
  _saveCoachHistory();

  const container = document.getElementById('coach-messages');
  const typing = document.createElement('div');
  typing.className = 'coach-typing';
  typing.id = 'coach-typing';
  typing.innerHTML = '<div class="coach-typing-dot"></div><div class="coach-typing-dot"></div><div class="coach-typing-dot"></div>';
  container.appendChild(typing);
  container.scrollTop = container.scrollHeight;

  try {
    // Check if this is a food logging message — if so, try to auto-log from database BEFORE calling AI
    let autoLogContext = '';
    let autoLogged = false;
    if (_looksLikeFoodLog(text)) {
      const foodQuery = _extractFoodQuery(text);
      const servingInfo = _extractServingAmount(text);
      if (foodQuery) {
        try {
          // Search USDA first, then OFF as fallback
          let bestMatch = null;
          const usdaResults = await _searchUSDA(foodQuery);
          if (usdaResults && usdaResults.length > 0) {
            bestMatch = usdaResults[0];
          } else {
            const offResults = await fetchOFF(foodQuery);
            if (offResults && offResults.length > 0) {
              bestMatch = {
                name: offResults[0].name + (offResults[0].brand ? ' (' + offResults[0].brand + ')' : ''),
                brand: offResults[0].brand || '',
                cal100: offResults[0].cal100, pro100: offResults[0].pro100,
                carb100: offResults[0].carb100, fat100: offResults[0].fat100,
                servingG: offResults[0].servingG,
                servingSize: offResults[0].serving,
              };
            }
          }

          if (bestMatch && bestMatch.cal100 > 0 && (bestMatch._score || 0) >= 2) {
            // Calculate macros: use user's serving size if specified, otherwise use label serving
            let grams = servingInfo.grams;
            let servingDesc = servingInfo.original;
            if (!grams && bestMatch.servingG) {
              grams = bestMatch.servingG * (servingInfo.count || 1);
              servingDesc = (servingInfo.count > 1 ? servingInfo.count + ' servings' : '1 serving') + ' (' + grams + 'g)';
            }
            if (!grams) grams = bestMatch.servingG || 100;

            const factor = grams / 100;
            const cal = Math.round(bestMatch.cal100 * factor);
            const pro = Math.round(bestMatch.pro100 * factor);
            const carb = Math.round(bestMatch.carb100 * factor);
            const fat = Math.round(bestMatch.fat100 * factor);

            const foodName = bestMatch.name + (bestMatch.brand && !bestMatch.name.includes(bestMatch.brand) ? ' (' + bestMatch.brand + ')' : '');
            const displayName = foodName.length > 50 ? foodName.substring(0, 47) + '...' : foodName;

            // Determine meal from time of day
            const hour = new Date().getHours();
            let meal = 'snacks';
            if (hour < 11) meal = 'breakfast';
            else if (hour < 14) meal = 'lunch';
            else if (hour >= 17) meal = 'dinner';

            // Check for explicit meal mentions
            const tl = text.toLowerCase();
            if (tl.includes('breakfast')) meal = 'breakfast';
            else if (tl.includes('lunch')) meal = 'lunch';
            else if (tl.includes('dinner') || tl.includes('supper')) meal = 'dinner';
            else if (tl.includes('snack')) meal = 'snacks';

            // Auto-log it
            _processFoodLog({
              meal: meal,
              items: [{ name: `${displayName} (${servingDesc || grams + 'g'})`, cal, pro, carb, fat }]
            });
            autoLogged = true;

            // Tell the AI what was logged so it can comment appropriately
            autoLogContext = `\n\n[AUTO-LOGGED BY APP: ${displayName} — ${servingDesc || grams + 'g'} — ${cal}cal ${pro}P ${carb}C ${fat}F → logged to ${meal}. Source: USDA database. The food has already been logged — do NOT include a FOODLOG block. Just acknowledge the logged food and give brief nutritional commentary.]`;
          }
        } catch(e) {
          console.log('Auto-log pre-fetch failed:', e.message);
          // Fall through to normal AI flow with FOODLOG
        }
      }
    }

    // Build messages
    const messages = _coachHistory.slice(-20);
    let systemPrompt = _getCoachSystemPrompt();
    if (autoLogContext) {
      systemPrompt += autoLogContext;
    }

    let reply = await callClaude(messages, {
      system: systemPrompt,
      max_tokens: 800
    });

    const typingEl = document.getElementById('coach-typing');
    if (typingEl) typingEl.remove();

    // Parse and process FOODLOG if present (only if we didn't auto-log)
    if (!autoLogged) {
      const foodLogResult = _parseFoodLog(reply);
      if (foodLogResult) {
        reply = foodLogResult.cleanReply;
        _processFoodLog(foodLogResult.data);
      }
    } else {
      // Strip any FOODLOG block the AI might have added anyway
      reply = reply.replace(/```FOODLOG[\s\S]*?```/g, '').trim();
    }

    _appendCoachBubble('assistant', reply || 'Sorry, I could not generate a response. Please try again.');
    _coachHistory.push({ role: 'assistant', content: reply });
    _saveCoachHistory();
  } catch (e) {
    const typingEl = document.getElementById('coach-typing');
    if (typingEl) typingEl.remove();
    _appendCoachBubble('assistant', e.message || 'Something went wrong. Try again in a moment.');
  }

  _coachStreaming = false;
  if (sendBtn) sendBtn.disabled = false;
  document.getElementById('coach-input')?.focus();
}

// ── USDA FoodData Central — parse a single food item ──
function _parseUSDAFood(food) {
  const per100 = {};
  for (const n of (food.foodNutrients || [])) {
    const id = n.nutrientId || n.nutrientNumber;
    const nm = n.nutrientName || '';
    if (id === 1008 || nm === 'Energy') per100.cal = n.value || 0;
    else if (id === 1003 || nm === 'Protein') per100.pro = n.value || 0;
    else if (id === 1005 || nm === 'Carbohydrate, by difference') per100.carb = n.value || 0;
    else if (id === 1004 || nm === 'Total lipid (fat)') per100.fat = n.value || 0;
  }
  let servingG = food.servingSize ? parseFloat(food.servingSize) : 0;
  if (!servingG || isNaN(servingG)) servingG = 100;
  const factor = servingG / 100;
  const unit = (food.servingSizeUnit || 'g').toLowerCase();
  let servingLabel;
  if (food.householdServingFullText) {
    servingLabel = food.householdServingFullText + ' (' + Math.round(servingG) + (unit === 'g' ? 'g' : unit) + ')';
  } else {
    servingLabel = Math.round(servingG) + (unit === 'g' ? 'g' : unit);
  }
  return {
    name: (food.description || '').replace(/,\s*UPC.*$/i, '').trim(),
    brand: (food.brandOwner || food.brandName || '').replace(/,.*$/, '').trim(),
    serving: servingLabel,
    servingG,
    cal:  Math.round((per100.cal  || 0) * factor),
    pro:  Math.round((per100.pro  || 0) * factor),
    carb: Math.round((per100.carb || 0) * factor),
    fat:  Math.round((per100.fat  || 0) * factor),
    cal100:  Math.round(per100.cal  || 0),
    pro100:  Math.round(per100.pro  || 0),
    carb100: Math.round(per100.carb || 0),
    fat100:  Math.round(per100.fat  || 0),
  };
}

// USDA Branded — real product labels with serving sizes (primary source)
async function _searchUSDA_branded(query) {
  try {
    const url = 'https://api.nal.usda.gov/fdc/v1/foods/search?api_key=DEMO_KEY&query=' + encodeURIComponent(query) + '&dataType=Branded&pageSize=50';
    const fetchPromise = fetch(url).then(function(r) { return r.json(); });
    const timeoutPromise = new Promise(function(_, rej) { setTimeout(function(){ rej(new Error('timeout')); }, 8000); });
    const data = await Promise.race([fetchPromise, timeoutPromise]);
    return (data.foods || [])
      .map(function(f) { return Object.assign(_parseUSDAFood(f), { _source: 'usda_branded' }); })
      .filter(function(f) { return f.cal > 0; });
  } catch(e) {
    console.log('USDA branded search failed:', e.message);
    return [];
  }
}

// USDA Foundation + SR Legacy — whole foods with verified nutrition (chicken breast, rice, etc.)
async function _searchUSDA_foundation(query) {
  try {
    const url = 'https://api.nal.usda.gov/fdc/v1/foods/search?api_key=DEMO_KEY&query=' + encodeURIComponent(query) + '&dataType=Foundation,SR%20Legacy&pageSize=10';
    const fetchPromise = fetch(url).then(function(r) { return r.json(); });
    const timeoutPromise = new Promise(function(_, rej) { setTimeout(function(){ rej(new Error('timeout')); }, 8000); });
    const data = await Promise.race([fetchPromise, timeoutPromise]);
    if (!data || !data.foods) return [];
    return (data.foods || []).map(function(food) {
      var parsed = _parseUSDAFood(food);
      if (!food.servingSize) {
        parsed.servingG = smartServingG(food.description) || 100;
        var sg = parsed.servingG;
        parsed.serving = sg === 100 ? '100g' : sg + 'g';
        var factor = sg / 100;
        parsed.cal  = Math.round(parsed.cal100  * factor);
        parsed.pro  = Math.round(parsed.pro100  * factor);
        parsed.carb = Math.round(parsed.carb100 * factor);
        parsed.fat  = Math.round(parsed.fat100  * factor);
      }
      return Object.assign(parsed, { _source: 'usda_foundation' });
    }).filter(function(f) { return f.cal > 0; });
  } catch(e) {
    console.log('USDA foundation search failed:', e.message);
    return [];
  }
}

// Alias for AI coach food auto-logging (uses branded only)
async function _searchUSDA(query) {
  return _searchUSDA_branded(query);
}

// ── SETS / REPS EDITOR ──
var _sreExIdx = -1;

function openSetRepEditor(exIdx) {
  _sreExIdx = exIdx;
  const ex = woWorkout.exercises[exIdx];
  if (!ex) return;
  document.getElementById('sre-ex-name').textContent = ex.name.toUpperCase();
  document.getElementById('sre-sets').value = woExtraSets[exIdx] || ex.sets;
  // Parse reps — could be "10-15" or "10"
  var repsRaw = String(ex.reps || '10');
  var repsNum = parseInt(repsRaw.split('-')[0]) || 10;
  document.getElementById('sre-reps').value = repsNum;
  var rest = ex.rest || 90;
  document.getElementById('sre-rest').value = rest;
  document.getElementById('sre-rest-display').textContent = rest + 's';
  document.getElementById('setrepedit-modal').style.display = 'flex';
}

function closeSetRepEditor() {
  document.getElementById('setrepedit-modal').style.display = 'none';
  _sreExIdx = -1;
}

function adjustSRE(field, delta) {
  if (field === 'sets') {
    var el = document.getElementById('sre-sets');
    el.value = Math.max(1, Math.min(10, (parseInt(el.value)||3) + delta));
  } else if (field === 'reps') {
    var el = document.getElementById('sre-reps');
    el.value = Math.max(1, Math.min(50, (parseInt(el.value)||10) + delta));
  } else if (field === 'rest') {
    var el = document.getElementById('sre-rest');
    var newVal = Math.max(15, Math.min(300, (parseInt(el.value)||90) + delta));
    el.value = newVal;
    document.getElementById('sre-rest-display').textContent = newVal + 's';
  }
}

function applySetRepEdit() {
  if (_sreExIdx < 0 || !woWorkout) return;
  var sets = parseInt(document.getElementById('sre-sets').value) || 3;
  var reps = parseInt(document.getElementById('sre-reps').value) || 10;
  var rest = parseInt(document.getElementById('sre-rest').value) || 90;
  var targetIdx = _sreExIdx;

  // Mutate exercise object directly
  var ex = woWorkout.exercises[targetIdx];
  if (!ex) { closeSetRepEditor(); return; }
  ex.sets = sets;
  ex.reps = reps;
  ex.rest = rest;

  // woExtraSets controls the actual row count in renderSetsTable
  woExtraSets[targetIdx] = sets;

  closeSetRepEditor();

  // Force badge update immediately (don't wait for loadExercise to re-read stale values)
  var badgeEl = document.getElementById('wo-ex-badge');
  if (badgeEl) {
    badgeEl.innerHTML =
      '<div style="display:flex;align-items:center;justify-content:space-between;gap:8px">' +
      '<span>' + sets + ' × ' + reps + '</span>' +
      '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="11" height="11" style="opacity:0.6;flex-shrink:0"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>' +
      '</div>' +
      '<span style="font-size:0.6rem;opacity:0.7;letter-spacing:0.5px">REST ' + rest + 's</span>';
    badgeEl.onclick = function() { openSetRepEditor(targetIdx); };
  }

  // Re-render the sets table with the new set count
  renderSetsTable(targetIdx, ex);
  persistWorkoutDraft();
}

// Detect if a message looks like food logging (vs a general question)
function _looksLikeFoodLog(text) {
  const t = text.toLowerCase();
  // Patterns that suggest food intake
  const atePatterns = /\b(i (?:had|ate|just had|just ate|eaten|drink|drank)|for (?:breakfast|lunch|dinner|snack)|(?:i'm|im) (?:having|eating)|(?:log|track|add)\b.*\b(?:cal|food|meal)|\d+\s*(?:oz|ounce|cup|scoop|piece|slice|serving|bowl|plate|g\b|gram))/i;
  return atePatterns.test(t);
}

// Extract the food name/brand from a food logging message
function _extractFoodQuery(text) {
  let q = text
    // Remove leading action phrases
    .replace(/^(i (?:had|ate|just had|just ate|eaten)|for (?:breakfast|lunch|dinner|snack)[,:]?\s*(?:i (?:had|ate))?|i'm having|im eating|log|track|add)\s*/i, '')
    // Remove serving amounts
    .replace(/\b\d+\.?\d*\s*(oz|ounce|ounces|cup|cups|scoop|scoops|piece|pieces|slice|slices|serving|servings|bowl|bowls|plate|plates|grams?|g|tbsp|tsp|ml|liter|litre)\s*(of\s*)?/gi, '')
    // Remove trailing meal context and command words
    .replace(/\b(for\s+)?(breakfast|lunch|dinner|snack|brunch|my meal|that|this|it|please|thanks|today|tonight|yesterday|log\s*(that|it|this)?|track\s*(that|it|this)?|add\s*(that|it|this)?)\b/gi, '')
    .replace(/\babout\b/gi, '')
    .trim();
  // Clean up extra whitespace
  q = q.replace(/\s+/g, ' ').trim();
  const words = q.split(/\s+/).filter(w => w.length > 1);
  if (words.length > 6) q = words.slice(0, 6).join(' ');
  return q.length >= 2 ? q : null;
}

// Extract serving amount from user text and convert to grams
function _extractServingAmount(text) {
  const t = text.toLowerCase();
  let grams = 0;
  let original = '';
  let count = 1;

  // Match patterns: "84g", "84 grams", "3oz", "3 ounces", "8 oz", "2.5 cups", "2 servings", etc.
  const patterns = [
    // Grams: "84g", "84 grams", "84 g"
    { re: /(\d+\.?\d*)\s*(?:g|grams?)\b/i, toG: (m) => parseFloat(m) },
    // Ounces: "8oz", "8 ounces", "2.68 oz"
    { re: /(\d+\.?\d*)\s*(?:oz|ounces?)\b/i, toG: (m) => parseFloat(m) * 28.35 },
    // Cups: "2 cups", "1.5 cup"
    { re: /(\d+\.?\d*)\s*(?:cups?)\b/i, toG: (m) => parseFloat(m) * 240 },
    // Tablespoons: "2 tbsp"
    { re: /(\d+\.?\d*)\s*(?:tbsp|tablespoons?)\b/i, toG: (m) => parseFloat(m) * 15 },
    // Teaspoons: "1 tsp"
    { re: /(\d+\.?\d*)\s*(?:tsp|teaspoons?)\b/i, toG: (m) => parseFloat(m) * 5 },
    // Pounds: "1.5 lbs"
    { re: /(\d+\.?\d*)\s*(?:lbs?|pounds?)\b/i, toG: (m) => parseFloat(m) * 453.6 },
    // ml: "250ml"
    { re: /(\d+\.?\d*)\s*(?:ml|milliliters?)\b/i, toG: (m) => parseFloat(m) },
    // Servings: "2 servings" — we'll use this as a multiplier
    { re: /(\d+\.?\d*)\s*(?:servings?)\b/i, toG: null, isCount: true },
    // Pieces/slices: "3 pieces", "2 slices"
    { re: /(\d+\.?\d*)\s*(?:pieces?|slices?|scoops?)\b/i, toG: null, isCount: true },
  ];

  for (const p of patterns) {
    const match = t.match(p.re);
    if (match) {
      original = match[0];
      if (p.isCount) {
        count = parseFloat(match[1]) || 1;
      } else {
        grams = p.toG(match[1]);
      }
      break;
    }
  }

  return { grams: Math.round(grams), original, count };
}

function _parseFoodLog(reply) {
  // Look for ```FOODLOG ... ``` block
  const regex = /```FOODLOG\s*\n?([\s\S]*?)```/;
  const match = reply.match(regex);
  if (!match) return null;
  try {
    const data = JSON.parse(match[1].trim());
    if (!data.meal || !Array.isArray(data.items) || data.items.length === 0) return null;
    const cleanReply = reply.replace(regex, '').trim();
    return { data, cleanReply };
  } catch(e) {
    return null;
  }
}

function _processFoodLog(data) {
  const validMeals = ['breakfast', 'lunch', 'dinner', 'snacks', 'other'];
  const meal = validMeals.includes(data.meal) ? data.meal : 'other';
  const loggedItems = [];

  for (const item of data.items) {
    if (!item.name) continue;
    const entry = {
      name: item.name,
      cal: Math.round(item.cal || 0),
      pro: Math.round(item.pro || 0),
      carb: Math.round(item.carb || 0),
      fat: Math.round(item.fat || 0),
    };
    getMealCatEntries(TODAY_IDX, meal).push(entry);
    loggedItems.push(entry);
  }

  if (loggedItems.length > 0) {
    saveToStorage();
    renderMealCategories();
    renderMacros();
    refreshDashMacros();

    // Show a confirmation card in the chat
    const totalCal = loggedItems.reduce((s, e) => s + e.cal, 0);
    const totalPro = loggedItems.reduce((s, e) => s + e.pro, 0);
    const mealLabel = meal.charAt(0).toUpperCase() + meal.slice(1);
    const itemList = loggedItems.map(e => `${e.name} — ${e.cal} cal, ${e.pro}g P`).join('<br>');

    const container = document.getElementById('coach-messages');
    const card = document.createElement('div');
    card.style.cssText = 'background:rgba(74,222,128,0.06);border:1px solid rgba(74,222,128,0.15);border-radius:14px;padding:12px 14px;font-size:0.78rem;color:var(--off);line-height:1.5;max-width:85%;align-self:flex-start;';
    card.innerHTML = `<div style="display:flex;align-items:center;gap:6px;margin-bottom:6px"><span style="color:var(--green);font-size:0.9rem">✓</span><span style="font-family:'Bebas Neue',sans-serif;font-size:0.78rem;letter-spacing:1.5px;color:var(--green)">LOGGED TO ${mealLabel.toUpperCase()}</span></div>
      <div style="font-size:0.76rem;color:var(--off);line-height:1.6">${itemList}</div>
      <div style="margin-top:6px;font-family:'DM Mono',monospace;font-size:0.7rem;color:var(--green);opacity:0.8">${totalCal} cal · ${totalPro}g protein</div>`;
    container.appendChild(card);
    container.scrollTop = container.scrollHeight;
  }
}


// ── BOOT ──
_bootApp();
</script>

</body>
</html>
